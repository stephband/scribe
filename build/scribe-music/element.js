/* Scribe 
   0.3.1
   By Stephen */

var Bi=Object.defineProperty;var Di=(e,t)=>{for(var r in t)Bi(e,r,{get:t[r],enumerable:!0})};var ee,qe;function Li(e,t){let r=-1;for(;e[++r]&&e[r]!==t;);for(;e[r++];)e[r-1]=e[r]}function Er(e){let t=0;for(;e[--t];)e[t].stop&&e[t].stop(),e[t]=void 0}function ft(e,t){let r=0;for(;t[--r]&&t[r]!==e;);for(t[r]=e,r=-1;e[++r]&&e[r]!==t;);e[r]=t}function Ze(e){let t=-1,r;for(;r=e[++t];)e[t]=void 0,r.invalidate(e)}function Cr(e,t){let r=0;for(;e[--r];)if(e[r]===t)return!0}var Q=class e{static isSignal(t){return t instanceof e}static of(t){return new vr(t)}static from(t,r){if(t.then){let f=e.of();return t.then(c=>f.value=c),f}return t.pipe?t.pipe(new br):new qt(t,r)}static compute(t,r){return new qt(t,r)}static fromProperty(t,r){return new yr(t,r)}static frame(t){return new zt(t)}static tick(t){return new Ut(t)}static temporal(t,r){return new xr(t,r)}static evaluate(t,r,f=t){let c=ee;ee=t,c||(qe=!1);let p=r.apply(f);return ee=c,p}static get hasInvalidDependency(){return qe}static get evaluating(){return ee}constructor(t){t&&(this.name=t)}valueOf(){return this.value}toString(){return this.value+""}toJSON(){return this.value}},vr=class extends Q{#e;constructor(t){super(),this.#e=t}get value(){return ee&&ft(this,ee),this.#e}set value(t){this.#e!==t&&(this.#e=t,Ze(this))}},br=class extends Q{#e;constructor(t){super(),this.#e=t}get value(){return ee&&ft(this,ee),this.#e}push(t){this.#e!==t&&(this.#e=t,Ze(this))}},yr=class extends Q{#e;#t;constructor(t,r){super(t),this.object=r}evaluate(){return this.object[this.name]}get value(){return ee&&ft(this,ee),this.#e?this.#t:(this.#t=Q.evaluate(this,this.evaluate,this),qe||(this.#e=!0),this.#t)}set value(t){if(this.#t===t)return;let{object:r,name:f}=this;r[f]=t,t=r[f],this.#t!==t&&(this.#t=t,Ze(this))}invalidate(t){this.#e&&(t&&!Cr(this,t)||(this.#e=!1,Er(this),Ze(this)))}},qt=class extends Q{#e;#t;#r;#n;constructor(t,r){super(),this.#e=t,this.#t=r}get value(){return ee&&ft(this,ee),this.#r?this.#n:(this.#n=Q.evaluate(this,this.#e,this.#t),qe||(this.#r=!0),this.#n)}invalidate(t){this.#r&&(t&&!Cr(this,t)||(this.#r=!1,Er(this),Ze(this)))}},xr=class extends Q{#e=0;constructor(t,r){super(t),this.object=r}getTime(){return window.performance.now()}evaluate(){return this.object[this.name]}get value(){return Q.evaluating&&(ft(this,ee),this.getTime()<this.#e&&(qe=!0)),this.evaluate()}set value(t){console.warn("Dont really want to be setting value of TimedSignal"),console.trace(),this.object[this.name]!==t&&(this.object[this.name]=t,invalidateUntil(this.getTime()))}invalidateUntil(t){let f=this.getTime()>=this.#e;this.#e=t,f&&Ze(this)}},$t=class extends Q{constructor(t){if(super(),ee){let r=0;for(;ee[--r]&&ee[r]!==this;);ee[r]=this}t&&(this.evaluate=t,(Q.evaluate(this,this.evaluate)||qe)&&this.cue())}invalidate(t){this.constructor.observers.indexOf(this)===-1&&(t&&!Cr(this,t)||(Er(this),this.cue()))}stop(){let t=0,r;for(;r=this[--t];){let p=-1;this[t]=void 0,r.stop?r.stop():Li(r,this)}let f=this.constructor.observers,c=f.indexOf(this);if(c!==-1){if(f===wr)throw new Error("Attempt to remove observer while observers is rendering");f.splice(c,1)}return this}valueOf(){return this}toString(){return"[object Signal]"}toJSON(){}},wr;function Qn(e){let t=-1,r;for(wr=e;r=e[++t];)!Q.evaluate(r,r.evaluate)&&!qe&&e.splice(t--,1);return wr=void 0,e}var Zn=Promise.resolve();function Jn(){Qn(Ut.observers).length&&Zn.then(Jn)}var Ut=class extends $t{static observers=[];cue(){let t=this.constructor.observers;t.length||Zn.then(Jn),t.push(this)}};function Yn(){Qn(zt.observers).length&&requestAnimationFrame(Yn)}var zt=class extends $t{static observers=[];cue(){let t=this.constructor.observers;t.length||window.requestAnimationFrame(Yn),t.push(this)}};function me(e){return e}function j(e,t){return function(){let f=e.apply(this,arguments),c=t[f]||t.default;if(!c)throw new Error('overload() no function defined for key "'+f+'"');return c.apply(this,arguments)}}function Je(e){var t=new Map;return function(f){if(t.has(f))return t.get(f);var c=e(f);return t.set(f,c),c}}var Fi=Array.prototype;function Ai(e,t){return typeof e=="function"?e.apply(null,t):e}function Vn(e,t,r){r=r||e.length;var f=r===1?t?e:Je(e):Je(function(c){return Vn(function(){var p=[c];return p.push.apply(p,arguments),e.apply(null,p)},t,r-1)});return function c(p){return arguments.length===0?c:arguments.length===1?f(p):arguments.length>=r?e.apply(null,arguments):Ai(f(p),Fi.slice.call(arguments,1))}}var ge=Vn;function ne(){}var Mi=j(me,{is:ne,tag:ne,data:function(e,t,r){for(e in r)r[e]===void 0&&delete r[e];Object.assign(t.dataset,r)},dataset:function(e,t,r){for(e in r)r[e]===void 0&&delete r[e];Object.assign(t.dataset,r)},html:function(e,t,r){t.innerHTML=r},text:function(e,t,r){t.textContent=r},style:j((e,t,r)=>typeof r,{string:(e,t,r)=>t.style=r,object:(e,t,r)=>Object.assign(t.style,r)}),children:function(e,t,r){t.innerHTML="",t.append.apply(t,r)},href:function(e,t,r){t instanceof SVGElement?t.setAttribute("href",r):t.href=r},points:ye,cx:ye,cy:ye,r:ye,x:ye,y:ye,dx:ye,dy:ye,transform:ye,preserveAspectRatio:ye,viewBox:ye,default:function(e,t,r){e in t?t[e]=r:t.setAttribute(e,r)}});function ye(e,t,r){t.setAttribute(e,r)}function Si(e,t){for(var r=Object.keys(t),f=r.length;f--;)t[r[f]]!==void 0&&Mi(r[f],e,t[r[f]]);return e}var Ht=ge(Si,!0);var kr="http://www.w3.org/2000/svg",ea=document.createElement("template"),Nr=(e,t)=>t&&typeof t;function ta(e,t=""){let r=document.createRange();return r.selectNode(e),r.createContextualFragment(t)}var fe=j(Nr,{string:function(e,t){let r=document.createElementNS(kr,e);return r.innerHTML=t,r},object:function(e,t){let r=document.createElementNS(kr,e);return typeof t.length=="number"?r.append.apply(r,t):Ht(r,t),r},default:e=>document.createElementNS(kr,e)}),Pi=j(Nr,{string:function(e,t){let r=document.createElement(e);return r.innerHTML=t,r},object:function(e,t){let r=document.createElement(e);return typeof t.length=="number"?r.append.apply(r,t):Ht(r,t),r},default:e=>document.createElement(e)}),Ii=j(me,{comment:function(e,t){return document.createComment(t||"")},fragment:j(Nr,{string:function(e,t,r){return r?ta(r,t):(ea.innerHTML=t,ea.content.cloneNode(!0))},object:function(e,t,r){let f=r?ta(r):document.createDocumentFragment();return typeof t.length=="number"?f.append.apply(f,t):Ht(f,t),f},default:()=>document.createDocumentFragment()}),circle:fe,ellipse:fe,g:fe,glyph:fe,image:fe,line:fe,rect:fe,use:fe,path:fe,pattern:fe,polygon:fe,polyline:fe,svg:fe,tspan:fe,text:fe,default:Pi}),W=Ii;function Tr(e,t,r){let f;typeof r!="string"&&r.input!==void 0&&r.index!==void 0&&(f=r,r=f.input.slice(r.index+r[0].length+(r.consumed||0)));let c=e.exec(r);if(!c)return;let p=t(c);return f&&(f.consumed=(f.consumed||0)+c.index+c[0].length+(c.consumed||0)),p}var mc=ge(Tr,!0);function Oi(e,t,r){throw r.input!==void 0&&r.index!==void 0&&(r=r.input),new Error('Cannot parse string "'+(r.length>128?r.length.slice(0,128)+"â€¦":r)+'"')}function Gi(e,t,r){let f=-1;for(;++f<r.length;)t=r[f]!==void 0&&e[f]?e[f](t,r):t;return e.done?e.done(t,r):e.close?e.close(t,r):t}function Ri(e,t,r,f){let c=Tr(e,p=>Gi(t,r,p),f);return c===void 0?t.catch?t.catch(r,f):Oi(e,t,f):c}var ra=ge(Ri,!0);var na=Symbol("internals");function _r(e,t,r){return t[na]=t.attachInternals&&!t.getAttribute("is")?t.attachInternals():{shadowRoot:r}}function z(e){return e[na]}var aa=Object.defineProperties;var Br={},qi={name:{set:function(e){return this.setAttribute("name",e)},get:function(){return this.getAttribute("name")||""}},form:{get:function(){return z(this).form}},labels:{get:function(){return z(this).labels}},validity:{get:function(){return z(this).validity}},validationMessage:{get:function(){return z(this).validationMessage}},willValidate:{get:function(){return z(this).willValidate}},checkValidity:{value:function(){return z(this).checkValidity()}},reportValidity:{value:function(){return z(this).reportValidity()}}},Dr=!1,$i=ra(/^\s*<?([a-z][\w]*-[\w-]+)>?\s*$|^\s*<?([a-z][\w]*)\s+is[=\s]*["']?([a-z][\w]*-[\w-]+)["']?>?\s*$/,{1:(e,t)=>({name:t[1]}),2:(e,t)=>({name:t[3],tag:t[2]}),catch:function(e,t){throw new SyntaxError(`dom element() â€“ name must be of the form 'element-name' or 'tag is="element-name"' (`+t+")")}},null),ia={once:!0};function Ui(e){return e.sheet?Promise.resolve({target:e}):new Promise((t,r)=>{e.addEventListener("load",t,ia),e.addEventListener("error",r,ia)})}function zi(e){e.stop()}function Hi(e){if(Br[e])return Br[e];let t=document.createElement(e).constructor;if(t===HTMLUnknownElement)throw new Error("Cannot define customised built-in - constructor for <"+e+"> is HTMLUnknownElement");return Br[e]=t}function Wi(e,t){if(e.hasOwnProperty(t)){let r=e[t];delete e[t],e[t]=r}return e}function sa(e,t){let r=e.attachShadow({mode:t.mode||"closed",delegatesFocus:t.focusable||!1});if(t.stylesheet){let f=W("link",{rel:"stylesheet",href:t.stylesheet});r.append(f)}return r}function Ki(e,t){return typeof t=="string"?t[0]==="#"?e.appendChild(document.getElementById(t.slice(1)).content.clone(!0)):e.innerHTML=t:e.appendChild(t.content.clone(!0)),e}function Xi(e){let t=e.isUpgraded;return e.isUpgraded=!0,!t}function oa(e,t){return Array.from(e.querySelectorAll('[is="'+t+'"]')).filter(Xi)}var ji=j((e,t)=>typeof t,{object:(e,t)=>t,function:(e,t)=>({value:t}),default:(e,t)=>{throw new TypeError("element() does not accept property descriptor of type "+typeof t)}});function Lr(e,t={},r={},f=""){let{name:c,tag:p}=$i(e),l=typeof p=="string"?Hi(p):HTMLElement,i=[],s={},u,d;for(u in r)d=ji(u,r[u]),d.attribute&&i.push(u),(d.set||d.get||"value"in d)&&(s[u]=d),r[u]=d;function n(){let a=Reflect.construct(l,arguments,n),o=t.mode||typeof t.shadow=="string"?sa(a,t):void 0;t.shadow&&Ki(o,t.shadow);let h=_r(n,a,o);return p&&(Dr=!0),t.construct&&t.construct.call(a,o,h),Object.keys(s).reduce(Wi,a),a}if(n.prototype=Object.create(l.prototype,s),r.value&&(n.formAssociated=!0,aa(n.prototype,qi),(t.enable||t.disable)&&(n.prototype.formDisabledCallback=function(a){let o=z(this);return a?t.disable&&t.disable.call(this,o.shadowRoot,o):t.enable&&t.enable.call(this,o.shadowRoot,o)}),t.reset&&(n.prototype.formResetCallback=function(){let a=z(this);return t.reset.call(this,a.shadowRoot,a)}),t.restore&&(n.prototype.formStateRestoreCallback=function(){let a=z(this);return t.restore.call(this,a.shadowRoot,a)})),i.length&&(n.observedAttributes=i,n.prototype.attributeChangedCallback=function(a,o,h){return r[a].attribute.call(this,h)}),t.connect&&(n.prototype.connectedCallback=function(){let a=z(this),o=a.shadowRoot;if(a.stopable=t.connect.call(this,o,a),!o)return;let h=o.querySelectorAll('link[rel="stylesheet"]');if(h.length){let m=W("style","*:not(slot), slot:not([name]) { display: none !important; }");o.prepend(m);let v;a.loadPromise?v=a.loadPromise.then(()=>new Promise(requestAnimationFrame)):v=a.loadPromise=Promise.all(Array.from(h,Ui)),v.finally(()=>{m.remove(),t.load&&t.load.call(this,o,a)})}else t.load&&t.load.call(this,o,a)}),n.prototype.disconnectedCallback=function(){let a=z(this);a.stopable&&(a.stopable.stop?a.stopable.stop():a.stopable.forEach(zi)),t.disconnect&&t.disconnect.call(this,a.shadowRoot,a)},window.console&&window.console.log("%c<"+(p?p+" is="+c:c)+">%c "+f,"color:#3a8ab0;font-weight:600;","color:#888888;font-weight:400;"),window.customElements.define(c,n,p&&{extends:p}),p&&!Dr){let a=document.createElement("div");if(a.style.position="fixed",a.style.left="-1000px",a.style.top="-1000px",a.innerHTML="<"+p+' is="'+c+'"></'+p+">",document.body.append(a),a.remove(),Dr)n.polyfillByRoot=ne;else{let o=function(m){let v={};Object.keys(s).forEach(g=>{m[g]!==void 0&&(v[g]=m[g])}),aa(m,s);let w=t.mode||t.shadow?sa(m,t):void 0,N=_r(n,m,w);t.construct&&t.construct.call(m,w,N),Object.assign(m,v);let B=-1,x;for(;x=i[++B];){let g=m.attributes[x];g&&r[x].attribute.call(m,g.value)}t.connect&&t.connect.call(m,w,N)},h=function(m){oa(m,c).forEach(o),new MutationObserver(()=>oa(m,c).forEach(o)).observe(m,{childList:!0,subtree:!0})};n.polyfillByRoot=h,h(document)}}else n.polyfillByRoot=ne;return n}var Wt=e=>typeof e;var Qi=Object.defineProperties,fa=j(Wt,{function:e=>e(),object:e=>e.stop()}),$e=class extends me{#e;stop(){if(this.status==="done")return this;this.status="done";let t=this.#e;return this.#e=void 0,t&&t.forEach(fa),this}done(t){return this.status==="done"?(fa(listener),this):((this.#e||(this.#e=[])).push(t),this)}};Qi($e.prototype,{status:{writable:!0}});function Zi(e){throw new TypeError("Stream cannot be created .from() "+typeof e)}function ce(e,t){if(t===void 0)return;let r=-1;for(;e[++r];)e[r].push(t);return e}function Ji(e){$e.prototype.stop.apply(e);let t=-1,r;for(;r=e[++t];)e[t]=void 0,r.stop&&(Gr(r,e),r[-1]||r.stop());return e}function Gr(e,t){let r=0;for(;e[--r]&&e[r]!==t;);for(;e[r--];)e[r+1]=e[r]}function ca(e,t){let r=-1;for(;e[++r]&&e[r]!==t;);for(;e[r++];)e[r-1]=e[r]}function Yi(e,t){Gr(t,e),ca(e,t)}var ct=class extends $e{stop(){if(this.status==="done")return this;let t;for(;t=this[-1];){let r=-1;for(;this[r--];)this[r+1]=this[r];ca(t,this),t.stop&&!t[0]&&t.stop(t)}return super.stop()}},Kt=class extends ct{constructor(t){super(),this.push=t}},Xt=class extends ct{constructor(t,r){super(),this.fn=t,this.value=r,this.i=0}push(t){let r=this.fn;this.value=r(this.value,t,this.i++,this)}},ae=class extends ct{start(){if(this.status)return this;let t=0,r;e:for(;r=this[--t];){let f=-1;for(;r[++f];)if(r[f]===this)continue e;r[f]=this,f===0&&r.start&&r.start()}return this}stop(){if(this.status==="done")return this;super.stop();let t=-1,r;for(;r=this[++t];)this[t]=void 0,r.stop&&(Gr(r,this),r[-1]||r.stop());return this}pipe(t){if(t.stop){let f=0;for(;t[--f]&&t[f]!==this;);t[f]=this}if(t.start&&!(t[0]||t.status==="running"))return t;let r=-1;for(;this[++r]&&this[r]!==t;);return this[r]=t,r||this.start(),t}each(t){return this.pipe(new Kt(t))}buffer(...t){return this.pipe(new Ye(t))}filter(t){return this.pipe(new Ar(t))}flatMap(t){return this.pipe(new Mr(t))}map(t){return this.pipe(new Qt(t))}reduce(t,r){return this.pipe(new Xt(t,r)).value}scan(t,r){return this.pipe(new Pr(t,r))}slice(t,r){return this.pipe(new Ir(t,r))}split(t){return this.pipe(new Or(t))}[Symbol.asyncIterator]=async function*(){let t=[],r=c=>t.push(c);function f(c,p){r=c}for(this.each(c=>r(c)).done(()=>r=ne);r!==ne;)yield t.length?t.shift():await new Promise(f)};static from=j(Wt,{function:t=>new Qt(t),object:t=>typeof t.pipe=="function"?t:typeof t.then=="function"?new Fr(t):typeof t.length=="number"?new Ye(Array.from(t)):Zi(t)});static of(...t){return t.length<2?new jt(t[0]):new Ye(t)}static buffer(t){return new Ye(t)}static value(t){return new jt(t)}static merge(...t){return new Sr(t)}static push=ce;static stop=Ji;static unpipe=Yi;static each(t){return new Kt(t)}static reduce(t,r){return new Xt(t,r)}},Fr=class extends ae{constructor(t){super(),this.promise=t}start(){return this.promise.then(t=>ce(this,t)).finally(()=>this.stop()),this}},jt=class extends ae{constructor(t){super(),this.value=t}start(){return this.value!==void 0&&(ce(this,this.value),this.status==="done")?this:super.start()}push(t){return this.value=t,ce(this,t)}},Ye=class extends ae{constructor(t){super(),this.values=t||[]}start(){let t=this.values;if(!t)return super.start();let r=-1;for(;r++<t.length;)if(ce(this,t[r]),this.status==="done")return this;return this.values=void 0,super.start()}push(t){return this.value=t,this.values?this.values.push(this.value):ce(this,this.value)}},Ar=class extends ae{constructor(t){super(),this.fn=t}push(t){let r=this.fn;return r(t)&&ce(this,t)}},Mr=class extends ae{constructor(t){super(),this.fn=t}push(t){let r=this.fn,f=r(t);if(f!==void 0)if(isIterable(f))for(let c of f)ce(this,c);else f.pipe?(console.warn("FlatMapping pipeables is dodgy. Map to arrays for the moment please."),this.done(f.each(c=>ce(this,c)))):f.then&&f.then(c=>ce(this,c))}},Qt=class extends ae{constructor(t){super(),this.fn=t}push(t){let r=this.fn,f=r(t);return f!==void 0&&ce(this,f)}},Sr=class extends ae{constructor(t){super(),this.inputs=t}push(t){return ce(this,t)}pipe(t){let r=-1,f;for(;f=this.inputs[++r];)ae.from(f).pipe(this);return ae.prototype.pipe.call(this,t)}},Pr=class extends ae{constructor(t,r){super(),this.fn=t,this.value=r}push(t){let r=this.fn;this.value=r(this.value,t),ce(this,this.value)}},Ir=class extends ae{constructor(t,r=1/0){super(),this.index=-t,this.indexEnd=r-t}push(t){++this.index>0&&ce(this,t),this.index===this.indexEnd&&this.stop()}},Or=class extends ae{constructor(t){super(),this.chunk=[],typeof t=="number"?this.n=t:this.fn=t}fn(){return this.chunk.length===this.n}push(t){let r=this.chunk;this.fn(t)?(ce(this,r),this.chunk=[]):r.push(t)}};var zc={fullscreenchange:Je(()=>"fullscreenElement"in document?"fullscreenchange":"webkitFullscreenElement"in document?"webkitfullscreenchange":"mozFullScreenElement"in document?"mozfullscreenchange":"msFullscreenElement"in document?"MSFullscreenChange":"fullscreenchange")},Vi=0;window.addEventListener("click",e=>Vi=e.timeStamp);function Rr(e){return function(){return arguments[e]}}function qr(e){return e}function Ue(){}function xe(){return this}var la=Object.create,es=Object.freeze,ua=es(la(la(Object.prototype,{at:{value:Ue},shift:{value:Ue},push:{value:Ue},forEach:{value:Ue},join:{value:function(){return""}},every:{value:function(){return!0}},filter:{value:xe},find:{value:Ue},findIndex:{value:function(){return-1}},flat:{value:xe},flatMap:{value:xe},includes:{value:function(){return!1}},indexOf:{value:function(){return-1}},map:{value:xe},reduce:{value:Rr(1)},sort:{value:xe},each:{value:xe},pipe:{value:qr},start:{value:xe},stop:{value:xe},done:{value:xe},valueOf:{value:function(){return null}}}),{length:{value:0}}));function $r(e,t){return(t%e+e)%e}var pa=e=>$r(12,e);var ts=/^([A-G][â™­â™¯#b]?)(-?\d)$/,rs=/^[A-G][â™­â™¯#b]?/,ns=/-?\d$/,as=/[Hh]z$/,Ve={C:0,"Câ™¯":1,"C#":1,"Dâ™­":1,Db:1,D:2,"Dâ™¯":3,"D#":3,"Eâ™­":3,Eb:3,E:4,F:5,"Fâ™¯":6,"F#":6,"Gâ™­":6,Gb:6,G:7,"Gâ™¯":8,"G#":8,"Aâ™­":8,Ab:8,A:9,"Aâ™¯":10,"A#":10,"Bâ™­":10,Bb:10,B:11},ha={27:"High Q",28:"Slap",29:"Scratch Push",30:"Scratch Pull",31:"Sticks",32:"Square Click",33:"Metronome Click",34:"Metronome Bell",35:"Bass Drum 2",36:"Bass Drum 1",37:"Side Stick",38:"Snare Drum 1",39:"Hand Clap",40:"Snare Drum 2",41:"Low Tom 2",42:"Closed Hi-hat",43:"Low Tom 1",44:"Pedal Hi-hat",45:"Mid Tom 2",46:"Open Hi-hat",47:"Mid Tom 1",48:"High Tom 2",49:"Crash Cymbal 1",50:"High Tom 1",51:"Ride Cymbal 1",52:"Chinese Cymbal",53:"Ride Bell",54:"Tambourine",55:"Splash Cymbal",56:"Cowbell",57:"Crash Cymbal 2",58:"Vibra Slap",59:"Ride Cymbal 2",60:"High Bongo",61:"Low Bongo",62:"Mute High Conga",63:"Open High Conga",64:"Low Conga",65:"High Timbale",66:"Low Timbale",67:"High Agogo",68:"Low Agogo",69:"Cabasa",70:"Maracas",71:"Short Whistle",72:"Long Whistle",73:"Short Guiro",74:"Long Guiro",75:"Claves",76:"High Wood Block",77:"Low Wood Block",78:"Mute Cuica",79:"Open Cuica",80:"Mute Triangle",81:"Open Triangle",82:"Shaker",83:"Jingle Bell",84:"Belltree",85:"Castanets",86:"Mute Surdo",87:"Open Surdo"};function da(e){return e.toLowerCase().replace(/\s+/g,"-")}for(let e in ha)Ve[da(ha[e])]=parseInt(e,10);var is=69;function ss(e,t=440){var r=is+12*Math.log(e/t)/Math.log(2);return Math.fround(r)}function te(e){if(typeof e=="number")return e;if(as.test(e))return ss(parseFloat(e));let t=ts.exec(e);return t?(parseInt(t[2],10)+1)*12+Ve[t[1]]:Ve[da(e)]}function ze(e){return typeof e=="number"?pa(e):Ve[rs.exec(e)[0]]}var Ur=["C","Câ™¯","D","Eâ™­","E","F","Fâ™¯","G","Gâ™¯","A","Bâ™­","B"];function ma(e){return lt(e)+Zt(e)}function lt(e){return Ur[pa(e)]}function Zt(e){return typeof e=="number"?Math.floor(e/12)-1:Number(Ve[(ns.exec(name)||ua)[0]])}function os(e,t){return t[e]}var Le=ge(os,!0);function zr(e,t){return t+e}function ut(e,t){return(t%e+e)%e}function we(e){return ut(12,e)}function et(e,t){return e>t?1:e<t?-1:0}var Hr=[];function ht(e){Hr.length=0;for(var t=e.length,r,f;t--;)r=e[t],f!==r[0]&&(f=r[0],Hr.push(f));return Hr.sort(et)}function Wr(e){return function(){return arguments[e]}}function Ee(){return this}var ga=Object.create,fs=Object.freeze,pt=fs(ga(ga(Object.prototype,{at:{value:ne},shift:{value:ne},push:{value:ne},forEach:{value:ne},join:{value:function(){return""}},every:{value:function(){return!0}},filter:{value:Ee},find:{value:ne},findIndex:{value:function(){return-1}},flat:{value:Ee},flatMap:{value:Ee},includes:{value:function(){return!1}},indexOf:{value:function(){return-1}},map:{value:Ee},reduce:{value:Wr(1)},sort:{value:Ee},each:{value:Ee},pipe:{value:me},start:{value:Ee},stop:{value:Ee},done:{value:Ee},valueOf:{value:function(){return null}}}),{length:{value:0}}));function cs(e,t,r){return r.indexOf(e)===t}function Kr(e,t){return e.map(r=>we(r+t)).filter(cs).sort(et)}function va(e,t){return Kr(e,t*7)}var Xr=[{name:"C",symbol:"Câˆ†",spellings:[0,1,0,-1,0,0,1,0,-1,0,-1,0]},{name:"Dâ™­",symbol:"Dâ™­âˆ†",spellings:[0,-1,0,-1,-1,0,-1,0,-1,0,-1,-1]},{name:"D",symbol:"Dâˆ†",spellings:[0,1,0,1,0,0,1,0,1,0,-1,0]},{name:"Eâ™­",symbol:"Eâ™­âˆ†",spellings:[0,-1,0,-1,0,0,-1,0,-1,0,-1,-1]},{name:"E",symbol:"Eâˆ†",spellings:[0,1,0,1,0,1,1,0,1,0,1,0]},{name:"F",symbol:"Fâˆ†",spellings:[0,-1,0,-1,0,0,1,0,-1,0,-1,0]},{name:"Fâ™¯",symbol:"Fâ™¯âˆ†",spellings:[1,1,0,1,0,1,1,0,1,0,1,0]},{name:"G",symbol:"Gâˆ†",spellings:[0,1,0,-1,0,0,1,0,1,0,-1,0]},{name:"Aâ™­",symbol:"Aâ™­âˆ†",spellings:[0,-1,0,-1,-1,0,-1,0,-1,0,-1,-1]},{name:"A",symbol:"Aâˆ†",spellings:[0,1,0,1,0,0,1,0,1,0,1,0]},{name:"Bâ™­",symbol:"Bâ™­âˆ†",spellings:[0,-1,0,-1,0,0,-1,0,-1,0,-1,0]},{name:"B",symbol:"Bâˆ†",spellings:[1,1,0,1,0,1,1,0,1,0,1,0]}],_e=[0,2,4,5,7,9,11],ba={"Fâ™­":-8,"Câ™­":-7,"Gâ™­":-6,"Dâ™­":-5,"Aâ™­":-4,"Eâ™­":-3,"Bâ™­":-2,F:-1,C:0,G:1,D:2,A:3,E:4,B:5,"Fâ™¯":6,"Câ™¯":7,"Gâ™¯":8,"Dâ™¯":9,"Aâ™¯":10,"Eâ™¯":11,"Bâ™¯":12},ls={bb:"ð„«",b:"â™­","":"","#":"â™¯","##":"ð„ª"};function us(e){return e.replace(/[#b]{1,2}$/,t=>ls[t])}function ya(e){return typeof e=="number"?e:ba[us(e)]}function xa(e){return typeof e=="number"?Kr(_e,e):va(_e,ba[e])}var jr={"âˆ†":[0,2,4,7,9,11],"âˆ†7":[0,2,4,7,9,11],"-":[0,3,7],"-7":[0,2,3,5,7,9,10],"susâ™­9":[0,1,5,7,10],"7susâ™­9":[0,1,5,7,10],"âˆ†â™¯11":[0,2,4,6,7,9,11],"âˆ†(â™¯11)":[0,2,4,6,7,9,11],7:[0,4,7,10],13:[0,4,7,9,10],sus:[0,2,5,7,10],"7sus":[0,2,5,7,10],"-â™­6":[0,2,3,5,7,8],Ã¸:[0,3,6,10],"7â™­9â™­13":[0,1,4,5,7,8,10],"-âˆ†":[0,2,3,5,7,9,11],"13susâ™­9":[0,1,5,7,9,10],"âˆ†+":[0,2,4,6,8,9,11],"âˆ†â™¯5":[0,2,4,6,8,9,11],"7â™¯11":[0,2,4,6,7,9,10],"7â™­13":[0,2,4,7,8,10],"Ã¸(9)":[0,2,3,6,10],"7alt":[0,1,3,4,6,8,10],"âˆ†â™­6":[0,2,4,7,8,11],"7â™­9":[0,1,3,4,6,7,9,10],"7â™¯9":[0,1,3,4,6,7,9,10],Âº:[0,2,3,5,6,8,9,11],"7+":[0,2,4,6,8,10]};function hs(e){return e.replace(/(maj)|(min)|(dim)/,(t,r,f,c)=>r?"âˆ†":f?"-":c?"Âº":"")}function wa(e,t,r){let f=ze(e),c=hs(t);return jr[c]?f?jr[c].map(p=>we(p+f)).sort(et):jr[c]:[]}var Qr=j(Le(1),{chord:e=>wa(e[2],e[3]),note:e=>[ze(e[2])],default:e=>[]});var Ea=j(Le(1),{chord:e=>e[3],lyric:e=>e[3],note:e=>e[4],sequence:e=>e[4],default:e=>0});var Zr=[];function dt(e,t){Zr.length=0;let r,f=-1;for(;(r=e[++f])&&!(r[0]>t);)(r[0]===t||r[0]+Ea(r)>t)&&Zr.push(r);return Zr}var ps=[1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],ka=[10,5,8,10,6,10,8,10,7,10,8,4],ds=ka.reduce(zr),ms=ka.map(e=>e/ds).map(Na),gs=[.1,.04,.1,.04,.1,.1,.04,.1,.04,.1,.04,.1].map(Na);function Na(e,t,r){return r.slice(12-t).concat(r.slice(0,12-t))}function Ca(e,t){for(var r=0,f=0;f<e.length;++f)r+=Math.log(t[e[f]]);return r}function vs(e,t,r,f){var c=[],p=[],l=[],i=[],s=0,u=-1,d,n,a;for(p[s]=c;++u<12;)c[u]=Math.log(t[u])+Ca(e[0],f[u]),l[u]=[u];for(;++s<e.length;){for(c=[],n=[],p[s]=c,d=-1;++d<12;){for(i.length=0,i[0]=-1/0,u=-1;++u<12;)a=p[s-1][u]+Math.log(r[u][d])+Ca(e[s],f[d]),a>i[0]&&(i[0]=a,i[1]=u);c[d]=i[0],n[d]=l[i[1]].concat(d)}l=n}for(i.length=0,i[0]=-1/0,u=-1;++u<12;)a=p[e.length-1][u],a>i[0]&&(i[0]=a,i[1]=u);return l[i[1]]}function bs(e,t){return e.push.apply(e,t),e}function Jr(e){let t=ht(e),r=t.length,f=[],c=-1,p,l;for(;++c<r;){p=t[c],l=dt(e,p);var i=l.map(Qr);if(i.find(s=>s.find(Number.isNaN)!==void 0)!==void 0)throw console.log(l),new Error("toNotes has returned NaN for beatEvents");f.push(l.map(Qr).reduce(bs,[]))}return r?vs(f,ps,ms,gs):[]}function ys(e,t,r){let f=e(t),c=e(r);return c===f?0:f>c?1:-1}var xs=ge(ys,!0);function Ta(e){let t=e.filter(c=>/^note|chord$/.test(c[1])),r=ht(t),f=Jr(t);return r.map((c,p)=>[c,f[p]])}function _a(e,t){let r=e.length;for(;r--;)if(e[r][0]<=t)return e[r][1];return e[0][1]}var ie={};Di(ie,{acciDoubleFlat:()=>nn,acciDoubleSharp:()=>an,acciFlat:()=>Jt,acciNatural:()=>Yt,acciParensLeft:()=>Ms,acciParensRight:()=>Ss,acciSharp:()=>Vt,altoClef:()=>en,bassClef:()=>gt,chordAugmented:()=>bo,chordBassSlash:()=>fn,chordBracketLeft:()=>Co,chordBracketRight:()=>ko,chordDiminished:()=>mo,chordDiminishedSmall:()=>go,chordGlyphs:()=>No,chordHalfDiminished:()=>vo,chordMajorSeventh:()=>yo,chordMinor:()=>xo,chordParensLeftTall:()=>wo,chordParensRightTall:()=>Eo,drumClef:()=>tn,graceNoteStemDown:()=>Qs,graceNoteStemUp:()=>js,head1:()=>Ps,head2:()=>Is,head4:()=>Os,headBracketLeft:()=>sn,headBracketRight:()=>on,headCircle:()=>zs,headCircleX:()=>Hs,headDiamond:()=>Rs,headDiamondWide:()=>qs,headPlus:()=>Us,headSlashHorizontalEnds:()=>Xs,headSlashVerticalEnds:()=>Ks,headSlashed2:()=>Gs,headTriangleUp:()=>Ws,headX:()=>$s,percussionClef:()=>rn,rest0125:()=>ro,rest01875:()=>no,rest025:()=>ao,rest0375:()=>io,rest05:()=>so,rest075:()=>oo,rest1:()=>fo,rest15:()=>co,rest2:()=>lo,rest3:()=>uo,rest4:()=>ho,rest6:()=>po,tailDown0125:()=>to,tailDown025:()=>Vs,tailDown05:()=>Js,tailUp0125:()=>eo,tailUp025:()=>Ys,tailUp05:()=>Zs,timeSig0:()=>ws,timeSig1:()=>Es,timeSig2:()=>Cs,timeSig3:()=>ks,timeSig4:()=>Ns,timeSig5:()=>Ts,timeSig6:()=>_s,timeSig7:()=>Bs,timeSig8:()=>Ds,timeSig9:()=>Ls,timeSigCommon:()=>Fs,timeSigCutCommon:()=>As,trebleClef:()=>mt,trebleDownClef:()=>Yr,trebleUpClef:()=>Vr});var mt="&#xE050;",Yr="&#xE052;",Vr="&#xE053;",en="&#xE05C;",gt="&#xE062;",tn="&#xE069;",rn="&#xE069;",ws="&#xE080;",Es="&#xE081;",Cs="&#xE082;",ks="&#xE083;",Ns="&#xE084;",Ts="&#xE085;",_s="&#xE086;",Bs="&#xE087;",Ds="&#xE088;",Ls="&#xE089;",Fs="&#xE08A;",As="&#xE08B;",nn="&#xE264;",Jt="&#xE260;",Yt="&#xE261;",Vt="&#xE262;",an="&#xE263;",Ms="&#xE26A;",Ss="&#xE26B;",Ps="&#xE0A4;",Is="&#xE0A3;",Os="&#xE0A2;",sn="&#xE0F5;",on="&#xE0F6;",Gs="&#xE0D0;",Rs="&#xE0DB;",qs="&#xE0DC;",$s="&#xE0A9;",Us="&#xE0AF;",zs="&#xE0E8;",Hs="&#xE0B3;",Ws="&#xE0BE;",Ks="&#xE100;",Xs="&#xE101;",js="&#xE560;",Qs="&#xE561;",Zs="&#xE240;",Js="&#xE241;",Ys="&#xE242;",Vs="&#xE243;",eo="&#xE244;",to="&#xE245;",ro="&#xE4E8;",no="&#xE4E8;&#xE1E7;",ao="&#xE4E7;",io="&#xE4E7;&#xE1E7;",so="&#xE4E6;",oo="&#xE4E6;&#xE1E7;",fo="&#xE4E5;",co="&#xE4E5;&#x200A;&#xE1E7;",lo="&#xE4E4;",uo="&#xE4E4;&#x200A;&#xE1E7;",ho="&#xE4E3;",po="&#xE4E3;&#x200A;&#xE1E7;",mo="&#xE870;",go="&#xF4D8;",vo="&#xE871;",bo="&#xE872;",yo="&#xE873;",xo="&#xE874;",wo="&#xE875;",Eo="&#xE876;",Co="(",ko=")",fn="&#xE87B;",No={"âˆ†â™¯11":"î¡³îµ¢11","âˆ†":"î¡³",7:"7","-7":"î¡´7","-â™­6":"î¡´îµ 6","7susâ™­9":"7susîµ¢",Ã¸:"î¡±","7â™¯11":"7îµ¢11","-âˆ†":"î¡´î¡³","âˆ†â™­6":"î¡³îµ 6","-â™­9":"î¡´îµ 9",Ã¸7:"î¡±7","âˆ†â™¯5":"î¡³îµ¢5","7alt":"7alt","Â°":"î¡°",dim:"î¡°","7â™­9":"7îµ ","+7":"î¡²7"};var To={"-2":"ð„«","-1":"â™­",0:"",1:"â™¯",2:"ð„ª"},_o=/^[A-G][b#â™­â™¯ð„«ð„ª]?(-?\d)?$/;function vt(e,t,r=0){let f=Xr[we(e+r)],c,p,l;if(typeof t[2]=="string"){let[u,d]=_o.exec(t[2])||[t[2]];d?(c=te(t[2])+r,p=f.spellings[we(c)],l=Zt(c-p)):(c=ze(t[2])+r,p=f.spellings[we(c)],l="")}else t[1]==="chord"?(c=ze(t[2])+r,p=f.spellings[we(c)],l=""):(c=t[2]+r,p=f.spellings[we(c)],l=Zt(c-p));let i=Ur[we(c-p)],s=To[p];return i+s+l}var bt=/b|â™­/,yt=/#|â™¯/;var cn=/b|â™­|#|â™¯/g;var K=class{constructor(){}clef="";pitched=!0;rows=pt;getNoteHTML(t,r,f){let c=f>=4||Math.fround(f)===Math.fround(2.666666667)?"head4":f>=2||Math.fround(f)===Math.fround(1.333333333)?"head2":"head1";return`<span class="head" data-glyph="${c}">${ie[c]}</span>`}get minPitch(){return this.rows[0]}get maxPitch(){return this.rows[27]}get minLinePitch(){return this.rows[9]}get midLinePitch(){return this.rows[13]}get maxLinePitch(){return this.rows[17]}movePitch(t,r){let f=te(this.minPitch),c=te(this.maxPitch),p=te(t)+r;return p>=f&&p<=c?p:void 0}getPart(t){return this.getRowDiff(this.midLinePitch,t)<0?{stemDirection:"up",tieDirection:"up"}:{stemDirection:"down",tieDirection:"down"}}getRowDiff(t,r){let f=t.replace(cn,""),c=r.replace(cn,""),p=this.rows.indexOf(f),l=this.rows.indexOf(c);if(p===-1)throw new Error('Pitch "'+t+'" is not supported by stave '+this.constructor.name);if(l===-1)throw new Error('Pitch "'+r+'" is not supported by stave '+this.constructor.name);return l-p}getSpelling(){return vt.apply(this,arguments)}yRatioToPitch(t){let r=floor(t*this.pitches.length);return r<0?this.pitches[0]:r>this.pitches.length-1?this.pitches[this.pitches.length-1]:this.pitches[r]}};var He=class extends K{type="drum";clef=tn;pitched=!1;rows=["","","","","","","","pedal-hi-hat","bass-drum-2","bass-drum-1","low-tom-2","low-tom-1","mid-tom-2","snare-drum-1","mid-tom-1","high-tom-1","closed-hi-hat","ride-cymbal-1","crash-cymbal-1","crash-cymbal-2","splash-cymbal","","","",""];#e={31:"headX",37:"headCircle",39:"headX",42:"headX",44:"headX",46:"headCircleX",49:"headCircleX",51:"headX",52:"headCircleX",53:"headDiamond",54:"headX",55:"headX",56:"headTriangleUp",57:"headCircleX",58:"headTriangleUp",59:"headX"};#t={27:0,28:0,29:0,30:0,31:13,32:0,33:0,34:0,35:10,36:9,37:14,38:14,39:13,40:14,41:11,42:17,43:12,44:8,45:13,46:17,47:13,48:15,49:19,50:16,51:18,52:21,53:18,54:13,55:21,56:16,57:20,58:0,59:19,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0};get maxPitch(){return this.rows[25]}get minLinePitch(){return this.rows[8]}get midLinePitch(){return this.rows[12]}get maxLinePitch(){return this.rows[16]}getNoteHTML(t,r,f){let c=te(t),p=this.#e[c],l=ie[p],i=p?`<span class="head" data-glyph="${p}">${l}</span>`:super.getNoteHTML(t,r,f);return r<.02?sn+i+on:i}getPart(t){return[35,36,37,38,40,41,43,44,45,47,50].includes(te(t))?{part:"drums",stemDirection:"down",tieDirection:"down",centerRow:"stave-lower"}:{stemDirection:"up",tieDirection:"up",centerRow:"stave-upper"}}getRowDiff(t,r){let f=te(t),c=te(r),p=this.#t[f],l=this.#t[c];if(p===void 0)throw new Error('Pitch "'+t+'" is not supported by stave '+this.constructor.name);if(l===void 0)throw new Error('Pitch "'+r+'" is not supported by stave '+this.constructor.name);return l-p}getSpelling(t,r,f){return r[1]==="note"?ma(te(r[2])):vt(t,r,f)}yRatioToPitch(t){let r=floor(t*this.rows.length),f=r<4?4:r>17?17:r;return this.pitches[f]}};var xt=class extends He{type="percussion";clef=rn;rows=["","","","","","","","","note","","","","","","","",""];get maxPitch(){return this.rows[17]}get minLinePitch(){return this.rows[8]}get midLinePitch(){return this.rows[8]}get maxLinePitch(){return this.rows[8]}getPart(t){return[35,36,37,38,40,41,43,44,45,47,50].includes(te(t))?{stemDirection:"down",tieDirection:"down"}:{stemDirection:"up",tieDirection:"up"}}getRowDiff(t,r){return 0}};var wt=class extends K{type="piano";rows=["E1","F1","G1","A1","B1","C2","D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6","F6","G6","A6"];getClefHTML(){return`<span class="treble-clef clef">${mt}</span><span class="bass-clef clef">${gt}</span>`}getTimeSigHTML(t,r,f){return`<span class="timesig" data-event="${f}" data-part="upper">
            <sup>${ie["timeSig"+t]}</sup>
            <sub>${ie["timeSig"+r]}</sub>
        </span>
        <span class="timesig" data-event="${f}" data-part="lower">
            <sup>${ie["timeSig"+t]}</sup>
            <sub>${ie["timeSig"+r]}</sub>
        </span>`}getPart(t){return/[012]$|[AC-G][b#â™­â™¯ð„«ð„ª]*3$/.test(t)?{part:"lower",centerPitch:"D3",centerRow:"stave-lower"}:{centerPitch:"B4",centerRow:"stave-upper"}}};var ln=class extends K{type="treble-up";clef=Vr;rows=["C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6","F6","G6","A6","B6","C7","D7","E7","F7","G7","A7"]},un=class extends K{type="treble";clef=mt;rows=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6","F6","G6","A6"]},hn=class extends K{type="treble-down";clef=Yr;rows=["C2","D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5"]},pn=class extends K{type="alto";clef=en;rows=["D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5"]},dn=class extends K{type="bass";clef=gt;rows=["E1","F1","G1","A1","B1","C2","D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5"]};K.treble=un;K["treble-up"]=ln;K["treble-down"]=hn;K.alto=pn;K.bass=dn;K.piano=wt;K.drum=He;K.percussion=xt;K.create=e=>new K[e];var er=K;function tr(e,t,r){let f=e.length,c=e[f-1],p=ut(c,r),l=-1;for(;p>e[++l];);let i=p-(l===0?e[f-2]-c:e[l-1]),s=p-(l===f-1?e[0]+c:e[l]);return r-t*(-s<i?s:i)}var Bo={"2,2":[2],"3,2":[2,4],"2,1":[1],"3,1":[1,2],"4,1":[2],"6,0.5":[1.5],"12,0.5":[1.5,3,4.5]};function mn(e){return Bo[e.slice(2).join(",")]||pt}function gn(e,t,r){let f=-1;for(;e[++f]&&e[f]<=t;);return r>e[f]?e[f]:void 0}var Ce=Object.assign,{abs:Ba,ceil:ih,floor:sh}=Math,Da=["Fâ™¯","Câ™¯","Gâ™¯","Dâ™¯","Aâ™¯","Eâ™¯","Bâ™¯","Bâ™­","Eâ™­","Aâ™­","Dâ™­","Gâ™­","Câ™­","Fâ™­"],La=[0,2/24,3/24,4/24,6/24,8/24,9/24,10/24,12/24,14/24,15/24,16/24,18/24,20/24,21/24,22/24,1],Et=[.125,.25,.375,.5,.75,.875,1,1.5,1.75,2,3,4,6,8];function Do(e,t){let r=Da.indexOf(e.pitch),f=Da.indexOf(t.pitch);return r>f?1:r<f?-1:0}function Fa(e,t){return t&&t.stemDirection||(te(e)<te(t.pitch)?"down":"up")}function Lo(e){return e[1]==="lyric"?e[3]:e[4]}function Aa(e,t,r,f){let c=e[0].part;if(r.length===1){let x=r[0];if(x>=f)throw new Error("Last beam index ("+r[0]+") cant be greater than n ("+f+")");let g=e[x];return g.tie==="begin"||g.tie==="middle"?(e.splice(x,0,Ce({},g,{type:"tie",beat:g.beat,updown:g.stemDirection==="up"?"down":"up",event:g.event})),1):0}let p=e[r[0]]&&e[r[0]].stemDirection?e[r[0]].stemDirection:r.map(x=>t.getRowDiff(t.midLinePitch,e[x].pitch)).reduce((x,g)=>x+g,0)/r.length<0?"up":"down",l=[],i=[],s=-1,u=0,d=0,n,a,o;for(;r[++s]!==void 0;)n=r[s],a=e[n],o=t.getRowDiff(t.midLinePitch,a.pitch),a.stemDirection=p,a.tieDirection=p==="up"?"down":"up",l.push(a),s<(r.length-1)/2?u+=o/Math.floor(r.length/2):s>(r.length-1)/2&&(d+=o/Math.floor(r.length/2)),a.tie==="begin"&&i.push(Ce({},a,{type:"tie",beat:a.beat,updown:a.tieDirection,event:a.event}));let h=l[0],m=l[l.length-1],v=t.getRowDiff(h.pitch,m.pitch),w=d-u,N=Ba(w)>Ba(.75*v)?.75*v:w;l.forEach((x,g)=>{x.stemHeight=p==="down"?1+.125*(-N*g/(l.length-1)+t.getRowDiff(h.pitch,x.pitch)):1+.125*(N*g/(l.length-1)-t.getRowDiff(h.pitch,x.pitch))});let B=l.map(Le("event"));return l.forEach(x=>x.beam=B),e.splice(n,0,{type:"beam",beat:h.beat,pitch:h.pitch,part:h.part,duration:m.beat-h.beat,range:N,direction:p,notes:l,events:h.beam}),e.splice(n,0,...i),1+i.length}function Ma(e,t,r,f,c,p){let l=c-p,i=-1;if(!(p===0||t.includes(p))||!(c===r||t.includes(c))){for(;t[++i]&&t[i]<=p;);p+l>t[i]&&(l=t[i]-p)}let s=Et.length;for(;Et[--s]>l;);l=Et[s];let u=8;for(;(u*=.5)&&p%u;);return u<l&&(l=u),{beat:p,type:"rest",pitch:"",part:f,duration:l}}function Fo(e,t){let r=e[0]&&e[0].part,f=t.stave,c=t.key.reduce((d,n,a)=>{let o=n-_e[a];if(o!==0){let h=lt(_e[a]),m=10;for(;m--;)d[h+m]=o}return d},{}),p=mn(t.meter),l=0,i=-1,s,u;for(;s=e[++i];){if(s.type!=="note")continue;if(s.beat>l){let o=Ma(Et,p,t.duration,r,s.beat,l);e.splice(i,0,o),l+=o.duration;continue}s.beat+s.duration>l&&(l=s.beat+s.duration);let d=yt.test(s.pitch)?1:bt.test(s.pitch)?-1:void 0,n=s.pitch[0]+s.pitch.slice(-1);!(s.beat===0&&s.tie&&s.tie!=="begin")&&d!==c[n]&&(c[n]=d,e.splice(i++,0,Ce({},s,{type:"acci",value:d||0})));let a=f.getRowDiff(f.maxLinePitch,s.pitch)-1;if(a>0?e.splice(i++,0,Ce({},s,{type:"upledger",rows:a})):(a=f.getRowDiff(s.pitch,f.minLinePitch)-1,a>0&&e.splice(i++,0,Ce({},s,{type:"downledger",rows:a}))),u&&u.length&&(s.duration>=1||s.duration.toFixed(2)==="0.67"||t.divisions.includes(s.beat)||gn(t.divisions,e[u[u.length-1]].beat,s.beat))&&(i+=Aa(e,t.stave,u,i),u=void 0),s.duration<4){if(s.duration<1&&s.duration.toFixed(2)!=="0.67")u?u.push(i):u=[i];else if(s.tie==="begin"||s.tie==="middle"){let o=Fa(f.centerPitch,s);e.splice(i++,0,Ce({},s,{type:"tie",beat:s.beat,updown:o==="up"?"down":"up",event:s.event}))}}else if(s.tie==="begin"||s.tie==="middle"){let o=Fa(f.centerPitch,s);e.splice(i++,0,Ce({},s,{type:"tie",beat:s.beat,updown:o==="up"?"down":"up",event:s.event}))}}for(u&&u.length&&(i+=Aa(e,t.stave,u,i),u=void 0);l<t.duration;){let d=Ma(Et,p,t.duration,r,t.duration,l);e.splice(i++,0,d),l+=d.duration}return e}function Ao(e){let t={clef:{name:"treble",stemDirectionNote:"B4"}},r=Object.values(e.symbols.reduce((f,c)=>(f[c.part]||(f[c.part]=[]),f[c.part].push(c),f),{}));return r.length===0&&(r[0]=[]),r.forEach(f=>Fo(f,e,t.clef.stemDirectionNote)),e.symbols.length=0,r.reduce((f,c)=>(f.push.apply(f,c),f),e.symbols),e}function vn(e,t,r,f,c){let p={beat:e,duration:f[2],divisions:mn(f),symbols:[],stave:t,key:r,meter:f},l=-1,i,s;for(;(i=c[++l])&&(s=i.event)&&s[0]<p.beat+f[2];){let u=s[0]+s[4]-p.beat;u>p.duration?p.symbols.push(Ce({},i,{beat:0,duration:p.duration,tie:"middle",stave:t},t.getPart(i.pitch))):(p.symbols.push(Ce({},i,{beat:0,duration:u,tie:"end",stave:t},t.getPart(i.pitch))),c.splice(l,1),--l)}return p}var Mo={"-2":"ð„«","-1":"â™­",0:"",1:"â™¯",2:"ð„ª"};function So(e,t,r,f,c){let p=[],l=[];f=dt(e,0).find(n=>n[1]==="meter")||f;let s=vn(0,r,_e,f,p);l.push(s),s.symbols.unshift({type:"clef",beat:0,stave:r});let u=-1,d;for(;d=e[++u];){if(d[1]==="key"){d[0]!==s.beat&&new TypeError('Scribe: "key" event must occur at bar start â€“ event ['+d.join(", ")+"] is on beat "+(d[0]-s.beat)+" of bar");let h=ya(d[2]),m=xa(h*7+c);s.key=m,s.symbols.push.apply(s.symbols,m.map((v,w)=>v-_e[w]&&{type:"acci",pitch:lt(_e[w])+Mo[v-_e[w]],value:v-_e[w]}).filter(v=>!!v).sort(Do));continue}if(d[1]==="meter"){d[0]!==s.beat&&new TypeError('Scribe: "meter" event must occur at bar start â€“ event ['+d.join(", ")+"] is on beat "+(d[0]-s.beat)+" of bar"),d[0]===s.beat&&s.symbols.push({type:"timesig",beat:0,numerator:d[2]/d[3],denominator:4/d[3],event:d,stave:r});continue}if(d[1]!=="note"&&d[1]!=="chord"&&d[1]!=="lyric")continue;for(;d[0]>=s.beat+s.duration;){if(d[0]===s.beat+s.duration){let h=u-1;for(;e[++h]&&e[h][0]===d[0];)e[h][1]==="meter"&&(f=e[h])}s=vn(s.beat+s.duration,r,s.key,f,p),l.push(s)}let n=t&&_a(t,d[0]),a=tr(La,1,d[0]-s.beat),o=tr(La,1,d[0]+Lo(d)-s.beat);if(d[1]==="note"){let h=r.getSpelling(n,d,c),m=r.getPart(h),v=a,w,N;if(a!==0&&a%s.meter[3]!==0||o<s.duration&&o%s.meter[3]!==0)for(;w=gn(s.divisions,v,o);){let g=w-v,k=Ce({type:"note",beat:v,duration:g,dynamic:d[3],pitch:h,transpose:c,event:d,stave:r,tie:N?"middle":"begin"},m);s.symbols.push(k),v+=g,N=!0}let B=o>s.duration?s.duration-v:o-v,x=Ce({type:"note",beat:v,duration:B,dynamic:d[3],pitch:h,transpose:c,event:d,stave:r},m);s.symbols.push(x),o>s.duration&&(x.tie=N?"middle":"begin",p.push(x))}else if(d[1]==="chord"){let h=o>s.duration?s.duration-a:o-a;s.symbols.push({type:"chord",beat:a,duration:h,transpose:c,root:r.getSpelling(n,d,c),extension:d[3],event:d,stave:r})}else{let h=o>s.duration?s.duration-a:o-a;s.symbols.push({type:"lyric",beat:a,duration:h,value:d[2],event:d,stave:r})}}for(;p.length;)s=vn(s.beat+s.duration,r,s.key,f,p),l.push(s);return l}function Po(e){return e[0]<=0&&e[1]==="meter"}function Io(e){return e[0]<=0&&e[1]==="key"}var Sa={key:2,meter:1,default:0};function Pa(e){return Sa[e[1]]||Sa.default}function Oo(e,t){return t[0]<e[0]?1:t[0]>e[0]?-1:Pa(t)-Pa(e)}function bn(e,t,r,f,c){!e.find(Po)&&f&&e.unshift([0,"meter",f[2],f[3]]),!e.find(Io)&&r&&e.unshift([0,"key",r]),e.sort(Oo);let i=er.create(t||"treble"),s=i.pitched?Ta(e):null;return So(e,s,i,f,c).map(Ao)}function yn(e){var t={};return function(f){return f in t?t[f]:t[f]=e(f)}}function rr(e){return function(r,...f){var c=e[r]||e.default;return c&&c.apply(this,f)}}var Go={xml:"application/xml",html:"text/html",svg:"image/svg+xml"};function xn(e,t){if(t){var r=Go[e.toLowerCase()]||e,f;try{f=new window.DOMParser().parseFromString(t,r)}catch{return}if(!f||f.getElementsByTagName("parsererror").length)throw new Error("Invalid "+e.toUpperCase()+": "+t);return f}}function Ia(e){return xn("html",e)}function Oa(e){return xn("svg",e)}var Fe=Object.assign,tt={headers:function(e){return{}},body:me},Ro=rr({"application/x-www-form-urlencoded":function(e){return Fe(e,{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"})},"application/json":function(e){return Fe(e,{"Content-Type":"application/json; charset=utf-8","X-Requested-With":"XMLHttpRequest"})},"multipart/form-data":function(e){return Fe(e,{"Content-Type":"multipart/form-data","X-Requested-With":"XMLHttpRequest"})},"audio/wav":function(e){return Fe(e,{"Content-Type":"audio/wav","X-Requested-With":"XMLHttpRequest"})},"image/png":function(e){return Fe(e,{"Content-Type":"image/png","X-Requested-With":"XMLHttpRequest"})},"image/jpg":function(e){return Fe(e,{"Content-Type":"image/jpg","X-Requested-With":"XMLHttpRequest"})},"image/jpeg":function(e){return Fe(e,{"Content-Type":"image/jpeg","X-Requested-With":"XMLHttpRequest"})},default:function(e){return Fe(e,{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"})}}),qo=rr({"application/json":function(e){return e instanceof FormData?$o(e):JSON.stringify(e)},"application/x-www-form-urlencoded":function(e){return e instanceof FormData?Ra(e):qa(e)},"multipart/form-data":function(e){return e instanceof FormData?e:Uo(e)},default:me});function $o(e){return JSON.stringify(Array.from(e.entries()).reduce(function(t,r){return t[r[0]]=r[1],t},{}))}function Ra(e){return new URLSearchParams(e).toString()}function qa(e){return Object.keys(e).reduce((t,r)=>(t.append(r,e[r]),t),new URLSearchParams)}function Uo(e){throw new Error("TODO: dataToFormData(data)")}function zo(e,t){return t instanceof FormData?e+"?"+Ra(t):e+"?"+qa(t)}function Ho(e,t,r,f){let c=typeof r=="string"?r:r&&r["Content-Type"]||"application/json",p=Ro(c,Fe(tt.headers&&t?tt.headers(t):{},typeof r=="string"?{}:r)),l={method:e,mode:"cors",headers:p,credentials:"same-origin",signal:f&&f.signal};return e!=="GET"&&(l.body=qo(c,tt.body?tt.body(t):t)),l}function nr(e){return e.blob()}function Wo(e){return e.json().catch(t=>{throw new Error("Cannot parse JSON "+e.url+". "+t.message)})}function Ga(e){return e.formData()}function Ko(e){return e.text()}function Xo(e){return e.text().then(t=>/^\s*<!DOCTYPE html>/.test(t)?Ia(t):W("fragment",t))}function jo(e){return e.text().then(t=>/^\s*<\?xml/.test(t)?Oa(t):(console.warn("Untested SVG fragment parsing in request.js!"),W("fragment",t)))}var Qo={"text/plain":Ko,"text/html":Xo,"image/svg+xml":jo,"application/json":Wo,"multipart/form-data":Ga,"application/x-www-form-urlencoded":Ga,audio:nr,"audio/wav":nr,"audio/m4a":nr,"application/zip":nr};function Zo(e){if(tt.onresponse&&(e=tt.onresponse(e)),!e.ok)throw new Error(e.statusText+"");let t=e.headers.get("Content-Type");if(!t)return;let r=t.replace(/\;.*$/,"");return Qo[r](e)}function $a(e="GET",t,r={},f="application/json"){e=e.toUpperCase(),e==="GET"&&r&&(t=zo(t,r));let c=Ho(e,r,f,arguments[4]);return fetch(t,c).then(Zo)}function Ua(e){return $a("GET",e)}function Jo(e,t){let r;for(r in e)if(e[r]!==t[r])return!1;return!0}var za=ge(Jo,!0);var ve={};ve.clone=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t};ve.cloneArray=function(e){for(var t=[],r=0;r<e.length;r++)t.push(ve.clone(e[r]));return t};ve.cloneHashOfHash=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=ve.clone(e[r]));return t};ve.cloneHashOfArrayOfHash=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=ve.cloneArray(e[r]));return t};ve.strip=function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")};ve.startsWith=function(e,t){return e.indexOf(t)===0};ve.endsWith=function(e,t){var r=e.length-t.length;return r>=0&&e.lastIndexOf(t)===r};ve.last=function(e){return e.length===0?null:e[e.length-1]};var G=ve;var We={};(function(){"use strict";var e,t,r,f,c;We.initialize=function(y,b,T,C,M){e=y,t=b,r=T,f=C,c=M,p()};function p(){r.annotationfont={face:"Helvetica",size:12,weight:"normal",style:"normal",decoration:"none"},r.gchordfont={face:"Helvetica",size:12,weight:"normal",style:"normal",decoration:"none"},r.historyfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},r.infofont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},r.measurefont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},r.partsfont={face:'"Times New Roman"',size:15,weight:"normal",style:"normal",decoration:"none"},r.repeatfont={face:'"Times New Roman"',size:13,weight:"normal",style:"normal",decoration:"none"},r.textfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},r.tripletfont={face:"Times",size:11,weight:"normal",style:"italic",decoration:"none"},r.vocalfont={face:'"Times New Roman"',size:13,weight:"bold",style:"normal",decoration:"none"},r.wordsfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},f.formatting.composerfont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},f.formatting.subtitlefont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},f.formatting.tempofont={face:'"Times New Roman"',size:15,weight:"bold",style:"normal",decoration:"none"},f.formatting.titlefont={face:'"Times New Roman"',size:20,weight:"normal",style:"normal",decoration:"none"},f.formatting.footerfont={face:'"Times New Roman"',size:12,weight:"normal",style:"normal",decoration:"none"},f.formatting.headerfont={face:'"Times New Roman"',size:12,weight:"normal",style:"normal",decoration:"none"},f.formatting.voicefont={face:'"Times New Roman"',size:13,weight:"bold",style:"normal",decoration:"none"},f.formatting.tablabelfont={face:'"Trebuchet MS"',size:16,weight:"normal",style:"normal",decoration:"none"},f.formatting.tabnumberfont={face:'"Arial"',size:11,weight:"normal",style:"normal",decoration:"none"},f.formatting.tabgracefont={face:'"Arial"',size:8,weight:"normal",style:"normal",decoration:"none"},f.formatting.annotationfont=r.annotationfont,f.formatting.gchordfont=r.gchordfont,f.formatting.historyfont=r.historyfont,f.formatting.infofont=r.infofont,f.formatting.measurefont=r.measurefont,f.formatting.partsfont=r.partsfont,f.formatting.repeatfont=r.repeatfont,f.formatting.textfont=r.textfont,f.formatting.tripletfont=r.tripletfont,f.formatting.vocalfont=r.vocalfont,f.formatting.wordsfont=r.wordsfont}var l={gchordfont:!0,measurefont:!0,partsfont:!0,annotationfont:!0,composerfont:!0,historyfont:!0,infofont:!0,subtitlefont:!0,textfont:!0,titlefont:!0,voicefont:!0},i=function(y){switch(y){case"Arial-Italic":return{face:"Arial",weight:"normal",style:"italic",decoration:"none"};case"Arial-Bold":return{face:"Arial",weight:"bold",style:"normal",decoration:"none"};case"Bookman-Demi":return{face:"Bookman,serif",weight:"bold",style:"normal",decoration:"none"};case"Bookman-DemiItalic":return{face:"Bookman,serif",weight:"bold",style:"italic",decoration:"none"};case"Bookman-Light":return{face:"Bookman,serif",weight:"normal",style:"normal",decoration:"none"};case"Bookman-LightItalic":return{face:"Bookman,serif",weight:"normal",style:"italic",decoration:"none"};case"Courier":return{face:'"Courier New"',weight:"normal",style:"normal",decoration:"none"};case"Courier-Oblique":return{face:'"Courier New"',weight:"normal",style:"italic",decoration:"none"};case"Courier-Bold":return{face:'"Courier New"',weight:"bold",style:"normal",decoration:"none"};case"Courier-BoldOblique":return{face:'"Courier New"',weight:"bold",style:"italic",decoration:"none"};case"AvantGarde-Book":return{face:"AvantGarde,Arial",weight:"normal",style:"normal",decoration:"none"};case"AvantGarde-BookOblique":return{face:"AvantGarde,Arial",weight:"normal",style:"italic",decoration:"none"};case"AvantGarde-Demi":case"Avant-Garde-Demi":return{face:"AvantGarde,Arial",weight:"bold",style:"normal",decoration:"none"};case"AvantGarde-DemiOblique":return{face:"AvantGarde,Arial",weight:"bold",style:"italic",decoration:"none"};case"Helvetica-Oblique":return{face:"Helvetica",weight:"normal",style:"italic",decoration:"none"};case"Helvetica-Bold":return{face:"Helvetica",weight:"bold",style:"normal",decoration:"none"};case"Helvetica-BoldOblique":return{face:"Helvetica",weight:"bold",style:"italic",decoration:"none"};case"Helvetica-Narrow":return{face:'"Helvetica Narrow",Helvetica',weight:"normal",style:"normal",decoration:"none"};case"Helvetica-Narrow-Oblique":return{face:'"Helvetica Narrow",Helvetica',weight:"normal",style:"italic",decoration:"none"};case"Helvetica-Narrow-Bold":return{face:'"Helvetica Narrow",Helvetica',weight:"bold",style:"normal",decoration:"none"};case"Helvetica-Narrow-BoldOblique":return{face:'"Helvetica Narrow",Helvetica',weight:"bold",style:"italic",decoration:"none"};case"Palatino-Roman":return{face:"Palatino",weight:"normal",style:"normal",decoration:"none"};case"Palatino-Italic":return{face:"Palatino",weight:"normal",style:"italic",decoration:"none"};case"Palatino-Bold":return{face:"Palatino",weight:"bold",style:"normal",decoration:"none"};case"Palatino-BoldItalic":return{face:"Palatino",weight:"bold",style:"italic",decoration:"none"};case"NewCenturySchlbk-Roman":return{face:'"New Century",serif',weight:"normal",style:"normal",decoration:"none"};case"NewCenturySchlbk-Italic":return{face:'"New Century",serif',weight:"normal",style:"italic",decoration:"none"};case"NewCenturySchlbk-Bold":return{face:'"New Century",serif',weight:"bold",style:"normal",decoration:"none"};case"NewCenturySchlbk-BoldItalic":return{face:'"New Century",serif',weight:"bold",style:"italic",decoration:"none"};case"Times":case"Times-Roman":case"Times-Narrow":case"Times-Courier":case"Times-New-Roman":return{face:'"Times New Roman"',weight:"normal",style:"normal",decoration:"none"};case"Times-Italic":case"Times-Italics":return{face:'"Times New Roman"',weight:"normal",style:"italic",decoration:"none"};case"Times-Bold":return{face:'"Times New Roman"',weight:"bold",style:"normal",decoration:"none"};case"Times-BoldItalic":return{face:'"Times New Roman"',weight:"bold",style:"italic",decoration:"none"};case"ZapfChancery-MediumItalic":return{face:'"Zapf Chancery",cursive,serif',weight:"normal",style:"normal",decoration:"none"};default:return null}},s=function(y,b,T,C,M){function q(){var pe=parseInt(y[0].token);return y.shift(),b?y.length===0?{face:b.face,weight:b.weight,style:b.style,decoration:b.decoration,size:pe}:y.length===1&&y[0].token==="box"&&l[M]?{face:b.face,weight:b.weight,style:b.style,decoration:b.decoration,size:pe,box:!0}:(t("Extra parameters in font definition.",T,C),{face:b.face,weight:b.weight,style:b.style,decoration:b.decoration,size:pe}):(t("Can't set just the size of the font since there is no default value.",T,C),{face:'"Times New Roman"',weight:"normal",style:"normal",decoration:"none",size:pe})}if(y[0].token==="*"){if(y.shift(),y[0].type==="number")return q();t("Expected font size number after *.",T,C)}if(y[0].type==="number")return q();for(var U=[],$,le="normal",X="normal",he="none",H=!1,Pe="face",Qe=!1;y.length;){var oe=y.shift(),J=oe.token.toLowerCase();switch(Pe){case"face":Qe||J!=="utf"&&oe.type!=="number"&&J!=="bold"&&J!=="italic"&&J!=="underline"&&J!=="box"?U.length>0&&oe.token==="-"?(Qe=!0,U[U.length-1]=U[U.length-1]+oe.token):Qe?(Qe=!1,U[U.length-1]=U[U.length-1]+oe.token):U.push(oe.token):oe.type==="number"?($?t("Font size specified twice in font definition.",T,C):$=oe.token,Pe="modifier"):J==="bold"?le="bold":J==="italic"?X="italic":J==="underline"?he="underline":J==="box"?(l[M]?H=!0:t(`This font style doesn't support "box"`,T,C),Pe="finished"):J==="utf"?(oe=y.shift(),Pe="size"):t("Unknown parameter "+oe.token+" in font definition.",T,C);break;case"size":oe.type==="number"?$?t("Font size specified twice in font definition.",T,C):$=oe.token:t("Expected font size in font definition.",T,C),Pe="modifier";break;case"modifier":J==="bold"?le="bold":J==="italic"?X="italic":J==="underline"?he="underline":J==="box"?(l[M]?H=!0:t(`This font style doesn't support "box"`,T,C),Pe="finished"):t("Unknown parameter "+oe.token+" in font definition.",T,C);break;case"finished":t('Extra characters found after "box" in font definition.',T,C);break}}$===void 0?b?$=b.size:(t("Must specify the size of the font since there is no default value.",T,C),$=12):$=parseFloat($),U=U.join(" "),U===""&&(b?U=b.face:(t("Must specify the name of the font since there is no default value.",T,C),U="sans-serif"));var Re=i(U),re={};return Re?(re.face=Re.face,re.weight=Re.weight,re.style=Re.style,re.decoration=Re.decoration,re.size=$,H&&(re.box=!0),re):(re.face=U,re.weight=le,re.style=X,re.decoration=he,re.size=$,H&&(re.box=!0),re)},u=function(y,b,T){return b.length===0?'Directive "'+y+'" requires a font as a parameter.':(r[y]=s(b,r[y],T,0,y),r.is_in_header&&(f.formatting[y]=r[y]),null)},d=function(y,b,T){return b.length===0?'Directive "'+y+'" requires a font as a parameter.':(f.formatting[y]=s(b,f.formatting[y],T,0,y),null)},n=function(y,b){var T="";b.forEach(function(M){T+=M.token});var C=parseFloat(T);if(isNaN(C)||C===0)return'Directive "'+y+'" requires a number as a parameter.';f.formatting.scale=C},a=["acoustic-bass-drum","bass-drum-1","side-stick","acoustic-snare","hand-clap","electric-snare","low-floor-tom","closed-hi-hat","high-floor-tom","pedal-hi-hat","low-tom","open-hi-hat","low-mid-tom","hi-mid-tom","crash-cymbal-1","high-tom","ride-cymbal-1","chinese-cymbal","ride-bell","tambourine","splash-cymbal","cowbell","crash-cymbal-2","vibraslap","ride-cymbal-2","hi-bongo","low-bongo","mute-hi-conga","open-hi-conga","low-conga","high-timbale","low-timbale","high-agogo","low-agogo","cabasa","maracas","short-whistle","long-whistle","short-guiro","long-guiro","claves","hi-wood-block","low-wood-block","mute-cuica","open-cuica","mute-triangle","open-triangle"],o=function(y){var b=y.split(/\s+/);if(b.length!==2&&b.length!==3)return{error:'Expected parameters "abc-note", "drum-sound", and optionally "note-head"'};var T=b[0],C=parseInt(b[1],10);if((isNaN(C)||C<35||C>81)&&b[1]&&(C=a.indexOf(b[1].toLowerCase())+35),isNaN(C)||C<35||C>81)return{error:'Expected drum name, received "'+b[1]+'"'};var M={sound:C};return b.length===3&&(M.noteHead=b[2]),{key:T,value:M}},h=function(y,b){var T=e.getMeasurement(b);return T.used===0||b.length!==0?{error:'Directive "'+y+'" requires a measurement as a parameter.'}:T.value},m=function(y,b){var T=e.getMeasurement(b);return T.used===0||b.length!==0?'Directive "'+y+'" requires a measurement as a parameter.':(f.formatting[y]=T.value,null)},v=function(y,b,T,C,M){if(T.length!==1||T[0].type!=="number")return'Directive "'+b+'" requires a number as a parameter.';var q=T[0].intt;return C!==void 0&&q<C?'Directive "'+b+'" requires a number greater than or equal to '+C+" as a parameter.":M!==void 0&&q>M?'Directive "'+b+'" requires a number less than or equal to '+M+" as a parameter.":(r[y]=q,null)},w=function(y,b,T){if(T.length===1&&(T[0].token==="true"||T[0].token==="false"))return r[y]=T[0].token==="true",null;var C=v(y,b,T,0,1);return C!==null?C:(r[y]=r[y]===1,null)},N=function(y,b,T,C){if(T.length!==1)return'Directive "'+b+'" requires one of [ '+C.join(", ")+" ] as a parameter.";for(var M=T[0].token,q=!1,U=0;!q&&U<C.length;U++)C[U]===M&&(q=!0);return q?(r[y]=M,null):'Directive "'+b+'" requires one of [ '+C.join(", ")+" ] as a parameter."},B=["nobarlines","barlines","beataccents","nobeataccents","droneon","droneoff","drumon","drumoff","fermatafixed","fermataproportional","gchordon","gchordoff","controlcombo","temperamentnormal","noportamento"],x=["gchord","ptstress","beatstring"],g=["bassvol","chordvol","bassprog","chordprog","c","channel","beatmod","deltaloudness","drumbars","gracedivider","makechordchannels","randomchordattack","chordattack","stressmodel","transpose","rtranspose","vol","volinc"],k=["program"],S=["ratio","snt","bendvelocity","pitchbend","control","temperamentlinear"],F=["beat"],A=["drone"],P=["portamento"],D=["expand","grace","trim"],L=["drum","chordname"],I=function(y,b,T){var C=y.shift().token,M=[];if(B.indexOf(C)>=0)y.length!==0&&t("Unexpected parameter in MIDI "+C,T,0);else if(x.indexOf(C)>=0)y.length!==1?t("Expected one parameter in MIDI "+C,T,0):M.push(y[0].token);else if(g.indexOf(C)>=0)y.length!==1?t("Expected one parameter in MIDI "+C,T,0):y[0].type!=="number"?t("Expected one integer parameter in MIDI "+C,T,0):M.push(y[0].intt);else if(k.indexOf(C)>=0)y.length!==1&&y.length!==2?t("Expected one or two parameters in MIDI "+C,T,0):y[0].type!=="number"||y.length===2&&y[1].type!=="number"?t("Expected integer parameter in MIDI "+C,T,0):(M.push(y[0].intt),y.length===2&&M.push(y[1].intt));else if(S.indexOf(C)>=0)y.length!==2?t("Expected two parameters in MIDI "+C,T,0):y[0].type!=="number"||y[1].type!=="number"?t("Expected two integer parameters in MIDI "+C,T,0):(M.push(y[0].intt),M.push(y[1].intt));else if(P.indexOf(C)>=0)y.length!==2?t("Expected two parameters in MIDI "+C,T,0):y[0].type!=="alpha"||y[1].type!=="number"?t("Expected one string and one integer parameters in MIDI "+C,T,0):(M.push(y[0].token),M.push(y[1].intt));else if(C==="drummap")y.length===2&&y[0].type==="alpha"&&y[1].type==="number"?(b.formatting||(b.formatting={}),b.formatting.midi||(b.formatting.midi={}),b.formatting.midi.drummap||(b.formatting.midi.drummap={}),b.formatting.midi.drummap[y[0].token]=y[1].intt,M=b.formatting.midi.drummap):y.length===3&&y[0].type==="punct"&&y[1].type==="alpha"&&y[2].type==="number"?(b.formatting||(b.formatting={}),b.formatting.midi||(b.formatting.midi={}),b.formatting.midi.drummap||(b.formatting.midi.drummap={}),b.formatting.midi.drummap[y[0].token+y[1].token]=y[2].intt,M=b.formatting.midi.drummap):t("Expected one note name and one integer parameter in MIDI "+C,T,0);else if(D.indexOf(C)>=0)y.length!==3||y[0].type!=="number"||y[1].token!=="/"||y[2].type!=="number"?t("Expected fraction parameter in MIDI "+C,T,0):(M.push(y[0].intt),M.push(y[2].intt));else if(F.indexOf(C)>=0)y.length!==4?t("Expected four parameters in MIDI "+C,T,0):y[0].type!=="number"||y[1].type!=="number"||y[2].type!=="number"||y[3].type!=="number"?t("Expected four integer parameters in MIDI "+C,T,0):(M.push(y[0].intt),M.push(y[1].intt),M.push(y[2].intt),M.push(y[3].intt));else if(A.indexOf(C)>=0)y.length!==5?t("Expected five parameters in MIDI "+C,T,0):y[0].type!=="number"||y[1].type!=="number"||y[2].type!=="number"||y[3].type!=="number"||y[4].type!=="number"?t("Expected five integer parameters in MIDI "+C,T,0):(M.push(y[0].intt),M.push(y[1].intt),M.push(y[2].intt),M.push(y[3].intt),M.push(y[4].intt));else if(k.indexOf(C)>=0)y.length!==1||y.length!==4?t("Expected one or two parameters in MIDI "+C,T,0):y[0].type!=="number"?t("Expected integer parameter in MIDI "+C,T,0):y.length===4?(y[1].token!=="octave"&&t("Expected octave parameter in MIDI "+C,T,0),y[2].token!=="="&&t("Expected octave parameter in MIDI "+C,T,0),y[3].type!=="number"&&t("Expected integer parameter for octave in MIDI "+C,T,0)):(M.push(y[0].intt),y.length===4&&M.push(y[3].intt));else if(L.indexOf(C)>=0)if(y.length<2)t("Expected string parameter and at least one integer parameter in MIDI "+C,T,0);else if(y[0].type!=="alpha")t("Expected string parameter and at least one integer parameter in MIDI "+C,T,0);else{var q=y.shift();for(M.push(q.token);y.length>0;)q=y.shift(),q.type!=="number"&&t("Expected integer parameter in MIDI "+C,T,0),M.push(q.intt)}c.hasBeginMusic()?c.appendElement("midi",-1,-1,{cmd:C,params:M}):(b.formatting.midi===void 0&&(b.formatting.midi={}),b.formatting.midi[C]=M)};We.parseFontChangeLine=function(y){y=y.replace(/\$\$/g,"");var b=y.split("$");if(b.length>1&&r.setfont){var T=[];b[0]!==""&&T.push({text:b[0]});for(var C=1;C<b.length;C++)if(b[C][0]==="0")T.push({text:b[C].substring(1).replace(/\x03/g,"$$")});else{var M=parseInt(b[C][0],10);r.setfont[M]?T.push({font:r.setfont[M],text:b[C].substring(1).replace(/\x03/g,"$$")}):T[T.length-1].text+="$"+b[C].replace(/\x03/g,"$$")}return T}return y.replace(/\x03/g,"$$")};var R=["auto","above","below","hidden"];We.addDirective=function(y){var b=e.tokenize(y,0,y.length);if(b.length===0||b[0].type!=="alpha")return null;var T=y.substring(y.indexOf(b[0].token)+b[0].token.length);T=e.stripComment(T);var C=b.shift().token.toLowerCase(),M="",q;switch(C){case"bagpipes":f.formatting.bagpipes=!0;break;case"flatbeams":f.formatting.flatbeams=!0;break;case"jazzchords":f.formatting.jazzchords=!0;break;case"accentAbove":f.formatting.accentAbove=!0;break;case"germanAlphabet":f.formatting.germanAlphabet=!0;break;case"landscape":r.landscape=!0;break;case"papersize":r.papersize=T;break;case"graceslurs":if(b.length!==1)return"Directive graceslurs requires one parameter: 0 or 1";if(b[0].token==="0"||b[0].token==="false")f.formatting.graceSlurs=!1;else if(b[0].token==="1"||b[0].token==="true")f.formatting.graceSlurs=!0;else return"Directive graceslurs requires one parameter: 0 or 1 (received "+b[0].token+")";break;case"lineThickness":var U=O(b);if(U.value!==void 0&&(f.formatting.lineThickness=U.value),U.error)return U.error;break;case"stretchlast":var $=O(b);if($.value!==void 0&&(f.formatting.stretchlast=$.value),$.error)return $.error;break;case"titlecaps":r.titlecaps=!0;break;case"titleleft":f.formatting.titleleft=!0;break;case"measurebox":f.formatting.measurebox=!0;break;case"vocal":return N("vocalPosition",C,b,R);case"dynamic":return N("dynamicPosition",C,b,R);case"gchord":return N("chordPosition",C,b,R);case"ornament":return N("ornamentPosition",C,b,R);case"volume":return N("volumePosition",C,b,R);case"botmargin":case"botspace":case"composerspace":case"indent":case"leftmargin":case"linesep":case"musicspace":case"partsspace":case"pageheight":case"pagewidth":case"rightmargin":case"staffsep":case"staffwidth":case"subtitlespace":case"sysstaffsep":case"systemsep":case"textspace":case"titlespace":case"topmargin":case"topspace":case"vocalspace":case"wordsspace":return m(C,b);case"voicescale":if(b.length!==1||b[0].type!=="number")return"voicescale requires one float as a parameter";var le=b.shift();return r.currentVoice&&(r.currentVoice.scale=le.floatt,c.changeVoiceScale(r.currentVoice.scale)),null;case"voicecolor":if(b.length!==1)return"voicecolor requires one string as a parameter";var X=b.shift();return r.currentVoice&&(r.currentVoice.color=X.token,c.changeVoiceColor(r.currentVoice.color)),null;case"vskip":var he=Math.round(h(C,b));return he.error?he.error:(c.addSpacing(he),null);case"scale":n(C,b);break;case"sep":if(b.length===0)c.addSeparator(14,14,85,{startChar:r.iChar,endChar:r.iChar+5});else{var H=e.getMeasurement(b);if(H.used===0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var Pe=H.value;if(H=e.getMeasurement(b),H.used===0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var Qe=H.value;if(H=e.getMeasurement(b),H.used===0||b.length!==0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var oe=H.value;c.addSeparator(Pe,Qe,oe,{startChar:r.iChar,endChar:r.iChar+T.length})}break;case"barsperstaff":if(M=v("barsperstaff",C,b),M!==null)return M;break;case"staffnonote":if(b.length!==1)return"Directive staffnonote requires one parameter: 0 or 1";if(b[0].token==="0")r.staffnonote=!0;else if(b[0].token==="1")r.staffnonote=!1;else return"Directive staffnonote requires one parameter: 0 or 1 (received "+b[0].token+")";break;case"printtempo":if(M=w("printTempo",C,b),M!==null)return M;break;case"partsbox":if(M=w("partsBox",C,b),M!==null)return M;r.partsfont.box=r.partsBox;break;case"freegchord":if(M=w("freegchord",C,b),M!==null)return M;break;case"measurenb":case"barnumbers":if(M=v("barNumbers",C,b),M!==null)return M;break;case"setbarnb":if(b.length!==1||b[0].type!=="number")return"Directive setbarnb requires a number as a parameter.";r.currBarNumber=c.setBarNumberImmediate(b[0].intt);break;case"begintext":var J="";for(q=e.nextLine();q&&q.indexOf("%%endtext")!==0;)G.startsWith(q,"%%")?J+=q.substring(2)+`
`:J+=q+`
`,q=e.nextLine();c.addText(J,{startChar:r.iChar,endChar:r.iChar+J.length+7});break;case"continueall":r.continueall=!0;break;case"beginps":for(q=e.nextLine();q&&q.indexOf("%%endps")!==0;)e.nextLine();t("Postscript ignored",y,0);break;case"deco":T.length>0&&r.ignoredDecorations.push(T.substring(0,T.indexOf(" "))),t("Decoration redefinition ignored",y,0);break;case"text":var Re=e.translateString(T);c.addText(We.parseFontChangeLine(Re),{startChar:r.iChar,endChar:r.iChar+T.length+7});break;case"center":var re=e.translateString(T);c.addCentered(We.parseFontChangeLine(re));break;case"font":break;case"setfont":var pe=e.tokenize(T,0,T.length);if(pe.length>=4&&pe[0].token==="-"&&pe[1].type==="number"){var Mt=parseInt(pe[1].token);Mt>=1&&Mt<=9&&(r.setfont||(r.setfont=[]),pe.shift(),pe.shift(),r.setfont[Mt]=s(pe,r.setfont[Mt],y,0,"setfont"))}break;case"gchordfont":case"partsfont":case"tripletfont":case"vocalfont":case"textfont":case"annotationfont":case"historyfont":case"infofont":case"measurefont":case"repeatfont":case"wordsfont":return u(C,b,y);case"composerfont":case"subtitlefont":case"tempofont":case"titlefont":case"voicefont":case"footerfont":case"headerfont":return d(C,b,y);case"barlabelfont":case"barnumberfont":case"barnumfont":return u("measurefont",b,y);case"staves":case"score":r.score_is_present=!0;for(var wi=function(ot,Ti,Xn,jn,_i){(Ti||r.staves.length===0)&&r.staves.push({index:r.staves.length,numVoices:0});var Oe=G.last(r.staves);Xn!==void 0&&Oe.bracket===void 0&&(Oe.bracket=Xn),jn!==void 0&&Oe.brace===void 0&&(Oe.brace=jn),_i&&(Oe.connectBarLines="end"),r.voices[ot]===void 0&&(r.voices[ot]={staffNum:Oe.index,index:Oe.numVoices},Oe.numVoices++)},nt=!1,at=!1,it=!1,St=!1,Pt=!1,It=!1,mr=!1,Ie,Wn=function(){if(mr=!0,Ie){var ot="start";Ie.staffNum>0&&(r.staves[Ie.staffNum-1].connectBarLines==="start"||r.staves[Ie.staffNum-1].connectBarLines==="continue")&&(ot="continue"),r.staves[Ie.staffNum].connectBarLines=ot}};b.length;){var de=b.shift();switch(de.token){case"(":nt?t("Can't nest parenthesis in %%score",y,de.start):(nt=!0,St=!0);break;case")":!nt||St?t("Unexpected close parenthesis in %%score",y,de.start):nt=!1;break;case"[":at?t("Can't nest brackets in %%score",y,de.start):(at=!0,Pt=!0);break;case"]":!at||Pt?t("Unexpected close bracket in %%score",y,de.start):(at=!1,r.staves[Ie.staffNum].bracket="end");break;case"{":it?t("Can't nest braces in %%score",y,de.start):(it=!0,It=!0);break;case"}":!it||It?t("Unexpected close brace in %%score",y,de.start):(it=!1,r.staves[Ie.staffNum].brace="end");break;case"|":Wn();break;default:for(var gr="";(de.type==="alpha"||de.type==="number")&&(gr+=de.token,de.continueId);)de=b.shift();var Ei=!nt||St,Ci=Pt?"start":at?"continue":void 0,ki=It?"start":it?"continue":void 0;wi(gr,Ei,Ci,ki,mr),St=!1,Pt=!1,It=!1,mr=!1,Ie=r.voices[gr],C==="staves"&&Wn();break}}break;case"newpage":var Kn=e.getInt(T);c.addNewPage(Kn.digits===0?-1:Kn.value);break;case"abc":var Ot=T.split(" ");switch(Ot[0]){case"-copyright":case"-creator":case"-edited-by":case"-version":case"-charset":var Ni=Ot.shift();c.addMetaText(C+Ni,Ot.join(" "),{startChar:r.iChar,endChar:r.iChar+T.length+5});break;default:return"Unknown directive: "+C+Ot[0]}break;case"header":case"footer":var Ne=e.getMeat(T,0,T.length);Ne=T.substring(Ne.start,Ne.end),Ne[0]==='"'&&Ne[Ne.length-1]==='"'&&(Ne=Ne.substring(1,Ne.length-1));var Te=Ne.split("	"),Gt={};Te.length===1?Gt={left:"",center:Te[0],right:""}:Te.length===2?Gt={left:Te[0],center:Te[1],right:""}:Gt={left:Te[0],center:Te[1],right:Te[2]},Te.length>3&&t("Too many tabs in "+C+": "+Te.length+" found.",T,0),c.addMetaTextObj(C,Gt,{startChar:r.iChar,endChar:r.iChar+y.length});break;case"midi":var st=e.tokenize(T,0,T.length,!0);st.length>0&&st[0].token==="="&&st.shift(),st.length===0?t("Expected midi command",T,0):I(st,f,T);break;case"percmap":var Rt=o(T);Rt.error?t(Rt.error,y,8):(f.formatting.percmap||(f.formatting.percmap={}),f.formatting.percmap[Rt.key]=Rt.value);break;case"map":case"playtempo":case"auquality":case"continuous":case"nobarcheck":f.formatting[C]=T;break;default:return"Unknown directive: "+C}return null},We.globalFormatting=function(y){for(var b in y)if(y.hasOwnProperty(b)){var T=""+y[b],C=e.tokenize(T,0,T.length),M;switch(b){case"titlefont":case"gchordfont":case"composerfont":case"footerfont":case"headerfont":case"historyfont":case"infofont":case"measurefont":case"partsfont":case"repeatfont":case"subtitlefont":case"tempofont":case"textfont":case"voicefont":case"tripletfont":case"vocalfont":case"wordsfont":case"annotationfont":case"tablabelfont":case"tabnumberfont":case"tabgracefont":u(b,C,T);break;case"scale":n(b,C);break;case"partsbox":M=w("partsBox",b,C),M!==null&&t(M),r.partsfont.box=r.partsBox;break;case"freegchord":M=w("freegchord",b,C),M!==null&&t(M);break;case"fontboxpadding":(C.length!==1||C[0].type!=="number")&&t('Directive "'+b+'" requires a number as a parameter.'),f.formatting.fontboxpadding=C[0].floatt;break;case"stretchlast":var q=O(C);if(q.value!==void 0&&(f.formatting.stretchlast=q.value),q.error)return q.error;break;default:t("Formatting directive unrecognized: ",b,0)}}};function O(y){if(y.length===0)return{value:1};if(y.length===1)if(y[0].type==="number"){if(y[0].floatt>=0||y[0].floatt<=1)return{value:y[0].floatt}}else{if(y[0].token==="false")return{value:0};if(y[0].token==="true")return{value:1}}return{error:"Directive stretchlast requires zero or one parameter: false, true, or number between 0 and 1 (received "+y[0].token+")"}}})();var V=We;var wn={},Ha=["C,,,","D,,,","E,,,","F,,,","G,,,","A,,,","B,,,","C,,","D,,","E,,","F,,","G,,","A,,","B,,","C,","D,","E,","F,","G,","A,","B,","C","D","E","F","G","A","B","c","d","e","f","g","a","b","c'","d'","e'","f'","g'","a'","b'","c''","d''","e''","f''","g''","a''","b''","c'''","d'''","e'''","f'''","g'''","a'''","b'''"];wn.pitchIndex=function(e){return Ha.indexOf(e)};wn.noteName=function(e){return Ha[e]};var En=wn;var ar=["C","Câ™¯","D","Dâ™¯","E","F","Fâ™¯","G","Gâ™¯","A","Aâ™¯","B"],ir=["C","Dâ™­","D","Eâ™­","E","F","Gâ™­","G","Aâ™­","A","Bâ™­","B"],sr=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],or=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];function Cn(e,t,r,f){if(!t||t%12===0)return e;for(;t<0;)t+=12;t>11&&(t=t%12);var c=e.match(/^([A-G][b#â™­â™¯]?)([^\/]+)?\/?([A-G][b#â™­â™¯]?)?(.+)?/);if(!c)return e;var p=c[1],l=c[2],i=c[3],s=c[4],u=ar.indexOf(p);if(u<0&&(u=ir.indexOf(p)),u<0&&(u=sr.indexOf(p)),u<0&&(u=or.indexOf(p)),u<0)return e;if(u+=t,u=u%12,r?f?e=or[u]:e=ir[u]:f?e=sr[u]:e=ar[u],l&&(e+=l),i){var u=ar.indexOf(i);u<0&&(u=ir.indexOf(i)),u<0&&(u=sr.indexOf(i)),u<0&&(u=or.indexOf(i)),e+="/",u>=0?(u+=t,u=u%12,r?f?e+=or[u]:e+=ir[u]:f?e+=sr[u]:e+=ar[u]):e+=i}return s&&(e+=s),e}var Wa={C:{modes:["CMaj","Amin","Am","GMix","DDor","EPhr","FLyd","BLoc"],stepsFromC:0},Db:{modes:["DbMaj","Bbmin","Bbm","AbMix","EbDor","FPhr","GbLyd","CLoc"],stepsFromC:1},D:{modes:["DMaj","Bmin","Bm","AMix","EDor","F#Phr","GLyd","C#Loc"],stepsFromC:2},Eb:{modes:["EbMaj","Cmin","Cm","BbMix","FDor","GPhr","AbLyd","DLoc"],stepsFromC:3},E:{modes:["EMaj","C#min","C#m","BMix","F#Dor","G#Phr","ALyd","D#Loc"],stepsFromC:4},F:{modes:["FMaj","Dmin","Dm","CMix","GDor","APhr","BbLyd","ELoc"],stepsFromC:5},Gb:{modes:["GbMaj","Ebmin","Ebm","DbMix","AbDor","BbPhr","CbLyd","FLoc"],stepsFromC:6},G:{modes:["GMaj","Emin","Em","DMix","ADor","BPhr","CLyd","F#Loc"],stepsFromC:7},Ab:{modes:["AbMaj","Fmin","Fm","EbMix","BbDor","CPhr","DbLyd","GLoc"],stepsFromC:8},A:{modes:["AMaj","F#min","F#m","EMix","BDor","C#Phr","DLyd","G#Loc"],stepsFromC:9},Bb:{modes:["BbMaj","Gmin","Gm","FMix","CDor","DPhr","EbLyd","ALoc"],stepsFromC:10},B:{modes:["BMaj","G#min","G#m","F#Mix","C#Dor","D#Phr","ELyd","A#Loc"],stepsFromC:11},"C#":{modes:["C#Maj","A#min","A#m","G#Mix","D#Dor","E#Phr","F#Lyd","B#Loc"],stepsFromC:1},"F#":{modes:["F#Maj","D#min","D#m","C#Mix","G#Dor","A#Phr","BLyd","E#Loc"],stepsFromC:6},Cb:{modes:["CbMaj","Abmin","Abm","GbMix","DbDor","EbPhr","FbLyd","BbLoc"],stepsFromC:11}},Ct=null;function Yo(){Ct={};for(var e=Object.keys(Wa),t=0;t<e.length;t++){var r=Wa[e[t]];Ct[e[t].toLowerCase()]=e[t];for(var f=0;f<r.modes.length;f++){var c=r.modes[f].toLowerCase();Ct[c]=e[t]}}}function Ka(e){Ct||Yo();var t=e.toLowerCase().match(/([a-g][b#]?)(maj|min|mix|dor|phr|lyd|loc|m)?/);if(!t||!t[2])return e;t=t[1]+t[2];var r=Ct[t];return r||e}var Ke={acc:"sharp",note:"f"},rt={acc:"sharp",note:"c"},kt={acc:"sharp",note:"g"},fr={acc:"sharp",note:"d"},kn={acc:"sharp",note:"A"},Xa={acc:"sharp",note:"e"},Vo={acc:"sharp",note:"B"},be={acc:"flat",note:"B"},Be={acc:"flat",note:"e"},Ge={acc:"flat",note:"A"},Nt={acc:"flat",note:"d"},Nn={acc:"flat",note:"G"},ja={acc:"flat",note:"c"},ef={acc:"flat",note:"F"},tf={"C#":[Ke,rt,kt,fr,kn,Xa,Vo],"F#":[Ke,rt,kt,fr,kn,Xa],B:[Ke,rt,kt,fr,kn],E:[Ke,rt,kt,fr],A:[Ke,rt,kt],D:[Ke,rt],G:[Ke],C:[],F:[be],Bb:[be,Be],Eb:[be,Be,Ge],Cm:[be,Be,Ge],Ab:[be,Be,Ge,Nt],Db:[be,Be,Ge,Nt,Nn],Gb:[be,Be,Ge,Nt,Nn,ja],Cb:[be,Be,Ge,Nt,Nn,ja,ef],"A#":[be,Be],"B#":[],"D#":[be,Be,Ge],"E#":[be],"G#":[be,Be,Ge,Nt],none:[]};function Tt(e){var t=tf[Ka(e)];return t?JSON.parse(JSON.stringify(t)):null}var cr={},rf={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11},nf=["C","Db","D","Eb","E","F","F#","G","Ab","A","Bb","B"],af=["C","C#","D","D#","E","F","F#","G","G#","A","Bb","B"];cr.keySignature=function(e,t,r,f,c){if(e.clef.type==="perc"||e.clef.type==="none")return{accidentals:Tt(t),root:r,acc:f};c||(c=0),e.localTransposeVerticalMovement=0,e.localTransposePreferFlats=!1;var p=Tt(t);if(!p)return e.key;if(e.localTranspose=(e.globalTranspose?e.globalTranspose:0)+c,!e.localTranspose)return{accidentals:p,root:r,acc:f};if(e.globalTransposeOrigKeySig=p,e.localTranspose%12===0)return e.localTransposeVerticalMovement=e.localTranspose/12*7,{accidentals:p,root:r,acc:f};var l=t[0];t[1]==="b"||t[1]==="#"?(l+=t[1],t=t.substr(2)):t=t.substr(1);var i=rf[l],s=i!==void 0;s||(i=0,l="C",t="");for(var u=i+e.localTranspose;u<0;)u+=12;u>11&&(u=u%12);var d=t[0]==="m"?af[u]:nf[u],n=d+t,a=Tt(n);a.length>0&&a[0].acc==="flat"&&(e.localTransposePreferFlats=!0);var o=n.charCodeAt(0)-l.charCodeAt(0);return e.localTranspose>0?(o<0||o===0&&(l[1]==="#"||n[1]==="b"))&&(o+=7):e.localTranspose<0&&(o>0||o===0&&(l[1]==="b"||n[1]==="#"))&&(o-=7),e.localTranspose>0?e.localTransposeVerticalMovement=o+Math.floor(e.localTranspose/12)*7:e.localTransposeVerticalMovement=o+Math.ceil(e.localTranspose/12)*7,s?{accidentals:a,root:d[0],acc:d.length>1?d[1]:""}:{accidentals:[],root:r,acc:f}};cr.chordName=function(e,t){return Cn(t,e.localTranspose,e.localTransposePreferFlats,e.freegchord)};var Qa=["c","d","e","f","g","a","b"];function sf(e,t,r,f,c){for(var p=Qa[(e+49)%7],l=0,i=0;i<f.length;i++)f[i].note.toLowerCase()===p&&(l=Tn[f[i].acc]);for(var s=Tn[r],u=s-l,d=Qa[(t+49)%7],n=0,a=0;a<c.accidentals.length;a++)c.accidentals[a].note.toLowerCase()===d&&(n=Tn[c.accidentals[a].acc]);var o=u+n;return o<-2&&(t--,o+=d==="c"||d==="f"?1:2),o>2&&(t++,o-=d==="b"||d==="e"?1:2),[t,o]}var Tn={dblflat:-2,flat:-1,natural:0,sharp:1,dblsharp:2},of={"-2":"dblflat","-1":"flat",0:"natural",1:"sharp",2:"dblsharp"},ff={"-2":"__","-1":"_",0:"=",1:"^",2:"^^"};cr.note=function(e,t){if(!(!e.localTranspose||e.clef.type==="perc")){var r=t.pitch;if(e.localTransposeVerticalMovement&&(t.pitch=t.pitch+e.localTransposeVerticalMovement,t.name)){var f=t.accidental?t.name.substring(1):t.name,c=t.accidental?t.name[0]:"",p=En.pitchIndex(f);t.name=c+En.noteName(p+e.localTransposeVerticalMovement)}if(t.accidental){var l=sf(r,t.pitch,t.accidental,e.globalTransposeOrigKeySig,e.targetKey);t.pitch=l[0],t.accidental=of[l[1]],t.name&&(t.name=ff[l[1]]+t.name.replace(/[_^=]/g,""))}}};var _t=cr;var ue={};(function(){var e,t,r,f,c;ue.initialize=function(n,a,o,h,m){e=n,t=a,r=o,f=h,c=m},ue.standardKey=function(n,a,o,h){return _t.keySignature(r,n,a,o,h)};var p={treble:{clef:"treble",pitch:4,mid:0},"treble+8":{clef:"treble+8",pitch:4,mid:0},"treble-8":{clef:"treble-8",pitch:4,mid:0},"treble^8":{clef:"treble+8",pitch:4,mid:0},treble_8:{clef:"treble-8",pitch:4,mid:0},treble1:{clef:"treble",pitch:2,mid:2},treble2:{clef:"treble",pitch:4,mid:0},treble3:{clef:"treble",pitch:6,mid:-2},treble4:{clef:"treble",pitch:8,mid:-4},treble5:{clef:"treble",pitch:10,mid:-6},perc:{clef:"perc",pitch:6,mid:0},none:{clef:"none",mid:0},bass:{clef:"bass",pitch:8,mid:-12},"bass+8":{clef:"bass+8",pitch:8,mid:-12},"bass-8":{clef:"bass-8",pitch:8,mid:-12},"bass^8":{clef:"bass+8",pitch:8,mid:-12},bass_8:{clef:"bass-8",pitch:8,mid:-12},"bass+16":{clef:"bass",pitch:8,mid:-12},"bass-16":{clef:"bass",pitch:8,mid:-12},"bass^16":{clef:"bass",pitch:8,mid:-12},bass_16:{clef:"bass",pitch:8,mid:-12},bass1:{clef:"bass",pitch:2,mid:-6},bass2:{clef:"bass",pitch:4,mid:-8},bass3:{clef:"bass",pitch:6,mid:-10},bass4:{clef:"bass",pitch:8,mid:-12},bass5:{clef:"bass",pitch:10,mid:-14},tenor:{clef:"alto",pitch:8,mid:-8},tenor1:{clef:"alto",pitch:2,mid:-2},tenor2:{clef:"alto",pitch:4,mid:-4},tenor3:{clef:"alto",pitch:6,mid:-6},tenor4:{clef:"alto",pitch:8,mid:-8},tenor5:{clef:"alto",pitch:10,mid:-10},alto:{clef:"alto",pitch:6,mid:-6},alto1:{clef:"alto",pitch:2,mid:-2},alto2:{clef:"alto",pitch:4,mid:-4},alto3:{clef:"alto",pitch:6,mid:-6},alto4:{clef:"alto",pitch:8,mid:-8},alto5:{clef:"alto",pitch:10,mid:-10},"alto+8":{clef:"alto+8",pitch:6,mid:-6},"alto-8":{clef:"alto-8",pitch:6,mid:-6},"alto^8":{clef:"alto+8",pitch:6,mid:-6},alto_8:{clef:"alto-8",pitch:6,mid:-6}},l=function(n,a){var o=p[n],h=o?o.mid:0;return h+a};ue.fixClef=function(n){var a=p[n.type];a&&(n.clefPos=a.pitch,n.type=a.clef)},ue.deepCopyKey=function(n){var a={accidentals:[],root:n.root,acc:n.acc,mode:n.mode};return n.accidentals.forEach(function(o){a.accidentals.push(G.clone(o))}),a};var i={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11};ue.addPosToKey=function(n,a){var o=n.verticalPos;a.accidentals.forEach(function(h){var m=i[h.note];m=m-o,h.verticalPos=m}),a.impliedNaturals&&a.impliedNaturals.forEach(function(h){var m=i[h.note];m=m-o,h.verticalPos=m}),o<-10?(a.accidentals.forEach(function(h){h.verticalPos-=7,(h.verticalPos>=11||h.verticalPos===10&&h.acc==="flat")&&(h.verticalPos-=7),h.note==="A"&&h.acc==="sharp"&&(h.verticalPos-=7),(h.note==="G"||h.note==="F")&&h.acc==="flat"&&(h.verticalPos-=7)}),a.impliedNaturals&&a.impliedNaturals.forEach(function(h){h.verticalPos-=7,(h.verticalPos>=11||h.verticalPos===10&&h.acc==="flat")&&(h.verticalPos-=7),h.note==="A"&&h.acc==="sharp"&&(h.verticalPos-=7),(h.note==="G"||h.note==="F")&&h.acc==="flat"&&(h.verticalPos-=7)})):o<-4?(a.accidentals.forEach(function(h){h.verticalPos-=7,o===-8&&(h.note==="f"||h.note==="g")&&h.acc==="sharp"&&(h.verticalPos-=7)}),a.impliedNaturals&&a.impliedNaturals.forEach(function(h){h.verticalPos-=7,o===-8&&(h.note==="f"||h.note==="g")&&h.acc==="sharp"&&(h.verticalPos-=7)})):o>=7&&(a.accidentals.forEach(function(h){h.verticalPos+=7}),a.impliedNaturals&&a.impliedNaturals.forEach(function(h){h.verticalPos+=7}))},ue.fixKey=function(n,a){var o=G.clone(a);return ue.addPosToKey(n,o),o};var s=function(n){var a=0,o=n[a++];(o==="^"||o==="_")&&(o=n[a++]);var h=i[o];for(h===void 0&&(h=6);a<n.length;a++)if(n[a]===",")h-=7;else if(n[a]==="'")h+=7;else break;return{mid:h-6,str:n.substring(a)}},u=function(n){for(var a=0;a<n.length;a++)n[a].note==="b"?n[a].note="B":n[a].note==="a"?n[a].note="A":n[a].note==="F"?n[a].note="f":n[a].note==="E"?n[a].note="e":n[a].note==="D"?n[a].note="d":n[a].note==="C"?n[a].note="c":n[a].note==="G"&&n[a].acc==="sharp"?n[a].note="g":n[a].note==="g"&&n[a].acc==="flat"&&(n[a].note="G")};ue.parseKey=function(n,a){n.length===0&&(n="none");var o=e.tokenize(n,0,n.length),h={};if(o.length===0)return t("Must pass in key signature.",n,0),h;switch(o[0].token){case"HP":V.addDirective("bagpipes"),r.key={root:"HP",accidentals:[],acc:"",mode:""},h.foundKey=!0,o.shift();break;case"Hp":V.addDirective("bagpipes"),r.key={root:"Hp",accidentals:[{acc:"natural",note:"g"},{acc:"sharp",note:"f"},{acc:"sharp",note:"c"}],acc:"",mode:""},h.foundKey=!0,o.shift();break;case"none":r.key={root:"none",accidentals:[],acc:"",mode:""},h.foundKey=!0,o.shift();break;default:var m=e.getKeyPitch(o[0].token);if(m.len>0){h.foundKey=!0;var v="",w="";o[0].token.length>1?o[0].token=o[0].token.substring(1):o.shift();var N=m.token;if(o.length>0){var B=e.getSharpFlat(o[0].token);if(B.len>0&&(o[0].token.length>1?o[0].token=o[0].token.substring(1):o.shift(),N+=B.token,v=B.token),o.length>0){var x=e.getMode(o[0].token);x.len>0&&(o.shift(),N+=x.token,w=x.token)}if(ue.standardKey(N,m.token,v,0)===void 0)return t("Unsupported key signature: "+N,n,0),h}var g=ue.deepCopyKey(r.key),k=!a&&r.globalTranspose?-r.globalTranspose:0,S;if(a&&(S=r.globalTransposeOrigKeySig),r.key=ue.deepCopyKey(ue.standardKey(N,m.token,v,k)),a&&(r.globalTransposeOrigKeySig=S),r.key.mode=w,g){for(var F,A=0;A<r.key.accidentals.length;A++)for(F=0;F<g.accidentals.length;F++)g.accidentals[F].note&&r.key.accidentals[A].note.toLowerCase()===g.accidentals[F].note.toLowerCase()&&(g.accidentals[F].note=null);for(F=0;F<g.accidentals.length;F++)g.accidentals[F].note&&(r.key.impliedNaturals||(r.key.impliedNaturals=[]),r.key.impliedNaturals.push({acc:"natural",note:g.accidentals[F].note}))}}break}if(o.length===0||(o[0].token==="exp"&&o.shift(),o.length===0)||(o[0].token==="oct"&&o.shift(),o.length===0))return h;var P=e.getKeyAccidentals2(o);if(P.warn&&t(P.warn,n,0),P.accs){h.foundKey||(h.foundKey=!0,r.key={root:"none",acc:"",mode:"",accidentals:[]}),u(P.accs);for(var D=0;D<P.accs.length;D++){for(var L=!1,I=0;I<r.key.accidentals.length&&!L;I++)r.key.accidentals[I].note===P.accs[D].note&&(L=!0,r.key.accidentals[I].acc!==P.accs[D].acc&&(r.key.accidentals[I].acc=P.accs[D].acc,r.key.explicitAccidentals||(r.key.explicitAccidentals=[]),r.key.explicitAccidentals.push(P.accs[D])));if(!L&&(r.key.explicitAccidentals||(r.key.explicitAccidentals=[]),r.key.explicitAccidentals.push(P.accs[D]),r.key.accidentals.push(P.accs[D]),r.key.impliedNaturals))for(var R=0;R<r.key.impliedNaturals.length;R++)r.key.impliedNaturals[R].note===P.accs[D].note&&r.key.impliedNaturals.splice(R,1)}}for(var O;o.length>0;)switch(o[0].token){case"m":case"middle":if(o.shift(),o.length===0)return t("Expected = after middle",n,0),h;if(O=o.shift(),O.token!=="="){t("Expected = after middle",n,O.start);break}if(o.length===0)return t("Expected parameter after middle=",n,0),h;var y=e.getPitchFromTokens(o);y.warn&&t(y.warn,n,0),y.position&&(r.clef.verticalPos=y.position-6);break;case"transpose":if(o.shift(),o.length===0)return t("Expected = after transpose",n,0),h;if(O=o.shift(),O.token!=="="){t("Expected = after transpose",n,O.start);break}if(o.length===0)return t("Expected parameter after transpose=",n,0),h;if(o[0].type!=="number"){t("Expected number after transpose",n,o[0].start);break}r.clef.transpose=o[0].intt,o.shift();break;case"stafflines":if(o.shift(),o.length===0)return t("Expected = after stafflines",n,0),h;if(O=o.shift(),O.token!=="="){t("Expected = after stafflines",n,O.start);break}if(o.length===0)return t("Expected parameter after stafflines=",n,0),h;if(o[0].type!=="number"){t("Expected number after stafflines",n,o[0].start);break}r.clef.stafflines=o[0].intt,o.shift();break;case"staffscale":if(o.shift(),o.length===0)return t("Expected = after staffscale",n,0),h;if(O=o.shift(),O.token!=="="){t("Expected = after staffscale",n,O.start);break}if(o.length===0)return t("Expected parameter after staffscale=",n,0),h;if(o[0].type!=="number"){t("Expected number after staffscale",n,o[0].start);break}r.clef.staffscale=o[0].floatt,o.shift();break;case"octave":if(o.shift(),o.length===0)return t("Expected = after octave",n,0),h;if(O=o.shift(),O.token!=="="){t("Expected = after octave",n,O.start);break}if(o.length===0)return t("Expected parameter after octave=",n,0),h;if(o[0].type!=="number"){t("Expected number after octave",n,o[0].start);break}r.octave=o[0].intt,o.shift();break;case"style":if(o.shift(),o.length===0)return t("Expected = after style",n,0),h;if(O=o.shift(),O.token!=="="){t("Expected = after style",n,O.start);break}if(o.length===0)return t("Expected parameter after style=",n,0),h;switch(o[0].token){case"normal":case"harmonic":case"rhythm":case"x":case"triangle":r.style=o[0].token,o.shift();break;default:t("error parsing style element: "+o[0].token,n,o[0].start);break}break;case"clef":if(o.shift(),o.length===0)return t("Expected = after clef",n,0),h;if(O=o.shift(),O.token!=="="){t("Expected = after clef",n,O.start);break}if(o.length===0)return t("Expected parameter after clef=",n,0),h;case"treble":case"bass":case"alto":case"tenor":case"perc":case"none":var b=o.shift();switch(b.token){case"treble":case"tenor":case"alto":case"bass":case"perc":case"none":break;case"C":b.token="alto";break;case"F":b.token="bass";break;case"G":b.token="treble";break;case"c":b.token="alto";break;case"f":b.token="bass";break;case"g":b.token="treble";break;default:t("Expected clef name. Found "+b.token,n,b.start);break}o.length>0&&o[0].type==="number"&&(b.token+=o[0].token,o.shift()),o.length>1&&(o[0].token==="-"||o[0].token==="+"||o[0].token==="^"||o[0].token==="_")&&o[1].token==="8"&&(b.token+=o[0].token+o[1].token,o.shift(),o.shift()),r.clef={type:b.token,verticalPos:l(b.token,0)},r.currentVoice&&r.currentVoice.transpose!==void 0&&(r.clef.transpose=r.currentVoice.transpose),h.foundClef=!0;break;default:t("Unknown parameter: "+o[0].token,n,o[0].start),o.shift()}return h};var d=function(n){r.currentVoice=r.voices[n],c.setCurrentVoice(r.currentVoice.staffNum,r.currentVoice.index)};ue.parseVoice=function(n,a,o){var h=e.getMeat(n,a,o),m=h.start,v=h.end,w=e.getToken(n,m,v);if(w.length===0){t("Expected a voice id",n,m);return}var N=!1;r.voices[w]===void 0&&(r.voices[w]={},N=!0,r.score_is_present&&t("Can't have an unknown V: id when the %score directive is present",n,m)),m+=w.length,m+=e.eatWhiteSpace(n,m);for(var B={startStaff:N},x=function(y){var b=e.getVoiceToken(n,m,v);b.warn!==void 0?t("Expected value for "+y+" in voice: "+b.warn,n,m):b.err!==void 0?t("Expected value for "+y+" in voice: "+b.err,n,m):b.token.length===0&&n[m]!=='"'?t("Expected value for "+y+" in voice",n,m):B[y]=b.token,m+=b.len},g=function(y,b,T){var C=e.getVoiceToken(n,m,v);C.warn!==void 0?t("Expected value for "+b+" in voice: "+C.warn,n,m):C.err!==void 0?t("Expected value for "+b+" in voice: "+C.err,n,m):C.token.length===0&&n[m]!=='"'?t("Expected value for "+b+" in voice",n,m):(T==="number"&&(C.token=parseFloat(C.token)),r.voices[y][b]=C.token),m+=C.len},k=function(y,b){var T=e.getVoiceToken(n,m,v);if(T.warn!==void 0)t("Expected value for "+y+" in voice: "+T.warn,n,m);else if(T.err!==void 0)t("Expected value for "+y+" in voice: "+T.err,n,m);else if(T.token.length===0&&n[m]!=='"')t("Expected value for "+y+" in voice",n,m);else return b==="number"&&(T.token=parseFloat(T.token)),T.token;m+=T.len},S=function(y,b){var T={_B:2,_E:9,_b:-10,_e:-3},C=e.getVoiceToken(n,m,v);if(C.warn!==void 0)t("Expected one of (_B, _E, _b, _e) for "+b+" in voice: "+C.warn,n,m);else if(C.token.length===0&&n[m]!=='"')t("Expected one of (_B, _E, _b, _e) for "+b+" in voice",n,m);else{var M=T[C.token];M?r.voices[y][b]=M:t("Expected one of (_B, _E, _b, _e) for "+b+" in voice",n,m)}m+=C.len};m<v;){var F=e.getVoiceToken(n,m,v);if(m+=F.len,F.warn)t("Error parsing voice: "+F.warn,n,m);else{var A=null;switch(F.token){case"clef":case"cl":x("clef");var P=0;B.clef!==void 0&&(B.clef=B.clef.replace(/[',]/g,""),B.clef.indexOf("+16")!==-1&&(P+=14,B.clef=B.clef.replace("+16","")),B.verticalPos=l(B.clef,P));break;case"treble":case"bass":case"tenor":case"alto":case"perc":case"none":case"treble'":case"bass'":case"tenor'":case"alto'":case"none'":case"treble''":case"bass''":case"tenor''":case"alto''":case"none''":case"treble,":case"bass,":case"tenor,":case"alto,":case"none,":case"treble,,":case"bass,,":case"tenor,,":case"alto,,":case"none,,":var D=0;B.clef=F.token.replace(/[',]/g,""),B.verticalPos=l(B.clef,D),r.voices[w].clef=F.token;break;case"staves":case"stave":case"stv":x("staves");break;case"brace":case"brc":x("brace");break;case"bracket":case"brk":x("bracket");break;case"name":case"nm":x("name");break;case"subname":case"sname":case"snm":x("subname");break;case"merge":B.startStaff=!1;break;case"stem":case"stems":A=e.getVoiceToken(n,m,v),A.warn!==void 0?t("Expected value for stems in voice: "+A.warn,n,m):A.err!==void 0?t("Expected value for stems in voice: "+A.err,n,m):A.token==="up"||A.token==="down"?r.voices[w].stem=A.token:t("Expected up or down for voice stem",n,m),m+=A.len;break;case"up":case"down":r.voices[w].stem=F.token;break;case"middle":case"m":x("verticalPos"),B.verticalPos=s(B.verticalPos).mid;break;case"gchords":case"gch":r.voices[w].suppressChords=!0,A=e.getVoiceToken(n,m,v),A.token==="0"&&(m=m+A.len);break;case"space":case"spc":x("spacing");break;case"scale":g(w,"scale","number");break;case"score":S(w,"scoreTranspose");break;case"transpose":g(w,"transpose","number");break;case"stafflines":g(w,"stafflines","number");break;case"staffscale":g(w,"staffscale","number");break;case"octave":g(w,"octave","number");break;case"volume":g(w,"volume","number");break;case"cue":var L=k("cue","string");L==="on"?r.voices[w].scale=.6:r.voices[w].scale=1;break;case"style":A=e.getVoiceToken(n,m,v),A.warn!==void 0?t("Expected value for style in voice: "+A.warn,n,m):A.err!==void 0?t("Expected value for style in voice: "+A.err,n,m):A.token==="normal"||A.token==="harmonic"||A.token==="rhythm"||A.token==="x"||A.token==="triangle"?r.voices[w].style=A.token:t("Expected one of [normal, harmonic, rhythm, x, triangle] for voice style",n,m),m+=A.len;break}}m+=e.eatWhiteSpace(n,m)}if((B.startStaff||r.staves.length===0)&&(r.staves.push({index:r.staves.length,meter:r.origMeter}),r.score_is_present||(r.staves[r.staves.length-1].numVoices=0)),r.voices[w].staffNum===void 0){r.voices[w].staffNum=r.staves.length-1;var I=0;for(var R in r.voices)r.voices.hasOwnProperty(R)&&r.voices[R].staffNum===r.voices[w].staffNum&&I++;r.voices[w].index=I-1}var O=r.staves[r.voices[w].staffNum];r.score_is_present||O.numVoices++,B.clef&&(O.clef={type:B.clef,verticalPos:B.verticalPos}),B.spacing&&(O.spacing_below_offset=B.spacing),B.verticalPos&&(O.verticalPos=B.verticalPos),B.name&&(O.name?O.name.push(B.name):O.name=[B.name]),B.subname&&(O.subname?O.subname.push(B.subname):O.subname=[B.subname]),d(w)}})();var se=ue;function Za(e,t,r,f,c){this.reset=function(i,s,u,d){se.initialize(i,s,u,d,c),V.initialize(i,s,u,d,c)},this.reset(e,t,r,f),this.setTitle=function(i,s){r.hasMainTitle?c.addSubtitle(i,{startChar:r.iChar,endChar:r.iChar+s+2}):(c.addMetaText("title",i,{startChar:r.iChar,endChar:r.iChar+s+2}),r.hasMainTitle=!0)},this.setMeter=function(i){if(i=e.stripComment(i),i==="C")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"common_time"};if(i==="C|")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"cut_time"};if(i==="o")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_perfectum"};if(i==="c")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_imperfectum"};if(i==="o.")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_perfectum_prolatio"};if(i==="c.")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_imperfectum_prolatio"};if(i.length===0||i.toLowerCase()==="none")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),null;var s=e.tokenize(i,0,i.length);try{var u=function(){var m={value:0,num:""},v=s.shift();for(v.token==="("&&(v=s.shift());;){if(v.type!=="number")throw"Expected top number of meter";if(m.value+=parseInt(v.token),m.num+=v.token,s.length===0||s[0].token==="/")return m;if(v=s.shift(),v.token===")"){if(s.length===0||s[0].token==="/")return m;throw"Unexpected paren in meter"}if(v.token!=="."&&v.token!=="+"||(m.num+=v.token,s.length===0))throw"Expected top number of meter";v=s.shift()}return m},d=function(){var m=u();if(s.length===0)return m;var v=s.shift();if(v.token!=="/")throw"Expected slash in meter";if(v=s.shift(),v.type!=="number")throw"Expected bottom number of meter";return m.den=v.token,m.value=m.value/parseInt(m.den),m};if(s.length===0)throw"Expected meter definition in M: line";for(var n={type:"specified",value:[]},a=0;;){var o=d();a+=o.value;var h={num:o.num};if(o.den!==void 0&&(h.den=o.den),n.value.push(h),s.length===0)break}return r.havent_set_length===!0&&(r.default_length=a<.75?.0625:.125,r.havent_set_length=!1),n}catch(m){t(m,i,0)}return null},this.calcTempo=function(i){var s=.25;r.meter&&r.meter.type==="specified"?s=1/parseInt(r.meter.value[0].den):r.origMeter&&r.origMeter.type==="specified"&&(s=1/parseInt(r.origMeter.value[0].den));for(var u=0;u<i.duration;u++)i.duration[u]=s*i.duration[u];return i},this.resolveTempo=function(){r.tempo&&(this.calcTempo(r.tempo),f.metaText.tempo=r.tempo,delete r.tempo)},this.addUserDefinition=function(i,s,u){var d=i.indexOf("=",s);if(d===-1){t("Need an = in a macro definition",i,s);return}var n=G.strip(i.substring(s,d)),a=G.strip(i.substring(d+1));if(n.length!==1){t("Macro definitions can only be one character",i,s);return}var o="HIJKLMNOPQRSTUVWXYhijklmnopqrstuvw~";if(o.indexOf(n)===-1){t("Macro definitions must be H-Y, h-w, or tilde",i,s);return}if(a.length===0){t("Missing macro definition",i,s);return}r.macros===void 0&&(r.macros={}),r.macros[n]=a},this.setDefaultLength=function(i,s,u){var d=i.substring(s,u).replace(/ /g,""),n=d.split("/");if(n.length===2){var a=parseInt(n[0]),o=parseInt(n[1]);o>0&&(r.default_length=a/o,r.havent_set_length=!1)}else n.length===1&&n[0]==="1"&&(r.default_length=1,r.havent_set_length=!1)};var p={larghissimo:20,adagissimo:24,sostenuto:28,grave:32,largo:40,lento:50,larghetto:60,adagio:68,adagietto:74,andante:80,andantino:88,"marcia moderato":84,"andante moderato":100,moderato:112,allegretto:116,"allegro moderato":120,allegro:126,animato:132,agitato:140,veloce:148,"mosso vivo":156,vivace:164,vivacissimo:172,allegrissimo:176,presto:184,prestissimo:210};this.setTempo=function(i,s,u,d){try{var n=e.tokenize(i,s,u);if(n.length===0)throw"Missing parameter in Q: field";var a={startChar:d+s-2,endChar:d+u},o=!0,h=n.shift();if(h.type==="quote"&&(a.preString=h.token,h=n.shift(),n.length===0))return p[a.preString.toLowerCase()]&&(a.bpm=p[a.preString.toLowerCase()],a.suppressBpm=!0),{type:"immediate",tempo:a};if(h.type==="alpha"&&h.token==="C"){if(n.length===0)throw"Missing tempo after C in Q: field";if(h=n.shift(),h.type==="punct"&&h.token==="="){if(n.length===0)throw"Missing tempo after = in Q: field";if(h=n.shift(),h.type!=="number")throw"Expected number after = in Q: field";a.duration=[1],a.bpm=parseInt(h.token)}else if(h.type==="number"){if(a.duration=[parseInt(h.token)],n.length===0)throw"Missing = after duration in Q: field";if(h=n.shift(),h.type!=="punct"||h.token!=="=")throw"Expected = after duration in Q: field";if(n.length===0)throw"Missing tempo after = in Q: field";if(h=n.shift(),h.type!=="number")throw"Expected number after = in Q: field";a.bpm=parseInt(h.token)}else throw"Expected number or equal after C in Q: field"}else if(h.type==="number"){var m=parseInt(h.token);if(n.length===0||n[0].type==="quote")a.duration=[1],a.bpm=m;else{if(o=!1,h=n.shift(),h.type!=="punct"&&h.token!=="/"||(h=n.shift(),h.type!=="number"))throw"Expected fraction in Q: field";var v=parseInt(h.token);for(a.duration=[m/v];n.length>0&&n[0].token!=="="&&n[0].type!=="quote";){if(h=n.shift(),h.type!=="number"||(m=parseInt(h.token),h=n.shift(),h.type!=="punct"&&h.token!=="/")||(h=n.shift(),h.type!=="number"))throw"Expected fraction in Q: field";v=parseInt(h.token),a.duration.push(m/v)}if(h=n.shift(),h.type!=="punct"&&h.token!=="=")throw"Expected = in Q: field";if(h=n.shift(),h.type!=="number")throw"Expected tempo in Q: field";a.bpm=parseInt(h.token)}}else throw"Unknown value in Q: field";if(n.length!==0&&(h=n.shift(),h.type==="quote"&&(a.postString=h.token,h=n.shift()),n.length!==0))throw"Unexpected string at end of Q: field";return r.printTempo===!1&&(a.suppress=!0),{type:o?"delaySet":"immediate",tempo:a}}catch(w){return t(w,i,s),{type:"none"}}},this.letter_to_inline_header=function(i,s,u){var d=e.eatWhiteSpace(i,s);if(s+=d,i.length>=s+5&&i[s]==="["&&i[s+2]===":"){var n=i.indexOf("]",s),a=r.iChar+s,o=r.iChar+n+1;switch(i.substring(s,s+3)){case"[I:":var h=V.addDirective(i.substring(s+3,n));return h&&t(h,i,s),[n-s+1+d];case"[M:":var m=this.setMeter(i.substring(s+3,n));return c.hasBeginMusic()&&m?c.appendStartingElement("meter",a,o,m):r.meter=m,[n-s+1+d];case"[K:":var v=se.parseKey(i.substring(s+3,n),!0);return v.foundClef&&c.hasBeginMusic()&&c.appendStartingElement("clef",a,o,r.clef),v.foundKey&&c.hasBeginMusic()&&c.appendStartingElement("key",a,o,se.fixKey(r.clef,r.key)),[n-s+1+d];case"[P:":var w=V.parseFontChangeLine(i.substring(s+3,n));return u||f.lines.length<=f.lineNum?r.partForNextLine={title:w,startChar:a,endChar:o}:c.appendElement("part",a,o,{title:w}),[n-s+1+d];case"[L:":return this.setDefaultLength(i,s+3,n),[n-s+1+d];case"[Q:":if(n>0){var N=this.setTempo(i,s+3,n,r.iChar);return N.type==="delaySet"?c.hasBeginMusic()?c.appendElement("tempo",a,o,this.calcTempo(N.tempo)):r.tempoForNextLine=["tempo",a,o,this.calcTempo(N.tempo)]:N.type==="immediate"&&(!u&&c.hasBeginMusic()?c.appendElement("tempo",a,o,N.tempo):r.tempoForNextLine=["tempo",a,o,N.tempo]),[n-s+1+d,i[s+1],i.substring(s+3,n)]}break;case"[V:":if(n>0)return se.parseVoice(i,s+3,n),[n-s+1+d,i[s+1],i.substring(s+3,n)];break;case"[r:":return[n-s+1+d];default:}}return[0]},this.letter_to_body_header=function(i,s){if(i.length>=s+3)switch(i.substring(s,s+2)){case"I:":var u=V.addDirective(i.substring(s+2));return u&&t(u,i,s),[i.length];case"M:":var d=this.setMeter(i.substring(s+2));return c.hasBeginMusic()&&d&&c.appendStartingElement("meter",r.iChar+s,r.iChar+i.length,d),[i.length];case"K:":var n=se.parseKey(i.substring(s+2),c.hasBeginMusic());return n.foundClef&&c.hasBeginMusic()&&c.appendStartingElement("clef",r.iChar+s,r.iChar+i.length,r.clef),n.foundKey&&c.hasBeginMusic()&&c.appendStartingElement("key",r.iChar+s,r.iChar+i.length,se.fixKey(r.clef,r.key)),[i.length];case"P:":return c.hasBeginMusic()&&c.appendElement("part",r.iChar+s,r.iChar+i.length,{title:i.substring(s+2)}),[i.length];case"L:":return this.setDefaultLength(i,s+2,i.length),[i.length];case"Q:":var a=i.indexOf("",s+2);a===-1&&(a=i.length);var o=this.setTempo(i,s+2,a,r.iChar);return o.type==="delaySet"?c.appendElement("tempo",r.iChar+s,r.iChar+i.length,this.calcTempo(o.tempo)):o.type==="immediate"&&c.appendElement("tempo",r.iChar+s,r.iChar+i.length,o.tempo),[a,i[s],G.strip(i.substring(s+2))];case"V:":return se.parseVoice(i,s+2,i.length),[i.length,i[s],G.strip(i.substring(s+2))];default:}return[0]};var l={A:"author",B:"book",C:"composer",D:"discography",F:"url",G:"group",I:"instruction",N:"notes",O:"origin",R:"rhythm",S:"source",W:"unalignedWords",Z:"transcription"};this.parseHeader=function(i){var s=l[i[0]],u=i.length-2,d=e.translateString(e.stripComment(i.substring(2)));if(s==="unalignedWords"||s==="notes")c.addMetaTextArray(s,V.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+i.length});else if(s!==void 0)c.addMetaText(s,V.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+i.length});else{var n=r.iChar,a=n+i.length;switch(i[0]){case"H":for(c.addMetaTextArray("history",V.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+i.length}),i=e.peekLine();i&&i[1]!==":";)e.nextLine(),c.addMetaTextArray("history",V.parseFontChangeLine(e.translateString(e.stripComment(i))),{startChar:r.iChar,endChar:r.iChar+i.length}),i=e.peekLine();break;case"K":this.resolveTempo();var o=se.parseKey(i.substring(2),!1);!r.is_in_header&&c.hasBeginMusic()&&(o.foundClef&&c.appendStartingElement("clef",n,a,r.clef),o.foundKey&&c.appendStartingElement("key",n,a,se.fixKey(r.clef,r.key))),r.is_in_header=!1;break;case"L":this.setDefaultLength(i,2,i.length);break;case"M":r.origMeter=r.meter=this.setMeter(i.substring(2));break;case"P":r.is_in_header?c.addMetaText("partOrder",V.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+i.length}):r.partForNextLine={title:d,startChar:n,endChar:a};break;case"Q":var h=this.setTempo(i,2,i.length,r.iChar);h.type==="delaySet"?r.tempo=h.tempo:h.type==="immediate"&&(f.metaText.tempo?r.tempoForNextLine=["tempo",n,a,h.tempo]:f.metaText.tempo=h.tempo);break;case"T":r.titlecaps&&(d=d.toUpperCase()),this.setTitle(V.parseFontChangeLine(e.theReverser(d)),u);break;case"U":this.addUserDefinition(i,2,i.length);break;case"V":if(se.parseVoice(i,2,i.length),!r.is_in_header)return{newline:!0};break;case"s":return{symbols:!0};case"w":return{words:!0};case"X":break;case"E":case"m":t("Ignored header",i,0);break;default:return{regular:!0}}}return{}}}var _n=["trill","lowermordent","uppermordent","mordent","pralltriller","accent","fermata","invertedfermata","tenuto","0","1","2","3","4","5","+","wedge","open","thumb","snap","turn","roll","breath","shortphrase","mediumphrase","longphrase","segno","coda","D.S.","D.C.","fine","beambr1","beambr2","slide","marcato","upbow","downbow","/","//","///","////","trem1","trem2","trem3","trem4","turnx","invertedturn","invertedturnx","trill(","trill)","arpeggio","xstem","mark","umarcato","style=normal","style=harmonic","style=rhythm","style=x","style=triangle","D.C.alcoda","D.C.alfine","D.S.alcoda","D.S.alfine","editorial","courtesy"],Bn=["p","pp","f","ff","mf","mp","ppp","pppp","fff","ffff","sfz"],Dn=["crescendo(","crescendo)","diminuendo(","diminuendo)","glissando(","glissando)","~(","~)"],Ln=[["<","accent"],[">","accent"],["tr","trill"],["plus","+"],["emphasis","accent"],["^","umarcato"],["marcato","umarcato"]],Fn=[["<(","crescendo("],["<)","crescendo)"],[">(","diminuendo("],[">)","diminuendo)"]],Ja="ABCDEFGabcdefgxyzZ[]|^_{",Ya=[.5,.75,.875,.9375,.96875,.984375,.25,.375,.4375,.46875,.484375,.4921875,.125,.1875,.21875,.234375,.2421875,.24609375,.0625,.09375,.109375,.1171875,.12109375,.123046875,.03125,.046875,.0546875,.05859375,.060546875,.0615234375,.015625,.0234375,.02734375,.029296875,.0302734375,.03076171875],Va={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11},ei={x:"invisible",X:"invisible-multimeasure",y:"spacer",z:"rest",Z:"multimeasure"},An={dblflat:"__",flat:"_",natural:"=",sharp:"^",dblsharp:"^^",quarterflat:"_/",quartersharp:"^/"},ti={2:3,3:2,4:3,5:2,6:2,7:2,8:3,9:2};var Z,Y,E,ke,De,Dt;function Ft(e,t,r,f,c,p){Z=e,Y=t,E=r,ke=f,De=c,Dt=p,this.lineContinuation=!1}var ri=function(e,t,r){if(e.inTie[t]===void 0)return!1;var f=e.currentVoice?e.currentVoice.staffNum*100+e.currentVoice.index:0;return!!(e.inTie[t][f]&&(r.pitches!==void 0||r.rest.type!=="spacer"))},_={};Ft.prototype.parseMusic=function(e){Dt.resolveTempo(),E.is_in_header=!1;for(var t=0,r=E.iChar;Z.isWhiteSpace(e[t])&&t<e.length;)t++;if(!(t===e.length||e[t]==="%")){var f=E.start_new_line;E.continueall===void 0?E.start_new_line=!0:E.start_new_line=!1;var c=0,p=Dt.letter_to_body_header(e,t);p[0]>0&&(t+=p[0],p[1]==="V"&&this.startNewLine());for(var l=0;t<e.length;){var i=t;if(e[t]==="%")break;var s=Dt.letter_to_inline_header(e,t,f);if(s[0]>0)t+=s[0],s[1]==="V"&&(f=!0);else{(!De.hasBeginMusic()||f&&!this.lineContinuation)&&(this.startNewLine(),f=!1);for(var u;;)if(u=Z.eatWhiteSpace(e,t),u>0&&(t+=u),t>0&&e[t-1]===""&&(u=Dt.letter_to_body_header(e,t),u[0]>0&&(u[1]==="V"&&this.startNewLine(),t=u[0],E.start_new_line=!1)),u=hf(e,t),u[0]>0&&(t+=u[0]),u=cf(e,t),u[0]>0){_.chord||(_.chord=[]);var d=Z.translateString(u[1]);d=d.replace(/;/g,`
`);for(var n=!1,a=0;a<_.chord.length;a++)_.chord[a].position===u[2]&&(n=!0,_.chord[a].name+=`
`+d);n===!1&&(u[2]===null&&u[3]?_.chord.push({name:d,rel_position:u[3]}):_.chord.push({name:d,position:u[2]})),t+=u[0];var o=Z.skipWhiteSpace(e.substring(t));o>0&&(_.force_end_beam_last=!0),t+=o}else if(Ja.indexOf(e[t])===-1?u=ai(e,t):u=[0],u[0]>0)u[1]===null?t+1<e.length&&this.startNewLine():u[1].length>0&&(u[1].indexOf("style=")===0?_.style=u[1].substr(6):(_.decoration===void 0&&(_.decoration=[]),u[1]==="beambr1"?_.beambr=1:u[1]==="beambr2"?_.beambr=2:_.decoration.push(u[1]))),t+=u[0];else if(u=lf(e,t),u[0]>0)_.gracenotes=u[1],t+=u[0];else break;if(u=pf(e,t),u[0]>0){l=0,_.gracenotes!==void 0&&(_.rest={type:"spacer"},_.duration=.125,E.addFormattingOptions(_,ke.formatting,"note"),De.appendElement("note",r+t,r+t+u[0],_),E.measureNotEmpty=!0,_={});var h={type:u[1]};if(h.type.length===0)Y("Unknown bar type",e,t);else{if(E.inEnding&&h.type!=="bar_thin"&&(h.endEnding=!0,E.inEnding=!1),u[2]&&(h.startEnding=u[2],E.inEnding&&(h.endEnding=!0),E.inEnding=!0,u[1]==="bar_right_repeat"?E.restoreStartEndingHoldOvers():E.duplicateStartEndingHoldOvers()),_.decoration!==void 0&&(h.decoration=_.decoration),_.chord!==void 0&&(h.chord=_.chord),h.startEnding&&E.barFirstEndingNum===void 0?E.barFirstEndingNum=E.currBarNumber:h.startEnding&&h.endEnding&&E.barFirstEndingNum?E.currBarNumber=E.barFirstEndingNum:h.endEnding&&(E.barFirstEndingNum=void 0),h.type!=="bar_invisible"&&E.measureNotEmpty){var m=E.currentVoice===void 0||E.currentVoice.staffNum===0&&E.currentVoice.index===0;m&&(E.currBarNumber++,E.barNumbers&&E.currBarNumber%E.barNumbers===0&&(h.barNumber=E.currBarNumber))}E.addFormattingOptions(_,ke.formatting,"bar"),De.appendElement("bar",r+i,r+t+u[0],h),E.measureNotEmpty=!1,_={}}t+=u[0]}else if(e[t]==="&")u=uf(e,t),u[0]>0&&(De.appendElement("overlay",r,r+1,{}),t+=1,l++);else{if(u=df(e,t),u.consumed>0&&(u.startSlur!==void 0&&(_.startSlur=u.startSlur),u.dottedSlur&&(_.dottedSlur=!0),u.triplet!==void 0&&(c>0?Y("Can't nest triplets",e,t):(_.startTriplet=u.triplet,_.tripletMultiplier=u.tripletQ/u.triplet,_.tripletR=u.num_notes,c=u.num_notes===void 0?u.triplet:u.num_notes)),t+=u.consumed),e[t]==="["){var v=t;t++;for(var w=null,N=!1,B=!1;!B;){var x=ai(e,t);x[0]>0&&(t+=x[0]);var g=Mn(e,t,{},!1);if(g!==null&&g.pitch!==void 0)x[0]>0&&x[1].indexOf("style=")!==0&&(_.decoration===void 0&&(_.decoration=[]),_.decoration.push(x[1])),g.end_beam&&(_.end_beam=!0,delete g.end_beam),_.pitches===void 0?(_.duration=g.duration,_.pitches=[g]):_.pitches.push(g),delete g.duration,x[0]>0&&x[1].indexOf("style=")===0&&(_.pitches[_.pitches.length-1].style=x[1].substr(6)),E.inTieChord[_.pitches.length]&&(g.endTie=!0,E.inTieChord[_.pitches.length]=void 0),g.startTie&&(E.inTieChord[_.pitches.length]=!0),t=g.endChar,delete g.endChar;else if(e[t]===" ")Y("Spaces are not allowed in chords",e,t),t++;else{if(t<e.length&&e[t]==="]"){t++,E.next_note_duration!==0&&(_.duration=_.duration*E.next_note_duration,E.next_note_duration=0),ri(E,l,_)&&(_.pitches.forEach(function(L){L.endTie=!0}),Bt(E,l,!1)),c>0&&!(_.rest&&_.rest.type==="spacer")&&(c--,c===0&&(_.endTriplet=!0));for(var k=!1;t<e.length&&!k;){switch(e[t]){case" ":case"	":Lt(_);break;case")":_.endSlur===void 0?_.endSlur=1:_.endSlur++;break;case"-":_.pitches.forEach(function(L){L.startTie={}}),Bt(E,l,!0);break;case">":case"<":var S=ii(e,t);t+=S[0]-1,E.next_note_duration=S[2],w?w=w*S[1]:w=S[1];break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"/":var F=Z.getFraction(e,t);w=F.value,t=F.index;var A=e[t];A===" "&&(N=!0),A==="-"||A===")"||A===" "||A==="<"||A===">"?t--:k=!0;break;default:k=!0;break}k||t++}}else Y("Expected ']' to end the chords",e,t);_.pitches!==void 0&&(w!==null&&(_.duration=_.duration*w,N&&Lt(_)),E.addFormattingOptions(_,ke.formatting,"note"),De.appendElement("note",r+i,r+t,_),E.measureNotEmpty=!0,_={}),B=!0}}}else{var P={},D=Mn(e,t,P,!0);P.endTie!==void 0&&Bt(E,l,!0),D!==null&&(D.pitch!==void 0?(_.pitches=[{}],D.accidental!==void 0&&(_.pitches[0].accidental=D.accidental),_.pitches[0].pitch=D.pitch,_.pitches[0].name=D.name,(D.midipitch||D.midipitch===0)&&(_.pitches[0].midipitch=D.midipitch),D.endSlur!==void 0&&(_.pitches[0].endSlur=D.endSlur),D.endTie!==void 0&&(_.pitches[0].endTie=D.endTie),D.startSlur!==void 0&&(_.pitches[0].startSlur=D.startSlur),_.startSlur!==void 0&&(_.pitches[0].startSlur=_.startSlur),_.dottedSlur!==void 0&&(_.pitches[0].dottedSlur=!0),D.startTie!==void 0&&(_.pitches[0].startTie=D.startTie),_.startTie!==void 0&&(_.pitches[0].startTie=_.startTie)):(_.rest=D.rest,D.endSlur!==void 0&&(_.endSlur=D.endSlur),D.endTie!==void 0&&(_.rest.endTie=D.endTie),D.startSlur!==void 0&&(_.startSlur=D.startSlur),D.startTie!==void 0&&(_.rest.startTie=D.startTie),_.startTie!==void 0&&(_.rest.startTie=_.startTie)),D.chord!==void 0&&(_.chord=D.chord),D.duration!==void 0&&(_.duration=D.duration),D.decoration!==void 0&&(_.decoration=D.decoration),D.graceNotes!==void 0&&(_.graceNotes=D.graceNotes),delete _.startSlur,delete _.dottedSlur,ri(E,l,_)&&(_.pitches!==void 0?_.pitches[0].endTie=!0:_.rest.type!=="spacer"&&(_.rest.endTie=!0),Bt(E,l,!1)),(D.startTie||_.startTie)&&Bt(E,l,!0),t=D.endChar,c>0&&!(D.rest&&D.rest.type==="spacer")&&(c--,c===0&&(_.endTriplet=!0)),D.end_beam&&Lt(_),_.rest&&_.rest.type==="rest"&&_.duration===1&&ni(E)<=1&&(_.rest.type="whole",_.duration=ni(E)),_.duration<1&&Ya.indexOf(_.duration)===-1&&_.duration!==0&&(!_.rest||_.rest.type!=="spacer")&&Y("Duration not representable: "+e.substring(i,t),e,t),E.addFormattingOptions(_,ke.formatting,"note"),De.appendElement("note",r+i,r+t,_),E.measureNotEmpty=!0,_={})}t===i&&(e[t]!==" "&&e[t]!=="`"&&Y("Unknown character ignored",e,t),t++)}}}this.lineContinuation=e.indexOf("")>=0||p[0]>0,this.lineContinuation||(_={})}};var Bt=function(e,t,r){var f=e.currentVoice?e.currentVoice.staffNum*100+e.currentVoice.index:0;e.inTie[t]===void 0&&(e.inTie[t]=[]),e.inTie[t][f]=r},cf=function(e,t){if(e[t]==='"'){var r=Z.getBrackettedSubstring(e,t,5);if(r[2]||Y("Missing the closing quote while parsing the chord symbol",e,t),r[0]>0&&r[1].length>0&&r[1][0]==="^")r[1]=r[1].substring(1),r[2]="above";else if(r[0]>0&&r[1].length>0&&r[1][0]==="_")r[1]=r[1].substring(1),r[2]="below";else if(r[0]>0&&r[1].length>0&&r[1][0]==="<")r[1]=r[1].substring(1),r[2]="left";else if(r[0]>0&&r[1].length>0&&r[1][0]===">")r[1]=r[1].substring(1),r[2]="right";else if(r[0]>0&&r[1].length>0&&r[1][0]==="@"){r[1]=r[1].substring(1);var f=Z.getFloat(r[1]);f.digits===0&&Y("Missing first position in absolutely positioned annotation.",e,t),r[1]=r[1].substring(f.digits),r[1][0]!==","&&Y("Missing comma absolutely positioned annotation.",e,t),r[1]=r[1].substring(1);var c=Z.getFloat(r[1]);c.digits===0&&Y("Missing second position in absolutely positioned annotation.",e,t),r[1]=r[1].substring(c.digits);var p=Z.skipWhiteSpace(r[1]);r[1]=r[1].substring(p),r[2]=null,r[3]={x:f.value,y:c.value}}else E.freegchord!==!0&&(r[1]=r[1].replace(/([ABCDEFG0-9])b/g,"$1â™­"),r[1]=r[1].replace(/([ABCDEFG0-9])#/g,"$1â™¯"),r[1]=r[1].replace(/^([ABCDEFG])([â™¯â™­]?)o([^A-Za-z])/g,"$1$2Â°$3"),r[1]=r[1].replace(/^([ABCDEFG])([â™¯â™­]?)o$/g,"$1$2Â°"),r[1]=r[1].replace(/^([ABCDEFG])([â™¯â™­]?)0([^A-Za-z])/g,"$1$2Ã¸$3"),r[1]=r[1].replace(/^([ABCDEFG])([â™¯â™­]?)\^([^A-Za-z])/g,"$1$2âˆ†$3")),r[2]="default",r[1]=_t.chordName(E,r[1]);return r}return[0,""]},lf=function(e,t){if(e[t]==="{"){var r=Z.getBrackettedSubstring(e,t,1,"}");r[2]||Y("Missing the closing '}' while parsing grace note",e,t),e[t+r[0]]===")"&&(r[0]++,r[1]+=")");for(var f=[],c=0,p=!1;c<r[1].length;){var l=!1;r[1][c]==="/"&&(l=!0,c++);var i=Mn(r[1],c,{},!1);i!==null?(i.duration=i.duration/(E.default_length*8),l&&(i.acciaccatura=!0),f.push(i),p&&(i.endTie=!0,p=!1),i.startTie&&(p=!0),c=i.endChar,delete i.endChar,i.end_beam&&(i.endBeam=!0,delete i.end_beam)):(r[1][c]===" "?f.length>0&&(f[f.length-1].endBeam=!0):Y("Unknown character '"+r[1][c]+"' while parsing grace note",e,t),c++)}if(f.length)return[r[0],f]}return[0]};function uf(e,t){if(e[t]==="&"){for(var r=t;e[t]&&e[t]!==":"&&e[t]!=="|";)t++;return[t-r,e.substring(r+1,t)]}return[0]}function ni(e){var t=e.origMeter;return!t||t.type!=="specified"||!t.value||t.value.length===0?1:parseInt(t.value[0].num,10)/parseInt(t.value[0].den,10)}var ai=function(e,t){var r=E.macros[e[t]];if(r!==void 0)return(r[0]==="!"||r[0]==="+")&&(r=r.substring(1)),(r[r.length-1]==="!"||r[r.length-1]==="+")&&(r=r.substring(0,r.length-1)),_n.includes(r)?[1,r]:Bn.includes(r)?(E.volumePosition==="hidden"&&(r=""),[1,r]):Dn.includes(r)?(E.dynamicPosition==="hidden"&&(r=""),[1,r]):(E.ignoredDecorations.includes(r)||Y("Unknown macro: "+r,e,t),[1,""]);switch(e[t]){case".":if(e[t+1]==="("||e[t+1]==="-")break;return[1,"staccato"];case"u":return[1,"upbow"];case"v":return[1,"downbow"];case"~":return[1,"irishroll"];case"!":case"+":var f=Z.getBrackettedSubstring(e,t,5);if(f[1].length>1&&(f[1][0]==="^"||f[1][0]==="_")&&(f[1]=f[1].substring(1)),_n.includes(f[1]))return f;if(Bn.includes(f[1]))return E.volumePosition==="hidden"&&(f[1]=""),f;if(Dn.includes(f[1]))return E.dynamicPosition==="hidden"&&(f[1]=""),f;var c=Ln.findIndex(function(p){return f[1]===p[0]});return c>=0?(f[1]=Ln[c][1],f):(c=Fn.findIndex(function(p){return f[1]===p[0]}),c>=0?(f[1]=Fn[c][1],E.dynamicPosition==="hidden"&&(f[1]=""),f):e[t]==="!"&&(f[0]===1||e[t+f[0]-1]!=="!")?[1,null]:(Y("Unknown decoration: "+f[1],e,t),f[1]="",f));case"H":return[1,"fermata"];case"J":return[1,"slide"];case"L":return[1,"accent"];case"M":return[1,"mordent"];case"O":return[1,"coda"];case"P":return[1,"pralltriller"];case"R":return[1,"roll"];case"S":return[1,"segno"];case"T":return[1,"trill"]}return[0,0]},hf=function(e,t){for(var r=t;Z.isWhiteSpace(e[t]);)t++;return[t-r]},pf=function(e,t){var r=Z.getBarLine(e,t);if(r.len===0)return[0,""];if(r.warn)return Y(r.warn,e,t),[r.len,""];for(var f=0;f<e.length&&e[t+r.len+f]===" ";f++);var c=r.len;if(e[t+r.len+f]==="["&&(r.len+=f+1),e[t+r.len]==='"'&&e[t+r.len-1]==="["){var p=Z.getBrackettedSubstring(e,t+r.len,5);return[r.len+p[0],r.token,p[1]]}var l=Z.getTokenOf(e.substring(t+r.len),"1234567890-,");return l.len===0||l.token[0]==="-"?[c,r.token]:[r.len+l.len,r.token,l.token]},df=function(e,t){var r={},f=t;for(e[t]==="."&&e[t+1]==="("&&(r.dottedSlur=!0,t++);e[t]==="("||Z.isWhiteSpace(e[t]);)e[t]==="("&&(t+1<e.length&&e[t+1]>="2"&&e[t+1]<="9"?(r.triplet!==void 0?Y("Can't nest triplets",e,t):(r.triplet=e[t+1]-"0",r.tripletQ=ti[r.triplet],r.num_notes=r.triplet,t+2<e.length&&e[t+2]===":"&&(t+3<e.length&&e[t+3]===":"?t+4<e.length&&e[t+4]>="1"&&e[t+4]<="9"?(r.num_notes=e[t+4]-"0",t+=3):Y("expected number after the two colons after the triplet to mark the duration",e,t):t+3<e.length&&e[t+3]>="1"&&e[t+3]<="9"?(r.tripletQ=e[t+3]-"0",t+4<e.length&&e[t+4]===":"?t+5<e.length&&e[t+5]>="1"&&e[t+5]<="9"&&(r.num_notes=e[t+5]-"0",t+=4):t+=2):Y("expected number after the triplet to mark the duration",e,t))),t++):r.startSlur===void 0?r.startSlur=1:r.startSlur++),t++;return r.consumed=t-f,r};Ft.prototype.startNewLine=function(){var e={startChar:-1,endChar:-1};E.partForNextLine.title&&(e.part=E.partForNextLine),e.clef=E.currentVoice&&E.staves[E.currentVoice.staffNum].clef!==void 0?G.clone(E.staves[E.currentVoice.staffNum].clef):G.clone(E.clef);var t=E.currentVoice?E.currentVoice.scoreTranspose:0;if(e.key=se.standardKey(E.key.root+E.key.acc+E.key.mode,E.key.root,E.key.acc,t),e.key.mode=E.key.mode,E.key.impliedNaturals&&(e.key.impliedNaturals=E.key.impliedNaturals),E.key.explicitAccidentals)for(var r=0;r<E.key.explicitAccidentals.length;r++){for(var f=!1,c=0;c<e.key.accidentals.length;c++)e.key.accidentals[c].note===E.key.explicitAccidentals[r].note&&(e.key.accidentals[c].acc=E.key.explicitAccidentals[r].acc,f=!0);f||e.key.accidentals.push(E.key.explicitAccidentals[r])}if(E.targetKey=e.key,e.key.explicitAccidentals&&delete e.key.explicitAccidentals,se.addPosToKey(e.clef,e.key),E.meter!==null?(E.currentVoice?(E.staves.forEach(function(i){i.meter=E.meter}),e.meter=E.staves[E.currentVoice.staffNum].meter,E.staves[E.currentVoice.staffNum].meter=null):e.meter=E.meter,E.meter=null):E.currentVoice&&E.staves[E.currentVoice.staffNum].meter&&(e.meter=E.staves[E.currentVoice.staffNum].meter,E.staves[E.currentVoice.staffNum].meter=null),E.currentVoice&&E.currentVoice.name&&(e.name=E.currentVoice.name),E.vocalfont&&(e.vocalfont=E.vocalfont),E.tripletfont&&(e.tripletfont=E.tripletfont),E.gchordfont&&(e.gchordfont=E.gchordfont),E.style&&(e.style=E.style),E.currentVoice){var p=E.staves[E.currentVoice.staffNum];p.brace&&(e.brace=p.brace),p.bracket&&(e.bracket=p.bracket),p.connectBarLines&&(e.connectBarLines=p.connectBarLines),p.name&&(e.name=p.name[E.currentVoice.index]),p.subname&&(e.subname=p.subname[E.currentVoice.index]),E.currentVoice.stem&&(e.stem=E.currentVoice.stem),E.currentVoice.stafflines&&(e.stafflines=E.currentVoice.stafflines),E.currentVoice.staffscale&&(e.staffscale=E.currentVoice.staffscale),E.currentVoice.scale&&(e.scale=E.currentVoice.scale),E.currentVoice.color&&(e.color=E.currentVoice.color),E.currentVoice.style&&(e.style=E.currentVoice.style),E.currentVoice.transpose&&(e.clef.transpose=E.currentVoice.transpose)}var l=E.currentVoice===void 0||E.currentVoice.staffNum===0&&E.currentVoice.index===0;E.barNumbers===0&&l&&E.currBarNumber!==1&&(e.barNumber=E.currBarNumber),De.startNewLine(e),E.key.impliedNaturals&&delete E.key.impliedNaturals,E.partForNextLine={},E.tempoForNextLine.length===4&&De.appendElement(E.tempoForNextLine[0],E.tempoForNextLine[1],E.tempoForNextLine[2],E.tempoForNextLine[3]),E.tempoForNextLine=[]};var Lt=function(e){return e.duration!==void 0&&e.duration<.25&&(e.end_beam=!0),e},Mn=function(e,t,r,f){var c=function(a){return a==="octave"||a==="duration"||a==="Zduration"||a==="broken_rhythm"||a==="end_slur"},p;e[t]==="."&&e[t+1]==="-"&&(p=!0,t++);for(var l="startSlur",i=!1;;){switch(e[t]){case"(":if(l==="startSlur")r.startSlur===void 0?r.startSlur=1:r.startSlur++;else return c(l)?(r.endChar=t,r):null;break;case")":if(c(l))r.endSlur===void 0?r.endSlur=1:r.endSlur++;else return null;break;case"^":if(l==="startSlur")r.accidental="sharp",l="sharp2";else if(l==="sharp2")r.accidental="dblsharp",l="pitch";else return c(l)?(r.endChar=t,r):null;break;case"_":if(l==="startSlur")r.accidental="flat",l="flat2";else if(l==="flat2")r.accidental="dblflat",l="pitch";else return c(l)?(r.endChar=t,r):null;break;case"=":if(l==="startSlur")r.accidental="natural",l="pitch";else return c(l)?(r.endChar=t,r):null;break;case"A":case"B":case"C":case"D":case"E":case"F":case"G":case"a":case"b":case"c":case"d":case"e":case"f":case"g":if(l==="startSlur"||l==="sharp2"||l==="flat2"||l==="pitch"){if(r.pitch=Va[e[t]],r.pitch+=7*(E.currentVoice&&E.currentVoice.octave!==void 0?E.currentVoice.octave:E.octave),r.name=e[t],r.accidental&&(r.name=An[r.accidental]+r.name),_t.note(E,r),l="octave",f&&E.next_note_duration!==0?(r.duration=E.default_length*E.next_note_duration,E.next_note_duration=0,i=!0):r.duration=E.default_length,E.clef&&E.clef.type==="perc"||E.currentVoice&&E.currentVoice.clef==="perc"){var s=e[t];r.accidental&&(s=An[r.accidental]+s),ke.formatting&&ke.formatting.midi&&ke.formatting.midi.drummap&&(r.midipitch=ke.formatting.midi.drummap[s])}}else return c(l)?(r.endChar=t,r):null;break;case",":if(l==="octave")r.pitch-=7,r.name+=",";else return c(l)?(r.endChar=t,r):null;break;case"'":if(l==="octave")r.pitch+=7,r.name+="'";else return c(l)?(r.endChar=t,r):null;break;case"x":case"X":case"y":case"z":case"Z":if(l==="startSlur")r.rest={type:ei[e[t]]},delete r.accidental,delete r.startSlur,delete r.startTie,delete r.endSlur,delete r.endTie,delete r.end_beam,delete r.grace_notes,r.rest.type.indexOf("multimeasure")>=0?(r.duration=ke.getBarLength(),r.rest.text=1,l="Zduration"):(f&&E.next_note_duration!==0?(r.duration=E.default_length*E.next_note_duration,E.next_note_duration=0,i=!0):r.duration=E.default_length,l="duration");else return c(l)?(r.endChar=t,r):null;break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":case"/":if(l==="octave"||l==="duration"){var u=Z.getFraction(e,t);for(r.duration=r.duration*u.value,r.endChar=u.index;u.index<e.length&&(Z.isWhiteSpace(e[u.index])||e[u.index]==="-");)e[u.index]==="-"?r.startTie={}:r=Lt(r),u.index++;t=u.index-1,l="broken_rhythm"}else if(l==="sharp2")r.accidental="quartersharp",l="pitch";else if(l==="flat2")r.accidental="quarterflat",l="pitch";else if(l==="Zduration"){var d=Z.getNumber(e,t);return r.duration=d.num*ke.getBarLength(),r.rest.text=d.num,r.endChar=d.index,r}else return null;break;case"-":if(l==="startSlur")De.addTieToLastNote(p),r.endTie=!0;else if(l==="octave"||l==="duration"||l==="end_slur")if(r.startTie={},!i&&f)l="broken_rhythm";else return Z.isWhiteSpace(e[t+1])&&Lt(r),r.endChar=t+1,r;else return l==="broken_rhythm"?(r.endChar=t,r):null;break;case" ":case"	":if(c(l)){r.end_beam=!0,p=!1;do e[t]==="."&&e[t+1]==="-"&&(p=!0,t++),e[t]==="-"&&(r.startTie={},p&&(r.startTie.style="dotted")),t++;while(t<e.length&&(Z.isWhiteSpace(e[t])||e[t]==="-")||e[t]==="."&&e[t+1]==="-");if(r.endChar=t,!i&&f&&(e[t]==="<"||e[t]===">"))t--,l="broken_rhythm";else return r}else return null;break;case">":case"<":if(c(l))if(f){var n=ii(e,t);t+=n[0]-1,E.next_note_duration=n[2],r.duration=n[1]*r.duration,l="end_slur"}else return r.endChar=t,r;else return null;break;default:return c(l)?(r.endChar=t,r):null}if(t++,t===e.length)return c(l)?(r.endChar=t,r):null}return null},ii=function(e,t){switch(e[t]){case">":return t<e.length-2&&e[t+1]===">"&&e[t+2]===">"?[3,1.875,.125]:t<e.length-1&&e[t+1]===">"?[2,1.75,.25]:[1,1.5,.5];case"<":return t<e.length-2&&e[t+1]==="<"&&e[t+2]==="<"?[3,.125,1.875]:t<e.length-1&&e[t+1]==="<"?[2,.25,1.75]:[1,.5,1.5]}return null};var Sn=function(e,t){this.lineIndex=0,this.lines=e,this.multilineVars=t,this.skipWhiteSpace=function(n){for(var a=0;a<n.length;a++)if(!this.isWhiteSpace(n[a]))return a;return n.length};var r=function(n,a){return a>=n.length};this.eatWhiteSpace=function(n,a){for(var o=a;o<n.length;o++)if(!this.isWhiteSpace(n[o]))return o-a;return o-a},this.getKeyPitch=function(n){var a=this.skipWhiteSpace(n);if(r(n,a))return{len:0};switch(n[a]){case"A":return{len:a+1,token:"A"};case"B":return{len:a+1,token:"B"};case"C":return{len:a+1,token:"C"};case"D":return{len:a+1,token:"D"};case"E":return{len:a+1,token:"E"};case"F":return{len:a+1,token:"F"};case"G":return{len:a+1,token:"G"}}return{len:0}},this.getSharpFlat=function(n){if(n==="bass")return{len:0};switch(n[0]){case"#":return{len:1,token:"#"};case"b":return{len:1,token:"b"}}return{len:0}},this.getMode=function(n){var a=function(m,v){for(;v<m.length&&(m[v]>="a"&&m[v]<="z"||m[v]>="A"&&m[v]<="Z");)v++;return v},o=this.skipWhiteSpace(n);if(r(n,o))return{len:0};var h=n.substring(o,o+3).toLowerCase();switch((h.length>1&&h[1]===" "||h[1]==="^"||h[1]==="_"||h[1]==="=")&&(h=h[0]),h){case"mix":return{len:a(n,o),token:"Mix"};case"dor":return{len:a(n,o),token:"Dor"};case"phr":return{len:a(n,o),token:"Phr"};case"lyd":return{len:a(n,o),token:"Lyd"};case"loc":return{len:a(n,o),token:"Loc"};case"aeo":return{len:a(n,o),token:"m"};case"maj":return{len:a(n,o),token:""};case"ion":return{len:a(n,o),token:""};case"min":return{len:a(n,o),token:"m"};case"m":return{len:a(n,o),token:"m"}}return{len:0}},this.getClef=function(n,a){var o=n,h=this.skipWhiteSpace(n);if(r(n,h))return{len:0};var m=!1,v=n.substring(h);if(G.startsWith(v,"clef=")&&(m=!0,v=v.substring(5),h+=5),v.length===0&&m)return{len:h+5,warn:"No clef specified: "+o};var w=this.skipWhiteSpace(v);if(r(v,w))return{len:0};w>0&&(h+=w,v=v.substring(w));var N=null;if(G.startsWith(v,"treble"))N="treble";else if(G.startsWith(v,"bass3"))N="bass3";else if(G.startsWith(v,"bass"))N="bass";else if(G.startsWith(v,"tenor"))N="tenor";else if(G.startsWith(v,"alto2"))N="alto2";else if(G.startsWith(v,"alto1"))N="alto1";else if(G.startsWith(v,"alto"))N="alto";else if(!a&&m&&G.startsWith(v,"none"))N="none";else if(G.startsWith(v,"perc"))N="perc";else if(!a&&m&&G.startsWith(v,"C"))N="tenor";else if(!a&&m&&G.startsWith(v,"F"))N="bass";else if(!a&&m&&G.startsWith(v,"G"))N="treble";else return{len:h+5,warn:"Unknown clef specified: "+o};return v=v.substring(N.length),w=this.isMatch(v,"+8"),w>0?N+="+8":(w=this.isMatch(v,"-8"),w>0&&(N+="-8")),{len:h+N.length,token:N,explicit:m}},this.getBarLine=function(n,a){switch(n[a]){case"]":switch(++a,n[a]){case"|":return{len:2,token:"bar_thick_thin"};case"[":return++a,n[a]>="1"&&n[a]<="9"||n[a]==='"'?{len:2,token:"bar_invisible"}:{len:1,warn:"Unknown bar symbol"};default:return{len:1,token:"bar_invisible"}}break;case":":switch(++a,n[a]){case":":return{len:2,token:"bar_dbl_repeat"};case"|":switch(++a,n[a]){case"]":switch(++a,n[a]){case"|":return++a,n[a]===":"?{len:5,token:"bar_dbl_repeat"}:{len:3,token:"bar_right_repeat"};default:return{len:3,token:"bar_right_repeat"}}break;case"|":return++a,n[a]===":"?{len:4,token:"bar_dbl_repeat"}:{len:3,token:"bar_right_repeat"};default:return{len:2,token:"bar_right_repeat"}}break;default:return{len:1,warn:"Unknown bar symbol"}}break;case"[":if(++a,n[a]==="|")switch(++a,n[a]){case":":return{len:3,token:"bar_left_repeat"};case"]":return{len:3,token:"bar_invisible"};default:return{len:2,token:"bar_thick_thin"}}else return n[a]>="1"&&n[a]<="9"||n[a]==='"'?{len:1,token:"bar_invisible"}:{len:0};break;case"|":switch(++a,n[a]){case"]":return{len:2,token:"bar_thin_thick"};case"|":return++a,n[a]===":"?{len:3,token:"bar_left_repeat"}:{len:2,token:"bar_thin_thin"};case":":for(var o=0;n[a+o]===":";)o++;return{len:1+o,token:"bar_left_repeat"};default:return{len:1,token:"bar_thin"}}break}return{len:0}},this.getTokenOf=function(n,a){for(var o=0;o<n.length;o++)if(a.indexOf(n[o])<0)return{len:o,token:n.substring(0,o)};return{len:o,token:n}},this.getToken=function(n,a,o){for(var h=a;h<o&&!this.isWhiteSpace(n[h]);)h++;return n.substring(a,h)},this.isMatch=function(n,a){var o=this.skipWhiteSpace(n);return r(n,o)?0:G.startsWith(n.substring(o),a)?o+a.length:0},this.getPitchFromTokens=function(n){var a={},o={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11};if(a.position=o[n[0].token],a.position===void 0)return{warn:"Pitch expected. Found: "+n[0].token};for(n.shift();n.length;)switch(n[0].token){case",":a.position-=7,n.shift();break;case"'":a.position+=7,n.shift();break;default:return a}return a},this.getKeyAccidentals2=function(n){for(var a;n.length>0;){var o;if(n[0].token==="^"){if(o="sharp",n.shift(),n.length===0)return{accs:a,warn:"Expected note name after "+o};switch(n[0].token){case"^":o="dblsharp",n.shift();break;case"/":o="quartersharp",n.shift();break}}else if(n[0].token==="=")o="natural",n.shift();else if(n[0].token==="_"){if(o="flat",n.shift(),n.length===0)return{accs:a,warn:"Expected note name after "+o};switch(n[0].token){case"_":o="dblflat",n.shift();break;case"/":o="quarterflat",n.shift();break}}else return{accs:a};if(n.length===0)return{accs:a,warn:"Expected note name after "+o};switch(n[0].token[0]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":a===void 0&&(a=[]),a.push({acc:o,note:n[0].token[0]}),n[0].token.length===1?n.shift():n[0].token=n[0].token.substring(1);break;default:return{accs:a,warn:"Expected note name after "+o+" Found: "+n[0].token}}}return{accs:a}},this.getKeyAccidental=function(n){var a={"^":"sharp","^^":"dblsharp","=":"natural",_:"flat",__:"dblflat","_/":"quarterflat","^/":"quartersharp"},o=this.skipWhiteSpace(n);if(r(n,o))return{len:0};var h=null;switch(n[o]){case"^":case"_":case"=":h=n[o];break;default:return{len:0}}if(o++,r(n,o))return{len:1,warn:"Expected note name after accidental"};switch(n[o]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":return{len:o+1,token:{acc:a[h],note:n[o]}};case"^":case"_":case"/":if(h+=n[o],o++,r(n,o))return{len:2,warn:"Expected note name after accidental"};switch(n[o]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":return{len:o+1,token:{acc:a[h],note:n[o]}};default:return{len:2,warn:"Expected note name after accidental"}}break;default:return{len:1,warn:"Expected note name after accidental"}}},this.isWhiteSpace=function(n){return n===" "||n==="	"||n===""},this.getMeat=function(n,a,o){var h=n.indexOf("%",a);for(h>=0&&h<o&&(o=h);a<o&&(n[a]===" "||n[a]==="	"||n[a]==="");)a++;for(;a<o&&(n[o-1]===" "||n[o-1]==="	"||n[o-1]==="");)o--;return{start:a,end:o}};var f=function(n){return n>="A"&&n<="Z"||n>="a"&&n<="z"},c=function(n){return n>="0"&&n<="9"};this.tokenize=function(n,a,o,h){var m=this.getMeat(n,a,o);a=m.start,o=m.end;for(var v=[],w;a<o;){if(n[a]==='"'){for(w=a+1;w<o&&n[w]!=='"';)w++;v.push({type:"quote",token:n.substring(a+1,w),start:a+1,end:w}),w++}else if(f(n[a])){if(w=a+1,h)for(;w<o&&!this.isWhiteSpace(n[w]);)w++;else for(;w<o&&f(n[w]);)w++;v.push({type:"alpha",token:n.substring(a,w),continueId:c(n[w]),start:a,end:w}),a=w+1}else if(n[a]==="."&&c(n[w+1])){w=a+1;for(var N=null,B=null;w<o&&c(n[w]);)w++;B=parseFloat(n.substring(a,w)),v.push({type:"number",token:n.substring(a,w),intt:N,floatt:B,continueId:f(n[w]),start:a,end:w}),a=w+1}else if(c(n[a])||n[a]==="-"&&c(n[w+1])){w=a+1;for(var x=null,g=null;w<o&&c(n[w]);)w++;if(n[w]==="."&&c(n[w+1]))for(w++;w<o&&c(n[w]);)w++;else x=parseInt(n.substring(a,w));g=parseFloat(n.substring(a,w)),v.push({type:"number",token:n.substring(a,w),intt:x,floatt:g,continueId:f(n[w]),start:a,end:w}),a=w+1}else n[a]===" "||n[a]==="	"||v.push({type:"punct",token:n[a],start:a,end:a+1}),w=a+1;a=w}return v},this.getVoiceToken=function(n,a,o){for(var h=a;h<o&&this.isWhiteSpace(n[h])||n[h]==="=";)h++;if(n[h]==='"'){var m=n.indexOf('"',h+1);return m===-1||m>=o?{len:1,err:"Missing close quote"}:{len:m-a+1,token:this.translateString(n.substring(h+1,m))}}else{for(var v=h;v<o&&!this.isWhiteSpace(n[v])&&n[v]!=="=";)v++;return{len:v-a+1,token:n.substring(h,v)}}};var p={"`a":"Ã ","'a":"Ã¡","^a":"Ã¢","~a":"Ã£",'"a':"Ã¤",oa:"Ã¥",aa:"Ã¥","=a":"Ä",ua:"Äƒ",";a":"Ä…","`e":"Ã¨","'e":"Ã©","^e":"Ãª",'"e':"Ã«","=e":"Ä“",ue:"Ä•",";e":"Ä™",".e":"Ä—","`i":"Ã¬","'i":"Ã­","^i":"Ã®",'"i':"Ã¯","=i":"Ä«",ui:"Ä­",";i":"Ä¯","`o":"Ã²","'o":"Ã³","^o":"Ã´","~o":"Ãµ",'"o':"Ã¶","=o":"Å",uo:"Å","/o":"Ã¸","`u":"Ã¹","'u":"Ãº","^u":"Ã»","~u":"Å©",'"u':"Ã¼",ou:"Å¯","=u":"Å«",uu:"Å­",";u":"Å³","`A":"Ã€","'A":"Ã","^A":"Ã‚","~A":"Ãƒ",'"A':"Ã„",oA:"Ã…",AA:"Ã…","=A":"Ä€",uA:"Ä‚",";A":"Ä„","`E":"Ãˆ","'E":"Ã‰","^E":"ÃŠ",'"E':"Ã‹","=E":"Ä’",uE:"Ä”",";E":"Ä˜",".E":"Ä–","`I":"ÃŒ","'I":"Ã","^I":"ÃŽ","~I":"Ä¨",'"I':"Ã","=I":"Äª",uI:"Ä¬",";I":"Ä®",".I":"Ä°","`O":"Ã’","'O":"Ã“","^O":"Ã”","~O":"Ã•",'"O':"Ã–","=O":"ÅŒ",uO:"ÅŽ","/O":"Ã˜","`U":"Ã™","'U":"Ãš","^U":"Ã›","~U":"Å¨",'"U':"Ãœ",oU:"Å®","=U":"Åª",uU:"Å¬",";U":"Å²",ae:"Ã¦",AE:"Ã†",oe:"Å“",OE:"Å’",ss:"ÃŸ","'c":"Ä‡","^c":"Ä‰",uc:"Ä",cc:"Ã§",".c":"Ä‹",cC:"Ã‡","'C":"Ä†","^C":"Äˆ",uC:"ÄŒ",".C":"ÄŠ","~N":"Ã‘","~n":"Ã±","=s":"Å¡",vs:"Å¡",DH:"Ã",dh:"Ã°",HO:"Å",Ho:"Å‘",HU:"Å°",Hu:"Å±","'Y":"Ã","'y":"Ã½","^Y":"Å¶","^y":"Å·",'"Y':"Å¸",'"y':"Ã¿",vS:"Å ",vZ:"Å½",vz:"Å¾"},l={"#":"â™¯",b:"â™­","=":"â™®"},i={201:"â™¯",202:"â™­",203:"â™®",241:"Â¡",242:"Â¢",252:"a",262:"2",272:"o",302:"Ã‚",312:"ÃŠ",322:"Ã’",332:"Ãš",342:"Ã¢",352:"Ãª",362:"Ã²",372:"Ãº",243:"Â£",253:"Â«",263:"3",273:"Â»",303:"Ãƒ",313:"Ã‹",323:"Ã“",333:"Ã›",343:"Ã£",353:"Ã«",363:"Ã³",373:"Ã»",244:"Â¤",254:"Â¬",264:"  Ì",274:"1â„4",304:"Ã„",314:"ÃŒ",324:"Ã”",334:"Ãœ",344:"Ã¤",354:"Ã¬",364:"Ã´",374:"Ã¼",245:"Â¥",255:"-",265:"Î¼",275:"1â„2",305:"Ã…",315:"Ã",325:"Ã•",335:"Ã",345:"Ã¥",355:"Ã­",365:"Ãµ",375:"Ã½",246:"Â¦",256:"Â®",266:"Â¶",276:"3â„4",306:"Ã†",316:"ÃŽ",326:"Ã–",336:"Ãž",346:"Ã¦",356:"Ã®",366:"Ã¶",376:"Ã¾",247:"Â§",257:" Ì„",267:"Â·",277:"Â¿",307:"Ã‡",317:"Ã",327:"Ã—",337:"ÃŸ",347:"Ã§",357:"Ã¯",367:"Ã·",377:"Ã¿",250:" Ìˆ",260:"Â°",270:" Ì§",300:"Ã€",310:"Ãˆ",320:"Ã",330:"Ã˜",340:"Ã ",350:"Ã¨",360:"Ã°",370:"Ã¸",251:"Â©",261:"Â±",271:"1",301:"Ã",311:"Ã‰",321:"Ã‘",331:"Ã™",341:"Ã¡",351:"Ã©",361:"Ã±",371:"Ã¹"};this.translateString=function(n){var a=n.split("\\");if(a.length===1)return n;var o=null;return a.forEach(function(h){if(o===null)o=h;else{var m=p[h.substring(0,2)];m!==void 0?o+=m+h.substring(2):(m=i[h.substring(0,3)],m!==void 0?o+=m+h.substring(3):(m=l[h.substring(0,1)],m!==void 0?o+=m+h.substring(1):o+="\\"+h))}}),o},this.getNumber=function(n,a){for(var o=0;a<n.length;)switch(n[a]){case"0":o=o*10,a++;break;case"1":o=o*10+1,a++;break;case"2":o=o*10+2,a++;break;case"3":o=o*10+3,a++;break;case"4":o=o*10+4,a++;break;case"5":o=o*10+5,a++;break;case"6":o=o*10+6,a++;break;case"7":o=o*10+7,a++;break;case"8":o=o*10+8,a++;break;case"9":o=o*10+9,a++;break;default:return{num:o,index:a}}return{num:o,index:a}},this.getFraction=function(n,a){var o=1,h=1;if(n[a]!=="/"){var m=this.getNumber(n,a);o=m.num,a=m.index}if(n[a]==="/")if(a++,n[a]==="/"){for(var v=.5;n[a++]==="/";)v=v/2;return{value:o*v,index:a-1}}else{var w=a,N=this.getNumber(n,a);N.num===0&&w===a&&(N.num=2),N.num!==0&&(h=N.num),a=N.index}return{value:o/h,index:a}};function s(n){let o=/^(\d+)\./.exec(n);return o?o[1]:null}var u=[{match:/,\s*[Tt]he$/,replace:"The "},{match:/,\s*[Aa]$/,replace:"A "},{match:/,\s*[Aa]n$/,replace:"An "}];this.theReverser=function(n){for(var a=0;a<u.length;a++){var o=u[a],h=n.match(o.match);if(h){var m=s(n);m&&(n=n.replace(m+".",""),n=n.trim());var v=h[0].length,w=o.replace+n.substring(0,n.length-v);return m&&(w=m+". "+w),w}}return n},this.stripComment=function(n){var a=n.indexOf("%");return a>=0?G.strip(n.substring(0,a)):G.strip(n)},this.getInt=function(n){var a=parseInt(n);if(isNaN(a))return{digits:0};var o=""+a,h=n.indexOf(o);return{value:a,digits:h+o.length}},this.getFloat=function(n){var a=parseFloat(n);if(isNaN(a))return{digits:0};var o=""+a,h=n.indexOf(o);return{value:a,digits:h+o.length}},this.getMeasurement=function(n){if(n.length===0)return{used:0};var a=1,o="";if(n[0].token==="-")n.shift(),o="-",a++;else if(n[0].type!=="number")return{used:0};if(o+=n.shift().token,n.length===0)return{used:1,value:parseInt(o)};var h=n.shift();if(h.token==="."){if(a++,n.length===0)return{used:a,value:parseInt(o)};if(n[0].type==="number"&&(h=n.shift(),o=o+"."+h.token,a++,n.length===0))return{used:a,value:parseFloat(o)};h=n.shift()}switch(h.token){case"pt":return{used:a+1,value:parseFloat(o)};case"px":return{used:a+1,value:parseFloat(o)};case"cm":return{used:a+1,value:parseFloat(o)/2.54*72};case"in":return{used:a+1,value:parseFloat(o)*72};default:return n.unshift(h),{used:a,value:parseFloat(o)}}};var d=function(n){return n=n.replace(/\\n/g,`
`),n=n.replace(/\\"/g,'"'),n};this.getBrackettedSubstring=function(n,a,o,h){for(var m=h||n[a],v=a+1,w=!1;v<n.length&&(w||n[v]!==m);)w=n[v]==="\\",++v;return n[v]===m?[v-a+1,d(n.substring(a+1,v)),!0]:(v=a+o,v>n.length-1&&(v=n.length-1),[v-a+1,d(n.substring(a+1,v)),!1])}};Sn.prototype.peekLine=function(){return this.lines[this.lineIndex]};Sn.prototype.nextLine=function(){if(this.lineIndex>0&&(this.multilineVars.iChar+=this.lines[this.lineIndex-1].length+1),this.lineIndex<this.lines.length){var e=this.lines[this.lineIndex];return this.lineIndex++,e}return null};var si=Sn;function mf(e,t,r){if(!(!t||e.lines.length===0)){var f=e.deline({lineBreaks:!1}),c=vf(f,t);e.lines=gf(f,c,r),e.lineBreaks=c}}function gf(e,t,r){for(var f=[],c=[],p=[],l=1,i=0;i<t.length;i++){var s=t[i];if(e[s.ogLine].staff){var u=e[s.ogLine].staff[s.staff];if(f[s.line]||(f[s.line]={staff:[]}),!f[s.line].staff[s.staff]){f[s.line].staff[s.staff]={voices:[]},r!==void 0&&s.staff===0&&s.line>0&&(f[s.line].staff[s.staff].barNumber=l);for(var d=Object.keys(u),n=0;n<d.length;n++){var a=d[n]==="voices";d[n]==="meter"&&s.line!==0&&(a=!0),a||(f[s.line].staff[s.staff][d[n]]=u[d[n]])}c[s.staff]&&(f[s.line].staff[s.staff].key=c[s.staff])}f[s.line].staff[s.staff].voices[s.voice]||(f[s.line].staff[s.staff].voices[s.voice]=[]),f[s.line].staff[s.staff].voices[s.voice]=e[s.ogLine].staff[s.staff].voices[s.voice].slice(s.start,s.end+1),p[s.staff*10+s.voice]&&f[s.line].staff[s.staff].voices[s.voice].unshift({el_type:"stem",direction:p[s.staff*10+s.voice].direction});for(var o=f[s.line].staff[s.staff].voices[s.voice],h=o.length-1;h>=0;h--)if(o[h].el_type==="key"){c[s.staff]={root:o[h].root,acc:o[h].acc,mode:o[h].mode,accidentals:o[h].accidentals.filter(function(v){return v.acc!=="natural"})};break}for(h=o.length-1;h>=0;h--)if(o[h].el_type==="stem"){p[s.staff*10+s.voice]={direction:o[h].direction};break}if(r!==void 0&&s.staff===0&&s.voice===0)for(h=0;h<o.length;h++)o[h].el_type==="bar"&&(l++,h===o.length-1?delete o[h].barNumber:o[h].barNumber=l)}else f[s.line]=e[s.ogLine]}for(var m=0;m<f.length;m++)f[m].staff&&(f[m].staff=f[m].staff.filter(function(v){return v!=null}));return f}function vf(e,t){for(var r=[],f=0,c=0,p=0,l=0;l<e.length;l++){var i=e[l];if(i.staff){var s=c,u=t[f];f++;for(var d=0;d<i.staff.length;d++)for(var n=i.staff[d],a=0;a<n.voices.length;a++){p=s;for(var o=0,h=0,m=n.voices[a],v=0,w=0;w<m.length;w++){var N=m[w];N.el_type==="bar"&&(u[h]===o&&(r.push({ogLine:l,line:p,staff:d,voice:a,start:v,end:w}),v=w+1,p++,c=Math.max(c,p),h++),o++)}r.push({ogLine:l,line:p,staff:d,voice:a,start:v,end:m.length}),p++,c=Math.max(c,p)}}else r.push({ogLine:l,line:p}),p++,c=Math.max(c,p)}return r}function bf(e,t){for(var r=[],f=[],c=0,p=0;p<e.length;p++){var l=e[p],i=c+l;if(i<t)c=i;else{var s=t-c,u=i-t;s<u&&c>0?(r.push(p-1),f.push(Math.round(c-l)),c=l):p<e.length-1&&(r.push(p),f.push(Math.round(c)),c=0)}}return f.push(Math.round(c)),{lineBreaks:r,totals:f}}function lr(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return t}function yf(e,t,r,f,c,p,l,i,s,u,d){for(var n=u;n<e.length;n++){var a=e[n];r+=a,f+=a;var o=Math.abs(r-t[i]),h=Math.abs(o-p)<t[0]/10;if(h)if(o<p){var m=lr(c),v=lr(s);v.push(n-1),m.push(f-a),d.push({accumulator:r,lineAccumulator:a,lineWidths:m,lastVariance:Math.abs(r-t[i+1]),highestVariance:Math.max(l,p),currLine:i+1,lineBreaks:v,startIndex:n+1})}else o>p&&n<e.length-1&&(m=lr(c),v=lr(s),d.push({accumulator:r,lineAccumulator:f,lineWidths:m,lastVariance:o,highestVariance:Math.max(l,o),currLine:i,lineBreaks:v,startIndex:n+1}));o>p?(s.push(n-1),i++,l=Math.max(l,p),p=Math.abs(r-t[i]),c.push(f-a),f=a):p=o}c.push(f)}function xf(e,t,r,f){for(var c=Math.ceil(e.total/t),p=Math.floor(e.total/c),l=[],i=0;i<c;i++)l.push(p*(i+1));var s=[];s.push({accumulator:0,lineAccumulator:0,lineWidths:[],lastVariance:999999,highestVariance:0,currLine:0,lineBreaks:[],startIndex:0});for(var u=0;u<s.length;)yf(e.measureWidths,l,s[u].accumulator,s[u].lineAccumulator,s[u].lineWidths,s[u].lastVariance,s[u].highestVariance,s[u].currLine,s[u].lineBreaks,s[u].startIndex,s),u++;for(i=0;i<s.length;i++){var d=s[i];d.variances=[],d.aveVariance=0;for(var n=0;n<d.lineWidths.length;n++){var a=d.lineWidths[n];d.variances.push(a-l[0]),d.aveVariance+=Math.abs(a-l[0])}d.aveVariance=d.aveVariance/d.lineWidths.length,f.attempts.push({type:"optimizeLineWidths",lineBreaks:d.lineBreaks,variances:d.variances,aveVariance:d.aveVariance,widths:e.measureWidths})}var o=9999999,h=-1;for(i=0;i<s.length;i++)d=s[i],d.aveVariance<o&&(o=d.aveVariance,h=i);return{failed:!1,lineBreaks:s[h].lineBreaks,variance:s[h].highestVariance}}function wf(e,t,r){for(var f=[],c=[],p=0,l=!1,i=0;i<e.length;i++)p+=e[i],p>t&&(l=!0),i%r===r-1&&(i!==e.length-1&&f.push(i),c.push(Math.round(p)),p=0);return{failed:l,totals:c,lineBreaks:f}}function Ef(e,t,r){var f={lineBreaks:e,staffwidth:t};for(var c in r)r.hasOwnProperty(c)&&c!=="wrap"&&c!=="staffwidth"&&(f[c]=r[c]);return{revisedParams:f}}function Cf(e,t,r){if(t.length===0||r.staffwidth<t[0].left)return{reParse:!1,explanation:"Staff width is narrower than the margin",revisedParams:r};var f=r.scale?Math.max(r.scale,.1):1,c=r.wrap.minSpacing?Math.max(parseFloat(r.wrap.minSpacing),1):1,p=r.wrap.minSpacingLimit?Math.max(parseFloat(r.wrap.minSpacingLimit),1):c-.1,l=r.wrap.maxSpacing?Math.max(parseFloat(r.wrap.maxSpacing),1):void 0;r.wrap.lastLineLimit&&!l&&(l=Math.max(parseFloat(r.wrap.lastLineLimit),1));for(var i=r.wrap.preferredMeasuresPerLine?Math.max(parseInt(r.wrap.preferredMeasuresPerLine,10),0):void 0,s=[],u=[],d=0;d<t.length;d++){var n=t[d],a=r.staffwidth-n.left,o=a/c/f,h=a/l/f,m=a/p/f,v={widths:n,lineBreakPoint:o,minLineSize:h,attempts:[],staffWidth:r.staffwidth,minWidth:Math.round(m)},w=null;if(i){var N=wf(n.measureWidths,o,i);v.attempts.push({type:"Fixed Measures Per Line",preferredMeasuresPerLine:i,lineBreaks:N.lineBreaks,failed:N.failed,totals:N.totals}),N.failed||(w=N.lineBreaks)}if(!w){var B=bf(n.measureWidths,o);v.attempts.push({type:"Free Form",lineBreaks:B.lineBreaks,totals:B.totals}),w=B.lineBreaks,w.length>0&&n.measureWidths.length<25&&(B=xf(n,o,w,v),v.attempts.push({type:"Optimize",failed:B.failed,reason:B.reason,lineBreaks:B.lineBreaks,totals:B.totals}),B.failed||(w=B.lineBreaks))}s.push(w),u.push(v)}var x=r.staffwidth,g=Ef(s,x,r);return g.explanation=u,g.reParse=!0,g}var oi={wrapLines:mf,calcLineWraps:Cf};var Ae={};Ae.FONTEM=360;Ae.FONTSIZE=30;Ae.STEP=Ae.FONTSIZE*93/720;Ae.SPACE=10;Ae.TOPNOTE=15;Ae.STAVEHEIGHT=100;Ae.INDENT=50;var Pn=Ae;function In(e,t){t||(t={});for(var r=!!t.lineBreaks,f=[],c=!1,p=[],l=[],i=[],s=[],u=[],d=[],n=[],a=0;a<e.length;a++){var o=e[a];if(o.staff){if(c&&!o.vskip)for(var h=f[f.length-1],m=0;m<h.staff.length;m++){var v=o.staff[m],w=h.staff[m];if(v&&(Xe(v.meter,p[m])||(kf(v.meter,v.voices),p[m]=v.meter,delete v.meter),Xe(v.key,l[m])||(Nf(v.key,v.voices),l[m]=v.key,delete v.key),v.title&&(w.abbrevTitle=v.title),Xe(v.clef,i[m])||(Tf(v.clef,v.voices),i[m]=v.clef,delete v.clef),Xe(v.vocalfont,s[m])||(ur(v.vocalfont,v.voices,"vocalfont"),s[m]=v.vocalfont,delete v.vocalfont),Xe(v.gchordfont,u[m])||(ur(v.gchordfont,v.voices,"gchordfont"),u[m]=v.gchordfont,delete v.gchordfont),Xe(v.tripletfont,d[m])||(ur(v.tripletfont,v.voices,"tripletfont"),d[m]=v.tripletfont,delete v.tripletfont),Xe(v.annotationfont,n[m])||(ur(v.annotationfont,v.voices,"annotationfont"),n[m]=v.annotationfont,delete v.annotationfont)),v)for(var N=0;N<w.voices.length;N++){var B=w.voices[N],x=v.voices[N];r&&B.push({el_type:"break"}),x&&(w.voices[N]=B.concat(x))}}else{for(var g=0;g<o.staff.length;g++)l[g]=o.staff[g].key,p[g]=o.staff[g].meter,i[g]=o.staff[g].clef;f.push(_f(o))}c=!0}else c=!1,f.push(o)}return f}function fi(e,t){return e==="abselem"?"abselem":t}function kf(e,t){e.el_type="meter",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function Nf(e,t){e.el_type="key",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function Tf(e,t){e.el_type="clef",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function ur(e,t,r){e.el_type="font",e.type=r,e.startChar=-1,e.endChar=-1;for(var f=0;f<t.length;f++)t[f].unshift(e)}function Xe(e,t){if(!e)return!0;var r=JSON.stringify(e,fi),f=JSON.stringify(t,fi);return r===f}function _f(e){for(var t={},r=Object.keys(e),f=0;f<r.length;f++)if(r[f]!=="staff")t[r[f]]=e[r[f]];else{t.staff=[];for(var c=0;c<e.staff.length;c++){for(var p={},l=Object.keys(e.staff[c]),i=0;i<l.length;i++)if(l[i]!=="voices")p[l[i]]=e.staff[c][l[i]];else{p.voices=[];for(var s=0;s<e.staff[c].voices.length;s++)p.voices.push([].concat(e.staff[c].voices[s]))}t.staff.push(p)}}return t}function On(){this.reset=function(){this.version="1.1.0",this.media="screen",this.metaText={},this.metaTextInfo={},this.formatting={},this.lines=[],this.staffNum=0,this.voiceNum=0,this.lineNum=0,this.runningFonts={},delete this.visualTranspose},this.reset();function e(l,i,s,u){for(var d=0;d<u.length;d++)l[s][u[d]]=i[s][u[d]]}this.copyTopInfo=function(l){var i=["tempo","title","header","rhythm","origin","composer","author","partOrder"];e(this,l,"metaText",i),e(this,l,"metaTextInfo",i)},this.copyBottomInfo=function(l){var i=["unalignedWords","book","source","discography","notes","transcription","history","abc-copyright","abc-creator","abc-edited-by","footer"];e(this,l,"metaText",i),e(this,l,"metaTextInfo",i)},this.getBeatLength=function(){var l=this.getMeterFraction(),i=1;return(l.num===6||l.num===9||l.num===12||l.num===3&&l.den===8)&&(i=3),i/l.den};function t(l,i){for(var s=0,u=0;u<l.length;u++)if(l[u].staff)for(var d=0;d<l[u].staff.length;d++)for(var n=0;n<l[u].staff[d].voices.length;n++)for(var a=l[u].staff[d].voices[n],o=1,h=0;h<a.length;h++){var m=a[h].rest&&a[h].rest.type==="spacer";if(a[h].startTriplet&&(o=a[h].tripletMultiplier),a[h].duration&&!m&&a[h].el_type!=="tempo"&&(s+=a[h].duration*o),a[h].endTriplet&&(o=1),s>=i&&(s-=i),a[h].el_type==="bar")return s}return s}this.getPickupLength=function(){var l=this.getBarLength(),i=t(this.lines,l);return i<1e-8||l-i<1e-8?0:i},this.getBarLength=function(){var l=this.getMeterFraction();return l.num/l.den},this.getTotalTime=function(){return this.totalTime},this.getTotalBeats=function(){return this.totalBeats},this.millisecondsPerMeasure=function(l){var i;if(l)i=l;else{var s=this.metaText?this.metaText.tempo:null;i=this.getBpm(s)}i<=0&&(i=1);var u=this.getBeatsPerMeasure(),d=u/i;return d*6e4},this.getBeatsPerMeasure=function(){var l=this.getBeatLength(),i=this.getBarLength();return i/l},this.getMeter=function(){for(var l=0;l<this.lines.length;l++){var i=this.lines[l];if(i.staff)for(var s=0;s<i.staff.length;s++){var u=i.staff[s].meter;if(u)return u}}return{type:"common_time"}},this.getMeterFraction=function(){var l=this.getMeter(),i=4,s=4;return l&&(l.type==="specified"?(i=parseInt(l.value[0].num,10),s=parseInt(l.value[0].den,10)):l.type==="cut_time"?(i=2,s=2):l.type==="common_time"&&(i=4,s=4)),this.meter={num:i,den:s},this.meter},this.getKeySignature=function(){for(var l=0;l<this.lines.length;l++){var i=this.lines[l];if(i.staff){for(var s=0;s<i.staff.length;s++)if(i.staff[s].key)return i.staff[s].key}}return{}},this.getElementFromChar=function(l){for(var i=0;i<this.lines.length;i++){var s=this.lines[i];if(s.staff)for(var u=0;u<s.staff.length;u++)for(var d=s.staff[u],n=0;n<d.voices.length;n++)for(var a=d.voices[n],o=0;o<a.length;o++){var h=a[o];if(h.startChar&&h.endChar&&h.startChar<=l&&h.endChar>l)return h}}return null};function r(l){for(var i,s,u,d,n=l.length-1;n>=0;n--){var a=l[n];a.type==="bar"?(a.top=u,a.nextTop=i,i=u,a.bottom=d,a.nextBottom=s,s=d):a.type==="event"&&(u=a.top,d=a.top+a.height)}}function f(l){var i=[];for(var s in l)l.hasOwnProperty(s)&&i.push(l[s]);return i=i.sort(function(u,d){var n=u.milliseconds-d.milliseconds;return n!==0?n:u.type==="bar"?-1:1}),i}this.addElementToEvents=function(l,i,s,u,d,n,a,o,h,m){if(i.hint)return{isTiedState:void 0,duration:0};var v=i.durationClass?i.durationClass:i.duration;if(i.abcelem.rest&&i.abcelem.rest.type==="spacer"&&(v=0),v>0){for(var w=[],N=0;N<i.elemset.length;N++)i.elemset[N]!==null&&w.push(i.elemset[N]);var B=i.startTie;if(h!==void 0)l["event"+h].elements.push(w),m&&(l["event"+s]||(l["event"+s]={type:"event",milliseconds:s,line:n,measureNumber:a,top:u,height:d,left:null,width:0,elements:[],startChar:null,endChar:null,startCharArray:[],endCharArray:[]}),l["event"+s].measureStart=!0,m=!1),B||(h=void 0);else{if(!l["event"+s])l["event"+s]={type:"event",milliseconds:s,line:n,measureNumber:a,top:u,height:d,left:i.x,width:i.w,elements:[w],startChar:i.abcelem.startChar,endChar:i.abcelem.endChar,startCharArray:[i.abcelem.startChar],endCharArray:[i.abcelem.endChar],midiPitches:i.abcelem.midiPitches?G.cloneArray(i.abcelem.midiPitches):[]},i.abcelem.midiGraceNotePitches&&(l["event"+s].midiGraceNotePitches=G.cloneArray(i.abcelem.midiGraceNotePitches));else{if(l["event"+s].left?l["event"+s].left=Math.min(l["event"+s].left,i.x):l["event"+s].left=i.x,l["event"+s].elements.push(w),l["event"+s].startCharArray.push(i.abcelem.startChar),l["event"+s].endCharArray.push(i.abcelem.endChar),l["event"+s].startChar===null&&(l["event"+s].startChar=i.abcelem.startChar),l["event"+s].endChar===null&&(l["event"+s].endChar=i.abcelem.endChar),i.abcelem.midiPitches&&i.abcelem.midiPitches.length){l["event"+s].midiPitches||(l["event"+s].midiPitches=[]);for(var N=0;N<i.abcelem.midiPitches.length;N++)l["event"+s].midiPitches.push(i.abcelem.midiPitches[N])}if(i.abcelem.midiGraceNotePitches&&i.abcelem.midiGraceNotePitches.length){l["event"+s].midiGraceNotePitches||(l["event"+s].midiGraceNotePitches=[]);for(var x=0;x<i.abcelem.midiGraceNotePitches.length;x++)l["event"+s].midiGraceNotePitches.push(i.abcelem.midiGraceNotePitches[x])}}m&&(l["event"+s].measureStart=!0,m=!1),B&&(h=s)}}return{isTiedState:h,duration:v/o,nextIsBar:m||i.type==="bar"}},this.makeVoicesArray=function(){for(var l=[],i=[],s={},u=0;u<this.engraver.staffgroups.length;u++){var d=this.engraver.staffgroups[u];if(d&&d.staffs&&d.staffs.length>0){var n=d.staffs[0],a=n.absoluteY,o=a-n.top*Pn.STEP,h=d.staffs[d.staffs.length-1];a=h.absoluteY;for(var m=a-h.bottom*Pn.STEP,v=m-o,w=d.voices,N=0;N<w.length;N++)if(!(w[N].staff&&w[N].staff.isTabStaff)){var B=!1;l[N]||(l[N]=[]),i[N]===void 0&&(i[N]=0);for(var x=w[N].children,g=0;g<x.length;g++)x[g].type==="tempo"&&(s[i[N]]=this.getBpm(x[g].abcelem)),l[N].push({top:o,height:v,line:d.line,measureNumber:i[N],elem:x[g]}),x[g].type==="bar"&&B&&i[N]++,(x[g].type==="note"||x[g].type==="rest")&&(B=!0)}}}return this.tempoLocations=s,l},this.setupEvents=function(l,i,s,u){u||(u=1);for(var d=[],n={},a=l,o,h=!0,m=this.makeVoicesArray(),v=0,w=0;w<m.length;w++){var N=a,B=Math.round(N*1e3),x=0,g=-1,k=m[w],S=s;i=this.getBeatLength()*S/60;for(var F=-1,A=0;A<k.length;A++){var P=k[A].measureNumber;F!==P&&this.tempoLocations[P]&&(S=this.tempoLocations[P],i=u*this.getBeatLength()*S/60,F=P);var D=k[A].elem,L=this.addElementToEvents(n,D,B,k[A].top,k[A].height,k[A].line,k[A].measureNumber,i,o,h);o=L.isTiedState,h=L.nextIsBar,N+=L.duration;var I;if(D.duration>0&&n["event"+B]&&(I="event"+B),B=Math.round(N*1e3),D.type==="bar"){var R=D.abcelem.type,O=R==="bar_right_repeat"||R==="bar_dbl_repeat",y=D.abcelem.startEnding==="1",b=R==="bar_left_repeat"||R==="bar_dbl_repeat"||R==="bar_right_repeat";if(O){A>0&&(n[I].endX=D.x),g===-1&&(g=A);var T=0;F=-1;for(var C=x;C<g;C++){P=k[C].measureNumber,F!==P&&this.tempoLocations[P]&&(S=this.tempoLocations[P],i=u*this.getBeatLength()*S/60,F=P);var M=k[C].elem;L=this.addElementToEvents(n,M,B,k[C].top,k[C].height,k[C].line,k[C].measureNumber,i,o,h),o=L.isTiedState,h=L.nextIsBar,N+=L.duration,T=B,B=Math.round(N*1e3)}n["event"+T]&&(n["event"+T].endX=k[g].elem.x),h=!0,g=-1}y&&(g=A),b&&(x=A)}}v=Math.max(v,B)}return d=f(n),r(d),p(this.lines,d),d.push({type:"end",milliseconds:v}),this.addUsefulCallbackInfo(d,S*u),d},this.addUsefulCallbackInfo=function(l,i){for(var s=this.millisecondsPerMeasure(i),u=0;u<l.length;u++){var d=l[u];d.millisecondsPerMeasure=s}};function c(l,i){for(;i<l.length&&l[i].left===null;)i++;return l[i]}function p(l,i){if(!(i.length<1)){for(var s=0;s<i.length-1;s++){var u=i[s],d=c(i,s+1);if(u.left!==null){var n=d&&u.top===d.top?d.left:l[u.line].staffGroup.w;u.endX!==void 0?n>u.left&&(u.endX=Math.min(u.endX,n)):u.endX=n}}var a=i[i.length-1];a.endX=l[a.line].staffGroup.w}}this.getBpm=function(l){var i;if(l){i=l.bpm;var s=this.getBeatLength(),u=l.duration&&l.duration.length>0?l.duration[0]:s;i=i*u/s}if(!i){i=180;var d=this.getMeterFraction();d&&d.num!==3&&d.num%3===0&&(i=120)}return i},this.setTiming=function(l,i){if(i=i||0,!this.engraver||!this.engraver.staffgroups)return console.log("setTiming cannot be called before the tune is drawn."),this.noteTimings=[],this.noteTimings;var s=this.metaText?this.metaText.tempo:null,u=this.getBpm(s),d=1;l?s&&(d=l/u):l=u;var n=this.getBeatLength(),a=l/60,o=this.getBarLength(),h=o/n*i/a;h&&(h-=this.getPickupLength()/n/a);var m=n*a;return this.noteTimings=this.setupEvents(h,m,l,d),this.noteTimings.length>0?(this.totalTime=this.noteTimings[this.noteTimings.length-1].milliseconds/1e3,this.totalBeats=this.totalTime*a):(this.totalTime=void 0,this.totalBeats=void 0),this.noteTimings},this.setUpAudio=function(l){console.log("NEUTERED")},this.deline=function(l){return In(this.lines,l)}}var Bf=function(e){var t=this;this.setVisualTranspose=function(c){c&&(e.visualTranspose=c)},this.resolveOverlays=function(){for(var c=!1,p=[],l=0;l<e.lines.length;l++){var i=e.lines[l];if(i.staff)for(var s=0;s<i.staff.length;s++){for(var u=i.staff[s],d=[],n=0;n<u.voices.length;n++){var a=u.voices[n];d.push({hasOverlay:!1,voice:[],snip:[]}),p[l]=0;for(var o=0,h=!1,m=0,v=-1,w=0;w<a.length;w++){var N=a[w];if(N.el_type==="overlay"&&!h){c=!0,h=!0,v=w,d[n].hasOverlay=!0,m===0&&(m=p[l]);for(var B=0;B<l;B++)p[B]&&e.lines[B].staff&&u.voices.length>=e.lines[B].staff[0].voices.length&&e.lines[B].staff[0].voices.push([{el_type:"note",duration:p[B],rest:{type:"invisible"},startChar:N.startChar,endChar:N.endChar}])}else N.el_type==="bar"?(h?(h=!1,d[n].snip.push({start:v,len:w-v}),d[n].voice.push(N)):(o>0&&d[n].voice.push({el_type:"note",duration:o,rest:{type:"invisible"},startChar:N.startChar,endChar:N.endChar}),d[n].voice.push(N)),o=0):N.el_type==="note"?h?d[n].voice.push(N):(o+=N.duration,p[l]+=N.duration):(N.el_type==="scale"||N.el_type==="stem"||N.el_type==="overlay"||N.el_type==="style"||N.el_type==="transpose"||N.el_type==="color")&&d[n].voice.push(N)}d[n].hasOverlay&&d[n].snip.length===0&&d[n].snip.push({start:v,len:a.length-v})}for(n=0;n<d.length;n++){var x=d[n];if(x.hasOverlay){x.voice.splice(0,0,{el_type:"stem",direction:"down"}),u.voices.push(x.voice);for(var g=x.snip.length-1;g>=0;g--){var k=x.snip[g];u.voices[n].splice(k.start,k.len),u.voices[n].splice(k.start+1,0,{el_type:"stem",direction:"auto"});var S=r(u.voices[n],k.start);u.voices[n].splice(S,0,{el_type:"stem",direction:"up"})}for(g=0;g<u.voices[u.voices.length-1].length;g++){u.voices[u.voices.length-1][g]=G.clone(u.voices[u.voices.length-1][g]);var F=u.voices[u.voices.length-1][g];F.el_type==="bar"&&F.startEnding&&delete F.startEnding,F.el_type==="bar"&&F.endEnding&&delete F.endEnding}}}}}return c};function r(c,p){for(var l=p-1;l>0&&c[l].el_type!=="bar";l--);return l}function f(c){for(var p=!0,l=0;l<c.length;l++){var i=c[l];if(i.staff){for(var s=0;s<i.staff.length;s++){var u=i.staff[s];if(u.title){for(var d=!1,n=0;n<u.title.length;n++)u.title[n]?(u.title[n]=p?u.title[n].name:u.title[n].subname,u.title[n]?d=!0:u.title[n]=""):u.title[n]="";d||delete u.title}}p=!1}}}this.cleanUp=function(c,p,l){this.closeLine(),delete e.runningFonts,Df(e),e.metaText.tempo&&e.metaText.tempo.bpm&&!e.metaText.tempo.duration&&(e.metaText.tempo.duration=[e.getBeatLength()]);var i=!1,s,u,d;for(s=0;s<e.lines.length;s++)if(e.lines[s].staff!==void 0){var n=!1;for(u=0;u<e.lines[s].staff.length;u++)if(e.lines[s].staff[u]===void 0)i=!0,e.lines[s].staff[u]=null;else for(d=0;d<e.lines[s].staff[u].voices.length;d++)e.lines[s].staff[u].voices[d]===void 0?e.lines[s].staff[u].voices[d]=[]:this.containsNotes(e.lines[s].staff[u].voices[d])&&(n=!0);n||(e.lines[s]=null,i=!0)}if(i&&(e.lines=e.lines.filter(function(g){return!!g}),e.lines.forEach(function(g){g.staff&&(g.staff=g.staff.filter(function(k){return!!k}))})),c)for(;m(e.lines,c););if(p){for(i=!1,s=0;s<e.lines.length;s++)if(e.lines[s].staff!==void 0)for(u=0;u<e.lines[s].staff.length;u++){var a=!1;for(d=0;d<e.lines[s].staff[u].voices.length;d++)this.containsNotesStrict(e.lines[s].staff[u].voices[d])&&(a=!0);a||(i=!0,e.lines[s].staff[u]=null)}i&&e.lines.forEach(function(g){g.staff&&(g.staff=g.staff.filter(function(k){return!!k}))})}for(f(e.lines),s=0;s<e.lines.length;s++)if(e.lines[s].staff)for(u=0;u<e.lines[s].staff.length;u++)delete e.lines[s].staff[u].workingClef;for(;this.resolveOverlays(););function o(g,k,S){l[k]||(l[k]=[]),l[k][S]||(l[k][S]=[]);for(var F,A=function(q,U,$){if(l[k][S][$]===void 0){for(F=0;F<l[k][S].length;F++)if(l[k][S][F]!==void 0){$=F;break}if(l[k][S][$]===void 0){var le=$*100+1;q.endSlur.forEach(function(H){le===H&&--le}),l[k][S][$]=[le]}}for(var X,he=0;he<U;he++)X=l[k][S][$].pop(),q.endSlur.push(X);return l[k][S][$].length===0&&delete l[k][S][$],X},P=function(q,U,$,le){q.startSlur=[],l[k][S][$]===void 0&&(l[k][S][$]=[]);for(var X=$*100+1,he=0;he<U;he++)le&&(le.forEach(function(H){X===H&&++X}),le.forEach(function(H){X===H&&++X}),le.forEach(function(H){X===H&&++X})),l[k][S][$].forEach(function(H){X===H&&++X}),l[k][S][$].forEach(function(H){X===H&&++X}),l[k][S][$].push(X),q.startSlur.push({label:X}),q.dottedSlur&&(q.startSlur[q.startSlur.length-1].style="dotted",delete q.dottedSlur),X++},D=0;D<g.length;D++){var L=g[D];if(L.el_type==="note"){if(L.gracenotes)for(var I=0;I<L.gracenotes.length;I++){if(L.gracenotes[I].endSlur){var R=L.gracenotes[I].endSlur;L.gracenotes[I].endSlur=[];for(var O=0;O<R;O++)A(L.gracenotes[I],1,20)}L.gracenotes[I].startSlur&&(F=L.gracenotes[I].startSlur,P(L.gracenotes[I],F,20))}if(L.endSlur&&(F=L.endSlur,L.endSlur=[],A(L,F,0)),L.startSlur&&(F=L.startSlur,P(L,F,0)),L.pitches){for(var y=[],b=0;b<L.pitches.length;b++)if(L.pitches[b].endSlur){var T=L.pitches[b].endSlur;L.pitches[b].endSlur=[];for(var C=0;C<T;C++){var M=A(L.pitches[b],1,b+1);y.push(M)}}for(b=0;b<L.pitches.length;b++)L.pitches[b].startSlur&&(F=L.pitches[b].startSlur,P(L.pitches[b],F,b+1,y));L.gracenotes&&L.pitches[0].endSlur&&L.pitches[0].endSlur[0]===100&&L.pitches[0].startSlur&&(L.gracenotes[0].endSlur?L.gracenotes[0].endSlur.push(L.pitches[0].startSlur[0].label):L.gracenotes[0].endSlur=[L.pitches[0].startSlur[0].label],L.pitches[0].endSlur.length===1?delete L.pitches[0].endSlur:L.pitches[0].endSlur[0]===100?L.pitches[0].endSlur.shift():L.pitches[0].endSlur[L.pitches[0].endSlur.length-1]===100&&L.pitches[0].endSlur.pop(),l[k][S][1].length===1?delete l[k][S][1]:l[k][S][1].pop())}}}}function h(g){se.fixClef(g)}function m(g,k){for(s=0;s<g.length;s++)if(g[s].staff!==void 0)for(u=0;u<g[s].staff.length;u++){var S=[];for(d=0;d<g[s].staff[u].voices.length;d++)for(var F=g[s].staff[u].voices[d],A=0,P=0;P<F.length;P++)if(F[P].el_type==="bar"){if(A++,A>=k&&P<F.length-1){var D=v(g,s);if(!D){var L=JSON.parse(JSON.stringify(g[s]));g.push(G.clone(L)),D=g[g.length-1];for(var I=0;I<D.staff.length;I++)for(var R=0;R<D.staff[I].voices.length;R++)D.staff[I].voices[R]=[]}var O=P+1,y=g[s].staff[u].voices[d].slice(O);return g[s].staff[u].voices[d]=g[s].staff[u].voices[d].slice(0,O),D.staff[u].voices[d]=S.concat(y.concat(D.staff[u].voices[d])),!0}}else F[P].duration||S.push(F[P])}return!1}function v(g,k){for(k++;g.length>k;){if(g[k].staff)return g[k];k++}return null}for(e.lineNum=0;e.lineNum<e.lines.length;e.lineNum++){var w=e.lines[e.lineNum].staff;if(w)for(e.staffNum=0;e.staffNum<w.length;e.staffNum++)for(w[e.staffNum].clef&&h(w[e.staffNum].clef),e.voiceNum=0;e.voiceNum<w[e.staffNum].voices.length;e.voiceNum++){var N=w[e.staffNum].voices[e.voiceNum];o(N,e.staffNum,e.voiceNum);for(var B=0;B<N.length;B++)N[B].el_type==="clef"&&h(N[B]);if(N.length>0&&N[N.length-1].barNumber){var x=v(e.lines,e.lineNum);x&&(x.staff[0].barNumber=N[N.length-1].barNumber),delete N[N.length-1].barNumber}}}return delete e.staffNum,delete e.voiceNum,delete e.lineNum,delete e.potentialStartBeam,delete e.potentialEndBeam,delete e.vskipPending,l},e.reset(),this.getLastNote=function(){if(e.lines[e.lineNum]&&e.lines[e.lineNum].staff&&e.lines[e.lineNum].staff[e.staffNum]&&e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum])for(var c=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum].length-1;c>=0;c--){var p=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum][c];if(p.el_type==="note")return p}return null},this.addTieToLastNote=function(c){var p=this.getLastNote();return p&&p.pitches&&p.pitches.length>0?(p.pitches[0].startTie={},c&&(p.pitches[0].startTie.style="dotted"),!0):!1},this.getDuration=function(c){return c.duration?c.duration:0},this.closeLine=function(){e.potentialStartBeam&&e.potentialEndBeam&&(e.potentialStartBeam.startBeam=!0,e.potentialEndBeam.endBeam=!0),delete e.potentialStartBeam,delete e.potentialEndBeam},this.appendElement=function(c,p,l,i){var s=e,u=function(o){var h=s.lines[s.lineNum].staff[s.staffNum];if(h){if(o.pitches!==void 0){var m=h.workingClef.verticalPos;o.pitches.forEach(function(w){w.verticalPos=w.pitch-m})}if(o.gracenotes!==void 0){var v=h.workingClef.verticalPos;o.gracenotes.forEach(function(w){w.verticalPos=w.pitch-v})}h.voices[s.voiceNum].push(o)}};i.el_type=c,p!==null&&(i.startChar=p),l!==null&&(i.endChar=l);var d=function(){s.potentialStartBeam.startBeam=!0,i.endBeam=!0,delete s.potentialStartBeam,delete s.potentialEndBeam},n=function(){s.potentialStartBeam!==void 0&&s.potentialEndBeam!==void 0&&(s.potentialStartBeam.startBeam=!0,s.potentialEndBeam.endBeam=!0),delete s.potentialStartBeam,delete s.potentialEndBeam};if(c==="note"){var a=t.getDuration(i);a>=.25||i.force_end_beam_last&&s.potentialStartBeam!==void 0?n():i.end_beam&&s.potentialStartBeam!==void 0?i.rest===void 0?d():n():i.rest===void 0&&(s.potentialStartBeam===void 0?i.end_beam||(s.potentialStartBeam=i,delete s.potentialEndBeam):s.potentialEndBeam=i)}else n();delete i.end_beam,delete i.force_end_beam_last,u(i)},this.appendStartingElement=function(c,p,l,i){this.closeLine();var s;c==="key"&&(s=i.impliedNaturals,delete i.impliedNaturals,delete i.explicitAccidentals);var u=G.clone(i);if(e.lines[e.lineNum]&&e.lines[e.lineNum].staff){e.lines[e.lineNum].staff.length<=e.staffNum&&(e.lines[e.lineNum].staff[e.staffNum]={},e.lines[e.lineNum].staff[e.staffNum].clef=G.clone(e.lines[e.lineNum].staff[0].clef),e.lines[e.lineNum].staff[e.staffNum].key=G.clone(e.lines[e.lineNum].staff[0].key),e.lines[e.lineNum].staff[0].meter&&(e.lines[e.lineNum].staff[e.staffNum].meter=G.clone(e.lines[e.lineNum].staff[0].meter)),e.lines[e.lineNum].staff[e.staffNum].workingClef=G.clone(e.lines[e.lineNum].staff[0].workingClef),e.lines[e.lineNum].staff[e.staffNum].voices=[[]]),c==="clef"&&(e.lines[e.lineNum].staff[e.staffNum].workingClef=u);for(var d=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum],n=0;n<d.length;n++){if(d[n].el_type==="note"||d[n].el_type==="bar"){u.el_type=c,u.startChar=p,u.endChar=l,s&&(u.accidentals=s.concat(u.accidentals)),d.push(u);return}if(d[n].el_type===c){u.el_type=c,u.startChar=p,u.endChar=l,s&&(u.accidentals=s.concat(u.accidentals)),d[n]=u;return}}e.lines[e.lineNum].staff[e.staffNum][c]=i}},this.pushLine=function(c){e.vskipPending&&(c.vskip=e.vskipPending,delete e.vskipPending),e.lines.push(c)},this.addSubtitle=function(c,p){this.pushLine({subtitle:{text:c,startChar:p.startChar,endChar:p.endChar}})},this.addSpacing=function(c){e.vskipPending=c},this.addNewPage=function(c){this.pushLine({newpage:c})},this.addSeparator=function(c,p,l,i){this.pushLine({separator:{spaceAbove:Math.round(c),spaceBelow:Math.round(p),lineLength:Math.round(l),startChar:i.startChar,endChar:i.endChar}})},this.addText=function(c,p){this.pushLine({text:{text:c,startChar:p.startChar,endChar:p.endChar}})},this.addCentered=function(c){this.pushLine({text:[{text:c,center:!0}]})},this.containsNotes=function(c){for(var p=0;p<c.length;p++)if(c[p].el_type==="note"||c[p].el_type==="bar")return!0;return!1},this.containsNotesStrict=function(c){for(var p=0;p<c.length;p++)if(c[p].el_type==="note"&&(c[p].rest===void 0||c[p].chord!==void 0))return!0;return!1},this.changeVoiceScale=function(c){t.appendElement("scale",null,null,{size:c})},this.changeVoiceColor=function(c){t.appendElement("color",null,null,{color:c})},this.startNewLine=function(c){var p=e;this.closeLine();var l=function(u){var d=p.lines[p.lineNum].staff[p.staffNum];if(d.voices[p.voiceNum]=[],d.title||(d.title=[]),d.title[p.voiceNum]={name:u.name,subname:u.subname},u.style&&t.appendElement("style",null,null,{head:u.style}),u.stem)t.appendElement("stem",null,null,{direction:u.stem});else if(p.voiceNum>0){if(d.voices[0]!==void 0){for(var n=!1,a=0;a<d.voices[0].length;a++)d.voices[0].el_type==="stem"&&(n=!0);if(!n){var o={el_type:"stem",direction:"up"};d.voices[0].splice(0,0,o)}}t.appendElement("stem",null,null,{direction:"down"})}u.scale&&t.appendElement("scale",null,null,{size:u.scale}),u.color&&t.appendElement("color",null,null,{color:u.color})},i=function(u){u.key&&u.key.impliedNaturals&&(u.key.accidentals=u.key.accidentals.concat(u.key.impliedNaturals),delete u.key.impliedNaturals),p.lines[p.lineNum].staff[p.staffNum]={voices:[],clef:u.clef,key:u.key,workingClef:u.clef},u.stafflines!==void 0&&(p.lines[p.lineNum].staff[p.staffNum].clef.stafflines=u.stafflines,p.lines[p.lineNum].staff[p.staffNum].workingClef.stafflines=u.stafflines),u.staffscale&&(p.lines[p.lineNum].staff[p.staffNum].staffscale=u.staffscale),u.annotationfont&&t.setLineFont("annotationfont",u.annotationfont),u.gchordfont&&t.setLineFont("gchordfont",u.gchordfont),u.tripletfont&&t.setLineFont("tripletfont",u.tripletfont),u.vocalfont&&t.setLineFont("vocalfont",u.vocalfont),u.bracket&&(p.lines[p.lineNum].staff[p.staffNum].bracket=u.bracket),u.brace&&(p.lines[p.lineNum].staff[p.staffNum].brace=u.brace),u.connectBarLines&&(p.lines[p.lineNum].staff[p.staffNum].connectBarLines=u.connectBarLines),u.barNumber&&(p.lines[p.lineNum].staff[p.staffNum].barNumber=u.barNumber),l(u),u.part&&t.appendElement("part",u.part.startChar,u.part.endChar,{title:u.part.title}),u.meter!==void 0&&(p.lines[p.lineNum].staff[p.staffNum].meter=u.meter),p.vskipPending&&(p.lines[p.lineNum].vskip=p.vskipPending,delete p.vskipPending)},s=function(u){p.lines[p.lineNum]={staff:[]},i(u)};e.lines[e.lineNum]===void 0?s(c):e.lines[e.lineNum].staff===void 0?(e.lineNum++,this.startNewLine(c)):e.lines[e.lineNum].staff[e.staffNum]===void 0?i(c):e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum]===void 0?l(c):this.containsNotes(e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum])?(e.lineNum++,this.startNewLine(c)):c.part&&t.appendElement("part",c.part.startChar,c.part.endChar,{title:c.part.title})},this.setRunningFont=function(c,p){e.runningFonts[c]=p},this.setLineFont=function(c,p){if(e.runningFonts[c]){for(var l=!1,i=Object.keys(p),s=0;s<i.length;s++)e.runningFonts[c][i[s]]!==p[i[s]]&&(l=!0);l&&(e.lines[e.lineNum].staff[e.staffNum][c]=p)}e.runningFonts[c]=p},this.setBarNumberImmediate=function(c){var p=this.getCurrentVoice();if(p&&p.length>0){var l=p[p.length-1];if(l.el_type==="bar")l.barNumber!==void 0&&(l.barNumber=c);else return c-1}return c},this.hasBeginMusic=function(){for(var c=0;c<e.lines.length;c++)if(e.lines[c].staff)return!0;return!1},this.isFirstLine=function(c){for(var p=c-1;p>=0;p--)if(e.lines[p].staff!==void 0)return!1;return!0},this.getCurrentVoice=function(){var c=e.lines[e.lineNum];if(!c)return null;var p=c.staff[e.staffNum];return p&&p.voices[e.voiceNum]!==void 0?p.voices[e.voiceNum]:null},this.setCurrentVoice=function(c,p){e.staffNum=c,e.voiceNum=p;for(var l=0;l<e.lines.length;l++)if(e.lines[l].staff&&(e.lines[l].staff[c]===void 0||e.lines[l].staff[c].voices[p]===void 0||!this.containsNotes(e.lines[l].staff[c].voices[p]))){e.lineNum=l;return}e.lineNum=l},this.addMetaText=function(c,p,l){e.metaText[c]===void 0?(e.metaText[c]=p,e.metaTextInfo[c]=l):(typeof e.metaText[c]=="string"&&typeof p=="string"?e.metaText[c]+=`
`+p:(e.metaText[c]==="string"&&(e.metaText[c]=[{text:e.metaText[c]}]),typeof p=="string"&&(p=[{text:p}]),e.metaText[c]=e.metaText[c].concat(p)),e.metaTextInfo[c].endChar=l.endChar)},this.addMetaTextArray=function(c,p,l){e.metaText[c]===void 0?(e.metaText[c]=[p],e.metaTextInfo[c]=l):(e.metaText[c].push(p),e.metaTextInfo[c].endChar=l.endChar)},this.addMetaTextObj=function(c,p,l){e.metaText[c]=p,e.metaTextInfo[c]=l}};function ci(e){if(!e||typeof e=="string")return!1;for(var t="",r=0;r<e.length;r++)if(typeof e[r]!="string")return!1;return!0}function Df(e){ci(e.metaText.notes)&&(e.metaText.notes=e.metaText.notes.join(`
`)),ci(e.metaText.history)&&(e.metaText.history=e.metaText.history.join(`
`))}var li=Bf;function ui(){"use strict";var e=new On,t=new li(e),r,f="",c="";this.getTune=function(){var x={formatting:e.formatting,lines:e.lines,media:e.media,metaText:e.metaText,metaTextInfo:e.metaTextInfo,version:e.version,addElementToEvents:e.addElementToEvents,addUsefulCallbackInfo:e.addUsefulCallbackInfo,getTotalTime:e.getTotalTime,getTotalBeats:e.getTotalBeats,getBarLength:e.getBarLength,getBeatLength:e.getBeatLength,getBeatsPerMeasure:e.getBeatsPerMeasure,getBpm:e.getBpm,getMeter:e.getMeter,getMeterFraction:e.getMeterFraction,getPickupLength:e.getPickupLength,getKeySignature:e.getKeySignature,getElementFromChar:e.getElementFromChar,makeVoicesArray:e.makeVoicesArray,millisecondsPerMeasure:e.millisecondsPerMeasure,setupEvents:e.setupEvents,setTiming:e.setTiming,setUpAudio:e.setUpAudio,deline:e.deline};return e.lineBreaks&&(x.lineBreaks=e.lineBreaks),e.visualTranspose&&(x.visualTranspose=e.visualTranspose),x};function p(x,g,k){x.positioning||(x.positioning={}),x.positioning[g]=k}function l(x,g,k){x.fonts||(x.fonts={}),x.fonts[g]=k}var i={reset:function(){for(var x in this)this.hasOwnProperty(x)&&typeof this[x]!="function"&&delete this[x];this.iChar=0,this.key={accidentals:[],root:"none",acc:"",mode:""},this.meter=null,this.origMeter=null,this.hasMainTitle=!1,this.default_length=.125,this.clef={type:"treble",verticalPos:0},this.octave=0,this.next_note_duration=0,this.start_new_line=!0,this.is_in_header=!0,this.partForNextLine={},this.tempoForNextLine=[],this.havent_set_length=!0,this.voices={},this.staves=[],this.macros={},this.currBarNumber=1,this.barCounter={},this.ignoredDecorations=[],this.score_is_present=!1,this.inEnding=!1,this.inTie=[],this.inTieChord={},this.vocalPosition="auto",this.dynamicPosition="auto",this.chordPosition="auto",this.ornamentPosition="auto",this.volumePosition="auto",this.openSlurs=[],this.freegchord=!1,this.endingHoldOver={}},differentFont:function(x,g){return this[x].decoration!==g[x].decoration||this[x].face!==g[x].face||this[x].size!==g[x].size||this[x].style!==g[x].style||this[x].weight!==g[x].weight},addFormattingOptions:function(x,g,k){k==="note"?(this.vocalPosition!=="auto"&&p(x,"vocalPosition",this.vocalPosition),this.dynamicPosition!=="auto"&&p(x,"dynamicPosition",this.dynamicPosition),this.chordPosition!=="auto"&&p(x,"chordPosition",this.chordPosition),this.ornamentPosition!=="auto"&&p(x,"ornamentPosition",this.ornamentPosition),this.volumePosition!=="auto"&&p(x,"volumePosition",this.volumePosition),this.differentFont("annotationfont",g)&&l(x,"annotationfont",this.annotationfont),this.differentFont("gchordfont",g)&&l(x,"gchordfont",this.gchordfont),this.differentFont("vocalfont",g)&&l(x,"vocalfont",this.vocalfont),this.differentFont("tripletfont",g)&&l(x,"tripletfont",this.tripletfont)):k==="bar"&&(this.dynamicPosition!=="auto"&&p(x,"dynamicPosition",this.dynamicPosition),this.chordPosition!=="auto"&&p(x,"chordPosition",this.chordPosition),this.ornamentPosition!=="auto"&&p(x,"ornamentPosition",this.ornamentPosition),this.volumePosition!=="auto"&&p(x,"volumePosition",this.volumePosition),this.differentFont("measurefont",g)&&l(x,"measurefont",this.measurefont),this.differentFont("repeatfont",g)&&l(x,"repeatfont",this.repeatfont))},duplicateStartEndingHoldOvers:function(){this.endingHoldOver={inTie:[],inTieChord:{}};for(var x=0;x<this.inTie.length;x++)if(this.endingHoldOver.inTie.push([]),this.inTie[x])for(var g=0;g<this.inTie[x].length;g++)this.endingHoldOver.inTie[x].push(this.inTie[x][g]);for(var k in this.inTieChord)this.inTieChord.hasOwnProperty(k)&&(this.endingHoldOver.inTieChord[k]=this.inTieChord[k])},restoreStartEndingHoldOvers:function(){if(this.endingHoldOver.inTie){this.inTie=[],this.inTieChord={};for(var x=0;x<this.endingHoldOver.inTie.length;x++){this.inTie.push([]);for(var g=0;g<this.endingHoldOver.inTie[x].length;g++)this.inTie[x].push(this.endingHoldOver.inTie[x][g])}for(var k in this.endingHoldOver.inTieChord)this.endingHoldOver.inTieChord.hasOwnProperty(k)&&(this.inTieChord[k]=this.endingHoldOver.inTieChord[k])}}},s=function(x){i.warnings||(i.warnings=[]),i.warnings.push(x)},u=function(x){i.warningObjects||(i.warningObjects=[]),i.warningObjects.push(x)},d=function(x){var g=x.replace(/\x12/g," ");return g=g.replace(/&/g,"&amp;"),g=g.replace(/</g,"&lt;"),g.replace(/>/g,"&gt;")},n=function(x,g,k){g||(g=" ");var S=g[k];(S===" "||!S)&&(S="SPACE");var F=d(g.substring(k-64,k))+'<span style="text-decoration:underline;font-size:1.3em;font-weight:bold;">'+S+"</span>"+d(g.substring(k+1).substring(0,64));s("Music Line:"+r.lineIndex+":"+(k+1)+": "+x+":  "+F),u({message:x,line:g,startChar:i.iChar+k,column:k})},a,o;this.getWarnings=function(){return i.warnings},this.getWarningObjects=function(){return i.warningObjects};var h=function(x,g){if(g.indexOf("")>=0){f+=g;return}if(g=f+g,f="",!x){n("Can't add words before the first line of music",x,0);return}g=G.strip(g),g[g.length-1]!=="-"&&(g=g+" ");for(var k=[],S=0,F=!1,A=function(I){var R=G.strip(g.substring(S,I));if(R=R.replace(/\\([-_*|~])/g,"$1"),S=I+1,R.length>0){F&&(R=R.replace(/~/g," "));var O=g[I];return O!=="_"&&O!=="-"&&(O=" "),k.push({syllable:r.translateString(R),divider:O}),F=!1,!0}return!1},P=!1,D=0;D<g.length;D++){switch(g[D]){case" ":case"":A(D);break;case"-":!P&&!A(D)&&k.length>0&&(G.last(k).divider="-",k.push({skip:!0,to:"next"}));break;case"_":P||(A(D),k.push({skip:!0,to:"slur"}));break;case"*":P||(A(D),k.push({skip:!0,to:"next"}));break;case"|":P||(A(D),k.push({skip:!0,to:"bar"}));break;case"~":P||(F=!0);break}P=g[D]==="\\"}var L=!1;x.forEach(function(I){if(k.length!==0){if(k[0].skip){switch(k[0].to){case"next":I.el_type==="note"&&I.pitches!==null&&!L&&k.shift();break;case"slur":I.el_type==="note"&&I.pitches!==null&&k.shift();break;case"bar":I.el_type==="bar"&&k.shift();break}I.el_type!=="bar"&&(I.lyric===void 0?I.lyric=[{syllable:"",divider:" "}]:I.lyric.push({syllable:"",divider:" "}))}else if(I.el_type==="note"&&I.rest===void 0&&!L){var R=k.shift();R.syllable&&(R.syllable=R.syllable.replace(/ +/g,"Â ")),I.lyric===void 0?I.lyric=[R]:I.lyric.push(R)}}})},m=function(x,g){if(g.indexOf("")>=0){c+=g;return}if(g=c+g,c="",!x){n("Can't add symbols before the first line of music",x,0);return}g=G.strip(g),g[g.length-1]!=="-"&&(g=g+" ");for(var k=[],S=0,F=!1,A=function(L){var I=G.strip(g.substring(S,L));if(S=L+1,I.length>0){F&&(I=I.replace(/~/g," "));var R=g[L];return R!=="_"&&R!=="-"&&(R=" "),k.push({syllable:r.translateString(I),divider:R}),F=!1,!0}return!1},P=0;P<g.length;P++)switch(g[P]){case" ":case"":A(P);break;case"-":!A(P)&&k.length>0&&(G.last(k).divider="-",k.push({skip:!0,to:"next"}));break;case"_":A(P),k.push({skip:!0,to:"slur"});break;case"*":A(P),k.push({skip:!0,to:"next"});break;case"|":A(P),k.push({skip:!0,to:"bar"});break;case"~":F=!0;break}var D=!1;x.forEach(function(L){if(k.length!==0){if(k[0].skip)switch(k[0].to){case"next":L.el_type==="note"&&L.pitches!==null&&!D&&k.shift();break;case"slur":L.el_type==="note"&&L.pitches!==null&&k.shift();break;case"bar":L.el_type==="bar"&&k.shift();break}else if(L.el_type==="note"&&L.rest===void 0&&!D){var I=k.shift();L.lyric===void 0?L.lyric=[I]:L.lyric.push(I)}}})},v=function(x){if(G.startsWith(x,"%%")){var g=V.addDirective(x.substring(2));g&&n(g,x,2);return}var k=x.indexOf("%");if(k>=0&&(x=x.substring(0,k)),x=x.replace(/\s+$/,""),x.length!==0){if(f){h(t.getCurrentVoice(),x.substring(2));return}if(c){m(t.getCurrentVoice(),x.substring(2));return}if(x.length<2||x[1]!==":"||o.lineContinuation){o.parseMusic(x);return}var S=a.parseHeader(x);S.regular&&o.parseMusic(x),S.newline&&o.startNewLine(),S.words&&h(t.getCurrentVoice(),x.substring(2)),S.symbols&&m(t.getCurrentVoice(),x.substring(2))}};function w(x,g){x.push({el_type:"hint"});for(var k=0;k<g.length;k++){var S=g[k],F=G.clone(S);if(x.push(F),S.el_type==="bar")return}}function N(x,g){for(var k=0;k<x.length;k++){var S=x[k],F=g[k];if(F)for(var A=0;A<F.voices.length;A++){var P=F.voices[A],D=S.voices[A];D&&w(D,P)}}}function B(){for(var x=0;x<e.lines.length;x++){var g=e.lines[x].staff;if(g){for(var k=x+1;k<e.lines.length&&e.lines[k].staff===void 0;)k++;if(k<e.lines.length){var S=e.lines[k].staff;N(g,S)}}}}this.parse=function(x,g,k){g||(g={}),k||(k=0),e.reset(),x=x.replace(/\r\n?/g,`
`)+`
`;var S=x.split(`
\\`);if(S.length>1){for(var F=1;F<S.length;F++)for(;S[F].length>0&&S[F][0]!==`
`;)S[F]=S[F].substr(1),S[F-1]+=" ";x=S.join("  ")}x=x.replace(/\\([ \t]*)(%.*)*\n/g,function(O,y,b){var T=b?Array(b.length+1).join(" "):"";return y+""+T+`
`});var A=x.split(`
`);G.last(A).length===0&&A.pop(),r=new si(A,i),a=new Za(r,n,i,e,t),o=new Ft(r,n,i,e,t,a),g.print&&(e.media="print"),i.reset(),i.iChar=k,g.visualTranspose?(i.globalTranspose=parseInt(g.visualTranspose),i.globalTranspose===0?i.globalTranspose=void 0:t.setVisualTranspose(g.visualTranspose)):i.globalTranspose=void 0,g.lineBreaks&&(i.lineBreaks=g.lineBreaks),a.reset(r,n,i,e);try{g.format&&V.globalFormatting(g.format);for(var P=r.nextLine();P;){if(g.header_only&&i.is_in_header===!1||g.stop_on_warning&&i.warnings)throw"normal_abort";var D=i.is_in_header;v(P),D&&!i.is_in_header&&(t.setRunningFont("annotationfont",i.annotationfont),t.setRunningFont("gchordfont",i.gchordfont),t.setRunningFont("tripletfont",i.tripletfont),t.setRunningFont("vocalfont",i.vocalfont)),P=r.nextLine()}f&&h(t.getCurrentVoice(),""),c&&m(t.getCurrentVoice(),""),i.openSlurs=t.cleanUp(i.barsperstaff,i.staffnonote,i.openSlurs)}catch(O){if(O!=="normal_abort")throw O}var L=11*72,I=8.5*72;switch(i.papersize){case"legal":L=14*72,I=8.5*72;break;case"A4":L=11.7*72,I=8.3*72;break}if(i.landscape){var R=L;L=I,I=R}e.formatting.pagewidth||(e.formatting.pagewidth=I),e.formatting.pageheight||(e.formatting.pageheight=L),g.hint_measures&&B(),oi.wrapLines(e,i.lineBreaks,i.barNumbers)}}var hi=new ui;function Gn(e){throw new Error("Todo: "+e)}function Lf(e,t){let r=t.sequences.find(za({id:e}));return r||(r={id:e,events:[],cursor:0},t.sequences.push(r),t.events.push([0,"sequence",e]),r)}function At(e,t){let r=t.length;for(;r--;)if(t[r][1]===e)return t[r]}function Ff(e,t){return[0,0,2,4,5,7,9,11,12,14,16,17,19,21,23,24,26,28,29,31,33,35,36,38,40,41,43,45,47,48][t]+e+60}function Rn(e){hi.parse(e);let t=hi.getTune(),r=t.lines.reduce((f,c)=>(c.staff.reduce((p,l,i)=>{let s=Lf(i,f),u=s.events;if(l.clef){let n=l.clef.type,a=At("clef",u);(!a||a[2]!==n)&&u.push([0,"clef",n])}let d=At("key",u);if(l.key){let n=l.key.mode===""?l.key.root:Gn("What happens when ABC decides key.mode is not an empty string?"),a={C:0,D:2,E:4,F:5,G:7,A:9,B:11};a[n]||Gn('ABC says root is "'+n+'", we have not implemented support for that');let o=a[n];(!d||d[2]!==n)&&(d=[s.cursor,"key",o],u.push(d))}if(l.meter){let n=1/(+l.meter.value[0].den/4),a=+l.meter.value[0].num*n,o=At("meter",u);(!o||o[2]!==a||o[3]!==n)&&u.push([0,"meter",a,n])}if(l.voices){let n=At("note",u);l.voices[0].reduce((a,o)=>{if(o.el_type==="note")o.pitches.reduce((h,m)=>(h.push([s.cursor,"note",Ff(d[2],m.pitch),.25,o.duration*4]),h),a),s.cursor+=o.duration*4;else if(o.el_type==="bar"){let h=At("meter",a);if((s.cursor-h[0])%h[2]!==0){let v=(Math.floor((s.cursor-h[0])/h[2])+1)*h[2];s.cursor=v}}else console.log("ABC voice ignored:",o);return a},u),l.voices[1]&&Gn("What do we do with a second array of voices?")}return p},f.sequences),f),{name:t.metaText.title,events:[],sequences:[],meta:t.metaText});return r.sequences.forEach(f=>delete f.cursor),r}var Af={chord:3,note:3,key:1,meter:2,rate:1,lyric:2},Mf=/^[ABCDEFG][bâ™­#â™¯]{0,1}-?\d$/,pi=/^[ABCDEFG][bâ™­#â™¯]{0,1}/;function qn(e){let t=e.trim().split(/\s+/),r=[],f=-1;for(;t[++f]!==void 0;){let c=Number(t[f]),p=t[++f];Mf.test(p)?(p="note",--f):pi.test(p)&&(p="chord",--f);let l=[c,p],i=Af[p];if(i===void 0)throw new TypeError('Unrecognised type "'+p+'" in sequence data');if(p==="chord"){let s=pi.exec(t[++f])[0],u=t[f].slice(s.length)||t[++f],d=Number(t[++f]);l.push(s,u,d)}else for(;i--;){let s=Number(t[++f]);l.push(Number.isNaN(s)?t[f]:s)}r.push(l)}return r}function Sf(e){let t=e.files[Object.keys(e.files)[0]];return je(t.type,t.content)}function Pf(e){let t=e.settings.find(matches({id:13324}))||e.settings[0];return je("abc",t.abc)}function je(e,t){if(typeof t=="object")return t.files?Sf(t):t.settings?Pf():Array.isArray(t)?{id:0,events:t}:t;if(e==="abc"||e==="text/x-abc")return Rn(t.replace(/\n\s+/g,`
`)).sequences[0];if(e==="sequence"||e==="text/plain")return{events:qn(t)};{let r=JSON.parse(t);return Array.isArray(r)?{id:0,events:r}:r}}var If=yn(Ua);var di=j((e,t)=>typeof t,{string:function(e,t){return If(t).then(r=>je(e,r)).catch(r=>console.error(r))},default:function(e,t,r,f){t[e]=f}});var Of=/^(\d+)\/(\d+)$/;function mi(e){let t=Of.exec(e),r=parseInt(t[1],10),f=4/parseInt(t[2],10);return{1:"meter",2:r*f,3:f}}function gi(e){let t=e[2],r=e[3],f=t/r,c=4/r;return f+"/"+c}function Gf(){return{x:0,y:0,left:0,top:0,right:window.innerWidth,bottom:window.innerHeight,width:window.innerWidth,height:window.innerHeight}}function $n(e){return e===window?Gf():e.getClientRects()[0]||e.getBoundingClientRect()}var Me=1.1;function Rf(e){return parseFloat(e.dataset.duration)}function qf(e){let t=e.childNodes;for(;t.length>1;)e.removeChild(e.lastChild)}function vi(e,t,r){return`M${t[r[0]]}, ${-e*t[r[0]]-.5*Me}
        L${t[r[r.length-1]]},${-e*t[r[r.length-1]]-.5*Me}
        L${t[r[r.length-1]]},${-e*t[r[r.length-1]]+.5*Me}
        L${t[r[0]]}, ${-e*t[r[0]]+.5*Me}
        Z`}function Un(e,t,r,f,c,p){if(p<.125)return;let l=f-1,i;for(;t[++l];)t[l]<=p?i?i.push(l):i=[l]:i&&(e.appendChild(W("path",{class:`beam-path-${4/p} beam-path`,d:vi(c,r,i)})),Un(e,t,r,i[0],c,p/2),i=void 0);i&&(e.appendChild(W("path",{class:`beam-path-${4/p} beam-path`,d:vi(c,r,i)})),Un(e,t,r,i[0],c,p/2),i=void 0)}function zn(e){let t=e.dataset.events.split(/\s+/),r=e.parentElement,f=t.map(n=>r.querySelector('.note[data-event="'+n+'"]')),c=f.map(Rf),p=e.viewBox.baseVal,l=p.y<-.5?p.y+.5:p.height-1,i=f.map($n),s=i[0].x,u=i[i.length-1].x,d=i.map(n=>(n.x-s)/(u-s));qf(e),Un(e,c,d,0,-l,.25)}var hr=Symbol("scribe-id"),$f=0;function Se(e){return e[hr]||(e[hr]=++$f+""),e[hr]}var bi=Math.abs,pr={flat:`<span class="chord-flat">${Jt}</span>`,sharp:`<span class="chord-sharp">${Vt}</span>`},Uf={2:"acci acci-doublesharp",1:"acci acci-sharp",0:"acci acci-natural","-1":"acci acci-flat","-2":"acci acci-doubleflat"},zf={2:an,1:Vt,0:Yt,"-1":Jt,"-2":nn},Hf=/^(âˆ†|-|Ã¸|7|\+)?(alt|sus|maj|min|dim|aug)?(.*)$/,yi=j(Le("type"),{clef:e=>e.stave.getClefHTML?W("fragment",e.stave.getClefHTML()):W("span",{class:`${e.stave.type}-clef clef`,html:e.stave.clef}),chord:e=>{let t=Hf.exec(e.extension);return W("abbr",{class:"chord chord-abbr",title:"TODO - name of chord",html:'<span class="chord-root">'+e.root.replace(yt,pr.sharp).replace(bt,pr.flat)+'</span><span class="chord-ext">'+(t[1]?'<span class="chord-ext-'+t[1]+'">'+t[1]+"</span>":"")+(t[2]?"<sub>"+t[2]+"</sub>":"")+(t[3]?"<sup>"+t[3].replace(yt,pr.sharp).replace(bt,pr.flat)+"</sup>":"")+"</span>"+(e.bass?fn+'<span class="chord-bass">'+e.bass+"</span>":""),data:{beat:e.beat+1,duration:e.duration,event:Se(e.event)}})},timesig:e=>e.stave.getTimeSigHTML?W("fragment",e.stave.getTimeSigHTML(e.numerator,e.denominator,Se(e.event))):W("span",{class:"timesig",html:`<sup>${ie["timeSig"+e.numerator]}</sup>
                <sub>${ie["timeSig"+e.denominator]}</sub>`,data:{event:Se(e.event)}}),lyric:e=>W("span",{class:"lyric",part:"lyric",html:e.value,data:{beat:e.beat+1,duration:e.duration,event:Se(e.event)}}),acci:e=>W("span",{class:Uf[e.value]||"acci",html:zf[e.value]||Yt,data:e.beat===void 0?{pitch:e.pitch}:{beat:e.beat+1,pitch:e.pitch,part:e.part,event:Se(e.event)}}),upledger:e=>W("svg",{class:"up-ledge ledge",viewBox:`0 ${.5-e.rows} 4.4 ${e.rows}`,preserveAspectRatio:"xMidYMax",style:`height: ${e.rows*.125}em;`,html:`
            <line x1="0" x2="4.4" y1="-6" y2="-6"></line>
            <line x1="0" x2="4.4" y1="-4" y2="-4"></line>
            <line x1="0" x2="4.4" y1="-2" y2="-2"></line>
            <line x1="0" x2="4.4" y1="0" y2="0"></line>
        `,data:{beat:e.beat+1,pitch:e.pitch,part:e.part}}),downledger:e=>W("svg",{class:"down-ledge ledge",viewBox:`0 -0.5 4.4 ${e.rows}`,preserveAspectRatio:"xMidYMin",style:`height: ${e.rows*.125}em;`,html:`
            <line x1="0" x2="4.4" y1="6" y2="6"></line>
            <line x1="0" x2="4.4" y1="4" y2="4"></line>
            <line x1="0" x2="4.4" y1="2" y2="2"></line>
            <line x1="0" x2="4.4" y1="0" y2="0"></line>
        `,data:{beat:e.beat+1,pitch:e.pitch,part:e.part}}),note:e=>W("data",{class:`${e.stemDirection==="up"?"up-note":"down-note"} note`,style:e.stemHeight&&`--stem-height: ${e.stemHeight};`,html:e.stave.getNoteHTML(e.pitch,e.dynamic,e.duration),data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part,beam:e.beam&&Se(e.beam[0]),event:Se(e.event)}}),beam:e=>W("svg",{class:`${e.direction}-beam beam`,viewBox:`0 ${(e.range>0?-e.range:0)-.5} 1 ${bi(e.range)+1}`,preserveAspectRatio:"none",style:`height: ${(bi(e.range)+1)*.125}em; align-self: ${e.range>0?"end":"start"};`,html:`<path class="beam-path" d="M0,${-.5*Me} L1,${-e.range-.5*Me} L1,${-e.range+.5*Me} L0,${.5*Me} Z"></path>`,data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part,events:e.events.map(Se).join(" ")}}),tie:e=>W("svg",{class:`${e.updown}-tie tie`,viewBox:"0 0 1 1",preserveAspectRatio:"none",html:'<path class="tie-path" transform="translate(0, 0.14) scale(1 0.6)" d="M0.979174733,0.0124875307 C0.650597814,1.1195554 0.135029714,1.00095361 0.0165376402,0.026468657 C0.0113570514,0.0135475362 0.00253387291,0.00218807553 0,0 C0.0977526897,1.29523004 0.656681642,1.37089992 1,2.43111793e-08 C0.991901367,2.43111797e-08 0.987703936,0.01248753 0.979174733,0.0124875307 Z M0.979174733,0.0124875307"></path>',data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part}}),rest:e=>W("span",{class:"rest",html:`${ie["rest"+(e.duration+"").replace(".","")]||""}`,data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part}}),default:function(e){return function(t){e[t.type]||(e[t.type]=!0,console.log(t),console.error('Scribe: symbol type "'+t.type+'" not rendered'))}}({})});function Wf(e,t){let r=yi(t);return r&&e.push(r),e}function Kf(e,t){return e.push(W("div",{class:`${t.stave.type}-stave stave bar`,data:{beat:t.beat,duration:t.duration},children:t.symbols.reduce(Wf,[])})),e}function Hn(e){return e.reduce(Kf,[])}var Xf=Object.assign,jf=Object.defineProperties,Qf=new URL("shadow.css",import.meta.url),dr=Q.of(),Zf=[],xi=new ResizeObserver(e=>{for(let t of e)z(t.target).shadowRoot.querySelectorAll(".beam").forEach(zn)}),ad=jf(Lr("scribe-music",{shadow:`<link rel="stylesheet" href="${Qf}" />`,construct:function(e,t){let r=e.querySelector("link");Zf.push(f=>r.href=f),dr.value&&(r.href=dr.value),t.data=Q.of(),t.clef=Q.of("treble"),t.key=Q.of("C"),t.meter=Q.of([-4,"meter",4,1]),t.transpose=Q.of(0),t.isSafari=navigator.userAgent.includes("AppleWebKit/")&&!navigator.userAgent.includes("Chrome/")&&!navigator.userAgent.includes("Edge/")&&!navigator.userAgent.includes("Gecko/")},connect:function(e,t){if(t.isSafari&&this.classList.add("safari"),xi.observe(this,{box:"content-box"}),!this.src){let r=this.textContent.trim();t.data.value=je(this.type,r)}return Q.frame(()=>{let r=t.data.value&&Hn(bn(t.data.value.events,t.clef.value,t.key.value,t.meter.value,t.transpose.value));e.querySelectorAll(".bar").forEach(f=>f.remove()),e.append.apply(e,r),e.querySelectorAll(".beam").forEach(zn)})},disconnect:function(){xi.unobserve(this)}},{clef:{attribute:function(e){this.clef=e},get:function(){return z(this).clef.value},set:function(e){if(!er[e]){console.warn('<scribe-music> Attempt to set invalid clef="'+e+'" ignored');return}z(this).clef.value=e}},key:{attribute:function(e){this.key=e===""?"C":e},get:function(){return z(this).key.value},set:function(e){let t=z(this);if(typeof e!="string"||!/^[A-G][#bâ™¯â™­]?$/.test(e)){console.warn('<scribe-music> Attempt to set invalid key="'+e+'" ignored');return}t.key.value=e.replace(/[#b]$/,r=>r==="#"?"â™¯":"â™­")}},meter:{attribute:function(e){this.meter=e===""?"4/4":e},get:function(){return gi(z(this).meter.value)},set:function(e){z(this).meter.value=Xf([0],mi(e))}},transpose:{attribute:function(e){this.transpose=e},get:function(){return z(this).transpose.value},set:function(e){z(this).transpose.value=typeof e=="number"?Math.round(e):parseInt(e,10)}},type:{attribute:function(e){this.type=e},writable:!0,value:"application/json"},src:{attribute:function(e){this.src=e},get:function(){return z(this).src},set:function(e){let t=z(this);t.src=e;let r=new URL(e,window.location);if(window.location.origin===r.origin&&window.location.pathname===r.pathname){let f=this.getRootNode().getElementById(r.hash.slice(1));if(!f)throw new Error('<scribe-music> src script "'+e+'" not found in document');this.data=JSON.parse(f.textContent)}else di(this.type,r.href).then(f=>this.data=f)},default:null},data:{get:function(){return z(this).data.value},set:function(e){z(this).data.value=e},default:null}},null,"github.com/stephband/scribe/"),{stylesheet:{set:e=>dr.value=e,get:()=>dr.value}});export{ad as default};
//# sourceMappingURL=element.js.map

/* Scribe 
   0.3.1
   By Stephen */

var Co=Object.defineProperty;var No=(e,t)=>{for(var r in t)Co(e,r,{get:t[r],enumerable:!0})};var re,He;function ko(e,t){let r=-1;for(;e[++r]&&e[r]!==t;);for(;e[r++];)e[r-1]=e[r]}function Kr(e){let t=0;for(;e[--t];)e[t].stop&&e[t].stop(),e[t]=void 0}function xt(e,t){let r=0;for(;t[--r]&&t[r]!==e;);for(t[r]=e,r=-1;e[++r]&&e[r]!==t;);e[r]=t}function at(e){let t=-1,r;for(;r=e[++t];)e[t]=void 0,r.invalidate(e)}function Xr(e,t){let r=0;for(;e[--r];)if(e[r]===t)return!0}var X=class e{static isSignal(t){return t instanceof e}static of(t){return new $r(t)}static from(t,r){if(t.then){let i=e.of();return t.then(o=>i.value=o),i}return t.pipe?t.pipe(new Ur):new er(t,r)}static compute(t,r){return new er(t,r)}static fromProperty(t,r){return new zr(t,r)}static frame(t){return new nr(t)}static tick(t){return new rr(t)}static temporal(t,r){return new Hr(t,r)}static evaluate(t,r,i=t){let o=re;re=t,o||(He=!1);let h=r.apply(i);return re=o,h}static get hasInvalidDependency(){return He}static get evaluating(){return re}constructor(t){t&&(this.name=t)}valueOf(){return this.value}toString(){return this.value+""}toJSON(){return this.value}},$r=class extends X{#e;constructor(t){super(),this.#e=t}get value(){return re&&xt(this,re),this.#e}set value(t){this.#e!==t&&(this.#e=t,at(this))}},Ur=class extends X{#e;constructor(t){super(),this.#e=t}get value(){return re&&xt(this,re),this.#e}push(t){this.#e!==t&&(this.#e=t,at(this))}},zr=class extends X{#e;#t;constructor(t,r){super(t),this.object=r}evaluate(){return this.object[this.name]}get value(){return re&&xt(this,re),this.#e?this.#t:(this.#t=X.evaluate(this,this.evaluate,this),He||(this.#e=!0),this.#t)}set value(t){if(this.#t===t)return;let{object:r,name:i}=this;r[i]=t,t=r[i],this.#t!==t&&(this.#t=t,at(this))}invalidate(t){this.#e&&(t&&!Xr(this,t)||(this.#e=!1,Kr(this),at(this)))}},er=class extends X{#e;#t;#r;#n;constructor(t,r){super(),this.#e=t,this.#t=r}get value(){return re&&xt(this,re),this.#r?this.#n:(this.#n=X.evaluate(this,this.#e,this.#t),He||(this.#r=!0),this.#n)}invalidate(t){this.#r&&(t&&!Xr(this,t)||(this.#r=!1,Kr(this),at(this)))}},Hr=class extends X{#e=0;constructor(t,r){super(t),this.object=r}getTime(){return window.performance.now()}evaluate(){return this.object[this.name]}get value(){return X.evaluating&&(xt(this,re),this.getTime()<this.#e&&(He=!0)),this.evaluate()}set value(t){console.warn("Dont really want to be setting value of TimedSignal"),console.trace(),this.object[this.name]!==t&&(this.object[this.name]=t,invalidateUntil(this.getTime()))}invalidateUntil(t){let i=this.getTime()>=this.#e;this.#e=t,i&&at(this)}},tr=class extends X{constructor(t){if(super(),re){let r=0;for(;re[--r]&&re[r]!==this;);re[r]=this}t&&(this.evaluate=t,(X.evaluate(this,this.evaluate)||He)&&this.cue())}invalidate(t){this.constructor.observers.indexOf(this)===-1&&(t&&!Xr(this,t)||(Kr(this),this.cue()))}stop(){let t=0,r;for(;r=this[--t];){let h=-1;this[t]=void 0,r.stop?r.stop():ko(r,this)}let i=this.constructor.observers,o=i.indexOf(this);if(o!==-1){if(i===Wr)throw new Error("Attempt to remove observer while observers is rendering");i.splice(o,1)}return this}valueOf(){return this}toString(){return"[object Signal]"}toJSON(){}},Wr;function Ga(e){let t=-1,r;for(Wr=e;r=e[++t];)!X.evaluate(r,r.evaluate)&&!He&&e.splice(t--,1);return Wr=void 0,e}var Ra=Promise.resolve();function qa(){Ga(rr.observers).length&&Ra.then(qa)}var rr=class extends tr{static observers=[];cue(){let t=this.constructor.observers;t.length||Ra.then(qa),t.push(this)}};function $a(){Ga(nr.observers).length&&requestAnimationFrame($a)}var nr=class extends tr{static observers=[];cue(){let t=this.constructor.observers;t.length||window.requestAnimationFrame($a),t.push(this)}};function be(e){return e}function J(e,t){return function(){let i=e.apply(this,arguments),o=t[i]||t.default;if(!o)throw new Error('overload() no function defined for key "'+i+'"');return o.apply(this,arguments)}}function it(e){var t=new Map;return function(i){if(t.has(i))return t.get(i);var o=e(i);return t.set(i,o),o}}var To=Array.prototype;function Bo(e,t){return typeof e=="function"?e.apply(null,t):e}function Ua(e,t,r){r=r||e.length;var i=r===1?t?e:it(e):it(function(o){return Ua(function(){var h=[o];return h.push.apply(h,arguments),e.apply(null,h)},t,r-1)});return function o(h){return arguments.length===0?o:arguments.length===1?i(h):arguments.length>=r?e.apply(null,arguments):Bo(i(h),To.slice.call(arguments,1))}}var xe=Ua;function ie(){}var _o=J(be,{is:ie,tag:ie,data:function(e,t,r){for(e in r)r[e]===void 0&&delete r[e];Object.assign(t.dataset,r)},dataset:function(e,t,r){for(e in r)r[e]===void 0&&delete r[e];Object.assign(t.dataset,r)},html:function(e,t,r){t.innerHTML=r},text:function(e,t,r){t.textContent=r},style:J((e,t,r)=>typeof r,{string:(e,t,r)=>t.style=r,object:(e,t,r)=>Object.assign(t.style,r)}),children:function(e,t,r){t.innerHTML="",t.append.apply(t,r)},href:function(e,t,r){t instanceof SVGElement?t.setAttribute("href",r):t.href=r},points:Ee,cx:Ee,cy:Ee,r:Ee,x:Ee,y:Ee,dx:Ee,dy:Ee,transform:Ee,preserveAspectRatio:Ee,viewBox:Ee,default:function(e,t,r){e in t?t[e]=r:t.setAttribute(e,r)}});function Ee(e,t,r){t.setAttribute(e,r)}function Do(e,t){for(var r=Object.keys(t),i=r.length;i--;)t[r[i]]!==void 0&&_o(r[i],e,t[r[i]]);return e}var ar=xe(Do,!0);var Qr="http://www.w3.org/2000/svg",za=document.createElement("template"),Zr=(e,t)=>t&&typeof t;function Ha(e,t=""){let r=document.createRange();return r.selectNode(e),r.createContextualFragment(t)}var le=J(Zr,{string:function(e,t){let r=document.createElementNS(Qr,e);return r.innerHTML=t,r},object:function(e,t){let r=document.createElementNS(Qr,e);return typeof t.length=="number"?r.append.apply(r,t):ar(r,t),r},default:e=>document.createElementNS(Qr,e)}),Ao=J(Zr,{string:function(e,t){let r=document.createElement(e);return r.innerHTML=t,r},object:function(e,t){let r=document.createElement(e);return typeof t.length=="number"?r.append.apply(r,t):ar(r,t),r},default:e=>document.createElement(e)}),Fo=J(be,{comment:function(e,t){return document.createComment(t||"")},fragment:J(Zr,{string:function(e,t,r){return r?Ha(r,t):(za.innerHTML=t,za.content.cloneNode(!0))},object:function(e,t,r){let i=r?Ha(r):document.createDocumentFragment();return typeof t.length=="number"?i.append.apply(i,t):ar(i,t),i},default:()=>document.createDocumentFragment()}),circle:le,ellipse:le,g:le,glyph:le,image:le,line:le,rect:le,use:le,path:le,pattern:le,polygon:le,polyline:le,svg:le,tspan:le,text:le,default:Ao}),U=Fo;function Jr(e,t,r){let i;typeof r!="string"&&r.input!==void 0&&r.index!==void 0&&(i=r,r=i.input.slice(r.index+r[0].length+(r.consumed||0)));let o=e.exec(r);if(!o)return;let h=t(o);return i&&(i.consumed=(i.consumed||0)+o.index+o[0].length+(o.consumed||0)),h}var bu=xe(Jr,!0);function So(e,t,r){throw r.input!==void 0&&r.index!==void 0&&(r=r.input),new Error('Cannot parse string "'+(r.length>128?r.length.slice(0,128)+"…":r)+'"')}function Lo(e,t,r){let i=-1;for(;++i<r.length;)t=r[i]!==void 0&&e[i]?e[i](t,r):t;return e.done?e.done(t,r):e.close?e.close(t,r):t}function Po(e,t,r,i){let o=Jr(e,h=>Lo(t,r,h),i);return o===void 0?t.catch?t.catch(r,i):So(e,t,i):o}var Wa=xe(Po,!0);var Ka=Symbol("internals");function Yr(e,t,r){return t[Ka]=t.attachInternals&&!t.getAttribute("is")?t.attachInternals():{shadowRoot:r}}function z(e){return e[Ka]}var Xa=Object.defineProperties;var jr={},Mo={name:{set:function(e){return this.setAttribute("name",e)},get:function(){return this.getAttribute("name")||""}},form:{get:function(){return z(this).form}},labels:{get:function(){return z(this).labels}},validity:{get:function(){return z(this).validity}},validationMessage:{get:function(){return z(this).validationMessage}},willValidate:{get:function(){return z(this).willValidate}},checkValidity:{value:function(){return z(this).checkValidity()}},reportValidity:{value:function(){return z(this).reportValidity()}}},Vr=!1,Oo=Wa(/^\s*<?([a-z][\w]*-[\w-]+)>?\s*$|^\s*<?([a-z][\w]*)\s+is[=\s]*["']?([a-z][\w]*-[\w-]+)["']?>?\s*$/,{1:(e,t)=>({name:t[1]}),2:(e,t)=>({name:t[3],tag:t[2]}),catch:function(e,t){throw new SyntaxError(`dom element() – name must be of the form 'element-name' or 'tag is="element-name"' (`+t+")")}},null),Qa={once:!0};function Io(e){return e.sheet?Promise.resolve({target:e}):new Promise((t,r)=>{e.addEventListener("load",t,Qa),e.addEventListener("error",r,Qa)})}function Go(e){e.stop()}function Ro(e){if(jr[e])return jr[e];let t=document.createElement(e).constructor;if(t===HTMLUnknownElement)throw new Error("Cannot define customised built-in - constructor for <"+e+"> is HTMLUnknownElement");return jr[e]=t}function qo(e,t){if(e.hasOwnProperty(t)){let r=e[t];delete e[t],e[t]=r}return e}function Za(e,t){let r=e.attachShadow({mode:t.mode||"closed",delegatesFocus:t.focusable||!1});if(t.stylesheet){let i=U("link",{rel:"stylesheet",href:t.stylesheet});r.append(i)}return r}function $o(e,t){return typeof t=="string"?t[0]==="#"?e.appendChild(document.getElementById(t.slice(1)).content.clone(!0)):e.innerHTML=t:e.appendChild(t.content.clone(!0)),e}function Uo(e){let t=e.isUpgraded;return e.isUpgraded=!0,!t}function Ja(e,t){return Array.from(e.querySelectorAll('[is="'+t+'"]')).filter(Uo)}var zo=J((e,t)=>typeof t,{object:(e,t)=>t,function:(e,t)=>({value:t}),default:(e,t)=>{throw new TypeError("element() does not accept property descriptor of type "+typeof t)}});function en(e,t={},r={},i=""){let{name:o,tag:h}=Oo(e),u=typeof h=="string"?Ro(h):HTMLElement,a=[],c={},l,d;for(l in r)d=zo(l,r[l]),d.attribute&&a.push(l),(d.set||d.get||"value"in d)&&(c[l]=d),r[l]=d;function n(){let s=Reflect.construct(u,arguments,n),f=t.mode||typeof t.shadow=="string"?Za(s,t):void 0;t.shadow&&$o(f,t.shadow);let p=Yr(n,s,f);return h&&(Vr=!0),t.construct&&t.construct.call(s,f,p),Object.keys(c).reduce(qo,s),s}if(n.prototype=Object.create(u.prototype,c),r.value&&(n.formAssociated=!0,Xa(n.prototype,Mo),(t.enable||t.disable)&&(n.prototype.formDisabledCallback=function(s){let f=z(this);return s?t.disable&&t.disable.call(this,f.shadowRoot,f):t.enable&&t.enable.call(this,f.shadowRoot,f)}),t.reset&&(n.prototype.formResetCallback=function(){let s=z(this);return t.reset.call(this,s.shadowRoot,s)}),t.restore&&(n.prototype.formStateRestoreCallback=function(){let s=z(this);return t.restore.call(this,s.shadowRoot,s)})),a.length&&(n.observedAttributes=a,n.prototype.attributeChangedCallback=function(s,f,p){return r[s].attribute.call(this,p)}),t.connect&&(n.prototype.connectedCallback=function(){let s=z(this),f=s.shadowRoot;if(s.stopable=t.connect.call(this,f,s),!f)return;let p=f.querySelectorAll('link[rel="stylesheet"]');if(p.length){let m=U("style","*:not(slot), slot:not([name]) { display: none !important; }");f.prepend(m);let g;s.loadPromise?g=s.loadPromise.then(()=>new Promise(requestAnimationFrame)):g=s.loadPromise=Promise.all(Array.from(p,Io)),g.finally(()=>{m.remove(),t.load&&t.load.call(this,f,s)})}else t.load&&t.load.call(this,f,s)}),n.prototype.disconnectedCallback=function(){let s=z(this);s.stopable&&(s.stopable.stop?s.stopable.stop():s.stopable.forEach(Go)),t.disconnect&&t.disconnect.call(this,s.shadowRoot,s)},window.console&&window.console.log("%c<"+(h?h+" is="+o:o)+">%c "+i,"color:#3a8ab0;font-weight:600;","color:#888888;font-weight:400;"),window.customElements.define(o,n,h&&{extends:h}),h&&!Vr){let s=document.createElement("div");if(s.style.position="fixed",s.style.left="-1000px",s.style.top="-1000px",s.innerHTML="<"+h+' is="'+o+'"></'+h+">",document.body.append(s),s.remove(),Vr)n.polyfillByRoot=ie;else{let f=function(m){let g={};Object.keys(c).forEach(v=>{m[v]!==void 0&&(g[v]=m[v])}),Xa(m,c);let b=t.mode||t.shadow?Za(m,t):void 0,N=Yr(n,m,b);t.construct&&t.construct.call(m,b,N),Object.assign(m,g);let B=-1,y;for(;y=a[++B];){let v=m.attributes[y];v&&r[y].attribute.call(m,v.value)}t.connect&&t.connect.call(m,b,N)},p=function(m){Ja(m,o).forEach(f),new MutationObserver(()=>Ja(m,o).forEach(f)).observe(m,{childList:!0,subtree:!0})};n.polyfillByRoot=p,p(document)}}else n.polyfillByRoot=ie;return n}var ir=e=>typeof e;var Ho=Object.defineProperties,Ya=J(ir,{function:e=>e(),object:e=>e.stop()}),We=class extends be{#e;stop(){if(this.status==="done")return this;this.status="done";let t=this.#e;return this.#e=void 0,t&&t.forEach(Ya),this}done(t){return this.status==="done"?(Ya(listener),this):((this.#e||(this.#e=[])).push(t),this)}};Ho(We.prototype,{status:{writable:!0}});function Wo(e){throw new TypeError("Stream cannot be created .from() "+typeof e)}function ue(e,t){if(t===void 0)return;let r=-1;for(;e[++r];)e[r].push(t);return e}function Ko(e){We.prototype.stop.apply(e);let t=-1,r;for(;r=e[++t];)e[t]=void 0,r.stop&&(cn(r,e),r[-1]||r.stop());return e}function cn(e,t){let r=0;for(;e[--r]&&e[r]!==t;);for(;e[r--];)e[r+1]=e[r]}function ja(e,t){let r=-1;for(;e[++r]&&e[r]!==t;);for(;e[r++];)e[r-1]=e[r]}function Xo(e,t){cn(t,e),ja(e,t)}var wt=class extends We{stop(){if(this.status==="done")return this;let t;for(;t=this[-1];){let r=-1;for(;this[r--];)this[r+1]=this[r];ja(t,this),t.stop&&!t[0]&&t.stop(t)}return super.stop()}},or=class extends wt{constructor(t){super(),this.push=t}},sr=class extends wt{constructor(t,r){super(),this.fn=t,this.value=r,this.i=0}push(t){let r=this.fn;this.value=r(this.value,t,this.i++,this)}},oe=class extends wt{start(){if(this.status)return this;let t=0,r;e:for(;r=this[--t];){let i=-1;for(;r[++i];)if(r[i]===this)continue e;r[i]=this,i===0&&r.start&&r.start()}return this}stop(){if(this.status==="done")return this;super.stop();let t=-1,r;for(;r=this[++t];)this[t]=void 0,r.stop&&(cn(r,this),r[-1]||r.stop());return this}pipe(t){if(t.stop){let i=0;for(;t[--i]&&t[i]!==this;);t[i]=this}if(t.start&&!(t[0]||t.status==="running"))return t;let r=-1;for(;this[++r]&&this[r]!==t;);return this[r]=t,r||this.start(),t}each(t){return this.pipe(new or(t))}buffer(...t){return this.pipe(new ot(t))}filter(t){return this.pipe(new rn(t))}flatMap(t){return this.pipe(new nn(t))}map(t){return this.pipe(new cr(t))}reduce(t,r){return this.pipe(new sr(t,r)).value}scan(t,r){return this.pipe(new on(t,r))}slice(t,r){return this.pipe(new sn(t,r))}split(t){return this.pipe(new fn(t))}[Symbol.asyncIterator]=async function*(){let t=[],r=o=>t.push(o);function i(o,h){r=o}for(this.each(o=>r(o)).done(()=>r=ie);r!==ie;)yield t.length?t.shift():await new Promise(i)};static from=J(ir,{function:t=>new cr(t),object:t=>typeof t.pipe=="function"?t:typeof t.then=="function"?new tn(t):typeof t.length=="number"?new ot(Array.from(t)):Wo(t)});static of(...t){return t.length<2?new fr(t[0]):new ot(t)}static buffer(t){return new ot(t)}static value(t){return new fr(t)}static merge(...t){return new an(t)}static push=ue;static stop=Ko;static unpipe=Xo;static each(t){return new or(t)}static reduce(t,r){return new sr(t,r)}},tn=class extends oe{constructor(t){super(),this.promise=t}start(){return this.promise.then(t=>ue(this,t)).finally(()=>this.stop()),this}},fr=class extends oe{constructor(t){super(),this.value=t}start(){return this.value!==void 0&&(ue(this,this.value),this.status==="done")?this:super.start()}push(t){return this.value=t,ue(this,t)}},ot=class extends oe{constructor(t){super(),this.values=t||[]}start(){let t=this.values;if(!t)return super.start();let r=-1;for(;r++<t.length;)if(ue(this,t[r]),this.status==="done")return this;return this.values=void 0,super.start()}push(t){return this.value=t,this.values?this.values.push(this.value):ue(this,this.value)}},rn=class extends oe{constructor(t){super(),this.fn=t}push(t){let r=this.fn;return r(t)&&ue(this,t)}},nn=class extends oe{constructor(t){super(),this.fn=t}push(t){let r=this.fn,i=r(t);if(i!==void 0)if(isIterable(i))for(let o of i)ue(this,o);else i.pipe?(console.warn("FlatMapping pipeables is dodgy. Map to arrays for the moment please."),this.done(i.each(o=>ue(this,o)))):i.then&&i.then(o=>ue(this,o))}},cr=class extends oe{constructor(t){super(),this.fn=t}push(t){let r=this.fn,i=r(t);return i!==void 0&&ue(this,i)}},an=class extends oe{constructor(t){super(),this.inputs=t}push(t){return ue(this,t)}pipe(t){let r=-1,i;for(;i=this.inputs[++r];)oe.from(i).pipe(this);return oe.prototype.pipe.call(this,t)}},on=class extends oe{constructor(t,r){super(),this.fn=t,this.value=r}push(t){let r=this.fn;this.value=r(this.value,t),ue(this,this.value)}},sn=class extends oe{constructor(t,r=1/0){super(),this.index=-t,this.indexEnd=r-t}push(t){++this.index>0&&ue(this,t),this.index===this.indexEnd&&this.stop()}},fn=class extends oe{constructor(t){super(),this.chunk=[],typeof t=="number"?this.n=t:this.fn=t}fn(){return this.chunk.length===this.n}push(t){let r=this.chunk;this.fn(t)?(ue(this,r),this.chunk=[]):r.push(t)}};var Ku={fullscreenchange:it(()=>"fullscreenElement"in document?"fullscreenchange":"webkitFullscreenElement"in document?"webkitfullscreenchange":"mozFullScreenElement"in document?"mozfullscreenchange":"msFullscreenElement"in document?"MSFullscreenChange":"fullscreenchange")},Qo=0;window.addEventListener("click",e=>Qo=e.timeStamp);function ln(e){return function(){return arguments[e]}}function un(e){return e}function Ke(){}function Ce(){return this}var Va=Object.create,Zo=Object.freeze,ei=Zo(Va(Va(Object.prototype,{at:{value:Ke},shift:{value:Ke},push:{value:Ke},forEach:{value:Ke},join:{value:function(){return""}},every:{value:function(){return!0}},filter:{value:Ce},find:{value:Ke},findIndex:{value:function(){return-1}},flat:{value:Ce},flatMap:{value:Ce},includes:{value:function(){return!1}},indexOf:{value:function(){return-1}},map:{value:Ce},reduce:{value:ln(1)},sort:{value:Ce},each:{value:Ce},pipe:{value:un},start:{value:Ce},stop:{value:Ce},done:{value:Ce},valueOf:{value:function(){return null}}}),{length:{value:0}}));function hn(e,t){return(t%e+e)%e}var ri=e=>hn(12,e);var Jo=/^([A-G][♭♯#b]?)(-?\d)$/,Yo=/^[A-G][♭♯#b]?/,jo=/-?\d$/,Vo=/[Hh]z$/,st={C:0,"C♯":1,"C#":1,"D♭":1,Db:1,D:2,"D♯":3,"D#":3,"E♭":3,Eb:3,E:4,F:5,"F♯":6,"F#":6,"G♭":6,Gb:6,G:7,"G♯":8,"G#":8,"A♭":8,Ab:8,A:9,"A♯":10,"A#":10,"B♭":10,Bb:10,B:11},ti={27:"High Q",28:"Slap",29:"Scratch Push",30:"Scratch Pull",31:"Sticks",32:"Square Click",33:"Metronome Click",34:"Metronome Bell",35:"Bass Drum 2",36:"Bass Drum 1",37:"Side Stick",38:"Snare Drum 1",39:"Hand Clap",40:"Snare Drum 2",41:"Low Tom 2",42:"Closed Hi-hat",43:"Low Tom 1",44:"Pedal Hi-hat",45:"Mid Tom 2",46:"Open Hi-hat",47:"Mid Tom 1",48:"High Tom 2",49:"Crash Cymbal 1",50:"High Tom 1",51:"Ride Cymbal 1",52:"Chinese Cymbal",53:"Ride Bell",54:"Tambourine",55:"Splash Cymbal",56:"Cowbell",57:"Crash Cymbal 2",58:"Vibra Slap",59:"Ride Cymbal 2",60:"High Bongo",61:"Low Bongo",62:"Mute High Conga",63:"Open High Conga",64:"Low Conga",65:"High Timbale",66:"Low Timbale",67:"High Agogo",68:"Low Agogo",69:"Cabasa",70:"Maracas",71:"Short Whistle",72:"Long Whistle",73:"Short Guiro",74:"Long Guiro",75:"Claves",76:"High Wood Block",77:"Low Wood Block",78:"Mute Cuica",79:"Open Cuica",80:"Mute Triangle",81:"Open Triangle",82:"Shaker",83:"Jingle Bell",84:"Belltree",85:"Castanets",86:"Mute Surdo",87:"Open Surdo"};function ni(e){return e.toLowerCase().replace(/\s+/g,"-")}for(let e in ti)st[ni(ti[e])]=parseInt(e,10);var es=69;function ts(e,t=440){var r=es+12*Math.log(e/t)/Math.log(2);return Math.fround(r)}function W(e){if(typeof e=="number")return e;if(Vo.test(e))return ts(parseFloat(e));let t=Jo.exec(e);return t?(parseInt(t[2],10)+1)*12+st[t[1]]:st[ni(e)]}function pe(e){return typeof e=="number"?ri(e):st[Yo.exec(e)[0]]}var pn=["C","C♯","D","E♭","E","F","F♯","G","G♯","A","B♭","B"];function yt(e){return Et(e)+lr(e)}function Et(e){return pn[ri(e)]}function lr(e){return typeof e=="number"?Math.floor(e/12)-1:Number(st[(jo.exec(name)||ei)[0]])}function dn(e){var t={};return function(i){return i in t?t[i]:t[i]=e(i)}}function ur(e){return function(r,...i){var o=e[r]||e.default;return o&&o.apply(this,i)}}var rs={xml:"application/xml",html:"text/html",svg:"image/svg+xml"};function mn(e,t){if(t){var r=rs[e.toLowerCase()]||e,i;try{i=new window.DOMParser().parseFromString(t,r)}catch{return}if(!i||i.getElementsByTagName("parsererror").length)throw new Error("Invalid "+e.toUpperCase()+": "+t);return i}}function ai(e){return mn("html",e)}function ii(e){return mn("svg",e)}var Pe=Object.assign,ft={headers:function(e){return{}},body:be},ns=ur({"application/x-www-form-urlencoded":function(e){return Pe(e,{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"})},"application/json":function(e){return Pe(e,{"Content-Type":"application/json; charset=utf-8","X-Requested-With":"XMLHttpRequest"})},"multipart/form-data":function(e){return Pe(e,{"Content-Type":"multipart/form-data","X-Requested-With":"XMLHttpRequest"})},"audio/wav":function(e){return Pe(e,{"Content-Type":"audio/wav","X-Requested-With":"XMLHttpRequest"})},"image/png":function(e){return Pe(e,{"Content-Type":"image/png","X-Requested-With":"XMLHttpRequest"})},"image/jpg":function(e){return Pe(e,{"Content-Type":"image/jpg","X-Requested-With":"XMLHttpRequest"})},"image/jpeg":function(e){return Pe(e,{"Content-Type":"image/jpeg","X-Requested-With":"XMLHttpRequest"})},default:function(e){return Pe(e,{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"})}}),as=ur({"application/json":function(e){return e instanceof FormData?is(e):JSON.stringify(e)},"application/x-www-form-urlencoded":function(e){return e instanceof FormData?si(e):fi(e)},"multipart/form-data":function(e){return e instanceof FormData?e:os(e)},default:be});function is(e){return JSON.stringify(Array.from(e.entries()).reduce(function(t,r){return t[r[0]]=r[1],t},{}))}function si(e){return new URLSearchParams(e).toString()}function fi(e){return Object.keys(e).reduce((t,r)=>(t.append(r,e[r]),t),new URLSearchParams)}function os(e){throw new Error("TODO: dataToFormData(data)")}function ss(e,t){return t instanceof FormData?e+"?"+si(t):e+"?"+fi(t)}function fs(e,t,r,i){let o=typeof r=="string"?r:r&&r["Content-Type"]||"application/json",h=ns(o,Pe(ft.headers&&t?ft.headers(t):{},typeof r=="string"?{}:r)),u={method:e,mode:"cors",headers:h,credentials:"same-origin",signal:i&&i.signal};return e!=="GET"&&(u.body=as(o,ft.body?ft.body(t):t)),u}function hr(e){return e.blob()}function cs(e){return e.json().catch(t=>{throw new Error("Cannot parse JSON "+e.url+". "+t.message)})}function oi(e){return e.formData()}function ls(e){return e.text()}function us(e){return e.text().then(t=>/^\s*<!DOCTYPE html>/.test(t)?ai(t):U("fragment",t))}function hs(e){return e.text().then(t=>/^\s*<\?xml/.test(t)?ii(t):(console.warn("Untested SVG fragment parsing in request.js!"),U("fragment",t)))}var ps={"text/plain":ls,"text/html":us,"image/svg+xml":hs,"application/json":cs,"multipart/form-data":oi,"application/x-www-form-urlencoded":oi,audio:hr,"audio/wav":hr,"audio/m4a":hr,"application/zip":hr};function ds(e){if(ft.onresponse&&(e=ft.onresponse(e)),!e.ok)throw new Error(e.statusText+"");let t=e.headers.get("Content-Type");if(!t)return;let r=t.replace(/\;.*$/,"");return ps[r](e)}function ci(e="GET",t,r={},i="application/json"){e=e.toUpperCase(),e==="GET"&&r&&(t=ss(t,r));let o=fs(e,r,i,arguments[4]);return fetch(t,o).then(ds)}function li(e){return ci("GET",e)}function ms(e,t){let r;for(r in e)if(e[r]!==t[r])return!1;return!0}var ui=xe(ms,!0);var we={};we.clone=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t};we.cloneArray=function(e){for(var t=[],r=0;r<e.length;r++)t.push(we.clone(e[r]));return t};we.cloneHashOfHash=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=we.clone(e[r]));return t};we.cloneHashOfArrayOfHash=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=we.cloneArray(e[r]));return t};we.strip=function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")};we.startsWith=function(e,t){return e.indexOf(t)===0};we.endsWith=function(e,t){var r=e.length-t.length;return r>=0&&e.lastIndexOf(t)===r};we.last=function(e){return e.length===0?null:e[e.length-1]};var G=we;var Xe={};(function(){"use strict";var e,t,r,i,o;Xe.initialize=function(w,x,T,C,P){e=w,t=x,r=T,i=C,o=P,h()};function h(){r.annotationfont={face:"Helvetica",size:12,weight:"normal",style:"normal",decoration:"none"},r.gchordfont={face:"Helvetica",size:12,weight:"normal",style:"normal",decoration:"none"},r.historyfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},r.infofont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},r.measurefont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},r.partsfont={face:'"Times New Roman"',size:15,weight:"normal",style:"normal",decoration:"none"},r.repeatfont={face:'"Times New Roman"',size:13,weight:"normal",style:"normal",decoration:"none"},r.textfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},r.tripletfont={face:"Times",size:11,weight:"normal",style:"italic",decoration:"none"},r.vocalfont={face:'"Times New Roman"',size:13,weight:"bold",style:"normal",decoration:"none"},r.wordsfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},i.formatting.composerfont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},i.formatting.subtitlefont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},i.formatting.tempofont={face:'"Times New Roman"',size:15,weight:"bold",style:"normal",decoration:"none"},i.formatting.titlefont={face:'"Times New Roman"',size:20,weight:"normal",style:"normal",decoration:"none"},i.formatting.footerfont={face:'"Times New Roman"',size:12,weight:"normal",style:"normal",decoration:"none"},i.formatting.headerfont={face:'"Times New Roman"',size:12,weight:"normal",style:"normal",decoration:"none"},i.formatting.voicefont={face:'"Times New Roman"',size:13,weight:"bold",style:"normal",decoration:"none"},i.formatting.tablabelfont={face:'"Trebuchet MS"',size:16,weight:"normal",style:"normal",decoration:"none"},i.formatting.tabnumberfont={face:'"Arial"',size:11,weight:"normal",style:"normal",decoration:"none"},i.formatting.tabgracefont={face:'"Arial"',size:8,weight:"normal",style:"normal",decoration:"none"},i.formatting.annotationfont=r.annotationfont,i.formatting.gchordfont=r.gchordfont,i.formatting.historyfont=r.historyfont,i.formatting.infofont=r.infofont,i.formatting.measurefont=r.measurefont,i.formatting.partsfont=r.partsfont,i.formatting.repeatfont=r.repeatfont,i.formatting.textfont=r.textfont,i.formatting.tripletfont=r.tripletfont,i.formatting.vocalfont=r.vocalfont,i.formatting.wordsfont=r.wordsfont}var u={gchordfont:!0,measurefont:!0,partsfont:!0,annotationfont:!0,composerfont:!0,historyfont:!0,infofont:!0,subtitlefont:!0,textfont:!0,titlefont:!0,voicefont:!0},a=function(w){switch(w){case"Arial-Italic":return{face:"Arial",weight:"normal",style:"italic",decoration:"none"};case"Arial-Bold":return{face:"Arial",weight:"bold",style:"normal",decoration:"none"};case"Bookman-Demi":return{face:"Bookman,serif",weight:"bold",style:"normal",decoration:"none"};case"Bookman-DemiItalic":return{face:"Bookman,serif",weight:"bold",style:"italic",decoration:"none"};case"Bookman-Light":return{face:"Bookman,serif",weight:"normal",style:"normal",decoration:"none"};case"Bookman-LightItalic":return{face:"Bookman,serif",weight:"normal",style:"italic",decoration:"none"};case"Courier":return{face:'"Courier New"',weight:"normal",style:"normal",decoration:"none"};case"Courier-Oblique":return{face:'"Courier New"',weight:"normal",style:"italic",decoration:"none"};case"Courier-Bold":return{face:'"Courier New"',weight:"bold",style:"normal",decoration:"none"};case"Courier-BoldOblique":return{face:'"Courier New"',weight:"bold",style:"italic",decoration:"none"};case"AvantGarde-Book":return{face:"AvantGarde,Arial",weight:"normal",style:"normal",decoration:"none"};case"AvantGarde-BookOblique":return{face:"AvantGarde,Arial",weight:"normal",style:"italic",decoration:"none"};case"AvantGarde-Demi":case"Avant-Garde-Demi":return{face:"AvantGarde,Arial",weight:"bold",style:"normal",decoration:"none"};case"AvantGarde-DemiOblique":return{face:"AvantGarde,Arial",weight:"bold",style:"italic",decoration:"none"};case"Helvetica-Oblique":return{face:"Helvetica",weight:"normal",style:"italic",decoration:"none"};case"Helvetica-Bold":return{face:"Helvetica",weight:"bold",style:"normal",decoration:"none"};case"Helvetica-BoldOblique":return{face:"Helvetica",weight:"bold",style:"italic",decoration:"none"};case"Helvetica-Narrow":return{face:'"Helvetica Narrow",Helvetica',weight:"normal",style:"normal",decoration:"none"};case"Helvetica-Narrow-Oblique":return{face:'"Helvetica Narrow",Helvetica',weight:"normal",style:"italic",decoration:"none"};case"Helvetica-Narrow-Bold":return{face:'"Helvetica Narrow",Helvetica',weight:"bold",style:"normal",decoration:"none"};case"Helvetica-Narrow-BoldOblique":return{face:'"Helvetica Narrow",Helvetica',weight:"bold",style:"italic",decoration:"none"};case"Palatino-Roman":return{face:"Palatino",weight:"normal",style:"normal",decoration:"none"};case"Palatino-Italic":return{face:"Palatino",weight:"normal",style:"italic",decoration:"none"};case"Palatino-Bold":return{face:"Palatino",weight:"bold",style:"normal",decoration:"none"};case"Palatino-BoldItalic":return{face:"Palatino",weight:"bold",style:"italic",decoration:"none"};case"NewCenturySchlbk-Roman":return{face:'"New Century",serif',weight:"normal",style:"normal",decoration:"none"};case"NewCenturySchlbk-Italic":return{face:'"New Century",serif',weight:"normal",style:"italic",decoration:"none"};case"NewCenturySchlbk-Bold":return{face:'"New Century",serif',weight:"bold",style:"normal",decoration:"none"};case"NewCenturySchlbk-BoldItalic":return{face:'"New Century",serif',weight:"bold",style:"italic",decoration:"none"};case"Times":case"Times-Roman":case"Times-Narrow":case"Times-Courier":case"Times-New-Roman":return{face:'"Times New Roman"',weight:"normal",style:"normal",decoration:"none"};case"Times-Italic":case"Times-Italics":return{face:'"Times New Roman"',weight:"normal",style:"italic",decoration:"none"};case"Times-Bold":return{face:'"Times New Roman"',weight:"bold",style:"normal",decoration:"none"};case"Times-BoldItalic":return{face:'"Times New Roman"',weight:"bold",style:"italic",decoration:"none"};case"ZapfChancery-MediumItalic":return{face:'"Zapf Chancery",cursive,serif',weight:"normal",style:"normal",decoration:"none"};default:return null}},c=function(w,x,T,C,P){function q(){var ge=parseInt(w[0].token);return w.shift(),x?w.length===0?{face:x.face,weight:x.weight,style:x.style,decoration:x.decoration,size:ge}:w.length===1&&w[0].token==="box"&&u[P]?{face:x.face,weight:x.weight,style:x.style,decoration:x.decoration,size:ge,box:!0}:(t("Extra parameters in font definition.",T,C),{face:x.face,weight:x.weight,style:x.style,decoration:x.decoration,size:ge}):(t("Can't set just the size of the font since there is no default value.",T,C),{face:'"Times New Roman"',weight:"normal",style:"normal",decoration:"none",size:ge})}if(w[0].token==="*"){if(w.shift(),w[0].type==="number")return q();t("Expected font size number after *.",T,C)}if(w[0].type==="number")return q();for(var H=[],$,he="normal",Z="normal",me="none",K=!1,Re="face",nt=!1;w.length;){var ce=w.shift(),j=ce.token.toLowerCase();switch(Re){case"face":nt||j!=="utf"&&ce.type!=="number"&&j!=="bold"&&j!=="italic"&&j!=="underline"&&j!=="box"?H.length>0&&ce.token==="-"?(nt=!0,H[H.length-1]=H[H.length-1]+ce.token):nt?(nt=!1,H[H.length-1]=H[H.length-1]+ce.token):H.push(ce.token):ce.type==="number"?($?t("Font size specified twice in font definition.",T,C):$=ce.token,Re="modifier"):j==="bold"?he="bold":j==="italic"?Z="italic":j==="underline"?me="underline":j==="box"?(u[P]?K=!0:t(`This font style doesn't support "box"`,T,C),Re="finished"):j==="utf"?(ce=w.shift(),Re="size"):t("Unknown parameter "+ce.token+" in font definition.",T,C);break;case"size":ce.type==="number"?$?t("Font size specified twice in font definition.",T,C):$=ce.token:t("Expected font size in font definition.",T,C),Re="modifier";break;case"modifier":j==="bold"?he="bold":j==="italic"?Z="italic":j==="underline"?me="underline":j==="box"?(u[P]?K=!0:t(`This font style doesn't support "box"`,T,C),Re="finished"):t("Unknown parameter "+ce.token+" in font definition.",T,C);break;case"finished":t('Extra characters found after "box" in font definition.',T,C);break}}$===void 0?x?$=x.size:(t("Must specify the size of the font since there is no default value.",T,C),$=12):$=parseFloat($),H=H.join(" "),H===""&&(x?H=x.face:(t("Must specify the name of the font since there is no default value.",T,C),H="sans-serif"));var ze=a(H),ae={};return ze?(ae.face=ze.face,ae.weight=ze.weight,ae.style=ze.style,ae.decoration=ze.decoration,ae.size=$,K&&(ae.box=!0),ae):(ae.face=H,ae.weight=he,ae.style=Z,ae.decoration=me,ae.size=$,K&&(ae.box=!0),ae)},l=function(w,x,T){return x.length===0?'Directive "'+w+'" requires a font as a parameter.':(r[w]=c(x,r[w],T,0,w),r.is_in_header&&(i.formatting[w]=r[w]),null)},d=function(w,x,T){return x.length===0?'Directive "'+w+'" requires a font as a parameter.':(i.formatting[w]=c(x,i.formatting[w],T,0,w),null)},n=function(w,x){var T="";x.forEach(function(P){T+=P.token});var C=parseFloat(T);if(isNaN(C)||C===0)return'Directive "'+w+'" requires a number as a parameter.';i.formatting.scale=C},s=["acoustic-bass-drum","bass-drum-1","side-stick","acoustic-snare","hand-clap","electric-snare","low-floor-tom","closed-hi-hat","high-floor-tom","pedal-hi-hat","low-tom","open-hi-hat","low-mid-tom","hi-mid-tom","crash-cymbal-1","high-tom","ride-cymbal-1","chinese-cymbal","ride-bell","tambourine","splash-cymbal","cowbell","crash-cymbal-2","vibraslap","ride-cymbal-2","hi-bongo","low-bongo","mute-hi-conga","open-hi-conga","low-conga","high-timbale","low-timbale","high-agogo","low-agogo","cabasa","maracas","short-whistle","long-whistle","short-guiro","long-guiro","claves","hi-wood-block","low-wood-block","mute-cuica","open-cuica","mute-triangle","open-triangle"],f=function(w){var x=w.split(/\s+/);if(x.length!==2&&x.length!==3)return{error:'Expected parameters "abc-note", "drum-sound", and optionally "note-head"'};var T=x[0],C=parseInt(x[1],10);if((isNaN(C)||C<35||C>81)&&x[1]&&(C=s.indexOf(x[1].toLowerCase())+35),isNaN(C)||C<35||C>81)return{error:'Expected drum name, received "'+x[1]+'"'};var P={sound:C};return x.length===3&&(P.noteHead=x[2]),{key:T,value:P}},p=function(w,x){var T=e.getMeasurement(x);return T.used===0||x.length!==0?{error:'Directive "'+w+'" requires a measurement as a parameter.'}:T.value},m=function(w,x){var T=e.getMeasurement(x);return T.used===0||x.length!==0?'Directive "'+w+'" requires a measurement as a parameter.':(i.formatting[w]=T.value,null)},g=function(w,x,T,C,P){if(T.length!==1||T[0].type!=="number")return'Directive "'+x+'" requires a number as a parameter.';var q=T[0].intt;return C!==void 0&&q<C?'Directive "'+x+'" requires a number greater than or equal to '+C+" as a parameter.":P!==void 0&&q>P?'Directive "'+x+'" requires a number less than or equal to '+P+" as a parameter.":(r[w]=q,null)},b=function(w,x,T){if(T.length===1&&(T[0].token==="true"||T[0].token==="false"))return r[w]=T[0].token==="true",null;var C=g(w,x,T,0,1);return C!==null?C:(r[w]=r[w]===1,null)},N=function(w,x,T,C){if(T.length!==1)return'Directive "'+x+'" requires one of [ '+C.join(", ")+" ] as a parameter.";for(var P=T[0].token,q=!1,H=0;!q&&H<C.length;H++)C[H]===P&&(q=!0);return q?(r[w]=P,null):'Directive "'+x+'" requires one of [ '+C.join(", ")+" ] as a parameter."},B=["nobarlines","barlines","beataccents","nobeataccents","droneon","droneoff","drumon","drumoff","fermatafixed","fermataproportional","gchordon","gchordoff","controlcombo","temperamentnormal","noportamento"],y=["gchord","ptstress","beatstring"],v=["bassvol","chordvol","bassprog","chordprog","c","channel","beatmod","deltaloudness","drumbars","gracedivider","makechordchannels","randomchordattack","chordattack","stressmodel","transpose","rtranspose","vol","volinc"],k=["program"],L=["ratio","snt","bendvelocity","pitchbend","control","temperamentlinear"],D=["beat"],A=["drone"],M=["portamento"],F=["expand","grace","trim"],S=["drum","chordname"],O=function(w,x,T){var C=w.shift().token,P=[];if(B.indexOf(C)>=0)w.length!==0&&t("Unexpected parameter in MIDI "+C,T,0);else if(y.indexOf(C)>=0)w.length!==1?t("Expected one parameter in MIDI "+C,T,0):P.push(w[0].token);else if(v.indexOf(C)>=0)w.length!==1?t("Expected one parameter in MIDI "+C,T,0):w[0].type!=="number"?t("Expected one integer parameter in MIDI "+C,T,0):P.push(w[0].intt);else if(k.indexOf(C)>=0)w.length!==1&&w.length!==2?t("Expected one or two parameters in MIDI "+C,T,0):w[0].type!=="number"||w.length===2&&w[1].type!=="number"?t("Expected integer parameter in MIDI "+C,T,0):(P.push(w[0].intt),w.length===2&&P.push(w[1].intt));else if(L.indexOf(C)>=0)w.length!==2?t("Expected two parameters in MIDI "+C,T,0):w[0].type!=="number"||w[1].type!=="number"?t("Expected two integer parameters in MIDI "+C,T,0):(P.push(w[0].intt),P.push(w[1].intt));else if(M.indexOf(C)>=0)w.length!==2?t("Expected two parameters in MIDI "+C,T,0):w[0].type!=="alpha"||w[1].type!=="number"?t("Expected one string and one integer parameters in MIDI "+C,T,0):(P.push(w[0].token),P.push(w[1].intt));else if(C==="drummap")w.length===2&&w[0].type==="alpha"&&w[1].type==="number"?(x.formatting||(x.formatting={}),x.formatting.midi||(x.formatting.midi={}),x.formatting.midi.drummap||(x.formatting.midi.drummap={}),x.formatting.midi.drummap[w[0].token]=w[1].intt,P=x.formatting.midi.drummap):w.length===3&&w[0].type==="punct"&&w[1].type==="alpha"&&w[2].type==="number"?(x.formatting||(x.formatting={}),x.formatting.midi||(x.formatting.midi={}),x.formatting.midi.drummap||(x.formatting.midi.drummap={}),x.formatting.midi.drummap[w[0].token+w[1].token]=w[2].intt,P=x.formatting.midi.drummap):t("Expected one note name and one integer parameter in MIDI "+C,T,0);else if(F.indexOf(C)>=0)w.length!==3||w[0].type!=="number"||w[1].token!=="/"||w[2].type!=="number"?t("Expected fraction parameter in MIDI "+C,T,0):(P.push(w[0].intt),P.push(w[2].intt));else if(D.indexOf(C)>=0)w.length!==4?t("Expected four parameters in MIDI "+C,T,0):w[0].type!=="number"||w[1].type!=="number"||w[2].type!=="number"||w[3].type!=="number"?t("Expected four integer parameters in MIDI "+C,T,0):(P.push(w[0].intt),P.push(w[1].intt),P.push(w[2].intt),P.push(w[3].intt));else if(A.indexOf(C)>=0)w.length!==5?t("Expected five parameters in MIDI "+C,T,0):w[0].type!=="number"||w[1].type!=="number"||w[2].type!=="number"||w[3].type!=="number"||w[4].type!=="number"?t("Expected five integer parameters in MIDI "+C,T,0):(P.push(w[0].intt),P.push(w[1].intt),P.push(w[2].intt),P.push(w[3].intt),P.push(w[4].intt));else if(k.indexOf(C)>=0)w.length!==1||w.length!==4?t("Expected one or two parameters in MIDI "+C,T,0):w[0].type!=="number"?t("Expected integer parameter in MIDI "+C,T,0):w.length===4?(w[1].token!=="octave"&&t("Expected octave parameter in MIDI "+C,T,0),w[2].token!=="="&&t("Expected octave parameter in MIDI "+C,T,0),w[3].type!=="number"&&t("Expected integer parameter for octave in MIDI "+C,T,0)):(P.push(w[0].intt),w.length===4&&P.push(w[3].intt));else if(S.indexOf(C)>=0)if(w.length<2)t("Expected string parameter and at least one integer parameter in MIDI "+C,T,0);else if(w[0].type!=="alpha")t("Expected string parameter and at least one integer parameter in MIDI "+C,T,0);else{var q=w.shift();for(P.push(q.token);w.length>0;)q=w.shift(),q.type!=="number"&&t("Expected integer parameter in MIDI "+C,T,0),P.push(q.intt)}o.hasBeginMusic()?o.appendElement("midi",-1,-1,{cmd:C,params:P}):(x.formatting.midi===void 0&&(x.formatting.midi={}),x.formatting.midi[C]=P)};Xe.parseFontChangeLine=function(w){w=w.replace(/\$\$/g,"");var x=w.split("$");if(x.length>1&&r.setfont){var T=[];x[0]!==""&&T.push({text:x[0]});for(var C=1;C<x.length;C++)if(x[C][0]==="0")T.push({text:x[C].substring(1).replace(/\x03/g,"$$")});else{var P=parseInt(x[C][0],10);r.setfont[P]?T.push({font:r.setfont[P],text:x[C].substring(1).replace(/\x03/g,"$$")}):T[T.length-1].text+="$"+x[C].replace(/\x03/g,"$$")}return T}return w.replace(/\x03/g,"$$")};var R=["auto","above","below","hidden"];Xe.addDirective=function(w){var x=e.tokenize(w,0,w.length);if(x.length===0||x[0].type!=="alpha")return null;var T=w.substring(w.indexOf(x[0].token)+x[0].token.length);T=e.stripComment(T);var C=x.shift().token.toLowerCase(),P="",q;switch(C){case"bagpipes":i.formatting.bagpipes=!0;break;case"flatbeams":i.formatting.flatbeams=!0;break;case"jazzchords":i.formatting.jazzchords=!0;break;case"accentAbove":i.formatting.accentAbove=!0;break;case"germanAlphabet":i.formatting.germanAlphabet=!0;break;case"landscape":r.landscape=!0;break;case"papersize":r.papersize=T;break;case"graceslurs":if(x.length!==1)return"Directive graceslurs requires one parameter: 0 or 1";if(x[0].token==="0"||x[0].token==="false")i.formatting.graceSlurs=!1;else if(x[0].token==="1"||x[0].token==="true")i.formatting.graceSlurs=!0;else return"Directive graceslurs requires one parameter: 0 or 1 (received "+x[0].token+")";break;case"lineThickness":var H=I(x);if(H.value!==void 0&&(i.formatting.lineThickness=H.value),H.error)return H.error;break;case"stretchlast":var $=I(x);if($.value!==void 0&&(i.formatting.stretchlast=$.value),$.error)return $.error;break;case"titlecaps":r.titlecaps=!0;break;case"titleleft":i.formatting.titleleft=!0;break;case"measurebox":i.formatting.measurebox=!0;break;case"vocal":return N("vocalPosition",C,x,R);case"dynamic":return N("dynamicPosition",C,x,R);case"gchord":return N("chordPosition",C,x,R);case"ornament":return N("ornamentPosition",C,x,R);case"volume":return N("volumePosition",C,x,R);case"botmargin":case"botspace":case"composerspace":case"indent":case"leftmargin":case"linesep":case"musicspace":case"partsspace":case"pageheight":case"pagewidth":case"rightmargin":case"staffsep":case"staffwidth":case"subtitlespace":case"sysstaffsep":case"systemsep":case"textspace":case"titlespace":case"topmargin":case"topspace":case"vocalspace":case"wordsspace":return m(C,x);case"voicescale":if(x.length!==1||x[0].type!=="number")return"voicescale requires one float as a parameter";var he=x.shift();return r.currentVoice&&(r.currentVoice.scale=he.floatt,o.changeVoiceScale(r.currentVoice.scale)),null;case"voicecolor":if(x.length!==1)return"voicecolor requires one string as a parameter";var Z=x.shift();return r.currentVoice&&(r.currentVoice.color=Z.token,o.changeVoiceColor(r.currentVoice.color)),null;case"vskip":var me=Math.round(p(C,x));return me.error?me.error:(o.addSpacing(me),null);case"scale":n(C,x);break;case"sep":if(x.length===0)o.addSeparator(14,14,85,{startChar:r.iChar,endChar:r.iChar+5});else{var K=e.getMeasurement(x);if(K.used===0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var Re=K.value;if(K=e.getMeasurement(x),K.used===0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var nt=K.value;if(K=e.getMeasurement(x),K.used===0||x.length!==0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var ce=K.value;o.addSeparator(Re,nt,ce,{startChar:r.iChar,endChar:r.iChar+T.length})}break;case"barsperstaff":if(P=g("barsperstaff",C,x),P!==null)return P;break;case"staffnonote":if(x.length!==1)return"Directive staffnonote requires one parameter: 0 or 1";if(x[0].token==="0")r.staffnonote=!0;else if(x[0].token==="1")r.staffnonote=!1;else return"Directive staffnonote requires one parameter: 0 or 1 (received "+x[0].token+")";break;case"printtempo":if(P=b("printTempo",C,x),P!==null)return P;break;case"partsbox":if(P=b("partsBox",C,x),P!==null)return P;r.partsfont.box=r.partsBox;break;case"freegchord":if(P=b("freegchord",C,x),P!==null)return P;break;case"measurenb":case"barnumbers":if(P=g("barNumbers",C,x),P!==null)return P;break;case"setbarnb":if(x.length!==1||x[0].type!=="number")return"Directive setbarnb requires a number as a parameter.";r.currBarNumber=o.setBarNumberImmediate(x[0].intt);break;case"begintext":var j="";for(q=e.nextLine();q&&q.indexOf("%%endtext")!==0;)G.startsWith(q,"%%")?j+=q.substring(2)+`
`:j+=q+`
`,q=e.nextLine();o.addText(j,{startChar:r.iChar,endChar:r.iChar+j.length+7});break;case"continueall":r.continueall=!0;break;case"beginps":for(q=e.nextLine();q&&q.indexOf("%%endps")!==0;)e.nextLine();t("Postscript ignored",w,0);break;case"deco":T.length>0&&r.ignoredDecorations.push(T.substring(0,T.indexOf(" "))),t("Decoration redefinition ignored",w,0);break;case"text":var ze=e.translateString(T);o.addText(Xe.parseFontChangeLine(ze),{startChar:r.iChar,endChar:r.iChar+T.length+7});break;case"center":var ae=e.translateString(T);o.addCentered(Xe.parseFontChangeLine(ae));break;case"font":break;case"setfont":var ge=e.tokenize(T,0,T.length);if(ge.length>=4&&ge[0].token==="-"&&ge[1].type==="number"){var Xt=parseInt(ge[1].token);Xt>=1&&Xt<=9&&(r.setfont||(r.setfont=[]),ge.shift(),ge.shift(),r.setfont[Xt]=c(ge,r.setfont[Xt],w,0,"setfont"))}break;case"gchordfont":case"partsfont":case"tripletfont":case"vocalfont":case"textfont":case"annotationfont":case"historyfont":case"infofont":case"measurefont":case"repeatfont":case"wordsfont":return l(C,x,w);case"composerfont":case"subtitlefont":case"tempofont":case"titlefont":case"voicefont":case"footerfont":case"headerfont":return d(C,x,w);case"barlabelfont":case"barnumberfont":case"barnumfont":return l("measurefont",x,w);case"staves":case"score":r.score_is_present=!0;for(var go=function(bt,yo,Oa,Ia,Eo){(yo||r.staves.length===0)&&r.staves.push({index:r.staves.length,numVoices:0});var $e=G.last(r.staves);Oa!==void 0&&$e.bracket===void 0&&($e.bracket=Oa),Ia!==void 0&&$e.brace===void 0&&($e.brace=Ia),Eo&&($e.connectBarLines="end"),r.voices[bt]===void 0&&(r.voices[bt]={staffNum:$e.index,index:$e.numVoices},$e.numVoices++)},dt=!1,mt=!1,gt=!1,Qt=!1,Zt=!1,Jt=!1,Rr=!1,qe,Pa=function(){if(Rr=!0,qe){var bt="start";qe.staffNum>0&&(r.staves[qe.staffNum-1].connectBarLines==="start"||r.staves[qe.staffNum-1].connectBarLines==="continue")&&(bt="continue"),r.staves[qe.staffNum].connectBarLines=bt}};x.length;){var ve=x.shift();switch(ve.token){case"(":dt?t("Can't nest parenthesis in %%score",w,ve.start):(dt=!0,Qt=!0);break;case")":!dt||Qt?t("Unexpected close parenthesis in %%score",w,ve.start):dt=!1;break;case"[":mt?t("Can't nest brackets in %%score",w,ve.start):(mt=!0,Zt=!0);break;case"]":!mt||Zt?t("Unexpected close bracket in %%score",w,ve.start):(mt=!1,r.staves[qe.staffNum].bracket="end");break;case"{":gt?t("Can't nest braces in %%score",w,ve.start):(gt=!0,Jt=!0);break;case"}":!gt||Jt?t("Unexpected close brace in %%score",w,ve.start):(gt=!1,r.staves[qe.staffNum].brace="end");break;case"|":Pa();break;default:for(var qr="";(ve.type==="alpha"||ve.type==="number")&&(qr+=ve.token,ve.continueId);)ve=x.shift();var vo=!dt||Qt,bo=Zt?"start":mt?"continue":void 0,xo=Jt?"start":gt?"continue":void 0;go(qr,vo,bo,xo,Rr),Qt=!1,Zt=!1,Jt=!1,Rr=!1,qe=r.voices[qr],C==="staves"&&Pa();break}}break;case"newpage":var Ma=e.getInt(T);o.addNewPage(Ma.digits===0?-1:Ma.value);break;case"abc":var Yt=T.split(" ");switch(Yt[0]){case"-copyright":case"-creator":case"-edited-by":case"-version":case"-charset":var wo=Yt.shift();o.addMetaText(C+wo,Yt.join(" "),{startChar:r.iChar,endChar:r.iChar+T.length+5});break;default:return"Unknown directive: "+C+Yt[0]}break;case"header":case"footer":var Ae=e.getMeat(T,0,T.length);Ae=T.substring(Ae.start,Ae.end),Ae[0]==='"'&&Ae[Ae.length-1]==='"'&&(Ae=Ae.substring(1,Ae.length-1));var Fe=Ae.split("	"),jt={};Fe.length===1?jt={left:"",center:Fe[0],right:""}:Fe.length===2?jt={left:Fe[0],center:Fe[1],right:""}:jt={left:Fe[0],center:Fe[1],right:Fe[2]},Fe.length>3&&t("Too many tabs in "+C+": "+Fe.length+" found.",T,0),o.addMetaTextObj(C,jt,{startChar:r.iChar,endChar:r.iChar+w.length});break;case"midi":var vt=e.tokenize(T,0,T.length,!0);vt.length>0&&vt[0].token==="="&&vt.shift(),vt.length===0?t("Expected midi command",T,0):O(vt,i,T);break;case"percmap":var Vt=f(T);Vt.error?t(Vt.error,w,8):(i.formatting.percmap||(i.formatting.percmap={}),i.formatting.percmap[Vt.key]=Vt.value);break;case"map":case"playtempo":case"auquality":case"continuous":case"nobarcheck":i.formatting[C]=T;break;default:return"Unknown directive: "+C}return null},Xe.globalFormatting=function(w){for(var x in w)if(w.hasOwnProperty(x)){var T=""+w[x],C=e.tokenize(T,0,T.length),P;switch(x){case"titlefont":case"gchordfont":case"composerfont":case"footerfont":case"headerfont":case"historyfont":case"infofont":case"measurefont":case"partsfont":case"repeatfont":case"subtitlefont":case"tempofont":case"textfont":case"voicefont":case"tripletfont":case"vocalfont":case"wordsfont":case"annotationfont":case"tablabelfont":case"tabnumberfont":case"tabgracefont":l(x,C,T);break;case"scale":n(x,C);break;case"partsbox":P=b("partsBox",x,C),P!==null&&t(P),r.partsfont.box=r.partsBox;break;case"freegchord":P=b("freegchord",x,C),P!==null&&t(P);break;case"fontboxpadding":(C.length!==1||C[0].type!=="number")&&t('Directive "'+x+'" requires a number as a parameter.'),i.formatting.fontboxpadding=C[0].floatt;break;case"stretchlast":var q=I(C);if(q.value!==void 0&&(i.formatting.stretchlast=q.value),q.error)return q.error;break;default:t("Formatting directive unrecognized: ",x,0)}}};function I(w){if(w.length===0)return{value:1};if(w.length===1)if(w[0].type==="number"){if(w[0].floatt>=0||w[0].floatt<=1)return{value:w[0].floatt}}else{if(w[0].token==="false")return{value:0};if(w[0].token==="true")return{value:1}}return{error:"Directive stretchlast requires zero or one parameter: false, true, or number between 0 and 1 (received "+w[0].token+")"}}})();var ee=Xe;var gn={},hi=["C,,,","D,,,","E,,,","F,,,","G,,,","A,,,","B,,,","C,,","D,,","E,,","F,,","G,,","A,,","B,,","C,","D,","E,","F,","G,","A,","B,","C","D","E","F","G","A","B","c","d","e","f","g","a","b","c'","d'","e'","f'","g'","a'","b'","c''","d''","e''","f''","g''","a''","b''","c'''","d'''","e'''","f'''","g'''","a'''","b'''"];gn.pitchIndex=function(e){return hi.indexOf(e)};gn.noteName=function(e){return hi[e]};var vn=gn;var pr=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"],dr=["C","D♭","D","E♭","E","F","G♭","G","A♭","A","B♭","B"],mr=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],gr=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];function bn(e,t,r,i){if(!t||t%12===0)return e;for(;t<0;)t+=12;t>11&&(t=t%12);var o=e.match(/^([A-G][b#♭♯]?)([^\/]+)?\/?([A-G][b#♭♯]?)?(.+)?/);if(!o)return e;var h=o[1],u=o[2],a=o[3],c=o[4],l=pr.indexOf(h);if(l<0&&(l=dr.indexOf(h)),l<0&&(l=mr.indexOf(h)),l<0&&(l=gr.indexOf(h)),l<0)return e;if(l+=t,l=l%12,r?i?e=gr[l]:e=dr[l]:i?e=mr[l]:e=pr[l],u&&(e+=u),a){var l=pr.indexOf(a);l<0&&(l=dr.indexOf(a)),l<0&&(l=mr.indexOf(a)),l<0&&(l=gr.indexOf(a)),e+="/",l>=0?(l+=t,l=l%12,r?i?e+=gr[l]:e+=dr[l]:i?e+=mr[l]:e+=pr[l]):e+=a}return c&&(e+=c),e}var pi={C:{modes:["CMaj","Amin","Am","GMix","DDor","EPhr","FLyd","BLoc"],stepsFromC:0},Db:{modes:["DbMaj","Bbmin","Bbm","AbMix","EbDor","FPhr","GbLyd","CLoc"],stepsFromC:1},D:{modes:["DMaj","Bmin","Bm","AMix","EDor","F#Phr","GLyd","C#Loc"],stepsFromC:2},Eb:{modes:["EbMaj","Cmin","Cm","BbMix","FDor","GPhr","AbLyd","DLoc"],stepsFromC:3},E:{modes:["EMaj","C#min","C#m","BMix","F#Dor","G#Phr","ALyd","D#Loc"],stepsFromC:4},F:{modes:["FMaj","Dmin","Dm","CMix","GDor","APhr","BbLyd","ELoc"],stepsFromC:5},Gb:{modes:["GbMaj","Ebmin","Ebm","DbMix","AbDor","BbPhr","CbLyd","FLoc"],stepsFromC:6},G:{modes:["GMaj","Emin","Em","DMix","ADor","BPhr","CLyd","F#Loc"],stepsFromC:7},Ab:{modes:["AbMaj","Fmin","Fm","EbMix","BbDor","CPhr","DbLyd","GLoc"],stepsFromC:8},A:{modes:["AMaj","F#min","F#m","EMix","BDor","C#Phr","DLyd","G#Loc"],stepsFromC:9},Bb:{modes:["BbMaj","Gmin","Gm","FMix","CDor","DPhr","EbLyd","ALoc"],stepsFromC:10},B:{modes:["BMaj","G#min","G#m","F#Mix","C#Dor","D#Phr","ELyd","A#Loc"],stepsFromC:11},"C#":{modes:["C#Maj","A#min","A#m","G#Mix","D#Dor","E#Phr","F#Lyd","B#Loc"],stepsFromC:1},"F#":{modes:["F#Maj","D#min","D#m","C#Mix","G#Dor","A#Phr","BLyd","E#Loc"],stepsFromC:6},Cb:{modes:["CbMaj","Abmin","Abm","GbMix","DbDor","EbPhr","FbLyd","BbLoc"],stepsFromC:11}},Ct=null;function gs(){Ct={};for(var e=Object.keys(pi),t=0;t<e.length;t++){var r=pi[e[t]];Ct[e[t].toLowerCase()]=e[t];for(var i=0;i<r.modes.length;i++){var o=r.modes[i].toLowerCase();Ct[o]=e[t]}}}function di(e){Ct||gs();var t=e.toLowerCase().match(/([a-g][b#]?)(maj|min|mix|dor|phr|lyd|loc|m)?/);if(!t||!t[2])return e;t=t[1]+t[2];var r=Ct[t];return r||e}var Qe={acc:"sharp",note:"f"},ct={acc:"sharp",note:"c"},Nt={acc:"sharp",note:"g"},vr={acc:"sharp",note:"d"},xn={acc:"sharp",note:"A"},mi={acc:"sharp",note:"e"},vs={acc:"sharp",note:"B"},ye={acc:"flat",note:"B"},Se={acc:"flat",note:"e"},Ue={acc:"flat",note:"A"},kt={acc:"flat",note:"d"},wn={acc:"flat",note:"G"},gi={acc:"flat",note:"c"},bs={acc:"flat",note:"F"},xs={"C#":[Qe,ct,Nt,vr,xn,mi,vs],"F#":[Qe,ct,Nt,vr,xn,mi],B:[Qe,ct,Nt,vr,xn],E:[Qe,ct,Nt,vr],A:[Qe,ct,Nt],D:[Qe,ct],G:[Qe],C:[],F:[ye],Bb:[ye,Se],Eb:[ye,Se,Ue],Cm:[ye,Se,Ue],Ab:[ye,Se,Ue,kt],Db:[ye,Se,Ue,kt,wn],Gb:[ye,Se,Ue,kt,wn,gi],Cb:[ye,Se,Ue,kt,wn,gi,bs],"A#":[ye,Se],"B#":[],"D#":[ye,Se,Ue],"E#":[ye],"G#":[ye,Se,Ue,kt],none:[]};function Tt(e){var t=xs[di(e)];return t?JSON.parse(JSON.stringify(t)):null}var br={},ws={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11},ys=["C","Db","D","Eb","E","F","F#","G","Ab","A","Bb","B"],Es=["C","C#","D","D#","E","F","F#","G","G#","A","Bb","B"];br.keySignature=function(e,t,r,i,o){if(e.clef.type==="perc"||e.clef.type==="none")return{accidentals:Tt(t),root:r,acc:i};o||(o=0),e.localTransposeVerticalMovement=0,e.localTransposePreferFlats=!1;var h=Tt(t);if(!h)return e.key;if(e.localTranspose=(e.globalTranspose?e.globalTranspose:0)+o,!e.localTranspose)return{accidentals:h,root:r,acc:i};if(e.globalTransposeOrigKeySig=h,e.localTranspose%12===0)return e.localTransposeVerticalMovement=e.localTranspose/12*7,{accidentals:h,root:r,acc:i};var u=t[0];t[1]==="b"||t[1]==="#"?(u+=t[1],t=t.substr(2)):t=t.substr(1);var a=ws[u],c=a!==void 0;c||(a=0,u="C",t="");for(var l=a+e.localTranspose;l<0;)l+=12;l>11&&(l=l%12);var d=t[0]==="m"?Es[l]:ys[l],n=d+t,s=Tt(n);s.length>0&&s[0].acc==="flat"&&(e.localTransposePreferFlats=!0);var f=n.charCodeAt(0)-u.charCodeAt(0);return e.localTranspose>0?(f<0||f===0&&(u[1]==="#"||n[1]==="b"))&&(f+=7):e.localTranspose<0&&(f>0||f===0&&(u[1]==="b"||n[1]==="#"))&&(f-=7),e.localTranspose>0?e.localTransposeVerticalMovement=f+Math.floor(e.localTranspose/12)*7:e.localTransposeVerticalMovement=f+Math.ceil(e.localTranspose/12)*7,c?{accidentals:s,root:d[0],acc:d.length>1?d[1]:""}:{accidentals:[],root:r,acc:i}};br.chordName=function(e,t){return bn(t,e.localTranspose,e.localTransposePreferFlats,e.freegchord)};var vi=["c","d","e","f","g","a","b"];function Cs(e,t,r,i,o){for(var h=vi[(e+49)%7],u=0,a=0;a<i.length;a++)i[a].note.toLowerCase()===h&&(u=yn[i[a].acc]);for(var c=yn[r],l=c-u,d=vi[(t+49)%7],n=0,s=0;s<o.accidentals.length;s++)o.accidentals[s].note.toLowerCase()===d&&(n=yn[o.accidentals[s].acc]);var f=l+n;return f<-2&&(t--,f+=d==="c"||d==="f"?1:2),f>2&&(t++,f-=d==="b"||d==="e"?1:2),[t,f]}var yn={dblflat:-2,flat:-1,natural:0,sharp:1,dblsharp:2},Ns={"-2":"dblflat","-1":"flat",0:"natural",1:"sharp",2:"dblsharp"},ks={"-2":"__","-1":"_",0:"=",1:"^",2:"^^"};br.note=function(e,t){if(!(!e.localTranspose||e.clef.type==="perc")){var r=t.pitch;if(e.localTransposeVerticalMovement&&(t.pitch=t.pitch+e.localTransposeVerticalMovement,t.name)){var i=t.accidental?t.name.substring(1):t.name,o=t.accidental?t.name[0]:"",h=vn.pitchIndex(i);t.name=o+vn.noteName(h+e.localTransposeVerticalMovement)}if(t.accidental){var u=Cs(r,t.pitch,t.accidental,e.globalTransposeOrigKeySig,e.targetKey);t.pitch=u[0],t.accidental=Ns[u[1]],t.name&&(t.name=ks[u[1]]+t.name.replace(/[_^=]/g,""))}}};var Bt=br;var de={};(function(){var e,t,r,i,o;de.initialize=function(n,s,f,p,m){e=n,t=s,r=f,i=p,o=m},de.standardKey=function(n,s,f,p){return Bt.keySignature(r,n,s,f,p)};var h={treble:{clef:"treble",pitch:4,mid:0},"treble+8":{clef:"treble+8",pitch:4,mid:0},"treble-8":{clef:"treble-8",pitch:4,mid:0},"treble^8":{clef:"treble+8",pitch:4,mid:0},treble_8:{clef:"treble-8",pitch:4,mid:0},treble1:{clef:"treble",pitch:2,mid:2},treble2:{clef:"treble",pitch:4,mid:0},treble3:{clef:"treble",pitch:6,mid:-2},treble4:{clef:"treble",pitch:8,mid:-4},treble5:{clef:"treble",pitch:10,mid:-6},perc:{clef:"perc",pitch:6,mid:0},none:{clef:"none",mid:0},bass:{clef:"bass",pitch:8,mid:-12},"bass+8":{clef:"bass+8",pitch:8,mid:-12},"bass-8":{clef:"bass-8",pitch:8,mid:-12},"bass^8":{clef:"bass+8",pitch:8,mid:-12},bass_8:{clef:"bass-8",pitch:8,mid:-12},"bass+16":{clef:"bass",pitch:8,mid:-12},"bass-16":{clef:"bass",pitch:8,mid:-12},"bass^16":{clef:"bass",pitch:8,mid:-12},bass_16:{clef:"bass",pitch:8,mid:-12},bass1:{clef:"bass",pitch:2,mid:-6},bass2:{clef:"bass",pitch:4,mid:-8},bass3:{clef:"bass",pitch:6,mid:-10},bass4:{clef:"bass",pitch:8,mid:-12},bass5:{clef:"bass",pitch:10,mid:-14},tenor:{clef:"alto",pitch:8,mid:-8},tenor1:{clef:"alto",pitch:2,mid:-2},tenor2:{clef:"alto",pitch:4,mid:-4},tenor3:{clef:"alto",pitch:6,mid:-6},tenor4:{clef:"alto",pitch:8,mid:-8},tenor5:{clef:"alto",pitch:10,mid:-10},alto:{clef:"alto",pitch:6,mid:-6},alto1:{clef:"alto",pitch:2,mid:-2},alto2:{clef:"alto",pitch:4,mid:-4},alto3:{clef:"alto",pitch:6,mid:-6},alto4:{clef:"alto",pitch:8,mid:-8},alto5:{clef:"alto",pitch:10,mid:-10},"alto+8":{clef:"alto+8",pitch:6,mid:-6},"alto-8":{clef:"alto-8",pitch:6,mid:-6},"alto^8":{clef:"alto+8",pitch:6,mid:-6},alto_8:{clef:"alto-8",pitch:6,mid:-6}},u=function(n,s){var f=h[n],p=f?f.mid:0;return p+s};de.fixClef=function(n){var s=h[n.type];s&&(n.clefPos=s.pitch,n.type=s.clef)},de.deepCopyKey=function(n){var s={accidentals:[],root:n.root,acc:n.acc,mode:n.mode};return n.accidentals.forEach(function(f){s.accidentals.push(G.clone(f))}),s};var a={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11};de.addPosToKey=function(n,s){var f=n.verticalPos;s.accidentals.forEach(function(p){var m=a[p.note];m=m-f,p.verticalPos=m}),s.impliedNaturals&&s.impliedNaturals.forEach(function(p){var m=a[p.note];m=m-f,p.verticalPos=m}),f<-10?(s.accidentals.forEach(function(p){p.verticalPos-=7,(p.verticalPos>=11||p.verticalPos===10&&p.acc==="flat")&&(p.verticalPos-=7),p.note==="A"&&p.acc==="sharp"&&(p.verticalPos-=7),(p.note==="G"||p.note==="F")&&p.acc==="flat"&&(p.verticalPos-=7)}),s.impliedNaturals&&s.impliedNaturals.forEach(function(p){p.verticalPos-=7,(p.verticalPos>=11||p.verticalPos===10&&p.acc==="flat")&&(p.verticalPos-=7),p.note==="A"&&p.acc==="sharp"&&(p.verticalPos-=7),(p.note==="G"||p.note==="F")&&p.acc==="flat"&&(p.verticalPos-=7)})):f<-4?(s.accidentals.forEach(function(p){p.verticalPos-=7,f===-8&&(p.note==="f"||p.note==="g")&&p.acc==="sharp"&&(p.verticalPos-=7)}),s.impliedNaturals&&s.impliedNaturals.forEach(function(p){p.verticalPos-=7,f===-8&&(p.note==="f"||p.note==="g")&&p.acc==="sharp"&&(p.verticalPos-=7)})):f>=7&&(s.accidentals.forEach(function(p){p.verticalPos+=7}),s.impliedNaturals&&s.impliedNaturals.forEach(function(p){p.verticalPos+=7}))},de.fixKey=function(n,s){var f=G.clone(s);return de.addPosToKey(n,f),f};var c=function(n){var s=0,f=n[s++];(f==="^"||f==="_")&&(f=n[s++]);var p=a[f];for(p===void 0&&(p=6);s<n.length;s++)if(n[s]===",")p-=7;else if(n[s]==="'")p+=7;else break;return{mid:p-6,str:n.substring(s)}},l=function(n){for(var s=0;s<n.length;s++)n[s].note==="b"?n[s].note="B":n[s].note==="a"?n[s].note="A":n[s].note==="F"?n[s].note="f":n[s].note==="E"?n[s].note="e":n[s].note==="D"?n[s].note="d":n[s].note==="C"?n[s].note="c":n[s].note==="G"&&n[s].acc==="sharp"?n[s].note="g":n[s].note==="g"&&n[s].acc==="flat"&&(n[s].note="G")};de.parseKey=function(n,s){n.length===0&&(n="none");var f=e.tokenize(n,0,n.length),p={};if(f.length===0)return t("Must pass in key signature.",n,0),p;switch(f[0].token){case"HP":ee.addDirective("bagpipes"),r.key={root:"HP",accidentals:[],acc:"",mode:""},p.foundKey=!0,f.shift();break;case"Hp":ee.addDirective("bagpipes"),r.key={root:"Hp",accidentals:[{acc:"natural",note:"g"},{acc:"sharp",note:"f"},{acc:"sharp",note:"c"}],acc:"",mode:""},p.foundKey=!0,f.shift();break;case"none":r.key={root:"none",accidentals:[],acc:"",mode:""},p.foundKey=!0,f.shift();break;default:var m=e.getKeyPitch(f[0].token);if(m.len>0){p.foundKey=!0;var g="",b="";f[0].token.length>1?f[0].token=f[0].token.substring(1):f.shift();var N=m.token;if(f.length>0){var B=e.getSharpFlat(f[0].token);if(B.len>0&&(f[0].token.length>1?f[0].token=f[0].token.substring(1):f.shift(),N+=B.token,g=B.token),f.length>0){var y=e.getMode(f[0].token);y.len>0&&(f.shift(),N+=y.token,b=y.token)}if(de.standardKey(N,m.token,g,0)===void 0)return t("Unsupported key signature: "+N,n,0),p}var v=de.deepCopyKey(r.key),k=!s&&r.globalTranspose?-r.globalTranspose:0,L;if(s&&(L=r.globalTransposeOrigKeySig),r.key=de.deepCopyKey(de.standardKey(N,m.token,g,k)),s&&(r.globalTransposeOrigKeySig=L),r.key.mode=b,v){for(var D,A=0;A<r.key.accidentals.length;A++)for(D=0;D<v.accidentals.length;D++)v.accidentals[D].note&&r.key.accidentals[A].note.toLowerCase()===v.accidentals[D].note.toLowerCase()&&(v.accidentals[D].note=null);for(D=0;D<v.accidentals.length;D++)v.accidentals[D].note&&(r.key.impliedNaturals||(r.key.impliedNaturals=[]),r.key.impliedNaturals.push({acc:"natural",note:v.accidentals[D].note}))}}break}if(f.length===0||(f[0].token==="exp"&&f.shift(),f.length===0)||(f[0].token==="oct"&&f.shift(),f.length===0))return p;var M=e.getKeyAccidentals2(f);if(M.warn&&t(M.warn,n,0),M.accs){p.foundKey||(p.foundKey=!0,r.key={root:"none",acc:"",mode:"",accidentals:[]}),l(M.accs);for(var F=0;F<M.accs.length;F++){for(var S=!1,O=0;O<r.key.accidentals.length&&!S;O++)r.key.accidentals[O].note===M.accs[F].note&&(S=!0,r.key.accidentals[O].acc!==M.accs[F].acc&&(r.key.accidentals[O].acc=M.accs[F].acc,r.key.explicitAccidentals||(r.key.explicitAccidentals=[]),r.key.explicitAccidentals.push(M.accs[F])));if(!S&&(r.key.explicitAccidentals||(r.key.explicitAccidentals=[]),r.key.explicitAccidentals.push(M.accs[F]),r.key.accidentals.push(M.accs[F]),r.key.impliedNaturals))for(var R=0;R<r.key.impliedNaturals.length;R++)r.key.impliedNaturals[R].note===M.accs[F].note&&r.key.impliedNaturals.splice(R,1)}}for(var I;f.length>0;)switch(f[0].token){case"m":case"middle":if(f.shift(),f.length===0)return t("Expected = after middle",n,0),p;if(I=f.shift(),I.token!=="="){t("Expected = after middle",n,I.start);break}if(f.length===0)return t("Expected parameter after middle=",n,0),p;var w=e.getPitchFromTokens(f);w.warn&&t(w.warn,n,0),w.position&&(r.clef.verticalPos=w.position-6);break;case"transpose":if(f.shift(),f.length===0)return t("Expected = after transpose",n,0),p;if(I=f.shift(),I.token!=="="){t("Expected = after transpose",n,I.start);break}if(f.length===0)return t("Expected parameter after transpose=",n,0),p;if(f[0].type!=="number"){t("Expected number after transpose",n,f[0].start);break}r.clef.transpose=f[0].intt,f.shift();break;case"stafflines":if(f.shift(),f.length===0)return t("Expected = after stafflines",n,0),p;if(I=f.shift(),I.token!=="="){t("Expected = after stafflines",n,I.start);break}if(f.length===0)return t("Expected parameter after stafflines=",n,0),p;if(f[0].type!=="number"){t("Expected number after stafflines",n,f[0].start);break}r.clef.stafflines=f[0].intt,f.shift();break;case"staffscale":if(f.shift(),f.length===0)return t("Expected = after staffscale",n,0),p;if(I=f.shift(),I.token!=="="){t("Expected = after staffscale",n,I.start);break}if(f.length===0)return t("Expected parameter after staffscale=",n,0),p;if(f[0].type!=="number"){t("Expected number after staffscale",n,f[0].start);break}r.clef.staffscale=f[0].floatt,f.shift();break;case"octave":if(f.shift(),f.length===0)return t("Expected = after octave",n,0),p;if(I=f.shift(),I.token!=="="){t("Expected = after octave",n,I.start);break}if(f.length===0)return t("Expected parameter after octave=",n,0),p;if(f[0].type!=="number"){t("Expected number after octave",n,f[0].start);break}r.octave=f[0].intt,f.shift();break;case"style":if(f.shift(),f.length===0)return t("Expected = after style",n,0),p;if(I=f.shift(),I.token!=="="){t("Expected = after style",n,I.start);break}if(f.length===0)return t("Expected parameter after style=",n,0),p;switch(f[0].token){case"normal":case"harmonic":case"rhythm":case"x":case"triangle":r.style=f[0].token,f.shift();break;default:t("error parsing style element: "+f[0].token,n,f[0].start);break}break;case"clef":if(f.shift(),f.length===0)return t("Expected = after clef",n,0),p;if(I=f.shift(),I.token!=="="){t("Expected = after clef",n,I.start);break}if(f.length===0)return t("Expected parameter after clef=",n,0),p;case"treble":case"bass":case"alto":case"tenor":case"perc":case"none":var x=f.shift();switch(x.token){case"treble":case"tenor":case"alto":case"bass":case"perc":case"none":break;case"C":x.token="alto";break;case"F":x.token="bass";break;case"G":x.token="treble";break;case"c":x.token="alto";break;case"f":x.token="bass";break;case"g":x.token="treble";break;default:t("Expected clef name. Found "+x.token,n,x.start);break}f.length>0&&f[0].type==="number"&&(x.token+=f[0].token,f.shift()),f.length>1&&(f[0].token==="-"||f[0].token==="+"||f[0].token==="^"||f[0].token==="_")&&f[1].token==="8"&&(x.token+=f[0].token+f[1].token,f.shift(),f.shift()),r.clef={type:x.token,verticalPos:u(x.token,0)},r.currentVoice&&r.currentVoice.transpose!==void 0&&(r.clef.transpose=r.currentVoice.transpose),p.foundClef=!0;break;default:t("Unknown parameter: "+f[0].token,n,f[0].start),f.shift()}return p};var d=function(n){r.currentVoice=r.voices[n],o.setCurrentVoice(r.currentVoice.staffNum,r.currentVoice.index)};de.parseVoice=function(n,s,f){var p=e.getMeat(n,s,f),m=p.start,g=p.end,b=e.getToken(n,m,g);if(b.length===0){t("Expected a voice id",n,m);return}var N=!1;r.voices[b]===void 0&&(r.voices[b]={},N=!0,r.score_is_present&&t("Can't have an unknown V: id when the %score directive is present",n,m)),m+=b.length,m+=e.eatWhiteSpace(n,m);for(var B={startStaff:N},y=function(w){var x=e.getVoiceToken(n,m,g);x.warn!==void 0?t("Expected value for "+w+" in voice: "+x.warn,n,m):x.err!==void 0?t("Expected value for "+w+" in voice: "+x.err,n,m):x.token.length===0&&n[m]!=='"'?t("Expected value for "+w+" in voice",n,m):B[w]=x.token,m+=x.len},v=function(w,x,T){var C=e.getVoiceToken(n,m,g);C.warn!==void 0?t("Expected value for "+x+" in voice: "+C.warn,n,m):C.err!==void 0?t("Expected value for "+x+" in voice: "+C.err,n,m):C.token.length===0&&n[m]!=='"'?t("Expected value for "+x+" in voice",n,m):(T==="number"&&(C.token=parseFloat(C.token)),r.voices[w][x]=C.token),m+=C.len},k=function(w,x){var T=e.getVoiceToken(n,m,g);if(T.warn!==void 0)t("Expected value for "+w+" in voice: "+T.warn,n,m);else if(T.err!==void 0)t("Expected value for "+w+" in voice: "+T.err,n,m);else if(T.token.length===0&&n[m]!=='"')t("Expected value for "+w+" in voice",n,m);else return x==="number"&&(T.token=parseFloat(T.token)),T.token;m+=T.len},L=function(w,x){var T={_B:2,_E:9,_b:-10,_e:-3},C=e.getVoiceToken(n,m,g);if(C.warn!==void 0)t("Expected one of (_B, _E, _b, _e) for "+x+" in voice: "+C.warn,n,m);else if(C.token.length===0&&n[m]!=='"')t("Expected one of (_B, _E, _b, _e) for "+x+" in voice",n,m);else{var P=T[C.token];P?r.voices[w][x]=P:t("Expected one of (_B, _E, _b, _e) for "+x+" in voice",n,m)}m+=C.len};m<g;){var D=e.getVoiceToken(n,m,g);if(m+=D.len,D.warn)t("Error parsing voice: "+D.warn,n,m);else{var A=null;switch(D.token){case"clef":case"cl":y("clef");var M=0;B.clef!==void 0&&(B.clef=B.clef.replace(/[',]/g,""),B.clef.indexOf("+16")!==-1&&(M+=14,B.clef=B.clef.replace("+16","")),B.verticalPos=u(B.clef,M));break;case"treble":case"bass":case"tenor":case"alto":case"perc":case"none":case"treble'":case"bass'":case"tenor'":case"alto'":case"none'":case"treble''":case"bass''":case"tenor''":case"alto''":case"none''":case"treble,":case"bass,":case"tenor,":case"alto,":case"none,":case"treble,,":case"bass,,":case"tenor,,":case"alto,,":case"none,,":var F=0;B.clef=D.token.replace(/[',]/g,""),B.verticalPos=u(B.clef,F),r.voices[b].clef=D.token;break;case"staves":case"stave":case"stv":y("staves");break;case"brace":case"brc":y("brace");break;case"bracket":case"brk":y("bracket");break;case"name":case"nm":y("name");break;case"subname":case"sname":case"snm":y("subname");break;case"merge":B.startStaff=!1;break;case"stem":case"stems":A=e.getVoiceToken(n,m,g),A.warn!==void 0?t("Expected value for stems in voice: "+A.warn,n,m):A.err!==void 0?t("Expected value for stems in voice: "+A.err,n,m):A.token==="up"||A.token==="down"?r.voices[b].stem=A.token:t("Expected up or down for voice stem",n,m),m+=A.len;break;case"up":case"down":r.voices[b].stem=D.token;break;case"middle":case"m":y("verticalPos"),B.verticalPos=c(B.verticalPos).mid;break;case"gchords":case"gch":r.voices[b].suppressChords=!0,A=e.getVoiceToken(n,m,g),A.token==="0"&&(m=m+A.len);break;case"space":case"spc":y("spacing");break;case"scale":v(b,"scale","number");break;case"score":L(b,"scoreTranspose");break;case"transpose":v(b,"transpose","number");break;case"stafflines":v(b,"stafflines","number");break;case"staffscale":v(b,"staffscale","number");break;case"octave":v(b,"octave","number");break;case"volume":v(b,"volume","number");break;case"cue":var S=k("cue","string");S==="on"?r.voices[b].scale=.6:r.voices[b].scale=1;break;case"style":A=e.getVoiceToken(n,m,g),A.warn!==void 0?t("Expected value for style in voice: "+A.warn,n,m):A.err!==void 0?t("Expected value for style in voice: "+A.err,n,m):A.token==="normal"||A.token==="harmonic"||A.token==="rhythm"||A.token==="x"||A.token==="triangle"?r.voices[b].style=A.token:t("Expected one of [normal, harmonic, rhythm, x, triangle] for voice style",n,m),m+=A.len;break}}m+=e.eatWhiteSpace(n,m)}if((B.startStaff||r.staves.length===0)&&(r.staves.push({index:r.staves.length,meter:r.origMeter}),r.score_is_present||(r.staves[r.staves.length-1].numVoices=0)),r.voices[b].staffNum===void 0){r.voices[b].staffNum=r.staves.length-1;var O=0;for(var R in r.voices)r.voices.hasOwnProperty(R)&&r.voices[R].staffNum===r.voices[b].staffNum&&O++;r.voices[b].index=O-1}var I=r.staves[r.voices[b].staffNum];r.score_is_present||I.numVoices++,B.clef&&(I.clef={type:B.clef,verticalPos:B.verticalPos}),B.spacing&&(I.spacing_below_offset=B.spacing),B.verticalPos&&(I.verticalPos=B.verticalPos),B.name&&(I.name?I.name.push(B.name):I.name=[B.name]),B.subname&&(I.subname?I.subname.push(B.subname):I.subname=[B.subname]),d(b)}})();var se=de;function bi(e,t,r,i,o){this.reset=function(a,c,l,d){se.initialize(a,c,l,d,o),ee.initialize(a,c,l,d,o)},this.reset(e,t,r,i),this.setTitle=function(a,c){r.hasMainTitle?o.addSubtitle(a,{startChar:r.iChar,endChar:r.iChar+c+2}):(o.addMetaText("title",a,{startChar:r.iChar,endChar:r.iChar+c+2}),r.hasMainTitle=!0)},this.setMeter=function(a){if(a=e.stripComment(a),a==="C")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"common_time"};if(a==="C|")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"cut_time"};if(a==="o")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_perfectum"};if(a==="c")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_imperfectum"};if(a==="o.")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_perfectum_prolatio"};if(a==="c.")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_imperfectum_prolatio"};if(a.length===0||a.toLowerCase()==="none")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),null;var c=e.tokenize(a,0,a.length);try{var l=function(){var m={value:0,num:""},g=c.shift();for(g.token==="("&&(g=c.shift());;){if(g.type!=="number")throw"Expected top number of meter";if(m.value+=parseInt(g.token),m.num+=g.token,c.length===0||c[0].token==="/")return m;if(g=c.shift(),g.token===")"){if(c.length===0||c[0].token==="/")return m;throw"Unexpected paren in meter"}if(g.token!=="."&&g.token!=="+"||(m.num+=g.token,c.length===0))throw"Expected top number of meter";g=c.shift()}return m},d=function(){var m=l();if(c.length===0)return m;var g=c.shift();if(g.token!=="/")throw"Expected slash in meter";if(g=c.shift(),g.type!=="number")throw"Expected bottom number of meter";return m.den=g.token,m.value=m.value/parseInt(m.den),m};if(c.length===0)throw"Expected meter definition in M: line";for(var n={type:"specified",value:[]},s=0;;){var f=d();s+=f.value;var p={num:f.num};if(f.den!==void 0&&(p.den=f.den),n.value.push(p),c.length===0)break}return r.havent_set_length===!0&&(r.default_length=s<.75?.0625:.125,r.havent_set_length=!1),n}catch(m){t(m,a,0)}return null},this.calcTempo=function(a){var c=.25;r.meter&&r.meter.type==="specified"?c=1/parseInt(r.meter.value[0].den):r.origMeter&&r.origMeter.type==="specified"&&(c=1/parseInt(r.origMeter.value[0].den));for(var l=0;l<a.duration;l++)a.duration[l]=c*a.duration[l];return a},this.resolveTempo=function(){r.tempo&&(this.calcTempo(r.tempo),i.metaText.tempo=r.tempo,delete r.tempo)},this.addUserDefinition=function(a,c,l){var d=a.indexOf("=",c);if(d===-1){t("Need an = in a macro definition",a,c);return}var n=G.strip(a.substring(c,d)),s=G.strip(a.substring(d+1));if(n.length!==1){t("Macro definitions can only be one character",a,c);return}var f="HIJKLMNOPQRSTUVWXYhijklmnopqrstuvw~";if(f.indexOf(n)===-1){t("Macro definitions must be H-Y, h-w, or tilde",a,c);return}if(s.length===0){t("Missing macro definition",a,c);return}r.macros===void 0&&(r.macros={}),r.macros[n]=s},this.setDefaultLength=function(a,c,l){var d=a.substring(c,l).replace(/ /g,""),n=d.split("/");if(n.length===2){var s=parseInt(n[0]),f=parseInt(n[1]);f>0&&(r.default_length=s/f,r.havent_set_length=!1)}else n.length===1&&n[0]==="1"&&(r.default_length=1,r.havent_set_length=!1)};var h={larghissimo:20,adagissimo:24,sostenuto:28,grave:32,largo:40,lento:50,larghetto:60,adagio:68,adagietto:74,andante:80,andantino:88,"marcia moderato":84,"andante moderato":100,moderato:112,allegretto:116,"allegro moderato":120,allegro:126,animato:132,agitato:140,veloce:148,"mosso vivo":156,vivace:164,vivacissimo:172,allegrissimo:176,presto:184,prestissimo:210};this.setTempo=function(a,c,l,d){try{var n=e.tokenize(a,c,l);if(n.length===0)throw"Missing parameter in Q: field";var s={startChar:d+c-2,endChar:d+l},f=!0,p=n.shift();if(p.type==="quote"&&(s.preString=p.token,p=n.shift(),n.length===0))return h[s.preString.toLowerCase()]&&(s.bpm=h[s.preString.toLowerCase()],s.suppressBpm=!0),{type:"immediate",tempo:s};if(p.type==="alpha"&&p.token==="C"){if(n.length===0)throw"Missing tempo after C in Q: field";if(p=n.shift(),p.type==="punct"&&p.token==="="){if(n.length===0)throw"Missing tempo after = in Q: field";if(p=n.shift(),p.type!=="number")throw"Expected number after = in Q: field";s.duration=[1],s.bpm=parseInt(p.token)}else if(p.type==="number"){if(s.duration=[parseInt(p.token)],n.length===0)throw"Missing = after duration in Q: field";if(p=n.shift(),p.type!=="punct"||p.token!=="=")throw"Expected = after duration in Q: field";if(n.length===0)throw"Missing tempo after = in Q: field";if(p=n.shift(),p.type!=="number")throw"Expected number after = in Q: field";s.bpm=parseInt(p.token)}else throw"Expected number or equal after C in Q: field"}else if(p.type==="number"){var m=parseInt(p.token);if(n.length===0||n[0].type==="quote")s.duration=[1],s.bpm=m;else{if(f=!1,p=n.shift(),p.type!=="punct"&&p.token!=="/"||(p=n.shift(),p.type!=="number"))throw"Expected fraction in Q: field";var g=parseInt(p.token);for(s.duration=[m/g];n.length>0&&n[0].token!=="="&&n[0].type!=="quote";){if(p=n.shift(),p.type!=="number"||(m=parseInt(p.token),p=n.shift(),p.type!=="punct"&&p.token!=="/")||(p=n.shift(),p.type!=="number"))throw"Expected fraction in Q: field";g=parseInt(p.token),s.duration.push(m/g)}if(p=n.shift(),p.type!=="punct"&&p.token!=="=")throw"Expected = in Q: field";if(p=n.shift(),p.type!=="number")throw"Expected tempo in Q: field";s.bpm=parseInt(p.token)}}else throw"Unknown value in Q: field";if(n.length!==0&&(p=n.shift(),p.type==="quote"&&(s.postString=p.token,p=n.shift()),n.length!==0))throw"Unexpected string at end of Q: field";return r.printTempo===!1&&(s.suppress=!0),{type:f?"delaySet":"immediate",tempo:s}}catch(b){return t(b,a,c),{type:"none"}}},this.letter_to_inline_header=function(a,c,l){var d=e.eatWhiteSpace(a,c);if(c+=d,a.length>=c+5&&a[c]==="["&&a[c+2]===":"){var n=a.indexOf("]",c),s=r.iChar+c,f=r.iChar+n+1;switch(a.substring(c,c+3)){case"[I:":var p=ee.addDirective(a.substring(c+3,n));return p&&t(p,a,c),[n-c+1+d];case"[M:":var m=this.setMeter(a.substring(c+3,n));return o.hasBeginMusic()&&m?o.appendStartingElement("meter",s,f,m):r.meter=m,[n-c+1+d];case"[K:":var g=se.parseKey(a.substring(c+3,n),!0);return g.foundClef&&o.hasBeginMusic()&&o.appendStartingElement("clef",s,f,r.clef),g.foundKey&&o.hasBeginMusic()&&o.appendStartingElement("key",s,f,se.fixKey(r.clef,r.key)),[n-c+1+d];case"[P:":var b=ee.parseFontChangeLine(a.substring(c+3,n));return l||i.lines.length<=i.lineNum?r.partForNextLine={title:b,startChar:s,endChar:f}:o.appendElement("part",s,f,{title:b}),[n-c+1+d];case"[L:":return this.setDefaultLength(a,c+3,n),[n-c+1+d];case"[Q:":if(n>0){var N=this.setTempo(a,c+3,n,r.iChar);return N.type==="delaySet"?o.hasBeginMusic()?o.appendElement("tempo",s,f,this.calcTempo(N.tempo)):r.tempoForNextLine=["tempo",s,f,this.calcTempo(N.tempo)]:N.type==="immediate"&&(!l&&o.hasBeginMusic()?o.appendElement("tempo",s,f,N.tempo):r.tempoForNextLine=["tempo",s,f,N.tempo]),[n-c+1+d,a[c+1],a.substring(c+3,n)]}break;case"[V:":if(n>0)return se.parseVoice(a,c+3,n),[n-c+1+d,a[c+1],a.substring(c+3,n)];break;case"[r:":return[n-c+1+d];default:}}return[0]},this.letter_to_body_header=function(a,c){if(a.length>=c+3)switch(a.substring(c,c+2)){case"I:":var l=ee.addDirective(a.substring(c+2));return l&&t(l,a,c),[a.length];case"M:":var d=this.setMeter(a.substring(c+2));return o.hasBeginMusic()&&d&&o.appendStartingElement("meter",r.iChar+c,r.iChar+a.length,d),[a.length];case"K:":var n=se.parseKey(a.substring(c+2),o.hasBeginMusic());return n.foundClef&&o.hasBeginMusic()&&o.appendStartingElement("clef",r.iChar+c,r.iChar+a.length,r.clef),n.foundKey&&o.hasBeginMusic()&&o.appendStartingElement("key",r.iChar+c,r.iChar+a.length,se.fixKey(r.clef,r.key)),[a.length];case"P:":return o.hasBeginMusic()&&o.appendElement("part",r.iChar+c,r.iChar+a.length,{title:a.substring(c+2)}),[a.length];case"L:":return this.setDefaultLength(a,c+2,a.length),[a.length];case"Q:":var s=a.indexOf("",c+2);s===-1&&(s=a.length);var f=this.setTempo(a,c+2,s,r.iChar);return f.type==="delaySet"?o.appendElement("tempo",r.iChar+c,r.iChar+a.length,this.calcTempo(f.tempo)):f.type==="immediate"&&o.appendElement("tempo",r.iChar+c,r.iChar+a.length,f.tempo),[s,a[c],G.strip(a.substring(c+2))];case"V:":return se.parseVoice(a,c+2,a.length),[a.length,a[c],G.strip(a.substring(c+2))];default:}return[0]};var u={A:"author",B:"book",C:"composer",D:"discography",F:"url",G:"group",I:"instruction",N:"notes",O:"origin",R:"rhythm",S:"source",W:"unalignedWords",Z:"transcription"};this.parseHeader=function(a){var c=u[a[0]],l=a.length-2,d=e.translateString(e.stripComment(a.substring(2)));if(c==="unalignedWords"||c==="notes")o.addMetaTextArray(c,ee.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+a.length});else if(c!==void 0)o.addMetaText(c,ee.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+a.length});else{var n=r.iChar,s=n+a.length;switch(a[0]){case"H":for(o.addMetaTextArray("history",ee.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+a.length}),a=e.peekLine();a&&a[1]!==":";)e.nextLine(),o.addMetaTextArray("history",ee.parseFontChangeLine(e.translateString(e.stripComment(a))),{startChar:r.iChar,endChar:r.iChar+a.length}),a=e.peekLine();break;case"K":this.resolveTempo();var f=se.parseKey(a.substring(2),!1);!r.is_in_header&&o.hasBeginMusic()&&(f.foundClef&&o.appendStartingElement("clef",n,s,r.clef),f.foundKey&&o.appendStartingElement("key",n,s,se.fixKey(r.clef,r.key))),r.is_in_header=!1;break;case"L":this.setDefaultLength(a,2,a.length);break;case"M":r.origMeter=r.meter=this.setMeter(a.substring(2));break;case"P":r.is_in_header?o.addMetaText("partOrder",ee.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+a.length}):r.partForNextLine={title:d,startChar:n,endChar:s};break;case"Q":var p=this.setTempo(a,2,a.length,r.iChar);p.type==="delaySet"?r.tempo=p.tempo:p.type==="immediate"&&(i.metaText.tempo?r.tempoForNextLine=["tempo",n,s,p.tempo]:i.metaText.tempo=p.tempo);break;case"T":r.titlecaps&&(d=d.toUpperCase()),this.setTitle(ee.parseFontChangeLine(e.theReverser(d)),l);break;case"U":this.addUserDefinition(a,2,a.length);break;case"V":if(se.parseVoice(a,2,a.length),!r.is_in_header)return{newline:!0};break;case"s":return{symbols:!0};case"w":return{words:!0};case"X":break;case"E":case"m":t("Ignored header",a,0);break;default:return{regular:!0}}}return{}}}var En=["trill","lowermordent","uppermordent","mordent","pralltriller","accent","fermata","invertedfermata","tenuto","0","1","2","3","4","5","+","wedge","open","thumb","snap","turn","roll","breath","shortphrase","mediumphrase","longphrase","segno","coda","D.S.","D.C.","fine","beambr1","beambr2","slide","marcato","upbow","downbow","/","//","///","////","trem1","trem2","trem3","trem4","turnx","invertedturn","invertedturnx","trill(","trill)","arpeggio","xstem","mark","umarcato","style=normal","style=harmonic","style=rhythm","style=x","style=triangle","D.C.alcoda","D.C.alfine","D.S.alcoda","D.S.alfine","editorial","courtesy"],Cn=["p","pp","f","ff","mf","mp","ppp","pppp","fff","ffff","sfz"],Nn=["crescendo(","crescendo)","diminuendo(","diminuendo)","glissando(","glissando)","~(","~)"],kn=[["<","accent"],[">","accent"],["tr","trill"],["plus","+"],["emphasis","accent"],["^","umarcato"],["marcato","umarcato"]],Tn=[["<(","crescendo("],["<)","crescendo)"],[">(","diminuendo("],[">)","diminuendo)"]],xi="ABCDEFGabcdefgxyzZ[]|^_{",wi=[.5,.75,.875,.9375,.96875,.984375,.25,.375,.4375,.46875,.484375,.4921875,.125,.1875,.21875,.234375,.2421875,.24609375,.0625,.09375,.109375,.1171875,.12109375,.123046875,.03125,.046875,.0546875,.05859375,.060546875,.0615234375,.015625,.0234375,.02734375,.029296875,.0302734375,.03076171875],yi={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11},Ei={x:"invisible",X:"invisible-multimeasure",y:"spacer",z:"rest",Z:"multimeasure"},Bn={dblflat:"__",flat:"_",natural:"=",sharp:"^",dblsharp:"^^",quarterflat:"_/",quartersharp:"^/"},Ci={2:3,3:2,4:3,5:2,6:2,7:2,8:3,9:2};var Y,V,E,Ne,Le,Dt;function Ft(e,t,r,i,o,h){Y=e,V=t,E=r,Ne=i,Le=o,Dt=h,this.lineContinuation=!1}var Ni=function(e,t,r){if(e.inTie[t]===void 0)return!1;var i=e.currentVoice?e.currentVoice.staffNum*100+e.currentVoice.index:0;return!!(e.inTie[t][i]&&(r.pitches!==void 0||r.rest.type!=="spacer"))},_={};Ft.prototype.parseMusic=function(e){Dt.resolveTempo(),E.is_in_header=!1;for(var t=0,r=E.iChar;Y.isWhiteSpace(e[t])&&t<e.length;)t++;if(!(t===e.length||e[t]==="%")){var i=E.start_new_line;E.continueall===void 0?E.start_new_line=!0:E.start_new_line=!1;var o=0,h=Dt.letter_to_body_header(e,t);h[0]>0&&(t+=h[0],h[1]==="V"&&this.startNewLine());for(var u=0;t<e.length;){var a=t;if(e[t]==="%")break;var c=Dt.letter_to_inline_header(e,t,i);if(c[0]>0)t+=c[0],c[1]==="V"&&(i=!0);else{(!Le.hasBeginMusic()||i&&!this.lineContinuation)&&(this.startNewLine(),i=!1);for(var l;;)if(l=Y.eatWhiteSpace(e,t),l>0&&(t+=l),t>0&&e[t-1]===""&&(l=Dt.letter_to_body_header(e,t),l[0]>0&&(l[1]==="V"&&this.startNewLine(),t=l[0],E.start_new_line=!1)),l=Ds(e,t),l[0]>0&&(t+=l[0]),l=Ts(e,t),l[0]>0){_.chord||(_.chord=[]);var d=Y.translateString(l[1]);d=d.replace(/;/g,`
`);for(var n=!1,s=0;s<_.chord.length;s++)_.chord[s].position===l[2]&&(n=!0,_.chord[s].name+=`
`+d);n===!1&&(l[2]===null&&l[3]?_.chord.push({name:d,rel_position:l[3]}):_.chord.push({name:d,position:l[2]})),t+=l[0];var f=Y.skipWhiteSpace(e.substring(t));f>0&&(_.force_end_beam_last=!0),t+=f}else if(xi.indexOf(e[t])===-1?l=Ti(e,t):l=[0],l[0]>0)l[1]===null?t+1<e.length&&this.startNewLine():l[1].length>0&&(l[1].indexOf("style=")===0?_.style=l[1].substr(6):(_.decoration===void 0&&(_.decoration=[]),l[1]==="beambr1"?_.beambr=1:l[1]==="beambr2"?_.beambr=2:_.decoration.push(l[1]))),t+=l[0];else if(l=Bs(e,t),l[0]>0)_.gracenotes=l[1],t+=l[0];else break;if(l=As(e,t),l[0]>0){u=0,_.gracenotes!==void 0&&(_.rest={type:"spacer"},_.duration=.125,E.addFormattingOptions(_,Ne.formatting,"note"),Le.appendElement("note",r+t,r+t+l[0],_),E.measureNotEmpty=!0,_={});var p={type:l[1]};if(p.type.length===0)V("Unknown bar type",e,t);else{if(E.inEnding&&p.type!=="bar_thin"&&(p.endEnding=!0,E.inEnding=!1),l[2]&&(p.startEnding=l[2],E.inEnding&&(p.endEnding=!0),E.inEnding=!0,l[1]==="bar_right_repeat"?E.restoreStartEndingHoldOvers():E.duplicateStartEndingHoldOvers()),_.decoration!==void 0&&(p.decoration=_.decoration),_.chord!==void 0&&(p.chord=_.chord),p.startEnding&&E.barFirstEndingNum===void 0?E.barFirstEndingNum=E.currBarNumber:p.startEnding&&p.endEnding&&E.barFirstEndingNum?E.currBarNumber=E.barFirstEndingNum:p.endEnding&&(E.barFirstEndingNum=void 0),p.type!=="bar_invisible"&&E.measureNotEmpty){var m=E.currentVoice===void 0||E.currentVoice.staffNum===0&&E.currentVoice.index===0;m&&(E.currBarNumber++,E.barNumbers&&E.currBarNumber%E.barNumbers===0&&(p.barNumber=E.currBarNumber))}E.addFormattingOptions(_,Ne.formatting,"bar"),Le.appendElement("bar",r+a,r+t+l[0],p),E.measureNotEmpty=!1,_={}}t+=l[0]}else if(e[t]==="&")l=_s(e,t),l[0]>0&&(Le.appendElement("overlay",r,r+1,{}),t+=1,u++);else{if(l=Fs(e,t),l.consumed>0&&(l.startSlur!==void 0&&(_.startSlur=l.startSlur),l.dottedSlur&&(_.dottedSlur=!0),l.triplet!==void 0&&(o>0?V("Can't nest triplets",e,t):(_.startTriplet=l.triplet,_.tripletMultiplier=l.tripletQ/l.triplet,_.tripletR=l.num_notes,o=l.num_notes===void 0?l.triplet:l.num_notes)),t+=l.consumed),e[t]==="["){var g=t;t++;for(var b=null,N=!1,B=!1;!B;){var y=Ti(e,t);y[0]>0&&(t+=y[0]);var v=_n(e,t,{},!1);if(v!==null&&v.pitch!==void 0)y[0]>0&&y[1].indexOf("style=")!==0&&(_.decoration===void 0&&(_.decoration=[]),_.decoration.push(y[1])),v.end_beam&&(_.end_beam=!0,delete v.end_beam),_.pitches===void 0?(_.duration=v.duration,_.pitches=[v]):_.pitches.push(v),delete v.duration,y[0]>0&&y[1].indexOf("style=")===0&&(_.pitches[_.pitches.length-1].style=y[1].substr(6)),E.inTieChord[_.pitches.length]&&(v.endTie=!0,E.inTieChord[_.pitches.length]=void 0),v.startTie&&(E.inTieChord[_.pitches.length]=!0),t=v.endChar,delete v.endChar;else if(e[t]===" ")V("Spaces are not allowed in chords",e,t),t++;else{if(t<e.length&&e[t]==="]"){t++,E.next_note_duration!==0&&(_.duration=_.duration*E.next_note_duration,E.next_note_duration=0),Ni(E,u,_)&&(_.pitches.forEach(function(S){S.endTie=!0}),_t(E,u,!1)),o>0&&!(_.rest&&_.rest.type==="spacer")&&(o--,o===0&&(_.endTriplet=!0));for(var k=!1;t<e.length&&!k;){switch(e[t]){case" ":case"	":At(_);break;case")":_.endSlur===void 0?_.endSlur=1:_.endSlur++;break;case"-":_.pitches.forEach(function(S){S.startTie={}}),_t(E,u,!0);break;case">":case"<":var L=Bi(e,t);t+=L[0]-1,E.next_note_duration=L[2],b?b=b*L[1]:b=L[1];break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"/":var D=Y.getFraction(e,t);b=D.value,t=D.index;var A=e[t];A===" "&&(N=!0),A==="-"||A===")"||A===" "||A==="<"||A===">"?t--:k=!0;break;default:k=!0;break}k||t++}}else V("Expected ']' to end the chords",e,t);_.pitches!==void 0&&(b!==null&&(_.duration=_.duration*b,N&&At(_)),E.addFormattingOptions(_,Ne.formatting,"note"),Le.appendElement("note",r+a,r+t,_),E.measureNotEmpty=!0,_={}),B=!0}}}else{var M={},F=_n(e,t,M,!0);M.endTie!==void 0&&_t(E,u,!0),F!==null&&(F.pitch!==void 0?(_.pitches=[{}],F.accidental!==void 0&&(_.pitches[0].accidental=F.accidental),_.pitches[0].pitch=F.pitch,_.pitches[0].name=F.name,(F.midipitch||F.midipitch===0)&&(_.pitches[0].midipitch=F.midipitch),F.endSlur!==void 0&&(_.pitches[0].endSlur=F.endSlur),F.endTie!==void 0&&(_.pitches[0].endTie=F.endTie),F.startSlur!==void 0&&(_.pitches[0].startSlur=F.startSlur),_.startSlur!==void 0&&(_.pitches[0].startSlur=_.startSlur),_.dottedSlur!==void 0&&(_.pitches[0].dottedSlur=!0),F.startTie!==void 0&&(_.pitches[0].startTie=F.startTie),_.startTie!==void 0&&(_.pitches[0].startTie=_.startTie)):(_.rest=F.rest,F.endSlur!==void 0&&(_.endSlur=F.endSlur),F.endTie!==void 0&&(_.rest.endTie=F.endTie),F.startSlur!==void 0&&(_.startSlur=F.startSlur),F.startTie!==void 0&&(_.rest.startTie=F.startTie),_.startTie!==void 0&&(_.rest.startTie=_.startTie)),F.chord!==void 0&&(_.chord=F.chord),F.duration!==void 0&&(_.duration=F.duration),F.decoration!==void 0&&(_.decoration=F.decoration),F.graceNotes!==void 0&&(_.graceNotes=F.graceNotes),delete _.startSlur,delete _.dottedSlur,Ni(E,u,_)&&(_.pitches!==void 0?_.pitches[0].endTie=!0:_.rest.type!=="spacer"&&(_.rest.endTie=!0),_t(E,u,!1)),(F.startTie||_.startTie)&&_t(E,u,!0),t=F.endChar,o>0&&!(F.rest&&F.rest.type==="spacer")&&(o--,o===0&&(_.endTriplet=!0)),F.end_beam&&At(_),_.rest&&_.rest.type==="rest"&&_.duration===1&&ki(E)<=1&&(_.rest.type="whole",_.duration=ki(E)),_.duration<1&&wi.indexOf(_.duration)===-1&&_.duration!==0&&(!_.rest||_.rest.type!=="spacer")&&V("Duration not representable: "+e.substring(a,t),e,t),E.addFormattingOptions(_,Ne.formatting,"note"),Le.appendElement("note",r+a,r+t,_),E.measureNotEmpty=!0,_={})}t===a&&(e[t]!==" "&&e[t]!=="`"&&V("Unknown character ignored",e,t),t++)}}}this.lineContinuation=e.indexOf("")>=0||h[0]>0,this.lineContinuation||(_={})}};var _t=function(e,t,r){var i=e.currentVoice?e.currentVoice.staffNum*100+e.currentVoice.index:0;e.inTie[t]===void 0&&(e.inTie[t]=[]),e.inTie[t][i]=r},Ts=function(e,t){if(e[t]==='"'){var r=Y.getBrackettedSubstring(e,t,5);if(r[2]||V("Missing the closing quote while parsing the chord symbol",e,t),r[0]>0&&r[1].length>0&&r[1][0]==="^")r[1]=r[1].substring(1),r[2]="above";else if(r[0]>0&&r[1].length>0&&r[1][0]==="_")r[1]=r[1].substring(1),r[2]="below";else if(r[0]>0&&r[1].length>0&&r[1][0]==="<")r[1]=r[1].substring(1),r[2]="left";else if(r[0]>0&&r[1].length>0&&r[1][0]===">")r[1]=r[1].substring(1),r[2]="right";else if(r[0]>0&&r[1].length>0&&r[1][0]==="@"){r[1]=r[1].substring(1);var i=Y.getFloat(r[1]);i.digits===0&&V("Missing first position in absolutely positioned annotation.",e,t),r[1]=r[1].substring(i.digits),r[1][0]!==","&&V("Missing comma absolutely positioned annotation.",e,t),r[1]=r[1].substring(1);var o=Y.getFloat(r[1]);o.digits===0&&V("Missing second position in absolutely positioned annotation.",e,t),r[1]=r[1].substring(o.digits);var h=Y.skipWhiteSpace(r[1]);r[1]=r[1].substring(h),r[2]=null,r[3]={x:i.value,y:o.value}}else E.freegchord!==!0&&(r[1]=r[1].replace(/([ABCDEFG0-9])b/g,"$1♭"),r[1]=r[1].replace(/([ABCDEFG0-9])#/g,"$1♯"),r[1]=r[1].replace(/^([ABCDEFG])([♯♭]?)o([^A-Za-z])/g,"$1$2°$3"),r[1]=r[1].replace(/^([ABCDEFG])([♯♭]?)o$/g,"$1$2°"),r[1]=r[1].replace(/^([ABCDEFG])([♯♭]?)0([^A-Za-z])/g,"$1$2ø$3"),r[1]=r[1].replace(/^([ABCDEFG])([♯♭]?)\^([^A-Za-z])/g,"$1$2∆$3")),r[2]="default",r[1]=Bt.chordName(E,r[1]);return r}return[0,""]},Bs=function(e,t){if(e[t]==="{"){var r=Y.getBrackettedSubstring(e,t,1,"}");r[2]||V("Missing the closing '}' while parsing grace note",e,t),e[t+r[0]]===")"&&(r[0]++,r[1]+=")");for(var i=[],o=0,h=!1;o<r[1].length;){var u=!1;r[1][o]==="/"&&(u=!0,o++);var a=_n(r[1],o,{},!1);a!==null?(a.duration=a.duration/(E.default_length*8),u&&(a.acciaccatura=!0),i.push(a),h&&(a.endTie=!0,h=!1),a.startTie&&(h=!0),o=a.endChar,delete a.endChar,a.end_beam&&(a.endBeam=!0,delete a.end_beam)):(r[1][o]===" "?i.length>0&&(i[i.length-1].endBeam=!0):V("Unknown character '"+r[1][o]+"' while parsing grace note",e,t),o++)}if(i.length)return[r[0],i]}return[0]};function _s(e,t){if(e[t]==="&"){for(var r=t;e[t]&&e[t]!==":"&&e[t]!=="|";)t++;return[t-r,e.substring(r+1,t)]}return[0]}function ki(e){var t=e.origMeter;return!t||t.type!=="specified"||!t.value||t.value.length===0?1:parseInt(t.value[0].num,10)/parseInt(t.value[0].den,10)}var Ti=function(e,t){var r=E.macros[e[t]];if(r!==void 0)return(r[0]==="!"||r[0]==="+")&&(r=r.substring(1)),(r[r.length-1]==="!"||r[r.length-1]==="+")&&(r=r.substring(0,r.length-1)),En.includes(r)?[1,r]:Cn.includes(r)?(E.volumePosition==="hidden"&&(r=""),[1,r]):Nn.includes(r)?(E.dynamicPosition==="hidden"&&(r=""),[1,r]):(E.ignoredDecorations.includes(r)||V("Unknown macro: "+r,e,t),[1,""]);switch(e[t]){case".":if(e[t+1]==="("||e[t+1]==="-")break;return[1,"staccato"];case"u":return[1,"upbow"];case"v":return[1,"downbow"];case"~":return[1,"irishroll"];case"!":case"+":var i=Y.getBrackettedSubstring(e,t,5);if(i[1].length>1&&(i[1][0]==="^"||i[1][0]==="_")&&(i[1]=i[1].substring(1)),En.includes(i[1]))return i;if(Cn.includes(i[1]))return E.volumePosition==="hidden"&&(i[1]=""),i;if(Nn.includes(i[1]))return E.dynamicPosition==="hidden"&&(i[1]=""),i;var o=kn.findIndex(function(h){return i[1]===h[0]});return o>=0?(i[1]=kn[o][1],i):(o=Tn.findIndex(function(h){return i[1]===h[0]}),o>=0?(i[1]=Tn[o][1],E.dynamicPosition==="hidden"&&(i[1]=""),i):e[t]==="!"&&(i[0]===1||e[t+i[0]-1]!=="!")?[1,null]:(V("Unknown decoration: "+i[1],e,t),i[1]="",i));case"H":return[1,"fermata"];case"J":return[1,"slide"];case"L":return[1,"accent"];case"M":return[1,"mordent"];case"O":return[1,"coda"];case"P":return[1,"pralltriller"];case"R":return[1,"roll"];case"S":return[1,"segno"];case"T":return[1,"trill"]}return[0,0]},Ds=function(e,t){for(var r=t;Y.isWhiteSpace(e[t]);)t++;return[t-r]},As=function(e,t){var r=Y.getBarLine(e,t);if(r.len===0)return[0,""];if(r.warn)return V(r.warn,e,t),[r.len,""];for(var i=0;i<e.length&&e[t+r.len+i]===" ";i++);var o=r.len;if(e[t+r.len+i]==="["&&(r.len+=i+1),e[t+r.len]==='"'&&e[t+r.len-1]==="["){var h=Y.getBrackettedSubstring(e,t+r.len,5);return[r.len+h[0],r.token,h[1]]}var u=Y.getTokenOf(e.substring(t+r.len),"1234567890-,");return u.len===0||u.token[0]==="-"?[o,r.token]:[r.len+u.len,r.token,u.token]},Fs=function(e,t){var r={},i=t;for(e[t]==="."&&e[t+1]==="("&&(r.dottedSlur=!0,t++);e[t]==="("||Y.isWhiteSpace(e[t]);)e[t]==="("&&(t+1<e.length&&e[t+1]>="2"&&e[t+1]<="9"?(r.triplet!==void 0?V("Can't nest triplets",e,t):(r.triplet=e[t+1]-"0",r.tripletQ=Ci[r.triplet],r.num_notes=r.triplet,t+2<e.length&&e[t+2]===":"&&(t+3<e.length&&e[t+3]===":"?t+4<e.length&&e[t+4]>="1"&&e[t+4]<="9"?(r.num_notes=e[t+4]-"0",t+=3):V("expected number after the two colons after the triplet to mark the duration",e,t):t+3<e.length&&e[t+3]>="1"&&e[t+3]<="9"?(r.tripletQ=e[t+3]-"0",t+4<e.length&&e[t+4]===":"?t+5<e.length&&e[t+5]>="1"&&e[t+5]<="9"&&(r.num_notes=e[t+5]-"0",t+=4):t+=2):V("expected number after the triplet to mark the duration",e,t))),t++):r.startSlur===void 0?r.startSlur=1:r.startSlur++),t++;return r.consumed=t-i,r};Ft.prototype.startNewLine=function(){var e={startChar:-1,endChar:-1};E.partForNextLine.title&&(e.part=E.partForNextLine),e.clef=E.currentVoice&&E.staves[E.currentVoice.staffNum].clef!==void 0?G.clone(E.staves[E.currentVoice.staffNum].clef):G.clone(E.clef);var t=E.currentVoice?E.currentVoice.scoreTranspose:0;if(e.key=se.standardKey(E.key.root+E.key.acc+E.key.mode,E.key.root,E.key.acc,t),e.key.mode=E.key.mode,E.key.impliedNaturals&&(e.key.impliedNaturals=E.key.impliedNaturals),E.key.explicitAccidentals)for(var r=0;r<E.key.explicitAccidentals.length;r++){for(var i=!1,o=0;o<e.key.accidentals.length;o++)e.key.accidentals[o].note===E.key.explicitAccidentals[r].note&&(e.key.accidentals[o].acc=E.key.explicitAccidentals[r].acc,i=!0);i||e.key.accidentals.push(E.key.explicitAccidentals[r])}if(E.targetKey=e.key,e.key.explicitAccidentals&&delete e.key.explicitAccidentals,se.addPosToKey(e.clef,e.key),E.meter!==null?(E.currentVoice?(E.staves.forEach(function(a){a.meter=E.meter}),e.meter=E.staves[E.currentVoice.staffNum].meter,E.staves[E.currentVoice.staffNum].meter=null):e.meter=E.meter,E.meter=null):E.currentVoice&&E.staves[E.currentVoice.staffNum].meter&&(e.meter=E.staves[E.currentVoice.staffNum].meter,E.staves[E.currentVoice.staffNum].meter=null),E.currentVoice&&E.currentVoice.name&&(e.name=E.currentVoice.name),E.vocalfont&&(e.vocalfont=E.vocalfont),E.tripletfont&&(e.tripletfont=E.tripletfont),E.gchordfont&&(e.gchordfont=E.gchordfont),E.style&&(e.style=E.style),E.currentVoice){var h=E.staves[E.currentVoice.staffNum];h.brace&&(e.brace=h.brace),h.bracket&&(e.bracket=h.bracket),h.connectBarLines&&(e.connectBarLines=h.connectBarLines),h.name&&(e.name=h.name[E.currentVoice.index]),h.subname&&(e.subname=h.subname[E.currentVoice.index]),E.currentVoice.stem&&(e.stem=E.currentVoice.stem),E.currentVoice.stafflines&&(e.stafflines=E.currentVoice.stafflines),E.currentVoice.staffscale&&(e.staffscale=E.currentVoice.staffscale),E.currentVoice.scale&&(e.scale=E.currentVoice.scale),E.currentVoice.color&&(e.color=E.currentVoice.color),E.currentVoice.style&&(e.style=E.currentVoice.style),E.currentVoice.transpose&&(e.clef.transpose=E.currentVoice.transpose)}var u=E.currentVoice===void 0||E.currentVoice.staffNum===0&&E.currentVoice.index===0;E.barNumbers===0&&u&&E.currBarNumber!==1&&(e.barNumber=E.currBarNumber),Le.startNewLine(e),E.key.impliedNaturals&&delete E.key.impliedNaturals,E.partForNextLine={},E.tempoForNextLine.length===4&&Le.appendElement(E.tempoForNextLine[0],E.tempoForNextLine[1],E.tempoForNextLine[2],E.tempoForNextLine[3]),E.tempoForNextLine=[]};var At=function(e){return e.duration!==void 0&&e.duration<.25&&(e.end_beam=!0),e},_n=function(e,t,r,i){var o=function(s){return s==="octave"||s==="duration"||s==="Zduration"||s==="broken_rhythm"||s==="end_slur"},h;e[t]==="."&&e[t+1]==="-"&&(h=!0,t++);for(var u="startSlur",a=!1;;){switch(e[t]){case"(":if(u==="startSlur")r.startSlur===void 0?r.startSlur=1:r.startSlur++;else return o(u)?(r.endChar=t,r):null;break;case")":if(o(u))r.endSlur===void 0?r.endSlur=1:r.endSlur++;else return null;break;case"^":if(u==="startSlur")r.accidental="sharp",u="sharp2";else if(u==="sharp2")r.accidental="dblsharp",u="pitch";else return o(u)?(r.endChar=t,r):null;break;case"_":if(u==="startSlur")r.accidental="flat",u="flat2";else if(u==="flat2")r.accidental="dblflat",u="pitch";else return o(u)?(r.endChar=t,r):null;break;case"=":if(u==="startSlur")r.accidental="natural",u="pitch";else return o(u)?(r.endChar=t,r):null;break;case"A":case"B":case"C":case"D":case"E":case"F":case"G":case"a":case"b":case"c":case"d":case"e":case"f":case"g":if(u==="startSlur"||u==="sharp2"||u==="flat2"||u==="pitch"){if(r.pitch=yi[e[t]],r.pitch+=7*(E.currentVoice&&E.currentVoice.octave!==void 0?E.currentVoice.octave:E.octave),r.name=e[t],r.accidental&&(r.name=Bn[r.accidental]+r.name),Bt.note(E,r),u="octave",i&&E.next_note_duration!==0?(r.duration=E.default_length*E.next_note_duration,E.next_note_duration=0,a=!0):r.duration=E.default_length,E.clef&&E.clef.type==="perc"||E.currentVoice&&E.currentVoice.clef==="perc"){var c=e[t];r.accidental&&(c=Bn[r.accidental]+c),Ne.formatting&&Ne.formatting.midi&&Ne.formatting.midi.drummap&&(r.midipitch=Ne.formatting.midi.drummap[c])}}else return o(u)?(r.endChar=t,r):null;break;case",":if(u==="octave")r.pitch-=7,r.name+=",";else return o(u)?(r.endChar=t,r):null;break;case"'":if(u==="octave")r.pitch+=7,r.name+="'";else return o(u)?(r.endChar=t,r):null;break;case"x":case"X":case"y":case"z":case"Z":if(u==="startSlur")r.rest={type:Ei[e[t]]},delete r.accidental,delete r.startSlur,delete r.startTie,delete r.endSlur,delete r.endTie,delete r.end_beam,delete r.grace_notes,r.rest.type.indexOf("multimeasure")>=0?(r.duration=Ne.getBarLength(),r.rest.text=1,u="Zduration"):(i&&E.next_note_duration!==0?(r.duration=E.default_length*E.next_note_duration,E.next_note_duration=0,a=!0):r.duration=E.default_length,u="duration");else return o(u)?(r.endChar=t,r):null;break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":case"/":if(u==="octave"||u==="duration"){var l=Y.getFraction(e,t);for(r.duration=r.duration*l.value,r.endChar=l.index;l.index<e.length&&(Y.isWhiteSpace(e[l.index])||e[l.index]==="-");)e[l.index]==="-"?r.startTie={}:r=At(r),l.index++;t=l.index-1,u="broken_rhythm"}else if(u==="sharp2")r.accidental="quartersharp",u="pitch";else if(u==="flat2")r.accidental="quarterflat",u="pitch";else if(u==="Zduration"){var d=Y.getNumber(e,t);return r.duration=d.num*Ne.getBarLength(),r.rest.text=d.num,r.endChar=d.index,r}else return null;break;case"-":if(u==="startSlur")Le.addTieToLastNote(h),r.endTie=!0;else if(u==="octave"||u==="duration"||u==="end_slur")if(r.startTie={},!a&&i)u="broken_rhythm";else return Y.isWhiteSpace(e[t+1])&&At(r),r.endChar=t+1,r;else return u==="broken_rhythm"?(r.endChar=t,r):null;break;case" ":case"	":if(o(u)){r.end_beam=!0,h=!1;do e[t]==="."&&e[t+1]==="-"&&(h=!0,t++),e[t]==="-"&&(r.startTie={},h&&(r.startTie.style="dotted")),t++;while(t<e.length&&(Y.isWhiteSpace(e[t])||e[t]==="-")||e[t]==="."&&e[t+1]==="-");if(r.endChar=t,!a&&i&&(e[t]==="<"||e[t]===">"))t--,u="broken_rhythm";else return r}else return null;break;case">":case"<":if(o(u))if(i){var n=Bi(e,t);t+=n[0]-1,E.next_note_duration=n[2],r.duration=n[1]*r.duration,u="end_slur"}else return r.endChar=t,r;else return null;break;default:return o(u)?(r.endChar=t,r):null}if(t++,t===e.length)return o(u)?(r.endChar=t,r):null}return null},Bi=function(e,t){switch(e[t]){case">":return t<e.length-2&&e[t+1]===">"&&e[t+2]===">"?[3,1.875,.125]:t<e.length-1&&e[t+1]===">"?[2,1.75,.25]:[1,1.5,.5];case"<":return t<e.length-2&&e[t+1]==="<"&&e[t+2]==="<"?[3,.125,1.875]:t<e.length-1&&e[t+1]==="<"?[2,.25,1.75]:[1,.5,1.5]}return null};var Dn=function(e,t){this.lineIndex=0,this.lines=e,this.multilineVars=t,this.skipWhiteSpace=function(n){for(var s=0;s<n.length;s++)if(!this.isWhiteSpace(n[s]))return s;return n.length};var r=function(n,s){return s>=n.length};this.eatWhiteSpace=function(n,s){for(var f=s;f<n.length;f++)if(!this.isWhiteSpace(n[f]))return f-s;return f-s},this.getKeyPitch=function(n){var s=this.skipWhiteSpace(n);if(r(n,s))return{len:0};switch(n[s]){case"A":return{len:s+1,token:"A"};case"B":return{len:s+1,token:"B"};case"C":return{len:s+1,token:"C"};case"D":return{len:s+1,token:"D"};case"E":return{len:s+1,token:"E"};case"F":return{len:s+1,token:"F"};case"G":return{len:s+1,token:"G"}}return{len:0}},this.getSharpFlat=function(n){if(n==="bass")return{len:0};switch(n[0]){case"#":return{len:1,token:"#"};case"b":return{len:1,token:"b"}}return{len:0}},this.getMode=function(n){var s=function(m,g){for(;g<m.length&&(m[g]>="a"&&m[g]<="z"||m[g]>="A"&&m[g]<="Z");)g++;return g},f=this.skipWhiteSpace(n);if(r(n,f))return{len:0};var p=n.substring(f,f+3).toLowerCase();switch((p.length>1&&p[1]===" "||p[1]==="^"||p[1]==="_"||p[1]==="=")&&(p=p[0]),p){case"mix":return{len:s(n,f),token:"Mix"};case"dor":return{len:s(n,f),token:"Dor"};case"phr":return{len:s(n,f),token:"Phr"};case"lyd":return{len:s(n,f),token:"Lyd"};case"loc":return{len:s(n,f),token:"Loc"};case"aeo":return{len:s(n,f),token:"m"};case"maj":return{len:s(n,f),token:""};case"ion":return{len:s(n,f),token:""};case"min":return{len:s(n,f),token:"m"};case"m":return{len:s(n,f),token:"m"}}return{len:0}},this.getClef=function(n,s){var f=n,p=this.skipWhiteSpace(n);if(r(n,p))return{len:0};var m=!1,g=n.substring(p);if(G.startsWith(g,"clef=")&&(m=!0,g=g.substring(5),p+=5),g.length===0&&m)return{len:p+5,warn:"No clef specified: "+f};var b=this.skipWhiteSpace(g);if(r(g,b))return{len:0};b>0&&(p+=b,g=g.substring(b));var N=null;if(G.startsWith(g,"treble"))N="treble";else if(G.startsWith(g,"bass3"))N="bass3";else if(G.startsWith(g,"bass"))N="bass";else if(G.startsWith(g,"tenor"))N="tenor";else if(G.startsWith(g,"alto2"))N="alto2";else if(G.startsWith(g,"alto1"))N="alto1";else if(G.startsWith(g,"alto"))N="alto";else if(!s&&m&&G.startsWith(g,"none"))N="none";else if(G.startsWith(g,"perc"))N="perc";else if(!s&&m&&G.startsWith(g,"C"))N="tenor";else if(!s&&m&&G.startsWith(g,"F"))N="bass";else if(!s&&m&&G.startsWith(g,"G"))N="treble";else return{len:p+5,warn:"Unknown clef specified: "+f};return g=g.substring(N.length),b=this.isMatch(g,"+8"),b>0?N+="+8":(b=this.isMatch(g,"-8"),b>0&&(N+="-8")),{len:p+N.length,token:N,explicit:m}},this.getBarLine=function(n,s){switch(n[s]){case"]":switch(++s,n[s]){case"|":return{len:2,token:"bar_thick_thin"};case"[":return++s,n[s]>="1"&&n[s]<="9"||n[s]==='"'?{len:2,token:"bar_invisible"}:{len:1,warn:"Unknown bar symbol"};default:return{len:1,token:"bar_invisible"}}break;case":":switch(++s,n[s]){case":":return{len:2,token:"bar_dbl_repeat"};case"|":switch(++s,n[s]){case"]":switch(++s,n[s]){case"|":return++s,n[s]===":"?{len:5,token:"bar_dbl_repeat"}:{len:3,token:"bar_right_repeat"};default:return{len:3,token:"bar_right_repeat"}}break;case"|":return++s,n[s]===":"?{len:4,token:"bar_dbl_repeat"}:{len:3,token:"bar_right_repeat"};default:return{len:2,token:"bar_right_repeat"}}break;default:return{len:1,warn:"Unknown bar symbol"}}break;case"[":if(++s,n[s]==="|")switch(++s,n[s]){case":":return{len:3,token:"bar_left_repeat"};case"]":return{len:3,token:"bar_invisible"};default:return{len:2,token:"bar_thick_thin"}}else return n[s]>="1"&&n[s]<="9"||n[s]==='"'?{len:1,token:"bar_invisible"}:{len:0};break;case"|":switch(++s,n[s]){case"]":return{len:2,token:"bar_thin_thick"};case"|":return++s,n[s]===":"?{len:3,token:"bar_left_repeat"}:{len:2,token:"bar_thin_thin"};case":":for(var f=0;n[s+f]===":";)f++;return{len:1+f,token:"bar_left_repeat"};default:return{len:1,token:"bar_thin"}}break}return{len:0}},this.getTokenOf=function(n,s){for(var f=0;f<n.length;f++)if(s.indexOf(n[f])<0)return{len:f,token:n.substring(0,f)};return{len:f,token:n}},this.getToken=function(n,s,f){for(var p=s;p<f&&!this.isWhiteSpace(n[p]);)p++;return n.substring(s,p)},this.isMatch=function(n,s){var f=this.skipWhiteSpace(n);return r(n,f)?0:G.startsWith(n.substring(f),s)?f+s.length:0},this.getPitchFromTokens=function(n){var s={},f={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11};if(s.position=f[n[0].token],s.position===void 0)return{warn:"Pitch expected. Found: "+n[0].token};for(n.shift();n.length;)switch(n[0].token){case",":s.position-=7,n.shift();break;case"'":s.position+=7,n.shift();break;default:return s}return s},this.getKeyAccidentals2=function(n){for(var s;n.length>0;){var f;if(n[0].token==="^"){if(f="sharp",n.shift(),n.length===0)return{accs:s,warn:"Expected note name after "+f};switch(n[0].token){case"^":f="dblsharp",n.shift();break;case"/":f="quartersharp",n.shift();break}}else if(n[0].token==="=")f="natural",n.shift();else if(n[0].token==="_"){if(f="flat",n.shift(),n.length===0)return{accs:s,warn:"Expected note name after "+f};switch(n[0].token){case"_":f="dblflat",n.shift();break;case"/":f="quarterflat",n.shift();break}}else return{accs:s};if(n.length===0)return{accs:s,warn:"Expected note name after "+f};switch(n[0].token[0]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":s===void 0&&(s=[]),s.push({acc:f,note:n[0].token[0]}),n[0].token.length===1?n.shift():n[0].token=n[0].token.substring(1);break;default:return{accs:s,warn:"Expected note name after "+f+" Found: "+n[0].token}}}return{accs:s}},this.getKeyAccidental=function(n){var s={"^":"sharp","^^":"dblsharp","=":"natural",_:"flat",__:"dblflat","_/":"quarterflat","^/":"quartersharp"},f=this.skipWhiteSpace(n);if(r(n,f))return{len:0};var p=null;switch(n[f]){case"^":case"_":case"=":p=n[f];break;default:return{len:0}}if(f++,r(n,f))return{len:1,warn:"Expected note name after accidental"};switch(n[f]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":return{len:f+1,token:{acc:s[p],note:n[f]}};case"^":case"_":case"/":if(p+=n[f],f++,r(n,f))return{len:2,warn:"Expected note name after accidental"};switch(n[f]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":return{len:f+1,token:{acc:s[p],note:n[f]}};default:return{len:2,warn:"Expected note name after accidental"}}break;default:return{len:1,warn:"Expected note name after accidental"}}},this.isWhiteSpace=function(n){return n===" "||n==="	"||n===""},this.getMeat=function(n,s,f){var p=n.indexOf("%",s);for(p>=0&&p<f&&(f=p);s<f&&(n[s]===" "||n[s]==="	"||n[s]==="");)s++;for(;s<f&&(n[f-1]===" "||n[f-1]==="	"||n[f-1]==="");)f--;return{start:s,end:f}};var i=function(n){return n>="A"&&n<="Z"||n>="a"&&n<="z"},o=function(n){return n>="0"&&n<="9"};this.tokenize=function(n,s,f,p){var m=this.getMeat(n,s,f);s=m.start,f=m.end;for(var g=[],b;s<f;){if(n[s]==='"'){for(b=s+1;b<f&&n[b]!=='"';)b++;g.push({type:"quote",token:n.substring(s+1,b),start:s+1,end:b}),b++}else if(i(n[s])){if(b=s+1,p)for(;b<f&&!this.isWhiteSpace(n[b]);)b++;else for(;b<f&&i(n[b]);)b++;g.push({type:"alpha",token:n.substring(s,b),continueId:o(n[b]),start:s,end:b}),s=b+1}else if(n[s]==="."&&o(n[b+1])){b=s+1;for(var N=null,B=null;b<f&&o(n[b]);)b++;B=parseFloat(n.substring(s,b)),g.push({type:"number",token:n.substring(s,b),intt:N,floatt:B,continueId:i(n[b]),start:s,end:b}),s=b+1}else if(o(n[s])||n[s]==="-"&&o(n[b+1])){b=s+1;for(var y=null,v=null;b<f&&o(n[b]);)b++;if(n[b]==="."&&o(n[b+1]))for(b++;b<f&&o(n[b]);)b++;else y=parseInt(n.substring(s,b));v=parseFloat(n.substring(s,b)),g.push({type:"number",token:n.substring(s,b),intt:y,floatt:v,continueId:i(n[b]),start:s,end:b}),s=b+1}else n[s]===" "||n[s]==="	"||g.push({type:"punct",token:n[s],start:s,end:s+1}),b=s+1;s=b}return g},this.getVoiceToken=function(n,s,f){for(var p=s;p<f&&this.isWhiteSpace(n[p])||n[p]==="=";)p++;if(n[p]==='"'){var m=n.indexOf('"',p+1);return m===-1||m>=f?{len:1,err:"Missing close quote"}:{len:m-s+1,token:this.translateString(n.substring(p+1,m))}}else{for(var g=p;g<f&&!this.isWhiteSpace(n[g])&&n[g]!=="=";)g++;return{len:g-s+1,token:n.substring(p,g)}}};var h={"`a":"à","'a":"á","^a":"â","~a":"ã",'"a':"ä",oa:"å",aa:"å","=a":"ā",ua:"ă",";a":"ą","`e":"è","'e":"é","^e":"ê",'"e':"ë","=e":"ē",ue:"ĕ",";e":"ę",".e":"ė","`i":"ì","'i":"í","^i":"î",'"i':"ï","=i":"ī",ui:"ĭ",";i":"į","`o":"ò","'o":"ó","^o":"ô","~o":"õ",'"o':"ö","=o":"ō",uo:"ŏ","/o":"ø","`u":"ù","'u":"ú","^u":"û","~u":"ũ",'"u':"ü",ou:"ů","=u":"ū",uu:"ŭ",";u":"ų","`A":"À","'A":"Á","^A":"Â","~A":"Ã",'"A':"Ä",oA:"Å",AA:"Å","=A":"Ā",uA:"Ă",";A":"Ą","`E":"È","'E":"É","^E":"Ê",'"E':"Ë","=E":"Ē",uE:"Ĕ",";E":"Ę",".E":"Ė","`I":"Ì","'I":"Í","^I":"Î","~I":"Ĩ",'"I':"Ï","=I":"Ī",uI:"Ĭ",";I":"Į",".I":"İ","`O":"Ò","'O":"Ó","^O":"Ô","~O":"Õ",'"O':"Ö","=O":"Ō",uO:"Ŏ","/O":"Ø","`U":"Ù","'U":"Ú","^U":"Û","~U":"Ũ",'"U':"Ü",oU:"Ů","=U":"Ū",uU:"Ŭ",";U":"Ų",ae:"æ",AE:"Æ",oe:"œ",OE:"Œ",ss:"ß","'c":"ć","^c":"ĉ",uc:"č",cc:"ç",".c":"ċ",cC:"Ç","'C":"Ć","^C":"Ĉ",uC:"Č",".C":"Ċ","~N":"Ñ","~n":"ñ","=s":"š",vs:"š",DH:"Ð",dh:"ð",HO:"Ő",Ho:"ő",HU:"Ű",Hu:"ű","'Y":"Ý","'y":"ý","^Y":"Ŷ","^y":"ŷ",'"Y':"Ÿ",'"y':"ÿ",vS:"Š",vZ:"Ž",vz:"ž"},u={"#":"♯",b:"♭","=":"♮"},a={201:"♯",202:"♭",203:"♮",241:"¡",242:"¢",252:"a",262:"2",272:"o",302:"Â",312:"Ê",322:"Ò",332:"Ú",342:"â",352:"ê",362:"ò",372:"ú",243:"£",253:"«",263:"3",273:"»",303:"Ã",313:"Ë",323:"Ó",333:"Û",343:"ã",353:"ë",363:"ó",373:"û",244:"¤",254:"¬",264:"  ́",274:"1⁄4",304:"Ä",314:"Ì",324:"Ô",334:"Ü",344:"ä",354:"ì",364:"ô",374:"ü",245:"¥",255:"-",265:"μ",275:"1⁄2",305:"Å",315:"Í",325:"Õ",335:"Ý",345:"å",355:"í",365:"õ",375:"ý",246:"¦",256:"®",266:"¶",276:"3⁄4",306:"Æ",316:"Î",326:"Ö",336:"Þ",346:"æ",356:"î",366:"ö",376:"þ",247:"§",257:" ̄",267:"·",277:"¿",307:"Ç",317:"Ï",327:"×",337:"ß",347:"ç",357:"ï",367:"÷",377:"ÿ",250:" ̈",260:"°",270:" ̧",300:"À",310:"È",320:"Ð",330:"Ø",340:"à",350:"è",360:"ð",370:"ø",251:"©",261:"±",271:"1",301:"Á",311:"É",321:"Ñ",331:"Ù",341:"á",351:"é",361:"ñ",371:"ù"};this.translateString=function(n){var s=n.split("\\");if(s.length===1)return n;var f=null;return s.forEach(function(p){if(f===null)f=p;else{var m=h[p.substring(0,2)];m!==void 0?f+=m+p.substring(2):(m=a[p.substring(0,3)],m!==void 0?f+=m+p.substring(3):(m=u[p.substring(0,1)],m!==void 0?f+=m+p.substring(1):f+="\\"+p))}}),f},this.getNumber=function(n,s){for(var f=0;s<n.length;)switch(n[s]){case"0":f=f*10,s++;break;case"1":f=f*10+1,s++;break;case"2":f=f*10+2,s++;break;case"3":f=f*10+3,s++;break;case"4":f=f*10+4,s++;break;case"5":f=f*10+5,s++;break;case"6":f=f*10+6,s++;break;case"7":f=f*10+7,s++;break;case"8":f=f*10+8,s++;break;case"9":f=f*10+9,s++;break;default:return{num:f,index:s}}return{num:f,index:s}},this.getFraction=function(n,s){var f=1,p=1;if(n[s]!=="/"){var m=this.getNumber(n,s);f=m.num,s=m.index}if(n[s]==="/")if(s++,n[s]==="/"){for(var g=.5;n[s++]==="/";)g=g/2;return{value:f*g,index:s-1}}else{var b=s,N=this.getNumber(n,s);N.num===0&&b===s&&(N.num=2),N.num!==0&&(p=N.num),s=N.index}return{value:f/p,index:s}};function c(n){let f=/^(\d+)\./.exec(n);return f?f[1]:null}var l=[{match:/,\s*[Tt]he$/,replace:"The "},{match:/,\s*[Aa]$/,replace:"A "},{match:/,\s*[Aa]n$/,replace:"An "}];this.theReverser=function(n){for(var s=0;s<l.length;s++){var f=l[s],p=n.match(f.match);if(p){var m=c(n);m&&(n=n.replace(m+".",""),n=n.trim());var g=p[0].length,b=f.replace+n.substring(0,n.length-g);return m&&(b=m+". "+b),b}}return n},this.stripComment=function(n){var s=n.indexOf("%");return s>=0?G.strip(n.substring(0,s)):G.strip(n)},this.getInt=function(n){var s=parseInt(n);if(isNaN(s))return{digits:0};var f=""+s,p=n.indexOf(f);return{value:s,digits:p+f.length}},this.getFloat=function(n){var s=parseFloat(n);if(isNaN(s))return{digits:0};var f=""+s,p=n.indexOf(f);return{value:s,digits:p+f.length}},this.getMeasurement=function(n){if(n.length===0)return{used:0};var s=1,f="";if(n[0].token==="-")n.shift(),f="-",s++;else if(n[0].type!=="number")return{used:0};if(f+=n.shift().token,n.length===0)return{used:1,value:parseInt(f)};var p=n.shift();if(p.token==="."){if(s++,n.length===0)return{used:s,value:parseInt(f)};if(n[0].type==="number"&&(p=n.shift(),f=f+"."+p.token,s++,n.length===0))return{used:s,value:parseFloat(f)};p=n.shift()}switch(p.token){case"pt":return{used:s+1,value:parseFloat(f)};case"px":return{used:s+1,value:parseFloat(f)};case"cm":return{used:s+1,value:parseFloat(f)/2.54*72};case"in":return{used:s+1,value:parseFloat(f)*72};default:return n.unshift(p),{used:s,value:parseFloat(f)}}};var d=function(n){return n=n.replace(/\\n/g,`
`),n=n.replace(/\\"/g,'"'),n};this.getBrackettedSubstring=function(n,s,f,p){for(var m=p||n[s],g=s+1,b=!1;g<n.length&&(b||n[g]!==m);)b=n[g]==="\\",++g;return n[g]===m?[g-s+1,d(n.substring(s+1,g)),!0]:(g=s+f,g>n.length-1&&(g=n.length-1),[g-s+1,d(n.substring(s+1,g)),!1])}};Dn.prototype.peekLine=function(){return this.lines[this.lineIndex]};Dn.prototype.nextLine=function(){if(this.lineIndex>0&&(this.multilineVars.iChar+=this.lines[this.lineIndex-1].length+1),this.lineIndex<this.lines.length){var e=this.lines[this.lineIndex];return this.lineIndex++,e}return null};var _i=Dn;function Ss(e,t,r){if(!(!t||e.lines.length===0)){var i=e.deline({lineBreaks:!1}),o=Ps(i,t);e.lines=Ls(i,o,r),e.lineBreaks=o}}function Ls(e,t,r){for(var i=[],o=[],h=[],u=1,a=0;a<t.length;a++){var c=t[a];if(e[c.ogLine].staff){var l=e[c.ogLine].staff[c.staff];if(i[c.line]||(i[c.line]={staff:[]}),!i[c.line].staff[c.staff]){i[c.line].staff[c.staff]={voices:[]},r!==void 0&&c.staff===0&&c.line>0&&(i[c.line].staff[c.staff].barNumber=u);for(var d=Object.keys(l),n=0;n<d.length;n++){var s=d[n]==="voices";d[n]==="meter"&&c.line!==0&&(s=!0),s||(i[c.line].staff[c.staff][d[n]]=l[d[n]])}o[c.staff]&&(i[c.line].staff[c.staff].key=o[c.staff])}i[c.line].staff[c.staff].voices[c.voice]||(i[c.line].staff[c.staff].voices[c.voice]=[]),i[c.line].staff[c.staff].voices[c.voice]=e[c.ogLine].staff[c.staff].voices[c.voice].slice(c.start,c.end+1),h[c.staff*10+c.voice]&&i[c.line].staff[c.staff].voices[c.voice].unshift({el_type:"stem",direction:h[c.staff*10+c.voice].direction});for(var f=i[c.line].staff[c.staff].voices[c.voice],p=f.length-1;p>=0;p--)if(f[p].el_type==="key"){o[c.staff]={root:f[p].root,acc:f[p].acc,mode:f[p].mode,accidentals:f[p].accidentals.filter(function(g){return g.acc!=="natural"})};break}for(p=f.length-1;p>=0;p--)if(f[p].el_type==="stem"){h[c.staff*10+c.voice]={direction:f[p].direction};break}if(r!==void 0&&c.staff===0&&c.voice===0)for(p=0;p<f.length;p++)f[p].el_type==="bar"&&(u++,p===f.length-1?delete f[p].barNumber:f[p].barNumber=u)}else i[c.line]=e[c.ogLine]}for(var m=0;m<i.length;m++)i[m].staff&&(i[m].staff=i[m].staff.filter(function(g){return g!=null}));return i}function Ps(e,t){for(var r=[],i=0,o=0,h=0,u=0;u<e.length;u++){var a=e[u];if(a.staff){var c=o,l=t[i];i++;for(var d=0;d<a.staff.length;d++)for(var n=a.staff[d],s=0;s<n.voices.length;s++){h=c;for(var f=0,p=0,m=n.voices[s],g=0,b=0;b<m.length;b++){var N=m[b];N.el_type==="bar"&&(l[p]===f&&(r.push({ogLine:u,line:h,staff:d,voice:s,start:g,end:b}),g=b+1,h++,o=Math.max(o,h),p++),f++)}r.push({ogLine:u,line:h,staff:d,voice:s,start:g,end:m.length}),h++,o=Math.max(o,h)}}else r.push({ogLine:u,line:h}),h++,o=Math.max(o,h)}return r}function Ms(e,t){for(var r=[],i=[],o=0,h=0;h<e.length;h++){var u=e[h],a=o+u;if(a<t)o=a;else{var c=t-o,l=a-t;c<l&&o>0?(r.push(h-1),i.push(Math.round(o-u)),o=u):h<e.length-1&&(r.push(h),i.push(Math.round(o)),o=0)}}return i.push(Math.round(o)),{lineBreaks:r,totals:i}}function xr(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return t}function Os(e,t,r,i,o,h,u,a,c,l,d){for(var n=l;n<e.length;n++){var s=e[n];r+=s,i+=s;var f=Math.abs(r-t[a]),p=Math.abs(f-h)<t[0]/10;if(p)if(f<h){var m=xr(o),g=xr(c);g.push(n-1),m.push(i-s),d.push({accumulator:r,lineAccumulator:s,lineWidths:m,lastVariance:Math.abs(r-t[a+1]),highestVariance:Math.max(u,h),currLine:a+1,lineBreaks:g,startIndex:n+1})}else f>h&&n<e.length-1&&(m=xr(o),g=xr(c),d.push({accumulator:r,lineAccumulator:i,lineWidths:m,lastVariance:f,highestVariance:Math.max(u,f),currLine:a,lineBreaks:g,startIndex:n+1}));f>h?(c.push(n-1),a++,u=Math.max(u,h),h=Math.abs(r-t[a]),o.push(i-s),i=s):h=f}o.push(i)}function Is(e,t,r,i){for(var o=Math.ceil(e.total/t),h=Math.floor(e.total/o),u=[],a=0;a<o;a++)u.push(h*(a+1));var c=[];c.push({accumulator:0,lineAccumulator:0,lineWidths:[],lastVariance:999999,highestVariance:0,currLine:0,lineBreaks:[],startIndex:0});for(var l=0;l<c.length;)Os(e.measureWidths,u,c[l].accumulator,c[l].lineAccumulator,c[l].lineWidths,c[l].lastVariance,c[l].highestVariance,c[l].currLine,c[l].lineBreaks,c[l].startIndex,c),l++;for(a=0;a<c.length;a++){var d=c[a];d.variances=[],d.aveVariance=0;for(var n=0;n<d.lineWidths.length;n++){var s=d.lineWidths[n];d.variances.push(s-u[0]),d.aveVariance+=Math.abs(s-u[0])}d.aveVariance=d.aveVariance/d.lineWidths.length,i.attempts.push({type:"optimizeLineWidths",lineBreaks:d.lineBreaks,variances:d.variances,aveVariance:d.aveVariance,widths:e.measureWidths})}var f=9999999,p=-1;for(a=0;a<c.length;a++)d=c[a],d.aveVariance<f&&(f=d.aveVariance,p=a);return{failed:!1,lineBreaks:c[p].lineBreaks,variance:c[p].highestVariance}}function Gs(e,t,r){for(var i=[],o=[],h=0,u=!1,a=0;a<e.length;a++)h+=e[a],h>t&&(u=!0),a%r===r-1&&(a!==e.length-1&&i.push(a),o.push(Math.round(h)),h=0);return{failed:u,totals:o,lineBreaks:i}}function Rs(e,t,r){var i={lineBreaks:e,staffwidth:t};for(var o in r)r.hasOwnProperty(o)&&o!=="wrap"&&o!=="staffwidth"&&(i[o]=r[o]);return{revisedParams:i}}function qs(e,t,r){if(t.length===0||r.staffwidth<t[0].left)return{reParse:!1,explanation:"Staff width is narrower than the margin",revisedParams:r};var i=r.scale?Math.max(r.scale,.1):1,o=r.wrap.minSpacing?Math.max(parseFloat(r.wrap.minSpacing),1):1,h=r.wrap.minSpacingLimit?Math.max(parseFloat(r.wrap.minSpacingLimit),1):o-.1,u=r.wrap.maxSpacing?Math.max(parseFloat(r.wrap.maxSpacing),1):void 0;r.wrap.lastLineLimit&&!u&&(u=Math.max(parseFloat(r.wrap.lastLineLimit),1));for(var a=r.wrap.preferredMeasuresPerLine?Math.max(parseInt(r.wrap.preferredMeasuresPerLine,10),0):void 0,c=[],l=[],d=0;d<t.length;d++){var n=t[d],s=r.staffwidth-n.left,f=s/o/i,p=s/u/i,m=s/h/i,g={widths:n,lineBreakPoint:f,minLineSize:p,attempts:[],staffWidth:r.staffwidth,minWidth:Math.round(m)},b=null;if(a){var N=Gs(n.measureWidths,f,a);g.attempts.push({type:"Fixed Measures Per Line",preferredMeasuresPerLine:a,lineBreaks:N.lineBreaks,failed:N.failed,totals:N.totals}),N.failed||(b=N.lineBreaks)}if(!b){var B=Ms(n.measureWidths,f);g.attempts.push({type:"Free Form",lineBreaks:B.lineBreaks,totals:B.totals}),b=B.lineBreaks,b.length>0&&n.measureWidths.length<25&&(B=Is(n,f,b,g),g.attempts.push({type:"Optimize",failed:B.failed,reason:B.reason,lineBreaks:B.lineBreaks,totals:B.totals}),B.failed||(b=B.lineBreaks))}c.push(b),l.push(g)}var y=r.staffwidth,v=Rs(c,y,r);return v.explanation=l,v.reParse=!0,v}var Di={wrapLines:Ss,calcLineWraps:qs};var Me={};Me.FONTEM=360;Me.FONTSIZE=30;Me.STEP=Me.FONTSIZE*93/720;Me.SPACE=10;Me.TOPNOTE=15;Me.STAVEHEIGHT=100;Me.INDENT=50;var An=Me;function Fn(e,t){t||(t={});for(var r=!!t.lineBreaks,i=[],o=!1,h=[],u=[],a=[],c=[],l=[],d=[],n=[],s=0;s<e.length;s++){var f=e[s];if(f.staff){if(o&&!f.vskip)for(var p=i[i.length-1],m=0;m<p.staff.length;m++){var g=f.staff[m],b=p.staff[m];if(g&&(Ze(g.meter,h[m])||($s(g.meter,g.voices),h[m]=g.meter,delete g.meter),Ze(g.key,u[m])||(Us(g.key,g.voices),u[m]=g.key,delete g.key),g.title&&(b.abbrevTitle=g.title),Ze(g.clef,a[m])||(zs(g.clef,g.voices),a[m]=g.clef,delete g.clef),Ze(g.vocalfont,c[m])||(wr(g.vocalfont,g.voices,"vocalfont"),c[m]=g.vocalfont,delete g.vocalfont),Ze(g.gchordfont,l[m])||(wr(g.gchordfont,g.voices,"gchordfont"),l[m]=g.gchordfont,delete g.gchordfont),Ze(g.tripletfont,d[m])||(wr(g.tripletfont,g.voices,"tripletfont"),d[m]=g.tripletfont,delete g.tripletfont),Ze(g.annotationfont,n[m])||(wr(g.annotationfont,g.voices,"annotationfont"),n[m]=g.annotationfont,delete g.annotationfont)),g)for(var N=0;N<b.voices.length;N++){var B=b.voices[N],y=g.voices[N];r&&B.push({el_type:"break"}),y&&(b.voices[N]=B.concat(y))}}else{for(var v=0;v<f.staff.length;v++)u[v]=f.staff[v].key,h[v]=f.staff[v].meter,a[v]=f.staff[v].clef;i.push(Hs(f))}o=!0}else o=!1,i.push(f)}return i}function Ai(e,t){return e==="abselem"?"abselem":t}function $s(e,t){e.el_type="meter",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function Us(e,t){e.el_type="key",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function zs(e,t){e.el_type="clef",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function wr(e,t,r){e.el_type="font",e.type=r,e.startChar=-1,e.endChar=-1;for(var i=0;i<t.length;i++)t[i].unshift(e)}function Ze(e,t){if(!e)return!0;var r=JSON.stringify(e,Ai),i=JSON.stringify(t,Ai);return r===i}function Hs(e){for(var t={},r=Object.keys(e),i=0;i<r.length;i++)if(r[i]!=="staff")t[r[i]]=e[r[i]];else{t.staff=[];for(var o=0;o<e.staff.length;o++){for(var h={},u=Object.keys(e.staff[o]),a=0;a<u.length;a++)if(u[a]!=="voices")h[u[a]]=e.staff[o][u[a]];else{h.voices=[];for(var c=0;c<e.staff[o].voices.length;c++)h.voices.push([].concat(e.staff[o].voices[c]))}t.staff.push(h)}}return t}function Sn(){this.reset=function(){this.version="1.1.0",this.media="screen",this.metaText={},this.metaTextInfo={},this.formatting={},this.lines=[],this.staffNum=0,this.voiceNum=0,this.lineNum=0,this.runningFonts={},delete this.visualTranspose},this.reset();function e(u,a,c,l){for(var d=0;d<l.length;d++)u[c][l[d]]=a[c][l[d]]}this.copyTopInfo=function(u){var a=["tempo","title","header","rhythm","origin","composer","author","partOrder"];e(this,u,"metaText",a),e(this,u,"metaTextInfo",a)},this.copyBottomInfo=function(u){var a=["unalignedWords","book","source","discography","notes","transcription","history","abc-copyright","abc-creator","abc-edited-by","footer"];e(this,u,"metaText",a),e(this,u,"metaTextInfo",a)},this.getBeatLength=function(){var u=this.getMeterFraction(),a=1;return(u.num===6||u.num===9||u.num===12||u.num===3&&u.den===8)&&(a=3),a/u.den};function t(u,a){for(var c=0,l=0;l<u.length;l++)if(u[l].staff)for(var d=0;d<u[l].staff.length;d++)for(var n=0;n<u[l].staff[d].voices.length;n++)for(var s=u[l].staff[d].voices[n],f=1,p=0;p<s.length;p++){var m=s[p].rest&&s[p].rest.type==="spacer";if(s[p].startTriplet&&(f=s[p].tripletMultiplier),s[p].duration&&!m&&s[p].el_type!=="tempo"&&(c+=s[p].duration*f),s[p].endTriplet&&(f=1),c>=a&&(c-=a),s[p].el_type==="bar")return c}return c}this.getPickupLength=function(){var u=this.getBarLength(),a=t(this.lines,u);return a<1e-8||u-a<1e-8?0:a},this.getBarLength=function(){var u=this.getMeterFraction();return u.num/u.den},this.getTotalTime=function(){return this.totalTime},this.getTotalBeats=function(){return this.totalBeats},this.millisecondsPerMeasure=function(u){var a;if(u)a=u;else{var c=this.metaText?this.metaText.tempo:null;a=this.getBpm(c)}a<=0&&(a=1);var l=this.getBeatsPerMeasure(),d=l/a;return d*6e4},this.getBeatsPerMeasure=function(){var u=this.getBeatLength(),a=this.getBarLength();return a/u},this.getMeter=function(){for(var u=0;u<this.lines.length;u++){var a=this.lines[u];if(a.staff)for(var c=0;c<a.staff.length;c++){var l=a.staff[c].meter;if(l)return l}}return{type:"common_time"}},this.getMeterFraction=function(){var u=this.getMeter(),a=4,c=4;return u&&(u.type==="specified"?(a=parseInt(u.value[0].num,10),c=parseInt(u.value[0].den,10)):u.type==="cut_time"?(a=2,c=2):u.type==="common_time"&&(a=4,c=4)),this.meter={num:a,den:c},this.meter},this.getKeySignature=function(){for(var u=0;u<this.lines.length;u++){var a=this.lines[u];if(a.staff){for(var c=0;c<a.staff.length;c++)if(a.staff[c].key)return a.staff[c].key}}return{}},this.getElementFromChar=function(u){for(var a=0;a<this.lines.length;a++){var c=this.lines[a];if(c.staff)for(var l=0;l<c.staff.length;l++)for(var d=c.staff[l],n=0;n<d.voices.length;n++)for(var s=d.voices[n],f=0;f<s.length;f++){var p=s[f];if(p.startChar&&p.endChar&&p.startChar<=u&&p.endChar>u)return p}}return null};function r(u){for(var a,c,l,d,n=u.length-1;n>=0;n--){var s=u[n];s.type==="bar"?(s.top=l,s.nextTop=a,a=l,s.bottom=d,s.nextBottom=c,c=d):s.type==="event"&&(l=s.top,d=s.top+s.height)}}function i(u){var a=[];for(var c in u)u.hasOwnProperty(c)&&a.push(u[c]);return a=a.sort(function(l,d){var n=l.milliseconds-d.milliseconds;return n!==0?n:l.type==="bar"?-1:1}),a}this.addElementToEvents=function(u,a,c,l,d,n,s,f,p,m){if(a.hint)return{isTiedState:void 0,duration:0};var g=a.durationClass?a.durationClass:a.duration;if(a.abcelem.rest&&a.abcelem.rest.type==="spacer"&&(g=0),g>0){for(var b=[],N=0;N<a.elemset.length;N++)a.elemset[N]!==null&&b.push(a.elemset[N]);var B=a.startTie;if(p!==void 0)u["event"+p].elements.push(b),m&&(u["event"+c]||(u["event"+c]={type:"event",milliseconds:c,line:n,measureNumber:s,top:l,height:d,left:null,width:0,elements:[],startChar:null,endChar:null,startCharArray:[],endCharArray:[]}),u["event"+c].measureStart=!0,m=!1),B||(p=void 0);else{if(!u["event"+c])u["event"+c]={type:"event",milliseconds:c,line:n,measureNumber:s,top:l,height:d,left:a.x,width:a.w,elements:[b],startChar:a.abcelem.startChar,endChar:a.abcelem.endChar,startCharArray:[a.abcelem.startChar],endCharArray:[a.abcelem.endChar],midiPitches:a.abcelem.midiPitches?G.cloneArray(a.abcelem.midiPitches):[]},a.abcelem.midiGraceNotePitches&&(u["event"+c].midiGraceNotePitches=G.cloneArray(a.abcelem.midiGraceNotePitches));else{if(u["event"+c].left?u["event"+c].left=Math.min(u["event"+c].left,a.x):u["event"+c].left=a.x,u["event"+c].elements.push(b),u["event"+c].startCharArray.push(a.abcelem.startChar),u["event"+c].endCharArray.push(a.abcelem.endChar),u["event"+c].startChar===null&&(u["event"+c].startChar=a.abcelem.startChar),u["event"+c].endChar===null&&(u["event"+c].endChar=a.abcelem.endChar),a.abcelem.midiPitches&&a.abcelem.midiPitches.length){u["event"+c].midiPitches||(u["event"+c].midiPitches=[]);for(var N=0;N<a.abcelem.midiPitches.length;N++)u["event"+c].midiPitches.push(a.abcelem.midiPitches[N])}if(a.abcelem.midiGraceNotePitches&&a.abcelem.midiGraceNotePitches.length){u["event"+c].midiGraceNotePitches||(u["event"+c].midiGraceNotePitches=[]);for(var y=0;y<a.abcelem.midiGraceNotePitches.length;y++)u["event"+c].midiGraceNotePitches.push(a.abcelem.midiGraceNotePitches[y])}}m&&(u["event"+c].measureStart=!0,m=!1),B&&(p=c)}}return{isTiedState:p,duration:g/f,nextIsBar:m||a.type==="bar"}},this.makeVoicesArray=function(){for(var u=[],a=[],c={},l=0;l<this.engraver.staffgroups.length;l++){var d=this.engraver.staffgroups[l];if(d&&d.staffs&&d.staffs.length>0){var n=d.staffs[0],s=n.absoluteY,f=s-n.top*An.STEP,p=d.staffs[d.staffs.length-1];s=p.absoluteY;for(var m=s-p.bottom*An.STEP,g=m-f,b=d.voices,N=0;N<b.length;N++)if(!(b[N].staff&&b[N].staff.isTabStaff)){var B=!1;u[N]||(u[N]=[]),a[N]===void 0&&(a[N]=0);for(var y=b[N].children,v=0;v<y.length;v++)y[v].type==="tempo"&&(c[a[N]]=this.getBpm(y[v].abcelem)),u[N].push({top:f,height:g,line:d.line,measureNumber:a[N],elem:y[v]}),y[v].type==="bar"&&B&&a[N]++,(y[v].type==="note"||y[v].type==="rest")&&(B=!0)}}}return this.tempoLocations=c,u},this.setupEvents=function(u,a,c,l){l||(l=1);for(var d=[],n={},s=u,f,p=!0,m=this.makeVoicesArray(),g=0,b=0;b<m.length;b++){var N=s,B=Math.round(N*1e3),y=0,v=-1,k=m[b],L=c;a=this.getBeatLength()*L/60;for(var D=-1,A=0;A<k.length;A++){var M=k[A].measureNumber;D!==M&&this.tempoLocations[M]&&(L=this.tempoLocations[M],a=l*this.getBeatLength()*L/60,D=M);var F=k[A].elem,S=this.addElementToEvents(n,F,B,k[A].top,k[A].height,k[A].line,k[A].measureNumber,a,f,p);f=S.isTiedState,p=S.nextIsBar,N+=S.duration;var O;if(F.duration>0&&n["event"+B]&&(O="event"+B),B=Math.round(N*1e3),F.type==="bar"){var R=F.abcelem.type,I=R==="bar_right_repeat"||R==="bar_dbl_repeat",w=F.abcelem.startEnding==="1",x=R==="bar_left_repeat"||R==="bar_dbl_repeat"||R==="bar_right_repeat";if(I){A>0&&(n[O].endX=F.x),v===-1&&(v=A);var T=0;D=-1;for(var C=y;C<v;C++){M=k[C].measureNumber,D!==M&&this.tempoLocations[M]&&(L=this.tempoLocations[M],a=l*this.getBeatLength()*L/60,D=M);var P=k[C].elem;S=this.addElementToEvents(n,P,B,k[C].top,k[C].height,k[C].line,k[C].measureNumber,a,f,p),f=S.isTiedState,p=S.nextIsBar,N+=S.duration,T=B,B=Math.round(N*1e3)}n["event"+T]&&(n["event"+T].endX=k[v].elem.x),p=!0,v=-1}w&&(v=A),x&&(y=A)}}g=Math.max(g,B)}return d=i(n),r(d),h(this.lines,d),d.push({type:"end",milliseconds:g}),this.addUsefulCallbackInfo(d,L*l),d},this.addUsefulCallbackInfo=function(u,a){for(var c=this.millisecondsPerMeasure(a),l=0;l<u.length;l++){var d=u[l];d.millisecondsPerMeasure=c}};function o(u,a){for(;a<u.length&&u[a].left===null;)a++;return u[a]}function h(u,a){if(!(a.length<1)){for(var c=0;c<a.length-1;c++){var l=a[c],d=o(a,c+1);if(l.left!==null){var n=d&&l.top===d.top?d.left:u[l.line].staffGroup.w;l.endX!==void 0?n>l.left&&(l.endX=Math.min(l.endX,n)):l.endX=n}}var s=a[a.length-1];s.endX=u[s.line].staffGroup.w}}this.getBpm=function(u){var a;if(u){a=u.bpm;var c=this.getBeatLength(),l=u.duration&&u.duration.length>0?u.duration[0]:c;a=a*l/c}if(!a){a=180;var d=this.getMeterFraction();d&&d.num!==3&&d.num%3===0&&(a=120)}return a},this.setTiming=function(u,a){if(a=a||0,!this.engraver||!this.engraver.staffgroups)return console.log("setTiming cannot be called before the tune is drawn."),this.noteTimings=[],this.noteTimings;var c=this.metaText?this.metaText.tempo:null,l=this.getBpm(c),d=1;u?c&&(d=u/l):u=l;var n=this.getBeatLength(),s=u/60,f=this.getBarLength(),p=f/n*a/s;p&&(p-=this.getPickupLength()/n/s);var m=n*s;return this.noteTimings=this.setupEvents(p,m,u,d),this.noteTimings.length>0?(this.totalTime=this.noteTimings[this.noteTimings.length-1].milliseconds/1e3,this.totalBeats=this.totalTime*s):(this.totalTime=void 0,this.totalBeats=void 0),this.noteTimings},this.setUpAudio=function(u){console.log("NEUTERED")},this.deline=function(u){return Fn(this.lines,u)}}var Ws=function(e){var t=this;this.setVisualTranspose=function(o){o&&(e.visualTranspose=o)},this.resolveOverlays=function(){for(var o=!1,h=[],u=0;u<e.lines.length;u++){var a=e.lines[u];if(a.staff)for(var c=0;c<a.staff.length;c++){for(var l=a.staff[c],d=[],n=0;n<l.voices.length;n++){var s=l.voices[n];d.push({hasOverlay:!1,voice:[],snip:[]}),h[u]=0;for(var f=0,p=!1,m=0,g=-1,b=0;b<s.length;b++){var N=s[b];if(N.el_type==="overlay"&&!p){o=!0,p=!0,g=b,d[n].hasOverlay=!0,m===0&&(m=h[u]);for(var B=0;B<u;B++)h[B]&&e.lines[B].staff&&l.voices.length>=e.lines[B].staff[0].voices.length&&e.lines[B].staff[0].voices.push([{el_type:"note",duration:h[B],rest:{type:"invisible"},startChar:N.startChar,endChar:N.endChar}])}else N.el_type==="bar"?(p?(p=!1,d[n].snip.push({start:g,len:b-g}),d[n].voice.push(N)):(f>0&&d[n].voice.push({el_type:"note",duration:f,rest:{type:"invisible"},startChar:N.startChar,endChar:N.endChar}),d[n].voice.push(N)),f=0):N.el_type==="note"?p?d[n].voice.push(N):(f+=N.duration,h[u]+=N.duration):(N.el_type==="scale"||N.el_type==="stem"||N.el_type==="overlay"||N.el_type==="style"||N.el_type==="transpose"||N.el_type==="color")&&d[n].voice.push(N)}d[n].hasOverlay&&d[n].snip.length===0&&d[n].snip.push({start:g,len:s.length-g})}for(n=0;n<d.length;n++){var y=d[n];if(y.hasOverlay){y.voice.splice(0,0,{el_type:"stem",direction:"down"}),l.voices.push(y.voice);for(var v=y.snip.length-1;v>=0;v--){var k=y.snip[v];l.voices[n].splice(k.start,k.len),l.voices[n].splice(k.start+1,0,{el_type:"stem",direction:"auto"});var L=r(l.voices[n],k.start);l.voices[n].splice(L,0,{el_type:"stem",direction:"up"})}for(v=0;v<l.voices[l.voices.length-1].length;v++){l.voices[l.voices.length-1][v]=G.clone(l.voices[l.voices.length-1][v]);var D=l.voices[l.voices.length-1][v];D.el_type==="bar"&&D.startEnding&&delete D.startEnding,D.el_type==="bar"&&D.endEnding&&delete D.endEnding}}}}}return o};function r(o,h){for(var u=h-1;u>0&&o[u].el_type!=="bar";u--);return u}function i(o){for(var h=!0,u=0;u<o.length;u++){var a=o[u];if(a.staff){for(var c=0;c<a.staff.length;c++){var l=a.staff[c];if(l.title){for(var d=!1,n=0;n<l.title.length;n++)l.title[n]?(l.title[n]=h?l.title[n].name:l.title[n].subname,l.title[n]?d=!0:l.title[n]=""):l.title[n]="";d||delete l.title}}h=!1}}}this.cleanUp=function(o,h,u){this.closeLine(),delete e.runningFonts,Ks(e),e.metaText.tempo&&e.metaText.tempo.bpm&&!e.metaText.tempo.duration&&(e.metaText.tempo.duration=[e.getBeatLength()]);var a=!1,c,l,d;for(c=0;c<e.lines.length;c++)if(e.lines[c].staff!==void 0){var n=!1;for(l=0;l<e.lines[c].staff.length;l++)if(e.lines[c].staff[l]===void 0)a=!0,e.lines[c].staff[l]=null;else for(d=0;d<e.lines[c].staff[l].voices.length;d++)e.lines[c].staff[l].voices[d]===void 0?e.lines[c].staff[l].voices[d]=[]:this.containsNotes(e.lines[c].staff[l].voices[d])&&(n=!0);n||(e.lines[c]=null,a=!0)}if(a&&(e.lines=e.lines.filter(function(v){return!!v}),e.lines.forEach(function(v){v.staff&&(v.staff=v.staff.filter(function(k){return!!k}))})),o)for(;m(e.lines,o););if(h){for(a=!1,c=0;c<e.lines.length;c++)if(e.lines[c].staff!==void 0)for(l=0;l<e.lines[c].staff.length;l++){var s=!1;for(d=0;d<e.lines[c].staff[l].voices.length;d++)this.containsNotesStrict(e.lines[c].staff[l].voices[d])&&(s=!0);s||(a=!0,e.lines[c].staff[l]=null)}a&&e.lines.forEach(function(v){v.staff&&(v.staff=v.staff.filter(function(k){return!!k}))})}for(i(e.lines),c=0;c<e.lines.length;c++)if(e.lines[c].staff)for(l=0;l<e.lines[c].staff.length;l++)delete e.lines[c].staff[l].workingClef;for(;this.resolveOverlays(););function f(v,k,L){u[k]||(u[k]=[]),u[k][L]||(u[k][L]=[]);for(var D,A=function(q,H,$){if(u[k][L][$]===void 0){for(D=0;D<u[k][L].length;D++)if(u[k][L][D]!==void 0){$=D;break}if(u[k][L][$]===void 0){var he=$*100+1;q.endSlur.forEach(function(K){he===K&&--he}),u[k][L][$]=[he]}}for(var Z,me=0;me<H;me++)Z=u[k][L][$].pop(),q.endSlur.push(Z);return u[k][L][$].length===0&&delete u[k][L][$],Z},M=function(q,H,$,he){q.startSlur=[],u[k][L][$]===void 0&&(u[k][L][$]=[]);for(var Z=$*100+1,me=0;me<H;me++)he&&(he.forEach(function(K){Z===K&&++Z}),he.forEach(function(K){Z===K&&++Z}),he.forEach(function(K){Z===K&&++Z})),u[k][L][$].forEach(function(K){Z===K&&++Z}),u[k][L][$].forEach(function(K){Z===K&&++Z}),u[k][L][$].push(Z),q.startSlur.push({label:Z}),q.dottedSlur&&(q.startSlur[q.startSlur.length-1].style="dotted",delete q.dottedSlur),Z++},F=0;F<v.length;F++){var S=v[F];if(S.el_type==="note"){if(S.gracenotes)for(var O=0;O<S.gracenotes.length;O++){if(S.gracenotes[O].endSlur){var R=S.gracenotes[O].endSlur;S.gracenotes[O].endSlur=[];for(var I=0;I<R;I++)A(S.gracenotes[O],1,20)}S.gracenotes[O].startSlur&&(D=S.gracenotes[O].startSlur,M(S.gracenotes[O],D,20))}if(S.endSlur&&(D=S.endSlur,S.endSlur=[],A(S,D,0)),S.startSlur&&(D=S.startSlur,M(S,D,0)),S.pitches){for(var w=[],x=0;x<S.pitches.length;x++)if(S.pitches[x].endSlur){var T=S.pitches[x].endSlur;S.pitches[x].endSlur=[];for(var C=0;C<T;C++){var P=A(S.pitches[x],1,x+1);w.push(P)}}for(x=0;x<S.pitches.length;x++)S.pitches[x].startSlur&&(D=S.pitches[x].startSlur,M(S.pitches[x],D,x+1,w));S.gracenotes&&S.pitches[0].endSlur&&S.pitches[0].endSlur[0]===100&&S.pitches[0].startSlur&&(S.gracenotes[0].endSlur?S.gracenotes[0].endSlur.push(S.pitches[0].startSlur[0].label):S.gracenotes[0].endSlur=[S.pitches[0].startSlur[0].label],S.pitches[0].endSlur.length===1?delete S.pitches[0].endSlur:S.pitches[0].endSlur[0]===100?S.pitches[0].endSlur.shift():S.pitches[0].endSlur[S.pitches[0].endSlur.length-1]===100&&S.pitches[0].endSlur.pop(),u[k][L][1].length===1?delete u[k][L][1]:u[k][L][1].pop())}}}}function p(v){se.fixClef(v)}function m(v,k){for(c=0;c<v.length;c++)if(v[c].staff!==void 0)for(l=0;l<v[c].staff.length;l++){var L=[];for(d=0;d<v[c].staff[l].voices.length;d++)for(var D=v[c].staff[l].voices[d],A=0,M=0;M<D.length;M++)if(D[M].el_type==="bar"){if(A++,A>=k&&M<D.length-1){var F=g(v,c);if(!F){var S=JSON.parse(JSON.stringify(v[c]));v.push(G.clone(S)),F=v[v.length-1];for(var O=0;O<F.staff.length;O++)for(var R=0;R<F.staff[O].voices.length;R++)F.staff[O].voices[R]=[]}var I=M+1,w=v[c].staff[l].voices[d].slice(I);return v[c].staff[l].voices[d]=v[c].staff[l].voices[d].slice(0,I),F.staff[l].voices[d]=L.concat(w.concat(F.staff[l].voices[d])),!0}}else D[M].duration||L.push(D[M])}return!1}function g(v,k){for(k++;v.length>k;){if(v[k].staff)return v[k];k++}return null}for(e.lineNum=0;e.lineNum<e.lines.length;e.lineNum++){var b=e.lines[e.lineNum].staff;if(b)for(e.staffNum=0;e.staffNum<b.length;e.staffNum++)for(b[e.staffNum].clef&&p(b[e.staffNum].clef),e.voiceNum=0;e.voiceNum<b[e.staffNum].voices.length;e.voiceNum++){var N=b[e.staffNum].voices[e.voiceNum];f(N,e.staffNum,e.voiceNum);for(var B=0;B<N.length;B++)N[B].el_type==="clef"&&p(N[B]);if(N.length>0&&N[N.length-1].barNumber){var y=g(e.lines,e.lineNum);y&&(y.staff[0].barNumber=N[N.length-1].barNumber),delete N[N.length-1].barNumber}}}return delete e.staffNum,delete e.voiceNum,delete e.lineNum,delete e.potentialStartBeam,delete e.potentialEndBeam,delete e.vskipPending,u},e.reset(),this.getLastNote=function(){if(e.lines[e.lineNum]&&e.lines[e.lineNum].staff&&e.lines[e.lineNum].staff[e.staffNum]&&e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum])for(var o=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum].length-1;o>=0;o--){var h=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum][o];if(h.el_type==="note")return h}return null},this.addTieToLastNote=function(o){var h=this.getLastNote();return h&&h.pitches&&h.pitches.length>0?(h.pitches[0].startTie={},o&&(h.pitches[0].startTie.style="dotted"),!0):!1},this.getDuration=function(o){return o.duration?o.duration:0},this.closeLine=function(){e.potentialStartBeam&&e.potentialEndBeam&&(e.potentialStartBeam.startBeam=!0,e.potentialEndBeam.endBeam=!0),delete e.potentialStartBeam,delete e.potentialEndBeam},this.appendElement=function(o,h,u,a){var c=e,l=function(f){var p=c.lines[c.lineNum].staff[c.staffNum];if(p){if(f.pitches!==void 0){var m=p.workingClef.verticalPos;f.pitches.forEach(function(b){b.verticalPos=b.pitch-m})}if(f.gracenotes!==void 0){var g=p.workingClef.verticalPos;f.gracenotes.forEach(function(b){b.verticalPos=b.pitch-g})}p.voices[c.voiceNum].push(f)}};a.el_type=o,h!==null&&(a.startChar=h),u!==null&&(a.endChar=u);var d=function(){c.potentialStartBeam.startBeam=!0,a.endBeam=!0,delete c.potentialStartBeam,delete c.potentialEndBeam},n=function(){c.potentialStartBeam!==void 0&&c.potentialEndBeam!==void 0&&(c.potentialStartBeam.startBeam=!0,c.potentialEndBeam.endBeam=!0),delete c.potentialStartBeam,delete c.potentialEndBeam};if(o==="note"){var s=t.getDuration(a);s>=.25||a.force_end_beam_last&&c.potentialStartBeam!==void 0?n():a.end_beam&&c.potentialStartBeam!==void 0?a.rest===void 0?d():n():a.rest===void 0&&(c.potentialStartBeam===void 0?a.end_beam||(c.potentialStartBeam=a,delete c.potentialEndBeam):c.potentialEndBeam=a)}else n();delete a.end_beam,delete a.force_end_beam_last,l(a)},this.appendStartingElement=function(o,h,u,a){this.closeLine();var c;o==="key"&&(c=a.impliedNaturals,delete a.impliedNaturals,delete a.explicitAccidentals);var l=G.clone(a);if(e.lines[e.lineNum]&&e.lines[e.lineNum].staff){e.lines[e.lineNum].staff.length<=e.staffNum&&(e.lines[e.lineNum].staff[e.staffNum]={},e.lines[e.lineNum].staff[e.staffNum].clef=G.clone(e.lines[e.lineNum].staff[0].clef),e.lines[e.lineNum].staff[e.staffNum].key=G.clone(e.lines[e.lineNum].staff[0].key),e.lines[e.lineNum].staff[0].meter&&(e.lines[e.lineNum].staff[e.staffNum].meter=G.clone(e.lines[e.lineNum].staff[0].meter)),e.lines[e.lineNum].staff[e.staffNum].workingClef=G.clone(e.lines[e.lineNum].staff[0].workingClef),e.lines[e.lineNum].staff[e.staffNum].voices=[[]]),o==="clef"&&(e.lines[e.lineNum].staff[e.staffNum].workingClef=l);for(var d=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum],n=0;n<d.length;n++){if(d[n].el_type==="note"||d[n].el_type==="bar"){l.el_type=o,l.startChar=h,l.endChar=u,c&&(l.accidentals=c.concat(l.accidentals)),d.push(l);return}if(d[n].el_type===o){l.el_type=o,l.startChar=h,l.endChar=u,c&&(l.accidentals=c.concat(l.accidentals)),d[n]=l;return}}e.lines[e.lineNum].staff[e.staffNum][o]=a}},this.pushLine=function(o){e.vskipPending&&(o.vskip=e.vskipPending,delete e.vskipPending),e.lines.push(o)},this.addSubtitle=function(o,h){this.pushLine({subtitle:{text:o,startChar:h.startChar,endChar:h.endChar}})},this.addSpacing=function(o){e.vskipPending=o},this.addNewPage=function(o){this.pushLine({newpage:o})},this.addSeparator=function(o,h,u,a){this.pushLine({separator:{spaceAbove:Math.round(o),spaceBelow:Math.round(h),lineLength:Math.round(u),startChar:a.startChar,endChar:a.endChar}})},this.addText=function(o,h){this.pushLine({text:{text:o,startChar:h.startChar,endChar:h.endChar}})},this.addCentered=function(o){this.pushLine({text:[{text:o,center:!0}]})},this.containsNotes=function(o){for(var h=0;h<o.length;h++)if(o[h].el_type==="note"||o[h].el_type==="bar")return!0;return!1},this.containsNotesStrict=function(o){for(var h=0;h<o.length;h++)if(o[h].el_type==="note"&&(o[h].rest===void 0||o[h].chord!==void 0))return!0;return!1},this.changeVoiceScale=function(o){t.appendElement("scale",null,null,{size:o})},this.changeVoiceColor=function(o){t.appendElement("color",null,null,{color:o})},this.startNewLine=function(o){var h=e;this.closeLine();var u=function(l){var d=h.lines[h.lineNum].staff[h.staffNum];if(d.voices[h.voiceNum]=[],d.title||(d.title=[]),d.title[h.voiceNum]={name:l.name,subname:l.subname},l.style&&t.appendElement("style",null,null,{head:l.style}),l.stem)t.appendElement("stem",null,null,{direction:l.stem});else if(h.voiceNum>0){if(d.voices[0]!==void 0){for(var n=!1,s=0;s<d.voices[0].length;s++)d.voices[0].el_type==="stem"&&(n=!0);if(!n){var f={el_type:"stem",direction:"up"};d.voices[0].splice(0,0,f)}}t.appendElement("stem",null,null,{direction:"down"})}l.scale&&t.appendElement("scale",null,null,{size:l.scale}),l.color&&t.appendElement("color",null,null,{color:l.color})},a=function(l){l.key&&l.key.impliedNaturals&&(l.key.accidentals=l.key.accidentals.concat(l.key.impliedNaturals),delete l.key.impliedNaturals),h.lines[h.lineNum].staff[h.staffNum]={voices:[],clef:l.clef,key:l.key,workingClef:l.clef},l.stafflines!==void 0&&(h.lines[h.lineNum].staff[h.staffNum].clef.stafflines=l.stafflines,h.lines[h.lineNum].staff[h.staffNum].workingClef.stafflines=l.stafflines),l.staffscale&&(h.lines[h.lineNum].staff[h.staffNum].staffscale=l.staffscale),l.annotationfont&&t.setLineFont("annotationfont",l.annotationfont),l.gchordfont&&t.setLineFont("gchordfont",l.gchordfont),l.tripletfont&&t.setLineFont("tripletfont",l.tripletfont),l.vocalfont&&t.setLineFont("vocalfont",l.vocalfont),l.bracket&&(h.lines[h.lineNum].staff[h.staffNum].bracket=l.bracket),l.brace&&(h.lines[h.lineNum].staff[h.staffNum].brace=l.brace),l.connectBarLines&&(h.lines[h.lineNum].staff[h.staffNum].connectBarLines=l.connectBarLines),l.barNumber&&(h.lines[h.lineNum].staff[h.staffNum].barNumber=l.barNumber),u(l),l.part&&t.appendElement("part",l.part.startChar,l.part.endChar,{title:l.part.title}),l.meter!==void 0&&(h.lines[h.lineNum].staff[h.staffNum].meter=l.meter),h.vskipPending&&(h.lines[h.lineNum].vskip=h.vskipPending,delete h.vskipPending)},c=function(l){h.lines[h.lineNum]={staff:[]},a(l)};e.lines[e.lineNum]===void 0?c(o):e.lines[e.lineNum].staff===void 0?(e.lineNum++,this.startNewLine(o)):e.lines[e.lineNum].staff[e.staffNum]===void 0?a(o):e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum]===void 0?u(o):this.containsNotes(e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum])?(e.lineNum++,this.startNewLine(o)):o.part&&t.appendElement("part",o.part.startChar,o.part.endChar,{title:o.part.title})},this.setRunningFont=function(o,h){e.runningFonts[o]=h},this.setLineFont=function(o,h){if(e.runningFonts[o]){for(var u=!1,a=Object.keys(h),c=0;c<a.length;c++)e.runningFonts[o][a[c]]!==h[a[c]]&&(u=!0);u&&(e.lines[e.lineNum].staff[e.staffNum][o]=h)}e.runningFonts[o]=h},this.setBarNumberImmediate=function(o){var h=this.getCurrentVoice();if(h&&h.length>0){var u=h[h.length-1];if(u.el_type==="bar")u.barNumber!==void 0&&(u.barNumber=o);else return o-1}return o},this.hasBeginMusic=function(){for(var o=0;o<e.lines.length;o++)if(e.lines[o].staff)return!0;return!1},this.isFirstLine=function(o){for(var h=o-1;h>=0;h--)if(e.lines[h].staff!==void 0)return!1;return!0},this.getCurrentVoice=function(){var o=e.lines[e.lineNum];if(!o)return null;var h=o.staff[e.staffNum];return h&&h.voices[e.voiceNum]!==void 0?h.voices[e.voiceNum]:null},this.setCurrentVoice=function(o,h){e.staffNum=o,e.voiceNum=h;for(var u=0;u<e.lines.length;u++)if(e.lines[u].staff&&(e.lines[u].staff[o]===void 0||e.lines[u].staff[o].voices[h]===void 0||!this.containsNotes(e.lines[u].staff[o].voices[h]))){e.lineNum=u;return}e.lineNum=u},this.addMetaText=function(o,h,u){e.metaText[o]===void 0?(e.metaText[o]=h,e.metaTextInfo[o]=u):(typeof e.metaText[o]=="string"&&typeof h=="string"?e.metaText[o]+=`
`+h:(e.metaText[o]==="string"&&(e.metaText[o]=[{text:e.metaText[o]}]),typeof h=="string"&&(h=[{text:h}]),e.metaText[o]=e.metaText[o].concat(h)),e.metaTextInfo[o].endChar=u.endChar)},this.addMetaTextArray=function(o,h,u){e.metaText[o]===void 0?(e.metaText[o]=[h],e.metaTextInfo[o]=u):(e.metaText[o].push(h),e.metaTextInfo[o].endChar=u.endChar)},this.addMetaTextObj=function(o,h,u){e.metaText[o]=h,e.metaTextInfo[o]=u}};function Fi(e){if(!e||typeof e=="string")return!1;for(var t="",r=0;r<e.length;r++)if(typeof e[r]!="string")return!1;return!0}function Ks(e){Fi(e.metaText.notes)&&(e.metaText.notes=e.metaText.notes.join(`
`)),Fi(e.metaText.history)&&(e.metaText.history=e.metaText.history.join(`
`))}var Si=Ws;function Li(){"use strict";var e=new Sn,t=new Si(e),r,i="",o="";this.getTune=function(){var y={formatting:e.formatting,lines:e.lines,media:e.media,metaText:e.metaText,metaTextInfo:e.metaTextInfo,version:e.version,addElementToEvents:e.addElementToEvents,addUsefulCallbackInfo:e.addUsefulCallbackInfo,getTotalTime:e.getTotalTime,getTotalBeats:e.getTotalBeats,getBarLength:e.getBarLength,getBeatLength:e.getBeatLength,getBeatsPerMeasure:e.getBeatsPerMeasure,getBpm:e.getBpm,getMeter:e.getMeter,getMeterFraction:e.getMeterFraction,getPickupLength:e.getPickupLength,getKeySignature:e.getKeySignature,getElementFromChar:e.getElementFromChar,makeVoicesArray:e.makeVoicesArray,millisecondsPerMeasure:e.millisecondsPerMeasure,setupEvents:e.setupEvents,setTiming:e.setTiming,setUpAudio:e.setUpAudio,deline:e.deline};return e.lineBreaks&&(y.lineBreaks=e.lineBreaks),e.visualTranspose&&(y.visualTranspose=e.visualTranspose),y};function h(y,v,k){y.positioning||(y.positioning={}),y.positioning[v]=k}function u(y,v,k){y.fonts||(y.fonts={}),y.fonts[v]=k}var a={reset:function(){for(var y in this)this.hasOwnProperty(y)&&typeof this[y]!="function"&&delete this[y];this.iChar=0,this.key={accidentals:[],root:"none",acc:"",mode:""},this.meter=null,this.origMeter=null,this.hasMainTitle=!1,this.default_length=.125,this.clef={type:"treble",verticalPos:0},this.octave=0,this.next_note_duration=0,this.start_new_line=!0,this.is_in_header=!0,this.partForNextLine={},this.tempoForNextLine=[],this.havent_set_length=!0,this.voices={},this.staves=[],this.macros={},this.currBarNumber=1,this.barCounter={},this.ignoredDecorations=[],this.score_is_present=!1,this.inEnding=!1,this.inTie=[],this.inTieChord={},this.vocalPosition="auto",this.dynamicPosition="auto",this.chordPosition="auto",this.ornamentPosition="auto",this.volumePosition="auto",this.openSlurs=[],this.freegchord=!1,this.endingHoldOver={}},differentFont:function(y,v){return this[y].decoration!==v[y].decoration||this[y].face!==v[y].face||this[y].size!==v[y].size||this[y].style!==v[y].style||this[y].weight!==v[y].weight},addFormattingOptions:function(y,v,k){k==="note"?(this.vocalPosition!=="auto"&&h(y,"vocalPosition",this.vocalPosition),this.dynamicPosition!=="auto"&&h(y,"dynamicPosition",this.dynamicPosition),this.chordPosition!=="auto"&&h(y,"chordPosition",this.chordPosition),this.ornamentPosition!=="auto"&&h(y,"ornamentPosition",this.ornamentPosition),this.volumePosition!=="auto"&&h(y,"volumePosition",this.volumePosition),this.differentFont("annotationfont",v)&&u(y,"annotationfont",this.annotationfont),this.differentFont("gchordfont",v)&&u(y,"gchordfont",this.gchordfont),this.differentFont("vocalfont",v)&&u(y,"vocalfont",this.vocalfont),this.differentFont("tripletfont",v)&&u(y,"tripletfont",this.tripletfont)):k==="bar"&&(this.dynamicPosition!=="auto"&&h(y,"dynamicPosition",this.dynamicPosition),this.chordPosition!=="auto"&&h(y,"chordPosition",this.chordPosition),this.ornamentPosition!=="auto"&&h(y,"ornamentPosition",this.ornamentPosition),this.volumePosition!=="auto"&&h(y,"volumePosition",this.volumePosition),this.differentFont("measurefont",v)&&u(y,"measurefont",this.measurefont),this.differentFont("repeatfont",v)&&u(y,"repeatfont",this.repeatfont))},duplicateStartEndingHoldOvers:function(){this.endingHoldOver={inTie:[],inTieChord:{}};for(var y=0;y<this.inTie.length;y++)if(this.endingHoldOver.inTie.push([]),this.inTie[y])for(var v=0;v<this.inTie[y].length;v++)this.endingHoldOver.inTie[y].push(this.inTie[y][v]);for(var k in this.inTieChord)this.inTieChord.hasOwnProperty(k)&&(this.endingHoldOver.inTieChord[k]=this.inTieChord[k])},restoreStartEndingHoldOvers:function(){if(this.endingHoldOver.inTie){this.inTie=[],this.inTieChord={};for(var y=0;y<this.endingHoldOver.inTie.length;y++){this.inTie.push([]);for(var v=0;v<this.endingHoldOver.inTie[y].length;v++)this.inTie[y].push(this.endingHoldOver.inTie[y][v])}for(var k in this.endingHoldOver.inTieChord)this.endingHoldOver.inTieChord.hasOwnProperty(k)&&(this.inTieChord[k]=this.endingHoldOver.inTieChord[k])}}},c=function(y){a.warnings||(a.warnings=[]),a.warnings.push(y)},l=function(y){a.warningObjects||(a.warningObjects=[]),a.warningObjects.push(y)},d=function(y){var v=y.replace(/\x12/g," ");return v=v.replace(/&/g,"&amp;"),v=v.replace(/</g,"&lt;"),v.replace(/>/g,"&gt;")},n=function(y,v,k){v||(v=" ");var L=v[k];(L===" "||!L)&&(L="SPACE");var D=d(v.substring(k-64,k))+'<span style="text-decoration:underline;font-size:1.3em;font-weight:bold;">'+L+"</span>"+d(v.substring(k+1).substring(0,64));c("Music Line:"+r.lineIndex+":"+(k+1)+": "+y+":  "+D),l({message:y,line:v,startChar:a.iChar+k,column:k})},s,f;this.getWarnings=function(){return a.warnings},this.getWarningObjects=function(){return a.warningObjects};var p=function(y,v){if(v.indexOf("")>=0){i+=v;return}if(v=i+v,i="",!y){n("Can't add words before the first line of music",y,0);return}v=G.strip(v),v[v.length-1]!=="-"&&(v=v+" ");for(var k=[],L=0,D=!1,A=function(O){var R=G.strip(v.substring(L,O));if(R=R.replace(/\\([-_*|~])/g,"$1"),L=O+1,R.length>0){D&&(R=R.replace(/~/g," "));var I=v[O];return I!=="_"&&I!=="-"&&(I=" "),k.push({syllable:r.translateString(R),divider:I}),D=!1,!0}return!1},M=!1,F=0;F<v.length;F++){switch(v[F]){case" ":case"":A(F);break;case"-":!M&&!A(F)&&k.length>0&&(G.last(k).divider="-",k.push({skip:!0,to:"next"}));break;case"_":M||(A(F),k.push({skip:!0,to:"slur"}));break;case"*":M||(A(F),k.push({skip:!0,to:"next"}));break;case"|":M||(A(F),k.push({skip:!0,to:"bar"}));break;case"~":M||(D=!0);break}M=v[F]==="\\"}var S=!1;y.forEach(function(O){if(k.length!==0){if(k[0].skip){switch(k[0].to){case"next":O.el_type==="note"&&O.pitches!==null&&!S&&k.shift();break;case"slur":O.el_type==="note"&&O.pitches!==null&&k.shift();break;case"bar":O.el_type==="bar"&&k.shift();break}O.el_type!=="bar"&&(O.lyric===void 0?O.lyric=[{syllable:"",divider:" "}]:O.lyric.push({syllable:"",divider:" "}))}else if(O.el_type==="note"&&O.rest===void 0&&!S){var R=k.shift();R.syllable&&(R.syllable=R.syllable.replace(/ +/g," ")),O.lyric===void 0?O.lyric=[R]:O.lyric.push(R)}}})},m=function(y,v){if(v.indexOf("")>=0){o+=v;return}if(v=o+v,o="",!y){n("Can't add symbols before the first line of music",y,0);return}v=G.strip(v),v[v.length-1]!=="-"&&(v=v+" ");for(var k=[],L=0,D=!1,A=function(S){var O=G.strip(v.substring(L,S));if(L=S+1,O.length>0){D&&(O=O.replace(/~/g," "));var R=v[S];return R!=="_"&&R!=="-"&&(R=" "),k.push({syllable:r.translateString(O),divider:R}),D=!1,!0}return!1},M=0;M<v.length;M++)switch(v[M]){case" ":case"":A(M);break;case"-":!A(M)&&k.length>0&&(G.last(k).divider="-",k.push({skip:!0,to:"next"}));break;case"_":A(M),k.push({skip:!0,to:"slur"});break;case"*":A(M),k.push({skip:!0,to:"next"});break;case"|":A(M),k.push({skip:!0,to:"bar"});break;case"~":D=!0;break}var F=!1;y.forEach(function(S){if(k.length!==0){if(k[0].skip)switch(k[0].to){case"next":S.el_type==="note"&&S.pitches!==null&&!F&&k.shift();break;case"slur":S.el_type==="note"&&S.pitches!==null&&k.shift();break;case"bar":S.el_type==="bar"&&k.shift();break}else if(S.el_type==="note"&&S.rest===void 0&&!F){var O=k.shift();S.lyric===void 0?S.lyric=[O]:S.lyric.push(O)}}})},g=function(y){if(G.startsWith(y,"%%")){var v=ee.addDirective(y.substring(2));v&&n(v,y,2);return}var k=y.indexOf("%");if(k>=0&&(y=y.substring(0,k)),y=y.replace(/\s+$/,""),y.length!==0){if(i){p(t.getCurrentVoice(),y.substring(2));return}if(o){m(t.getCurrentVoice(),y.substring(2));return}if(y.length<2||y[1]!==":"||f.lineContinuation){f.parseMusic(y);return}var L=s.parseHeader(y);L.regular&&f.parseMusic(y),L.newline&&f.startNewLine(),L.words&&p(t.getCurrentVoice(),y.substring(2)),L.symbols&&m(t.getCurrentVoice(),y.substring(2))}};function b(y,v){y.push({el_type:"hint"});for(var k=0;k<v.length;k++){var L=v[k],D=G.clone(L);if(y.push(D),L.el_type==="bar")return}}function N(y,v){for(var k=0;k<y.length;k++){var L=y[k],D=v[k];if(D)for(var A=0;A<D.voices.length;A++){var M=D.voices[A],F=L.voices[A];F&&b(F,M)}}}function B(){for(var y=0;y<e.lines.length;y++){var v=e.lines[y].staff;if(v){for(var k=y+1;k<e.lines.length&&e.lines[k].staff===void 0;)k++;if(k<e.lines.length){var L=e.lines[k].staff;N(v,L)}}}}this.parse=function(y,v,k){v||(v={}),k||(k=0),e.reset(),y=y.replace(/\r\n?/g,`
`)+`
`;var L=y.split(`
\\`);if(L.length>1){for(var D=1;D<L.length;D++)for(;L[D].length>0&&L[D][0]!==`
`;)L[D]=L[D].substr(1),L[D-1]+=" ";y=L.join("  ")}y=y.replace(/\\([ \t]*)(%.*)*\n/g,function(I,w,x){var T=x?Array(x.length+1).join(" "):"";return w+""+T+`
`});var A=y.split(`
`);G.last(A).length===0&&A.pop(),r=new _i(A,a),s=new bi(r,n,a,e,t),f=new Ft(r,n,a,e,t,s),v.print&&(e.media="print"),a.reset(),a.iChar=k,v.visualTranspose?(a.globalTranspose=parseInt(v.visualTranspose),a.globalTranspose===0?a.globalTranspose=void 0:t.setVisualTranspose(v.visualTranspose)):a.globalTranspose=void 0,v.lineBreaks&&(a.lineBreaks=v.lineBreaks),s.reset(r,n,a,e);try{v.format&&ee.globalFormatting(v.format);for(var M=r.nextLine();M;){if(v.header_only&&a.is_in_header===!1||v.stop_on_warning&&a.warnings)throw"normal_abort";var F=a.is_in_header;g(M),F&&!a.is_in_header&&(t.setRunningFont("annotationfont",a.annotationfont),t.setRunningFont("gchordfont",a.gchordfont),t.setRunningFont("tripletfont",a.tripletfont),t.setRunningFont("vocalfont",a.vocalfont)),M=r.nextLine()}i&&p(t.getCurrentVoice(),""),o&&m(t.getCurrentVoice(),""),a.openSlurs=t.cleanUp(a.barsperstaff,a.staffnonote,a.openSlurs)}catch(I){if(I!=="normal_abort")throw I}var S=11*72,O=8.5*72;switch(a.papersize){case"legal":S=14*72,O=8.5*72;break;case"A4":S=11.7*72,O=8.3*72;break}if(a.landscape){var R=S;S=O,O=R}e.formatting.pagewidth||(e.formatting.pagewidth=O),e.formatting.pageheight||(e.formatting.pageheight=S),v.hint_measures&&B(),Di.wrapLines(e,a.lineBreaks,a.barNumbers)}}var Pi=new Li;function Ln(e){throw new Error("Todo: "+e)}function Xs(e,t){let r=t.sequences.find(ui({id:e}));return r||(r={id:e,events:[],cursor:0},t.sequences.push(r),t.events.push([0,"sequence",e]),r)}function St(e,t){let r=t.length;for(;r--;)if(t[r][1]===e)return t[r]}function Qs(e,t){return[0,0,2,4,5,7,9,11,12,14,16,17,19,21,23,24,26,28,29,31,33,35,36,38,40,41,43,45,47,48][t]+e+60}function Pn(e){Pi.parse(e);let t=Pi.getTune(),r=t.lines.reduce((i,o)=>(o.staff.reduce((h,u,a)=>{let c=Xs(a,i),l=c.events;if(u.clef){let n=u.clef.type,s=St("clef",l);(!s||s[2]!==n)&&l.push([0,"clef",n])}let d=St("key",l);if(u.key){let n=u.key.mode===""?u.key.root:Ln("What happens when ABC decides key.mode is not an empty string?"),s={C:0,D:2,E:4,F:5,G:7,A:9,B:11};s[n]||Ln('ABC says root is "'+n+'", we have not implemented support for that');let f=s[n];(!d||d[2]!==n)&&(d=[c.cursor,"key",f],l.push(d))}if(u.meter){let n=1/(+u.meter.value[0].den/4),s=+u.meter.value[0].num*n,f=St("meter",l);(!f||f[2]!==s||f[3]!==n)&&l.push([0,"meter",s,n])}if(u.voices){let n=St("note",l);u.voices[0].reduce((s,f)=>{if(f.el_type==="note")f.pitches.reduce((p,m)=>(p.push([c.cursor,"note",Qs(d[2],m.pitch),.25,f.duration*4]),p),s),c.cursor+=f.duration*4;else if(f.el_type==="bar"){let p=St("meter",s);if((c.cursor-p[0])%p[2]!==0){let g=(Math.floor((c.cursor-p[0])/p[2])+1)*p[2];c.cursor=g}}else console.log("ABC voice ignored:",f);return s},l),u.voices[1]&&Ln("What do we do with a second array of voices?")}return h},i.sequences),i),{name:t.metaText.title,events:[],sequences:[],meta:t.metaText});return r.sequences.forEach(i=>delete i.cursor),r}var Zs={chord:3,note:3,key:1,meter:2,rate:1,lyric:2},Js=/^[ABCDEFG][b♭#♯]{0,1}-?\d$/,Mi=/^[ABCDEFG][b♭#♯]{0,1}/;function Mn(e){let t=e.trim().split(/\s+/),r=[],i=-1;for(;t[++i]!==void 0;){let o=Number(t[i]),h=t[++i];Js.test(h)?(h="note",--i):Mi.test(h)&&(h="chord",--i);let u=[o,h],a=Zs[h];if(a===void 0)throw new TypeError('Unrecognised type "'+h+'" in sequence data');if(h==="chord"){let c=Mi.exec(t[++i])[0],l=t[i].slice(c.length)||t[++i],d=Number(t[++i]);u.push(c,l,d)}else for(;a--;){let c=Number(t[++i]);u.push(Number.isNaN(c)?t[i]:c)}r.push(u)}return r}function Ys(e){let t=e.files[Object.keys(e.files)[0]];return Je(t.type,t.content)}function js(e){let t=e.settings.find(matches({id:13324}))||e.settings[0];return Je("abc",t.abc)}function Je(e,t){if(typeof t=="object")return t.files?Ys(t):t.settings?js():Array.isArray(t)?{id:0,events:t}:t;if(e==="abc"||e==="text/x-abc")return Pn(t.replace(/\n\s+/g,`
`)).sequences[0];if(e==="sequence"||e==="text/plain")return{events:Mn(t)};{let r=JSON.parse(t);return Array.isArray(r)?{id:0,events:r}:r}}var Vs=dn(li);var Oi=J((e,t)=>typeof t,{string:function(e,t){return Vs(t).then(r=>Je(e,r)).catch(r=>console.error(r))},default:function(e,t,r,i){t[e]=i}});var ef=/^(\d+)\/(\d+)$/;function Ii(e){let t=ef.exec(e),r=parseInt(t[1],10),i=4/parseInt(t[2],10);return{1:"meter",2:r*i,3:i}}function Gi(e){let t=e[2],r=e[3],i=t/r,o=4/r;return i+"/"+o}var te={};No(te,{acciDoubleFlat:()=>$n,acciDoubleSharp:()=>Un,acciFlat:()=>yr,acciNatural:()=>Er,acciParensLeft:()=>df,acciParensRight:()=>mf,acciSharp:()=>Cr,augmentationDot:()=>Rf,barLine:()=>Nr,barRepeat1:()=>fc,barRepeat2:()=>cc,barRepeat4:()=>lc,barRepeatBegin:()=>dc,barRepeatDots:()=>vc,barRepeatEnd:()=>mc,barRepeatEndBegin:()=>gc,barRepeatLowerDot:()=>pc,barRepeatSlash:()=>uc,barRepeatUpperDot:()=>hc,chordAugmented:()=>Ac,chordBassSlash:()=>Yn,chordBracketLeft:()=>Mc,chordBracketRight:()=>Oc,chordDiminished:()=>_c,chordGlyphs:()=>Ic,chordHalfDiminished:()=>Dc,chordMajorSeventh:()=>Fc,chordMinor:()=>Sc,chordParensLeftTall:()=>Lc,chordParensRightTall:()=>Pc,clefAlto:()=>Gn,clefBass:()=>Pt,clefDrum:()=>Rn,clefPercussion:()=>qn,clefTreble:()=>Lt,clefTrebleDown:()=>On,clefTrebleUp:()=>In,coda:()=>Jn,graceNoteStemDown:()=>Qf,graceNoteStemUp:()=>Xf,head1:()=>gf,head2:()=>vf,head4:()=>bf,headBracketLeft:()=>zn,headBracketRight:()=>Hn,headCircle:()=>Nf,headCircleX:()=>kf,headDiamond:()=>wf,headDiamondWide:()=>yf,headPlus:()=>Cf,headSlashHorizontalEnds:()=>_f,headSlashVerticalEnds:()=>Bf,headSlashed2:()=>xf,headTriangleUp:()=>Tf,headX:()=>Ef,metDot:()=>Kf,metNote05Down:()=>Wf,metNote05Up:()=>Uf,metNote1Down:()=>Hf,metNote1Up:()=>$f,metNote2Down:()=>zf,metNote2Up:()=>qf,note0125Down:()=>Gf,note0125Up:()=>Lf,note025Down:()=>If,note025Up:()=>Sf,note05Down:()=>Of,note05Up:()=>Ff,note1Down:()=>Mf,note1Up:()=>Af,note2Down:()=>Pf,note2Up:()=>Df,rest0125:()=>Wn,rest01875:()=>tc,rest025:()=>Kn,rest0375:()=>rc,rest05:()=>Xn,rest075:()=>nc,rest1:()=>Qn,rest15:()=>ac,rest2:()=>Zn,rest3:()=>ic,rest4:()=>oc,rest6:()=>sc,tailDown0125:()=>ec,tailDown025:()=>jf,tailDown05:()=>Jf,tailUp0125:()=>Vf,tailUp025:()=>Yf,tailUp05:()=>Zf,textBeam16Long:()=>Xc,textBeam16Short:()=>Kc,textBeam8Long:()=>Wc,textBeam8Short:()=>Hc,textDot:()=>Qc,textNote16Long:()=>zc,textNote16Short:()=>Uc,textNote8Long:()=>$c,textNote8Short:()=>qc,textNoteLong:()=>Rc,textNoteShort:()=>Gc,textTie:()=>Zc,textTuplet3Long:()=>el,textTuplet3Short:()=>Yc,textTupletBeginLong:()=>Vc,textTupletBeginShort:()=>Jc,textTupletEndLong:()=>tl,textTupletEndShort:()=>jc,timeSig0:()=>tf,timeSig1:()=>rf,timeSig2:()=>nf,timeSig3:()=>af,timeSig4:()=>of,timeSig5:()=>sf,timeSig6:()=>ff,timeSig7:()=>cf,timeSig8:()=>lf,timeSig9:()=>uf,timeSigCommon:()=>hf,timeSigCutCommon:()=>pf,tuplet0:()=>bc,tuplet1:()=>xc,tuplet2:()=>wc,tuplet3:()=>yc,tuplet4:()=>Ec,tuplet5:()=>Cc,tuplet6:()=>Nc,tuplet7:()=>kc,tuplet8:()=>Tc,tuplet9:()=>Bc});var Lt="&#xE050;",On="&#xE052;",In="&#xE053;",Gn="&#xE05C;",Pt="&#xE062;",Rn="&#xE069;",qn="&#xE069;",tf="&#xE080;",rf="&#xE081;",nf="&#xE082;",af="&#xE083;",of="&#xE084;",sf="&#xE085;",ff="&#xE086;",cf="&#xE087;",lf="&#xE088;",uf="&#xE089;",hf="&#xE08A;",pf="&#xE08B;",$n="&#xE264;",yr="&#xE260;",Er="&#xE261;",Cr="&#xE262;",Un="&#xE263;",df="&#xE26A;",mf="&#xE26B;",gf="&#xE0A4;",vf="&#xE0A3;",bf="&#xE0A2;",zn="&#xE0F5;",Hn="&#xE0F6;",xf="&#xE0D0;",wf="&#xE0DB;",yf="&#xE0DC;",Ef="&#xE0A9;",Cf="&#xE0AF;",Nf="&#xE0E8;",kf="&#xE0B3;",Tf="&#xE0BE;",Bf="&#xE100;",_f="&#xE101;",Df="&#xE1D3;",Af="&#xE1D5;",Ff="&#xE1D7;",Sf="&#xE1D9;",Lf="&#xE1DB;",Pf="&#xE1D4;",Mf="&#xE1D6;",Of="&#xE1D8;",If="&#xE1DA;",Gf="&#xE1DC;",Rf="&#xE1E7;",qf="&#xECA3;",$f="&#xECA5;",Uf="&#xECA7;",zf="&#xECA4;",Hf="&#xECA6;",Wf="&#xECA8;",Kf="&#xECB7;",Xf="&#xE560;",Qf="&#xE561;",Zf="&#xE240;",Jf="&#xE241;",Yf="&#xE242;",jf="&#xE243;",Vf="&#xE244;",ec="&#xE245;",Wn="&#xE4E8;",tc="&#xE4E8;&#xE1E7;",Kn="&#xE4E7;",rc="&#xE4E7;&#xE1E7;",Xn="&#xE4E6;",nc="&#xE4E6;&#xE1E7;",Qn="&#xE4E5;",ac="&#xE4E5;&#x200A;&#xE1E7;",Zn="&#xE4E4;",ic="&#xE4E4;&#x200A;&#xE1E7;",oc="&#xE4E3;",sc="&#xE4E3;&#x200A;&#xE1E7;",Nr="&#xE030",fc="&#xE500;",cc="&#xE501;",lc="&#xE502;",uc="&#xE504;",hc="&#xE503;",pc="&#xE505;",dc="&#xE040",mc="&#xE041",gc="&#xE042",vc="&#xE043",Jn="&#xE048",bc="&#xE880;",xc="&#xE881;",wc="&#xE882;",yc="&#xE883;",Ec="&#xE884;",Cc="&#xE885;",Nc="&#xE886;",kc="&#xE887;",Tc="&#xE888;",Bc="&#xE889;",_c="&#xE870;",Dc="&#xE871;",Ac="&#xE872;",Fc="&#xE873;",Sc="&#xE874;",Lc="&#xE875;",Pc="&#xE876;",Mc="(",Oc=")",Yn="&#xE87B;",Ic={"∆♯11":"11","∆":"",7:"7","-7":"7","-♭6":"6","7sus♭9":"7sus",ø:"","7♯11":"711","-∆":"","∆♭6":"6","-♭9":"9",ø7:"7","∆♯5":"5","7alt":"7alt","°":"",dim:"","7♭9":"7","+7":"7"},Gc="&#xE1F0;",Rc="&#xE1F1;",qc="&#xE1F2;",$c="&#xE1F3;",Uc="&#xE1F4;",zc="&#xE1F5;",Hc="&#xE1F7;",Wc="&#xE1F8;",Kc="&#xE1F9;",Xc="&#xE1FA;",Qc="&#xE1FC;",Zc="&#xE1FD;",Jc="&#xE1FE",Yc="&#xE1FF",jc="&#xE200",Vc="&#xE201",el="&#xE202",tl="&#xE203";function jn(e){return function(){return arguments[e]}}function ke(){return this}var Ri=Object.create,rl=Object.freeze,Mt=rl(Ri(Ri(Object.prototype,{at:{value:ie},shift:{value:ie},push:{value:ie},forEach:{value:ie},join:{value:function(){return""}},every:{value:function(){return!0}},filter:{value:ke},find:{value:ie},findIndex:{value:function(){return-1}},flat:{value:ke},flatMap:{value:ke},includes:{value:function(){return!1}},indexOf:{value:function(){return-1}},map:{value:ke},reduce:{value:jn(1)},sort:{value:ke},each:{value:ke},pipe:{value:be},start:{value:ke},stop:{value:ke},done:{value:ke},valueOf:{value:function(){return null}}}),{length:{value:0}}));function kr(e,t){return(t%e+e)%e}function Te(e){return kr(12,e)}function lt(e,t){return e>t?1:e<t?-1:0}function nl(e,t,r){return r.indexOf(e)===t}function Vn(e,t){return e.map(r=>Te(r+t)).filter(nl).sort(lt)}function qi(e,t){return Vn(e,t*7)}var ea=[{name:"C",symbol:"C∆",spellings:[0,1,0,-1,0,0,1,0,-1,0,-1,0]},{name:"D♭",symbol:"D♭∆",spellings:[0,-1,0,-1,-1,0,-1,0,-1,0,-1,-1]},{name:"D",symbol:"D∆",spellings:[0,1,0,1,0,0,1,0,1,0,-1,0]},{name:"E♭",symbol:"E♭∆",spellings:[0,-1,0,-1,0,0,-1,0,-1,0,-1,-1]},{name:"E",symbol:"E∆",spellings:[0,1,0,1,0,1,1,0,1,0,1,0]},{name:"F",symbol:"F∆",spellings:[0,-1,0,-1,0,0,1,0,-1,0,-1,0]},{name:"F♯",symbol:"F♯∆",spellings:[1,1,0,1,0,1,1,0,1,0,1,0]},{name:"G",symbol:"G∆",spellings:[0,1,0,-1,0,0,1,0,1,0,-1,0]},{name:"A♭",symbol:"A♭∆",spellings:[0,-1,0,-1,-1,0,-1,0,-1,0,-1,-1]},{name:"A",symbol:"A∆",spellings:[0,1,0,1,0,0,1,0,1,0,1,0]},{name:"B♭",symbol:"B♭∆",spellings:[0,-1,0,-1,0,0,-1,0,-1,0,-1,0]},{name:"B",symbol:"B∆",spellings:[1,1,0,1,0,1,1,0,1,0,1,0]}],Oe=[0,2,4,5,7,9,11],$i={"F♭":-8,"C♭":-7,"G♭":-6,"D♭":-5,"A♭":-4,"E♭":-3,"B♭":-2,F:-1,C:0,G:1,D:2,A:3,E:4,B:5,"F♯":6,"C♯":7,"G♯":8,"D♯":9,"A♯":10,"E♯":11,"B♯":12},al={bb:"𝄫",b:"♭","":"","#":"♯","##":"𝄪"};function il(e){return e.replace(/[#b]{1,2}$/,t=>al[t])}function Tr(e){return typeof e=="number"?e:$i[il(e)]}function ta(e){return typeof e=="number"?Vn(Oe,e):qi(Oe,$i[e])}var Ye=/^([A-G])([b#♭♯𝄫𝄪])?(-?\d)?$/;var ol={"-2":"𝄫","-1":"♭",0:"",1:"♯",2:"𝄪"};function Ot(e,t,r=0){let i=ea[Te(e+r)],o,h,u;if(typeof t[2]=="string"){let[l,d,n,s]=Ye.exec(t[2])||[t[2]];s?(o=W(t[2])+r,h=i.spellings[Te(o)],u=lr(o-h)):(o=pe(t[2])+r,h=i.spellings[Te(o)],u="")}else t[1]==="chord"?(o=pe(t[2])+r,h=i.spellings[Te(o)],u=""):(o=t[2]+r,h=i.spellings[Te(o)],u=lr(o-h));let a=pn[Te(o-h)],c=ol[h];return a+c+u}var It=/b|♭/,Gt=/#|♯/;var ra=/b|♭|#|♯/g;var Q=class{constructor(){}clef="";pitched=!0;rows=Mt;getNoteHTML(t,r,i){let o=i>=4||Math.fround(i)===Math.fround(2.666666667)?"head4":i>=2||Math.fround(i)===Math.fround(1.333333333)?"head2":"head1";return`<span class="head" data-glyph="${o}">${te[o]}</span>`}get minPitch(){return this.rows[0]}get midPitch(){return this.rows[13]}get maxPitch(){return this.rows[27]}get minLinePitch(){return this.rows[9]}get midLinePitch(){return this.rows[13]}get maxLinePitch(){return this.rows[17]}movePitch(t,r){let i=W(this.minPitch),o=W(this.maxPitch),h=W(t)+r;return h>=i&&h<=o?h:void 0}getPart(t){return this.getRowDiff(this.midLinePitch,t)<0?{stemDirection:"up",tieDirection:"up"}:{stemDirection:"down",tieDirection:"down"}}parts=[{}];getPartIndex(t){return 0}getRowDiff(t,r){let i=t.replace(ra,""),o=r.replace(ra,""),h=this.rows.indexOf(i),u=this.rows.indexOf(o);if(h===-1)throw new Error('Pitch "'+t+'" is not supported by stave '+this.constructor.name);if(u===-1)throw new Error('Pitch "'+r+'" is not supported by stave '+this.constructor.name);return u-h}getSpelling(){return Ot.apply(this,arguments)}yRatioToPitch(t){let r=floor(t*this.pitches.length);return r<0?this.pitches[0]:r>this.pitches.length-1?this.pitches[this.pitches.length-1]:this.pitches[r]}};var je=class extends Q{type="drum";clef=Rn;pitched=!1;rows=["","","","","","","","pedal-hi-hat","bass-drum-2","bass-drum-1","low-tom-2","low-tom-1","mid-tom-2","snare-drum-1","mid-tom-1","high-tom-1","closed-hi-hat","ride-cymbal-1","crash-cymbal-1","crash-cymbal-2","splash-cymbal","","","",""];#e={31:"headX",37:"headCircle",39:"headX",42:"headX",44:"headX",46:"headCircleX",49:"headCircleX",51:"headX",52:"headCircleX",53:"headDiamond",54:"headX",55:"headX",56:"headTriangleUp",57:"headCircleX",58:"headTriangleUp",59:"headX"};#t={27:0,28:0,29:0,30:0,31:13,32:0,33:0,34:0,35:10,36:9,37:14,38:14,39:13,40:14,41:11,42:17,43:12,44:8,45:13,46:17,47:13,48:15,49:19,50:16,51:18,52:21,53:18,54:13,55:21,56:16,57:20,58:0,59:19,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0};get maxPitch(){return this.rows[25]}get minLinePitch(){return this.rows[8]}get midLinePitch(){return this.rows[12]}get maxLinePitch(){return this.rows[16]}getNoteHTML(t,r,i){let o=W(t),h=this.#e[o],u=te[h],a=h?`<span class="head" data-glyph="${h}">${u}</span>`:super.getNoteHTML(t,r,i);return r<.02?zn+a+Hn:a}getPart(t){return[35,36,37,38,40,41,43,44,45,47,50].includes(W(t))?{part:"drums",stemDirection:"down",tieDirection:"down",centerRow:"stave-lower"}:{stemDirection:"up",tieDirection:"up",centerRow:"stave-upper"}}parts=[{part:"drums",stemup:!1,tieup:!1,centerRow:"stave-lower"},{part:"cymbals",stemup:!0,tieup:!0,centerRow:"stave-upper"}];getPartIndex(t){return[35,36,37,38,40,41,43,44,45,47,50].includes(W(t))?1:0}getRowDiff(t,r){let i=W(t),o=W(r),h=this.#t[i],u=this.#t[o];if(h===void 0)throw new Error('Pitch "'+t+'" is not supported by stave '+this.constructor.name);if(u===void 0)throw new Error('Pitch "'+r+'" is not supported by stave '+this.constructor.name);return u-h}getSpelling(t,r,i){return r[1]==="note"?yt(W(r[2])):Ot(t,r,i)}yRatioToPitch(t){let r=floor(t*this.rows.length),i=r<4?4:r>17?17:r;return this.pitches[i]}};var Rt=class extends je{type="percussion";clef=qn;rows=["","","","","","","","","note","","","","","","","",""];get maxPitch(){return this.rows[17]}get minLinePitch(){return this.rows[8]}get midLinePitch(){return this.rows[8]}get maxLinePitch(){return this.rows[8]}getPart(t){return[35,36,37,38,40,41,43,44,45,47,50].includes(W(t))?{stemDirection:"down",tieDirection:"down"}:{stemDirection:"up",tieDirection:"up"}}getRowDiff(t,r){return 0}};var qt=class extends Q{type="piano";rows=["E1","F1","G1","A1","B1","C2","D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6","F6","G6","A6"];getClefHTML(){return`<span class="treble-clef clef">${Lt}</span><span class="bass-clef clef">${Pt}</span>`}getTimeSigHTML(t,r,i){return`<span class="timesig" data-event="${i}" data-part="upper">
            <sup>${te["timeSig"+t]}</sup>
            <sub>${te["timeSig"+r]}</sub>
        </span>
        <span class="timesig" data-event="${i}" data-part="lower">
            <sup>${te["timeSig"+t]}</sup>
            <sub>${te["timeSig"+r]}</sub>
        </span>`}getPart(t){return/[012]$|[AC-G][b#♭♯𝄫𝄪]*3$/.test(t)?{part:"lower",centerPitch:"D3",centerRow:"stave-lower"}:{centerPitch:"B4",centerRow:"stave-upper"}}};var na=class extends Q{type="treble-up";clef=In;rows=["C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6","F6","G6","A6","B6","C7","D7","E7","F7","G7","A7"]},aa=class extends Q{type="treble";clef=Lt;rows=["C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5","C6","D6","E6","F6","G6","A6"]},ia=class extends Q{type="treble-down";clef=On;rows=["C2","D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5"]},oa=class extends Q{type="alto";clef=Gn;rows=["D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5","D5","E5","F5","G5","A5","B5"]},sa=class extends Q{type="bass";clef=Pt;rows=["E1","F1","G1","A1","B1","C2","D2","E2","F2","G2","A2","B2","C3","D3","E3","F3","G3","A3","B3","C4","D4","E4","F4","G4","A4","B4","C5"]};Q.treble=aa;Q["treble-up"]=na;Q["treble-down"]=ia;Q.alto=oa;Q.bass=sa;Q.piano=qt;Q.drum=je;Q.percussion=Rt;Q.create=e=>new Q[e];var Br=Q;function sl(){return{x:0,y:0,left:0,top:0,right:window.innerWidth,bottom:window.innerHeight,width:window.innerWidth,height:window.innerHeight}}function fa(e){return e===window?sl():e.getClientRects()[0]||e.getBoundingClientRect()}var Ie=1.1;function fl(e){return parseFloat(e.dataset.duration)}function cl(e){let t=e.childNodes;for(;t.length>1;)e.removeChild(e.lastChild)}function Ui(e,t,r){return`M${t[r[0]]}, ${-e*t[r[0]]-.5*Ie}
        L${t[r[r.length-1]]},${-e*t[r[r.length-1]]-.5*Ie}
        L${t[r[r.length-1]]},${-e*t[r[r.length-1]]+.5*Ie}
        L${t[r[0]]}, ${-e*t[r[0]]+.5*Ie}
        Z`}function ca(e,t,r,i,o,h){if(h<.125)return;let u=i-1,a;for(;t[++u];)t[u]<=h?a?a.push(u):a=[u]:a&&(e.appendChild(U("path",{class:`beam-path-${4/h} beam-path`,d:Ui(o,r,a)})),ca(e,t,r,a[0],o,h/2),a=void 0);a&&(e.appendChild(U("path",{class:`beam-path-${4/h} beam-path`,d:Ui(o,r,a)})),ca(e,t,r,a[0],o,h/2),a=void 0)}function la(e){let t=e.dataset.events.split(/\s+/),r=e.parentElement,i=t.map(n=>r.querySelector('.note[data-event="'+n+'"]')),o=i.map(fl),h=e.viewBox.baseVal,u=h.y<-.5?h.y+.5:h.height-1,a=i.map(fa),c=a[0].x,l=a[a.length-1].x,d=a.map(n=>(n.x-c)/(l-c));cl(e),ca(e,o,d,0,-u,.25)}function ll(e,t){return t[e]}var Be=xe(ll,!0);function zi(e){return e[1]==="sequence"}var ua=Object.assign,Hi=[],ul={done:!0,value:void 0};var Wi={key:2,meter:1,default:0},hl={},Td=Be(0);function Ki(e){return Wi[e[1]]||Wi.default}function pl(e,t){return t[0]<e[0]?1:t[0]>e[0]?-1:Ki(t)-Ki(e)}function dl(e,t){return e.find(r=>r.id===t)}var ml={offset:(e,t,r)=>(r[0]-=e[++t],t),rate:(e,t,r)=>(r[0]/=e[++t],t),quantize:(e,t,r)=>{},transpose:(e,t,r)=>{switch(r[1]){case"note":case"chord":case"key":{let i=typeof r[2]=="string"?W(r[2]):r[2];r[2]=i+e[t+1];break}}return t+1}};function ha(e,t){let r=-1,i;for(;i=e[++r];)r=ml[i](e,r,t);return t}var pa=class e{constructor(t,r=Hi,i=0,o=1/0,h=Hi){t.sort(pl),this.events=t,this.sequences=r,this.beat=i,this.duration=o,this.transforms=h;let u=-1,a;for(;(a=t[++u])&&ha(this.transforms,ua(hl,a))[0]<0;);this.n=u-1}next(){let{buffer:t,events:r,sequences:i,n:o}=this,h=r[o+1],u=h&&ha(this.transforms,ua({event:h,events:r},h)),a,c=0,l=0,d=h?u[0]:this.duration,n;for(;a=this[--c];)a.value||(a.next().value&&ha(this.transforms,a.value),a.done&&++l),a.value&&a.value[0]<d&&(n=a,d=a.value[0]),l&&(this[c]=this[c-l]);if(n)return this.value=n.value,this.value[0]+=this.beat,n.value=void 0,this;if(!u||this.duration<=u[0])return ua(this,ul);if(zi(h)){let s=this.sequences,f=dl(s,h[2]);if(!f)throw new Error('Sequence "'+h[2]+'" not found');let p=h.slice(5),m=new e(f.events,f.sequences?f.sequences.concat(s):s,u[0],u[4],p),g=0;for(;this[--g];);this[g]=m}return this.n+=1,this.value=u,this.value[0]+=this.beat,this}[Symbol.iterator](){return this}},$t=class e{constructor(t,r=[],i=""){this.name=i,this.events=t,this.sequences=r}of(...t){return new e(t)}from(t){return t.length?new e(t):new e(t.events,t.sequences,t.name)}[Symbol.iterator](){return new pa(this.events,this.sequences)}};function gl(e,t,r){let i=e(t),o=e(r);return o===i?0:i>o?1:-1}var vl=xe(gl,!0);var da=[];function Ut(e){da.length=0;for(var t=e.length,r,i;t--;)r=e[t],i!==r[0]&&(i=r[0],da.push(i));return da.sort(lt)}function _r(e,t){return t+e}var ma={"∆":[0,2,4,7,9,11],"∆7":[0,2,4,7,9,11],"-":[0,3,7],"-7":[0,2,3,5,7,9,10],"sus♭9":[0,1,5,7,10],"7sus♭9":[0,1,5,7,10],"∆♯11":[0,2,4,6,7,9,11],"∆(♯11)":[0,2,4,6,7,9,11],7:[0,4,7,10],13:[0,4,7,9,10],sus:[0,2,5,7,10],"7sus":[0,2,5,7,10],"-♭6":[0,2,3,5,7,8],ø:[0,3,6,10],"7♭9♭13":[0,1,4,5,7,8,10],"-∆":[0,2,3,5,7,9,11],"13sus♭9":[0,1,5,7,9,10],"∆+":[0,2,4,6,8,9,11],"∆♯5":[0,2,4,6,8,9,11],"7♯11":[0,2,4,6,7,9,10],"7♭13":[0,2,4,7,8,10],"ø(9)":[0,2,3,6,10],"7alt":[0,1,3,4,6,8,10],"∆♭6":[0,2,4,7,8,11],"7♭9":[0,1,3,4,6,7,9,10],"7♯9":[0,1,3,4,6,7,9,10],º:[0,2,3,5,6,8,9,11],"7+":[0,2,4,6,8,10]};function bl(e){return e.replace(/(maj)|(min)|(dim)/,(t,r,i,o)=>r?"∆":i?"-":o?"º":"")}function Xi(e,t,r){let i=pe(e),o=bl(t);return ma[o]?i?ma[o].map(h=>Te(h+i)).sort(lt):ma[o]:[]}var ga=J(Be(1),{chord:e=>Xi(e[2],e[3]),note:e=>[pe(e[2])],default:e=>[]});var ut=J(Be(1),{chord:e=>e[4],lyric:e=>e[3],note:e=>e[4],sequence:e=>e[4],default:e=>0});var va=[];function ba(e,t){va.length=0;let r,i=-1;for(;(r=e[++i])&&!(r[0]>t);)(r[0]===t||r[0]+ut(r)>t)&&va.push(r);return va}var xl=[1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],Zi=[10,5,8,10,6,10,8,10,7,10,8,4],wl=Zi.reduce(_r),yl=Zi.map(e=>e/wl).map(Ji),El=[.1,.04,.1,.04,.1,.1,.04,.1,.04,.1,.04,.1].map(Ji);function Ji(e,t,r){return r.slice(12-t).concat(r.slice(0,12-t))}function Qi(e,t){for(var r=0,i=0;i<e.length;++i)r+=Math.log(t[e[i]]);return r}function Cl(e,t,r,i){var o=[],h=[],u=[],a=[],c=0,l=-1,d,n,s;for(h[c]=o;++l<12;)o[l]=Math.log(t[l])+Qi(e[0],i[l]),u[l]=[l];for(;++c<e.length;){for(o=[],n=[],h[c]=o,d=-1;++d<12;){for(a.length=0,a[0]=-1/0,l=-1;++l<12;)s=h[c-1][l]+Math.log(r[l][d])+Qi(e[c],i[d]),s>a[0]&&(a[0]=s,a[1]=l);o[d]=a[0],n[d]=u[a[1]].concat(d)}u=n}for(a.length=0,a[0]=-1/0,l=-1;++l<12;)s=h[e.length-1][l],s>a[0]&&(a[0]=s,a[1]=l);return u[a[1]]}function Nl(e,t){return e.push.apply(e,t),e}function xa(e){let t=Ut(e),r=t.length,i=[],o=-1,h,u;for(;++o<r;){h=t[o],u=ba(e,h);var a=u.map(ga);if(a.find(c=>c.find(Number.isNaN)!==void 0)!==void 0)throw console.log(u),new Error("toNotes has returned NaN for beatEvents");i.push(u.map(ga).reduce(Nl,[]))}return r?Cl(i,xl,yl,El):[]}function Yi(e){let t=e.filter(o=>/^note|chord$/.test(o[1])),r=Ut(t),i=xa(t);return r.map((o,h)=>[o,i[h]])}function _e(e){return e[0]+ut(e)}function wa(e){return 2**Math.ceil(Math.log2(e))}function ji(e){return e>0&&(e&e-1)===0}var kl=[2,3,4,5,6,7,9],Tl=1/12,Vi=.4,ht=0;function eo(e,t){return .5*(1+Math.cos(2*Math.PI*t/e))}var ya={};function to(e,t,r,i,o){let h=e/t,u=0,a=0,c=0,l,d;for(--o;i[++o]!==void 0&&i[o][0]-r<h/4;)c=1;for(--o;i[++o]!==void 0&&i[o][0]-r<e-h/4;){if(l=Math.round((i[o][0]-r)/h),d=1<<l,d>c){if(t>4&&d>c<<1)return;c+=d}u+=eo(h,i[o][0]-r),a+=1,!(i[o][0]+i[o][4]-r>e)&&(u+=Vi*eo(h,i[o][0]+i[o][4]-r),a+=Vi)}if(!(t>4&&l!==t-1)&&a)return ya.score=u/a,ya.rhythm=c,ya}function Bl(e,t,r,i,o,h,u){let a=t*Math.floor((r[i][0]-o)/t)+o,c=h.length;for(;t/h[--c]<Tl;);++c;let l,d;for(;l=h[--c];)d=to(t,l,a,r,i),d&&d.score>=ht&&(ht=d.score,e.beat=a,e.duration=t,e.divisor=l,e.rhythm=d.rhythm),r[i][0]>=a+.5*t&&a+1.5*t<u&&(d=to(t,l,a+.5*t,r,i),d&&d.score>=ht&&(ht=d.score,e.beat=a+.5*t,e.duration=t,e.divisor=l,e.rhythm=d.rhythm));return e}function Ea(e,t,r){let i=-1;for(;e[++i]!==void 0&&e[i][0]<t;);if(!e[i])return;let o={};ht=0;let h=1/8;for(;(h*=2)&&h<=r;)Bl(o,h,e,i,t,kl,t+r);return ht>0&&o}function zt(e,t){return Math.round(t/e)*e}function Ve(e,t,r=Math.EPSILON){return e!==void 0&&(e===t||Math.abs(e-t)<r)}function et(e,t,r){return Ve(e,t,r)||e<t}function _l(e,t,r){return Ve(e,t,r)||e>t}function Dr(e,t,r){return e!==void 0&&t!==void 0&&!et(e,t,r)}function Ca(e,t,r){return e!==void 0&&t!==void 0&&!_l(e,t,r)}function Ar(e,t){let r=e.length;for(;e[--r]&&e[r]>t;);return e[r]}function Ht(e,t){let r=-1,i=0;for(;e[++r]!==void 0;);for(;arguments[++i]!==void 0;)e[r++]=arguments[i];return e}function pt(e){let t=-1;for(;e[++t]!==void 0;);return t}function Fr(e){return e[pt(e)-1]}function Wt(e,t){let r=[],i=-1;for(;t[++i]!==void 0;)r.push(e(t[i],i));return r}var De={spellChordRootCFlatAsB:!0,spellChordRootBSharpAsC:!0,spellChordRootESharpAsF:!0,spellChordRootFFlatAsE:!0,swingAsStraight8ths:!0,swingAsStraight16ths:!0};var no=Object.assign,{abs:ro,ceil:Ng,floor:kg,min:Dl,max:ao}=Math,ne=1/24,Tg=[0,2/24,3/24,4/24,6/24,8/24,9/24,10/24,12/24,14/24,15/24,16/24,18/24,20/24,21/24,22/24,1],Ta=[1/8,6/32,7/32,1/4,6/16,7/16,1/2,6/8,7/8,1,6/4,7/4,2,6/2,7/2,4,6,7,8],Bg=Ta[0],Na=[1/8,6/32,1/4,6/16,1/2,6/8,1,6/4,2,3,4,6,8];function Ba(e){return e[0]+ut(e)}function io(e,t){return ao(e,Ba(t))}function oo(e,t,r){let i={},o=-1,h;for(;h=r[++o];)i[o]=e.getSpelling(t,h);return i}function Sr(e){let[t,r,i,o]=Ye.exec(e[0]),h=o,u=pe(r),a=e[0],c=0;for(;e[++c];){let[l,d,n,s]=Ye.exec(e[c]);(s<h||s===h&&pe(d)<u)&&(h=s,u=pe(d),a=e[c])}return a}function Lr(e){let[t,r,i,o]=Ye.exec(e[0]),h=o,u=pe(r),a=e[0],c=0;for(;e[++c];){let[l,d,n,s]=Ye.exec(e[c]);(s>h||s===h&&pe(d)>u)&&(h=s,u=pe(d),a=e[c])}return a}function _a(e,t,r){let i=e.getRowDiff(e.midLinePitch,t);return e.getRowDiff(e.midLinePitch,r)+i<-1}function so(e,t){let r=Sr(t),i=Lr(t);return _a(e,r,i)}function Al(e,t){let r=[],i=-1,o;for(;o=t[++i];)o.type==="note"&&r.push(o.pitch);return so(e,r)}function tt(e,t,r,i){let o=-1;for(;i[++o]&&i[o].beat===i.beat;);if(!i[o])return e;let h=i[0].beat,a=Fr(i).beat-h,c=r.stemup===void 0?so(t,Wt(Be("pitch"),i)):r.stemup,l=[],d;for(o=-1;d=i[++o];){let y=d.pitch;for(;i[++o]&&Ve(i[o].beat,d.beat,ne);)c?W(i[o].pitch)>W(y)&&(y=i[o].pitch):W(i[o].pitch)<W(y)&&(y=i[o].pitch);--o,l.push(y)}let n=pt(i),s=0,f=0,p;for(o=-1;l[++o];)p=t.getRowDiff(t.midLinePitch,l[o]),o<(l.length-1)/2?s+=p/Math.floor(l.length/2):o>(l.length-1)/2&&(f+=p/Math.floor(l.length/2));let m=i[0],g=Fr(i),b=t.getRowDiff(m.pitch,g.pitch),N=f-s,B=ro(N)>ro(.75*b)?.5*b:.5*N;for(o=-1;d=i[++o];)d.stemup=c,d.beam=i,d.stemHeight=c?1+.125*(B*o/(l.length-1)-t.getRowDiff(m.pitch,d.pitch)):1+.125*(-B*o/(l.length-1)+t.getRowDiff(m.pitch,d.pitch));return e.push(no(i,{pitch:m.pitch,duration:a,stemup:c,range:B})),e}function Fl(e,t,r){let{beat:i,duration:o,divisor:h}=r,u=t.stemup===void 0?Al(e,r):t.stemup,a=-1,c;for(;c=r[++a];)c.type==="note"&&!c.beam&&(c.stemup=u);let l=i+.5*o,d=W(e.maxLinePitch)-12,n,s=pt(r);for(;(c=r[--s])&&c.beat>l;);for(++s;(c=r[--s])&&c.beat+c.duration>l;){let b=W(c.pitch);(!n||b>n)&&(n=b)}let f=d;for(s=-1;(c=r[++s])&&c.beat<ne;){let b=W(c.pitch);(!f||b>f)&&(f=b)}let p=d;for(s=r.length;(c=r[--s])&&c.beat>i+o-o/h-ne;){let b=W(c.pitch);(!p||b>p)&&(p=b)}let m=Math.ceil((f+p)/2),g=yt(m);m>n&&(n=m),r.pitch=yt(n),r.angle=-3*Math.sqrt(p-f),r.stemup=u}function Sl(e,t,r,i,o,h,u){let a=h-u;if(!(u===0||t.includes(u))||!(h===r||t.includes(h))){let d=Aa(t,u,u+a);d&&(a=d-u)}let c=e.length;for(;e[--c]+ne>a;);a=e[c+1]||e[e.length-1];let l=8;for(;(l*=.5)&&u%l;);return l<a&&(a=l),{type:"rest",beat:u,duration:a,stave:i,part:o}}function ka(e,t,r,i,o,h,u){for(;Dr(u,h,ne);){let a=Sl(t,r.divisions,r.duration||100,i,o,u,h);e.push(a),h+=a.duration}return u}function Ll(e,t,r,i,o,h,u){let a=Gt.test(u)?1:It.test(u)?-1:void 0,c=u[0]+u.slice(-1);a!==i[c]&&(i[c]=a,e.push(no({},{type:"acci",beat:o,pitch:u,part:r,stave:t,event:h,value:a||0})))}function fo(e,t,r,i,o,h,u){let a=-1;for(;u[++a];)Ll(e,t,r,i,o,h[a],u[a]);return o}function co(e,t,r,i){let o=Lr(i),h=t.getRowDiff(o,t.maxLinePitch)+1;h<0&&e.push({type:"ledge",beat:r,pitch:o,rows:h}),o=Sr(i),h=t.getRowDiff(o,t.minLinePitch)-1,h>0&&e.push({type:"ledge",beat:r,pitch:o,rows:h})}function Pl(e,t,r,i,o,h,u,a,c,l,d,n,s,f){(u.swingAsStraight8ths&&c===1||u.swingAsStraight16ths&&c===.5)&&l===3&&(d===4||d===5)&&(l=2);let p=c/l,m=a+c,g={type:"tuplet",beat:a,duration:c,divisor:l,part:h,stave:r},b,N;for(ji(l)||e.push(g);Ca(a,m,ne);){for(;(b=s[++f])&&et(b[0]-t.beat,a+.5*p,ne);)n.push(b);if(--f,!n.length){e.push({type:"rest",beat:a,duration:p,stave:r,part:h}),a+=p;continue}let B=oo(r,i,n),y=Sr(B),v=Lr(B),k=h.stemup===void 0?_a(r,y,v):h.stemup,L=Dl(n.reduce(io,0)-t.beat,b?b[0]-t.beat:t.duration,g.beat+g.duration),D=ao(p,zt(p,L-a));Dr(D,.5,ne)?N&&(tt(e,r,h,N),N=void 0):N||(N={type:"beam",beat:a,part:h}),co(e,r,a,B),fo(e,r,h,o,a,n,B);let A=-1;for(;n[++A];)e.push({type:"note",beat:a,pitch:B[A],duration:D,part:h,stemup:k,top:B[A]===v,bottom:B[A]===y,stave:r,event:n[A]});for(Ht(g,...e.slice(-1*n.length)),N&&Ht(N,...e.slice(-1*n.length)),A=n.length;A--;){let M=Ba(n[A])-t.beat;et(M,a+D+.5*p,ne)?n.splice(A,1):e.push({type:"tie",beat:a,pitch:B[A],duration:D,stemup:k,part:h,event:n[A]})}a+=D}return N&&tt(e,r,h,N),Fl(r,h,g),f}function Da(e,t,r,i=0,o={},h,u,a=De){let c=[],l=0,d=-1,n,s,f;for(;(n=u[++d])&&et(n[0]+n[4]-t.beat,l,ne););for(--d;Ca(l,t.duration,ne);){f&&t.divisions.find(D=>Ve(l,D,ne))&&(tt(e,r,h,f),f=void 0);let p=Ea(u,t.beat+l,t.duration-l);if(p&&p.divisor!==2&&p.divisor!==4){Dr(p.beat-t.beat,l,ne)&&ka(e,Na,t,r,h,l,p.beat-t.beat),f&&(tt(e,r,h,f),f=void 0),d=Pl(e,t,r,i,o,h,a,p.beat-t.beat,p.duration,p.divisor,p.rhythm,c,u,d),l=p.beat-t.beat+p.duration;continue}for(;(n=u[++d])&&et(n[0]-t.beat,l,ne);)c.push(n);if(--d,!c.length){if(!n){f&&(tt(e,r,h,f),f=void 0),ka(e,Na,t,r,h,l,t.duration);break}let D=zt(.125,n[0]-t.beat);if(D<=l){console.log(`Problem at bar ${t.count}, moving to next bar ${l} ${D}`),t.error="Stop beat has ended up less than beat";break}ka(e,Na,t,r,h,l,D),l=D;continue}let m=oo(r,i,c),g=Sr(m),b=Lr(m),N=h.stemup===void 0?_a(r,g,b):h.stemup;co(e,r,l,m),fo(e,r,h,o,l,c,m);let B=c.reduce(io,0)-t.beat,y=n&&zt(.125,n[0])-t.beat;y<B?B=y:B%t.divisor>.6?B=Math.ceil(B/t.divisor)*t.divisor:B-l<1&&B-l>.5*wa(B-l)?B=wa(B-l)+l:B=zt(.125,B),t.duration<B&&(B=t.duration);let v=Ar(Ta,B-l)||headDuration[0];if(B=l+v,!v||!B){console.log("We have a problem. Stopping bar render."),console.log("DURATION ",v,B),t.error="Bad duration";break}let k=Aa(t.divisions,l,l+v);k&&(!(l===0||Ve(0,l%t.divisor,ne))||!(B===t.duration||Ve(0,B%t.divisor,ne)))&&(v=Ar(Ta,k-l)),v>=1?f&&(tt(e,r,h,f),f=void 0):f||(f={type:"beam",beat:l,part:h});let L=-1;for(;c[++L];)e.push({type:"note",beat:l,pitch:m[L],duration:v,part:h,stemup:N,top:m[L]===b,bottom:m[L]===g,stave:r,event:c[L]});for(f&&Ht(f,...e.slice(-1*c.length)),L=c.length;L--;){let D=Ba(c[L])-t.beat;et(D,l+v,ne)?c.splice(L,1):e.push({type:"tie",beat:l,pitch:m[L],duration:v,stemup:N,part:h,event:c[L]})}l+=v}return f&&(tt(e,r,h,f),f=void 0),e}var Ml={"2,2":[2],"3,2":[2,4],"2,1":[1],"3,1":[1,2],"4,1":[2],"3,0.5":[1.5],"3,1.5":[1.5],"12,0.5":[1.5,3,4.5]};function Ol(e,t){return Ml[e+","+t]||Mt}function Aa(e,t,r){let i=-1;for(;e[++i]&&e[i]<=t;);return r>e[i]?e[i]:void 0}var Il=[],Gl={"-2":"𝄫","-1":"♭",0:"",1:"♯",2:"𝄪"},lo=["F♯","C♯","G♯","D♯","A♯","E♯","B♯","B♭","E♭","A♭","D♭","G♭","C♭","F♭"];function Rl(e,t){let r=lo.indexOf(e.pitch),i=lo.indexOf(t.pitch);return r>i?1:r<i?-1:0}function ql(e,t,r,i,o,h){let u=-1,a;for(;a=o[++u];)switch(a[1]){case"key":{let c=Tr(a[2]),l=ta(c*7);e.push.apply(e,l.map((d,n)=>d-Oe[n]&&{type:"acci",pitch:Et(Oe[n])+Gl[d-Oe[n]],value:d-Oe[n],stave:r}).filter(d=>!!d).sort(Rl));break}case"meter":{e.push({type:"timesig",beat:0,numerator:a[3]===1.5?a[2]/.5:a[2]/a[3],denominator:a[3]===1.5?8:4/a[3],stave:r,event:a});break}case"symbol":{e.push({type:"symbol"+a[2],stave:r});break}case"chord":{let c=a[0]-t.beat,l=r.getSpelling(i,a);l==="C♭"&&h.spellChordRootCFlatAsB&&(l="B"),l==="E♯"&&h.spellChordRootESharpAsF&&(l="F"),l==="B♯"&&h.spellChordRootBSharpAsC&&(l="C"),l==="F♭"&&h.spellChordRootFFlatAsE&&(l="E"),e.push({type:"chord",beat:c,duration:a[0]+a[4]>t.beat+t.duration?t.duration-c:a[4],root:l,extension:a[3],event:a,stave:r});break}case"lyric":{let c=a[0]-t.beat;e.push({type:"lyric",beat:c,duration:a[0]+a[3]>t.beat+t.duration?t.duration-c:a[3],value:a[2],event:a,stave:r});break}case"sequence":{e.push({type:"doublebarline",stave:r,event:a}),e.push({type:"barcount",text:t.count,stave:r});break}default:{if(Il.includes(a[1]))return;console.log('Scribe: ignoring event type "'+a[1]+'"')}}return e}function Kt(e,t,r,i,o,h,u,a,c,l=De){let d=[];if(c){let m=_e(c);m>t&&m<=t+r&&u.push(c)}let s=ta(h*7).reduce((m,g,b)=>{let N=g-Oe[b];if(N!==0){let B=Et(Oe[b]),y=10;for(;y--;)m[B+y]=N}return m},{}),f={type:"bar",beat:t,duration:r,divisor:i,divisions:Ol(r,i),stave:o,count:e,symbols:d};f.symbols.push({type:"clef",beat:0,stave:o}),ql(d,f,o,h,u,De);let p;for(p in a)Da(d,f,o,h,s,p,a[p],l);return p||Da(d,f,o,h,s,"0",[],l),f}var Pr=Symbol("scribe-id"),$l=0;function Ge(e){return e[Pr]||(e[Pr]=++$l+""),e[Pr]}var Mr=Math.abs,Or={flat:`<span class="chord-flat">${yr}</span>`,sharp:`<span class="chord-sharp">${Cr}</span>`},Ul={2:"acci acci-doublesharp",1:"acci acci-sharp",0:"acci acci-natural","-1":"acci acci-flat","-2":"acci acci-doubleflat"},zl={2:Un,1:Cr,0:Er,"-1":yr,"-2":$n},Hl={"1.33":Zn,"0.67":Qn,"0.33":Xn,"0.17":Kn,"0.08":Wn},Wl=/^(∆|-|ø|7|\+)?(alt|sus|maj|min|dim|aug)?(.*)$/;function fe(e){return e.toFixed(4).replace(/\.?0+$/,"")}var uo=J(Be("type"),{BARREPEAT:e=>U("span",{class:"BARREPEAT",html:te["barRepeat"+e.count],data:{duration:e.duration}}),clef:e=>e.stave.getClefHTML?U("fragment",e.stave.getClefHTML()):U("span",{class:`${e.stave.type}-clef clef`,html:e.stave.clef}),chord:e=>{let t=Wl.exec(e.extension);return U("abbr",{class:"chord chord-abbr",title:"TODO - name of chord",html:'<span class="chord-root">'+e.root.replace(Gt,Or.sharp).replace(It,Or.flat)+'</span><span class="chord-ext">'+(t[1]?'<span class="chord-ext-'+t[1]+'">'+t[1]+"</span>":"")+(t[2]?"<sub>"+t[2]+"</sub>":"")+(t[3]?"<sup>"+t[3].replace(Gt,Or.sharp).replace(It,Or.flat)+"</sup>":"")+"</span>"+(e.bass?Yn+'<span class="chord-bass">'+e.bass+"</span>":""),data:{beat:fe(e.beat+1),duration:fe(e.duration),event:Ge(e.event)}})},timesig:e=>e.stave.getTimeSigHTML?U("fragment",e.stave.getTimeSigHTML(e.numerator,e.denominator,Ge(e.event))):U("span",{class:"timesig",html:`<sup>${te["timeSig"+e.numerator]}</sup>
                <sub>${te["timeSig"+e.denominator]}</sub>`,data:{event:Ge(e.event)}}),symbolcoda:e=>U("p",{html:Jn,class:"coda"}),barcount:e=>U("span",{html:e.text,class:"barcount"}),doublebarline:e=>U("span",{html:Nr+"&#x200A;"+Nr,class:"barline"}),lyric:e=>U("span",{class:"lyric",part:"lyric",html:e.value,data:{beat:fe(e.beat+1),duration:fe(e.duration),event:Ge(e.event)}}),acci:e=>U("span",{class:Ul[e.value]||"acci",html:zl[e.value]||Er,data:e.beat===void 0?{pitch:e.pitch}:{beat:fe(e.beat+1),pitch:e.pitch,part:e.part,event:Ge(e.event)}}),ledge:e=>U("svg",{class:`${e.rows<0?"up":"down"}-ledge ledge`,viewBox:`0 -0.5 4.4 ${Mr(e.rows)}`,preserveAspectRatio:"xMidYMin",style:`height: ${Mr(e.rows)*.125}em;`,html:`
            <line x1="0" x2="4.4" y1="0" y2="0"></line>
            <line x1="0" x2="4.4" y1="2" y2="2"></line>
            <line x1="0" x2="4.4" y1="4" y2="4"></line>
            <line x1="0" x2="4.4" y1="6" y2="6"></line>
            <line x1="0" x2="4.4" y1="8" y2="8"></line>
        `,data:{beat:fe(e.beat+1),pitch:e.pitch}}),note:e=>U("data",{class:`${e.stemup?"up-note":"down-note"} ${e.top?"top-note":""} ${e.bottom?"bottom-note":""} note`,style:e.stemHeight?`--stem-height: ${e.stemHeight};`:void 0,html:e.stave.getNoteHTML(e.pitch,e.dynamic,e.duration),data:{beat:fe(e.beat+1),pitch:e.pitch,duration:fe(e.duration),part:e.part,beam:e.beam&&Ge(e.beam),event:Ge(e.event)}}),beam:e=>U("svg",{class:`${e.stemup?"up":"down"}-beam beam`,viewBox:`0 ${(e.range>0?-e.range:0)-.5} 1 ${Mr(e.range)+1}`,preserveAspectRatio:"none",style:`height: ${(Mr(e.range)+.5)*.125}em; align-self: ${e.range>0?"end":"start"};`,html:`<path class="beam-path" d="M0,${-.5*Ie} L1,${-e.range-.5*Ie} L1,${-e.range+.5*Ie} L0,${.5*Ie} Z"></path>`,data:{beat:fe(e.beat+1),pitch:e.pitch,duration:fe(e.duration),part:e.part,events:Wt(t=>Ge(t.event),e).join(" ")}}),tie:e=>U("svg",{class:`${e.stemup?"down":"up"}-tie tie`,viewBox:"0 0 1 1",preserveAspectRatio:"none",html:'<path class="tie-path" transform="translate(0, 0.14) scale(1 0.6)" d="M0.979174733,0.0124875307 C0.650597814,1.1195554 0.135029714,1.00095361 0.0165376402,0.026468657 C0.0113570514,0.0135475362 0.00253387291,0.00218807553 0,0 C0.0977526897,1.29523004 0.656681642,1.37089992 1,2.43111793e-08 C0.991901367,2.43111797e-08 0.987703936,0.01248753 0.979174733,0.0124875307 Z M0.979174733,0.0124875307"></path>',data:{beat:fe(e.beat+1),pitch:e.pitch,duration:fe(e.duration),part:e.part}}),tuplet:e=>U("span",{class:`${e.stemup?"up":"down"}-tuplet tuplet`,html:te["tuplet"+e.divisor],data:{beat:fe(e.beat+1),pitch:e.pitch,duration:fe(e.duration),part:e.part},style:`--angle: ${e.angle}deg;`}),rest:e=>U("span",{class:"rest",html:Hl[e.duration.toFixed(2)]||te["rest"+(e.duration+"").replace(".","")]||"",data:{beat:fe(e.beat+1),pitch:e.pitch,duration:fe(e.duration),part:e.part},"aria-hidden":"true"}),default:function(e){return function(t){e[t.type]||(e[t.type]=!0,console.log(t),console.error('Scribe: symbol type "'+t.type+'" not rendered'))}}({})});function Kl(e,t){let r=uo(t);return r&&e.push(r),e}function ho(e,t){return e.push(U("div",{class:`${t.stave.type}-stave stave ${t.error?"error ":""}bar`,data:{beat:t.beat,duration:t.duration,count:t.count},children:t.symbols.reduce(Kl,[])})),e}function Xl(e,t){if(!(e==="stave"||e==="event"||e==="sequence"||e==="beam"))return t}function Ql(e){let t=e.symbols.filter(r=>r.type==="chord"||r.type==="note");return JSON.stringify(t,Xl)}function rt(e,t){e.symbols=e.symbols.filter(r=>r.type==="doublebarline"||r.type==="clef").concat([{type:"BARREPEAT",count:t,duration:e.duration}])}function Ir(e,t,r){let i=Ql(r);switch(t.length){case 1:break;case 2:break;case 3:{i===t[0]&&i===t[1]&&i===t[2]&&r.symbols.filter(o=>o.type!=="clef"&&o.type!=="timesig").find(o=>o.type!=="rest")?(rt(e[e.length-2],1),rt(e[e.length-1],1),rt(r,1)):(i!==t[1]||t[0]!==t[2])&&(t.length=2);break}case 4:{i===t[0]&&i===t[1]&&i===t[2]&&i===t[3]?(rt(r,1),t.length=3):(i!==t[1]||t[0]!==t[2]||i!==t[3])&&(t.length=2);break}case 5:{i===t[1]&&i===t[3]&&t[0]===t[2]&&t[0]===t[4]?(e.length-=2,rt(e[e.length-1],2),rt(r,2)):t.length=4;break}case 6:break;case 7:{i===t[1]&&i===t[3]&&t[0]===t[2]&&t[0]===t[4]?(e.length-=1,rt(r,2),t.length=5):t.length=1;break}}for(t.unshift(i);t.length>8;)t.pop()}function Fa(e,t,r){let i=e.getPartIndex(r[2]),o=t[i]||(t[i]=[]);t[i].push(r)}function Sa(e,t,r=De){let i=[],o=[],h=[],u=0,a=[],c={},l=0,d=0,n,s,f,p;for(f of e){for(;f[0]>=u+n;){let g=Kt(i.length+1,u,n,s,t,l,a,c,p,r);Ir(i,h,g),i.push(g),u=u+n,a=[],c={};let b=-1;for(;o[++b];)Fa(t,c,o[b]),_e(o[b])<u+n&&o.splice(b--,1)}switch(f[1]){case"note":{Fa(t,c,f),_e(f)>u+n&&o.push(f),d<_e(f)&&(d=_e(f));break}case"sequence":{f.events===e.events&&(p=f),d<_e(f)&&(d=_e(f));break}case"key":f[0]!==u&&new TypeError('Scribe: "key" event must occur at bar start – event ['+f.join(", ")+"] is on beat "+(f[0]-u)+" of bar"),l=Tr(f[2]);case"meter":n=f[2],s=f[3],f[0]!==u&&console.log("TODO");default:a.push(f)}}for(;o.length;){let g=Kt(i.length+1,u,n,s,t,l,a,c,p,r);Ir(i,h,g),i.push(g),u=u+n,a=[],c={};let b=-1;for(;f=o[++b];)Fa(t,c,f),_e(f)<u+n&&o.splice(b--,1)}for(;u<d-n;){let g=Kt(i.length+1,u,n,s,t,l,a,c,p,r);Ir(i,h,g),i.push(g),u=u+n,a=[],c={}}let m=Kt(i.length+1,u,n,s,t,l,a,c,p,r);return Ir(i,h,m),i.push(m),i}function Zl(e){return e[0]<=0&&e[1]==="meter"}function Jl(e){return e[0]<=0&&e[1]==="key"}function La(e,t,r,i,o,h=De){let u=e.events;!u.find(Zl)&&i&&u.unshift([0,"meter",i[2],i[3]]),!u.find(Jl)&&r&&u.unshift([0,"key",r]);let l=new $t(u,e.sequences,e.name),d=Br.create(t||"treble"),n=d.pitched?Yi(Array.from(l)):null,s=[],f=[];return h.swingAsStraight8ths&&f.push("Swing 8ths"),h.swingAsStraight16ths&&f.push("Swing 16ths"),f.length&&s.push(U("p",{class:"instruction",html:f.join(", ")})),Sa(l,d,h).reduce(ho,s)}var po=Object.assign,Yl=Object.defineProperties,jl=new URL("shadow.css",import.meta.url),Gr=X.of(),Vl=[],mo=new ResizeObserver(e=>{for(let t of e)z(t.target).shadowRoot.querySelectorAll(".beam").forEach(la)}),U0=Yl(en("scribe-music",{shadow:`<link rel="stylesheet" href="${jl}" />`,construct:function(e,t){let r=e.querySelector("link");Vl.push(i=>r.href=i),Gr.value&&(r.href=Gr.value),t.data=X.of(),t.clef=X.of("treble"),t.key=X.of("C"),t.meter=X.of([-4,"meter",4,1]),t.transpose=X.of(0),t.swingAsStraight8ths=X.of(!1),t.swingAsStraight16ths=X.of(!1),t.debug=X.of(!1),t.isSafari=navigator.userAgent.includes("AppleWebKit/")&&!navigator.userAgent.includes("Chrome/")&&!navigator.userAgent.includes("Edge/")&&!navigator.userAgent.includes("Gecko/")},connect:function(e,t){if(t.isSafari&&this.classList.add("safari"),mo.observe(this,{box:"content-box"}),!this.src){let r=this.textContent.trim();t.data.value=Je(this.type,r)}return X.frame(()=>{let r=t.data.value&&La(t.data.value,t.clef.value,t.key.value,t.meter.value,t.transpose.value,po({},De,{swingAsStraight8ths:t.swingAsStraight8ths.value,swingAsStraight16ths:t.swingAsStraight16ths.value}));e.querySelectorAll(".bar").forEach(i=>i.remove()),e.append.apply(e,r),e.querySelectorAll(".beam").forEach(la),t.debug.value&&e.querySelectorAll(".bar").forEach(i=>{let o=parseFloat(i.dataset.duration),h=0,u,a;i.querySelector(".BARREPEAT")||(i.querySelectorAll(".rest[data-duration], .note[data-duration]").forEach(c=>{u!==parseFloat(c.dataset.beat)&&(u=parseFloat(c.dataset.beat),a=parseFloat(c.dataset.duration),h+=a)}),Math.round(h/.0625)!==Math.round(o/.0625)&&i.classList.add("error"))})})},disconnect:function(){mo.unobserve(this)}},{clef:{attribute:function(e){this.clef=e},get:function(){return z(this).clef.value},set:function(e){if(!Br[e]){console.warn('<scribe-music> Attempt to set invalid clef="'+e+'" ignored');return}z(this).clef.value=e}},key:{attribute:function(e){this.key=e===""?"C":e},get:function(){return z(this).key.value},set:function(e){let t=z(this);if(typeof e!="string"||!/^[A-G][#b♯♭]?$/.test(e)){console.warn('<scribe-music> Attempt to set invalid key="'+e+'" ignored');return}t.key.value=e.replace(/[#b]$/,r=>r==="#"?"♯":"♭")}},meter:{attribute:function(e){this.meter=e===""?"4/4":e},get:function(){return Gi(z(this).meter.value)},set:function(e){z(this).meter.value=po([0],Ii(e))}},transpose:{attribute:function(e){this.transpose=e},get:function(){return z(this).transpose.value},set:function(e){z(this).transpose.value=typeof e=="number"?Math.round(e):parseInt(e,10)}},type:{attribute:function(e){this.type=e},writable:!0,value:"application/json"},src:{attribute:function(e){this.src=e},get:function(){return z(this).src},set:function(e){let t=z(this);t.src=e;let r=new URL(e,window.location);if(window.location.origin===r.origin&&window.location.pathname===r.pathname){let i=this.getRootNode().getElementById(r.hash.slice(1));if(!i)throw new Error('<scribe-music> src script "'+e+'" not found in document');this.data=JSON.parse(i.textContent)}else Oi(this.type,r.href).then(i=>this.data=i)},default:null},data:{get:function(){return z(this).data.value},set:function(e){z(this).data.value=e},default:null},swing:{attribute:function(e){z(this).swingAsStraight8ths.value=e!==null}},shuffle:{attribute:function(e){z(this).swingAsStraight16ths.value=e!==null}},debug:{attribute:function(e){this.debug=e!==null},get:function(){return z(this).debug.value},set:function(e){z(this).debug.value=!!e}}},null,"github.com/stephband/scribe/"),{stylesheet:{set:e=>Gr.value=e,get:()=>Gr.value}});export{U0 as default};
//# sourceMappingURL=element.js.map

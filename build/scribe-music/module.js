/* Scribe 
   0.3.1
   By Stephen */

var wa=Object.defineProperty;var Kr=(e,t)=>{for(var r in t)wa(e,r,{get:t[r],enumerable:!0})};var Qr=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var xe=(e,t,r)=>(Qr(e,t,"read from private field"),r?r.call(e):t.get(e)),nt=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},Me=(e,t,r,u)=>(Qr(e,t,"write to private field"),u?u.call(e,r):t.set(e,r),r);function le(){}var Ue;function Ea(e,t){let r=0;for(;e[--r];);for(e[r]=t,r=-1;t[++r];)if(t[r]===e)return;t[r]=e}function Ca(e,t){let r=0;for(;e[--r];)e[r]=void 0;let u=Ue;Ue=e;let c=e.value=t();return Ue=u,c}var Ne,We,De,at,pe=class{constructor(t,r){nt(this,Ne,void 0);nt(this,We,void 0);nt(this,De,void 0);nt(this,at,void 0);t&&Me(this,at,t),Me(this,De,r||le)}static of(t){let r=new this;return r.value=t,r}static from(t){return new this(t)}static get evaluating(){return Ue}set value(t){if(xe(this,We)===t){Me(this,Ne,!0);return}if(Me(this,We,t),xe(this,Ne)){let r=-1;for(;this[++r];)this[r].invalidate();xe(this,De).call(this)}else Me(this,Ne,!0)}get value(){return Ue&&Ea(Ue,this),xe(this,Ne)?xe(this,We):Ca(this,xe(this,at))}each(t,r){return Me(this,De,()=>{let u=this.value;if(u===r){r=NaN;return}t(u)}),xe(this,De).call(this),this}invalidate(){if(xe(this,Ne)){Me(this,Ne,!1);let t=-1;for(;this[++t];)this[t].invalidate();xe(this,De).call(this)}return this}valueOf(){return this.value}toString(){return this.valueOf()+""}toJSON(){return this.value}};Ne=new WeakMap,We=new WeakMap,De=new WeakMap,at=new WeakMap;function ye(e){return e}function j(e,t){return function(){let u=e.apply(this,arguments),c=t[u]||t.default;if(!c)throw new Error('overload() no function defined for key "'+u+'"');return c.apply(this,arguments)}}function Ke(e){var t=new Map;return function(u){if(t.has(u))return t.get(u);var c=e(u);return t.set(u,c),c}}var ka=Array.prototype;function Na(e,t){return typeof e=="function"?e.apply(null,t):e}function Xr(e,t,r){r=r||e.length;var u=r===1?t?e:Ke(e):Ke(function(c){return Xr(function(){var p=[c];return p.push.apply(p,arguments),e.apply(null,p)},t,r-1)});return function c(p){return arguments.length===0?c:arguments.length===1?u(p):arguments.length>=r?e.apply(null,arguments):Na(u(p),ka.slice.call(arguments,1))}}var re=Xr;var _a=j(ye,{is:le,tag:le,data:function(e,t,r){for(e in r)r[e]===void 0&&delete r[e];Object.assign(t.dataset,r)},dataset:function(e,t,r){Object.assign(t.dataset,r)},html:function(e,t,r){t.innerHTML=r},text:function(e,t,r){t.textContent=r},children:function(e,t,r){t.innerHTML="",t.append.apply(t,r)},points:de,cx:de,cy:de,r:de,x:de,y:de,dx:de,dy:de,transform:de,preserveAspectRatio:de,viewBox:de,default:function(e,t,r){e in t?t[e]=r:t.setAttribute(e,r)}});function de(e,t,r){t.setAttribute(e,r)}function Ta(e,t){for(var r=Object.keys(t),u=r.length;u--;)_a(r[u],e,t[r[u]]);return e}var Mt=re(Ta,!0);var Jt="http://www.w3.org/2000/svg",Zr=document.createElement("template"),Yt=(e,t)=>t&&typeof t;function Jr(e,t=""){let r=document.createRange();return r.selectNode(e),r.createContextualFragment(t)}var ne=j(Yt,{string:function(e,t){let r=document.createElementNS(Jt,e);return r.innerHTML=t,r},object:function(e,t){let r=document.createElementNS(Jt,e);return typeof t.length=="number"?r.append.apply(r,t):Mt(r,t),r},default:e=>document.createElementNS(Jt,e)}),Ba=j(Yt,{string:function(e,t){let r=document.createElement(e);return r.innerHTML=t,r},object:function(e,t){let r=document.createElement(e);return typeof t.length=="number"?r.append.apply(r,t):Mt(r,t),r},default:e=>document.createElement(e)}),La=j(ye,{comment:function(e,t){return document.createComment(t||"")},fragment:j(Yt,{string:function(e,t,r){return r?Jr(r,t):(Zr.innerHTML=t,Zr.content.cloneNode(!0))},object:function(e,t,r){let u=r?Jr(r):document.createDocumentFragment();return typeof t.length=="number"?u.append.apply(u,t):Mt(u,t),u},default:()=>document.createDocumentFragment()}),text:function(e,t){return document.createTextNode(t||"")},circle:ne,ellipse:ne,g:ne,glyph:ne,image:ne,line:ne,rect:ne,use:ne,path:ne,pattern:ne,polygon:ne,polyline:ne,svg:ne,tspan:ne,default:Ba}),z=La;function jt(e,t,r){let u;typeof r!="string"&&r.input!==void 0&&r.index!==void 0&&(u=r,r=u.input.slice(r.index+r[0].length+(r.consumed||0)));let c=e.exec(r);if(!c)return;let p=t(c);return u&&(u.consumed=(u.consumed||0)+c.index+c[0].length+(c.consumed||0)),p}var vf=re(jt,!0);function Aa(e,t,r){throw r.input!==void 0&&r.index!==void 0&&(r=r.input),new Error('Cannot parse string "'+(r.length>128?r.length.slice(0,128)+"‚Ä¶":r)+'"')}function Ma(e,t,r){let u=-1;for(;++u<r.length;)t=r[u]!==void 0&&e[u]?e[u](t,r):t;return e.done?e.done(t,r):e.close?e.close(t,r):t}function Da(e,t,r,u){let c=jt(e,p=>Ma(t,r,p),u);return c===void 0?t.catch?t.catch(r,u):Aa(e,t,u):c}var Yr=re(Da,!0);var jr={once:!0};function it(e){return new Promise((t,r)=>{e.addEventListener("load",t,jr),e.addEventListener("error",r,jr)})}var Vr=Ke(e=>{if(!e||e.includes("undefined"))throw new Error("ERRR?");let t=z("link",{rel:"preload",as:"style",href:e}),r=it(t);return document.head.append(t),r});var en=Symbol("internals");function Pa(e){var t;if(e.attachInternals){if(t=e.attachInternals(),t.setFormValue)return t}else t={shadowRoot:elem.shadowRoot};return t.polyfillInput=z("input",{type:"hidden",name:elem.name}),elem.appendChild(t.polyfillInput),t.setFormValue=function(r){this.input.value=r},t}function Vt(e,t,r){return t[en]=e.formAssociated?Pa(t):{shadowRoot:r}}function U(e){return e[en]}var tn=Object.defineProperties,Fa={},Sa={a:HTMLAnchorElement,article:HTMLElement,dl:HTMLDListElement,p:HTMLParagraphElement,br:HTMLBRElement,fieldset:HTMLFieldSetElement,hr:HTMLHRElement,img:HTMLImageElement,li:HTMLLIElement,ol:HTMLOListElement,optgroup:HTMLOptGroupElement,q:HTMLQuoteElement,section:HTMLElement,textarea:HTMLTextAreaElement,td:HTMLTableCellElement,th:HTMLTableCellElement,tr:HTMLTableRowElement,tbody:HTMLTableSectionElement,thead:HTMLTableSectionElement,tfoot:HTMLTableSectionElement,ul:HTMLUListElement},Ia={name:{set:function(e){return this.setAttribute("name",e)},get:function(){return this.getAttribute("name")||""}},form:{get:function(){return U(this).form}},labels:{get:function(){return U(this).labels}},validity:{get:function(){return U(this).validity}},validationMessage:{get:function(){return U(this).validationMessage}},willValidate:{get:function(){return U(this).willValidate}},checkValidity:{value:function(){return U(this).checkValidity()}},reportValidity:{value:function(){return U(this).reportValidity()}}},Oa=0,rn=!1;function Ga(e){return Sa[e]||window["HTML"+e[0].toUpperCase()+e.slice(1)+"Element"]||(()=>{throw new Error('Constructor not found for tag "'+e+'"')})()}var qa=Yr(/^\s*<?([a-z][\w]*-[\w-]+)>?\s*$|^\s*<?([a-z][\w]*)\s+is[=\s]*["']?([a-z][\w]*-[\w-]+)["']?>?\s*$/,{1:(e,t)=>({name:t[1]}),2:(e,t)=>({name:t[3],tag:t[2]}),catch:function(e,t){throw new SyntaxError(`dom element() ‚Äì name must be of the form 'element-name' or 'tag is="element-name"' (`+t+")")}},null);function Ra(e,t){if(e.hasOwnProperty(t)){let r=e[t];delete e[t],e[t]=r}return e}function nn(e,t,r){let u=e.attachShadow({mode:t.mode||"closed",delegatesFocus:t.focusable||!1});if(r){let c=z("link",{rel:"stylesheet",href:r});u.append(c)}return u}function $a(e,t){return typeof t=="string"?t[0]==="#"?e.appendChild(document.getElementById(t.slice(1)).content.clone(!0)):e.innerHTML=t:e.appendChild(t.content.clone(!0)),e}function Ha(e){return!!e.attribute}function za(e){return e.set||e.get||e.hasOwnProperty("value")}function Ua(e,t){return Ha(t[1])&&(e.attributes[t[0]]=t[1].attribute),za(t[1])&&(e.properties[t[0]]=t[1]),e}function er(e,t,r,u,c=""){let{name:p,tag:l}=qa(e),a=typeof l=="string"?Ga(l):HTMLElement,{attributes:o,properties:f}=r?Object.entries(r).reduce(Ua,{attributes:{},properties:{}}):Fa;function d(){let n=Reflect.construct(a,arguments,d),i=t.mode||t.shadow?nn(n,t,u||t.stylesheet):void 0;t.shadow&&$a(i,t.shadow);let s=Vt(d,n,i);if(s.unconnected=!0,l&&(rn=!0),t.construct&&t.construct.call(n,i,s),f&&Object.keys(f).reduce(Ra,n),i){let h=i.querySelectorAll('link[rel="stylesheet"]');if(h.length){let m=z("style","*:not(:has(slot:not([name]))) { display: none !important; }");i.append(m),s.stylesheetsLoadPromise=Promise.all(Array.from(h,it)).finally(()=>m.remove())}}return n}return u&&(Vr(u),c=c),d.prototype=Object.create(a.prototype,f),f&&f.value&&(d.formAssociated=!0,tn(d.prototype,Ia),(t.enable||t.disable)&&(d.prototype.formDisabledCallback=function(n){let i=U(this),s=i.shadowRoot;return n?t.disable&&t.disable.call(this,s,i):t.enable&&t.enable.call(this,s,i)}),t.reset&&(d.prototype.formResetCallback=function(){let n=U(this),i=n.shadowRoot;return t.reset.call(this,i,n)}),t.restore&&(d.prototype.formStateRestoreCallback=function(){let n=U(this),i=n.shadowRoot;return t.restore.call(this,i,n)})),o&&(d.observedAttributes=Object.keys(o),d.prototype.attributeChangedCallback=function(n,i,s){return o[n].call(this,s)}),d.prototype.connectedCallback=function(){let n=U(this),i=n.shadowRoot;n.polyfillInput&&elem.appendChild(n.polyfillInput),n.unconnected&&(t.load&&n.stylesheetsLoadPromise?n.stylesheetsLoadPromise.then(()=>t.load.call(this,i,n)):t.load&&Promise.resolve().then(()=>t.load.call(this,i,n)),delete n.unconnected),t.connect&&t.connect.call(this,i,n)},t.disconnect&&(d.prototype.disconnectedCallback=function(){let n=U(this),i=n.shadowRoot;return t.disconnect.call(this,i,n)}),window.console&&window.console.log("%c<"+(l?l+" is="+p:p)+">%c "+c,"color:#3a8ab0;font-weight:600;","color:#888888;font-weight:400;"),window.customElements.define(p,d,l&&{extends:l}),l&&!rn&&document.querySelectorAll('[is="'+p+'"]').forEach(n=>{f&&tn(n,f);let i=t.construct&&t.construct.length>Oa?nn(n,t,u||t.stylesheet):void 0,s=Vt(d,n,i);t.construct&&t.construct.call(n,i);let h;for(h in o){let m=n.attributes[h];m&&o[h].call(n,m.value)}t.connect&&t.connect.apply(n)}),d}function tr(e){return function(){return arguments[e]}}function me(){return this}var an=Object.create,Wa=Object.freeze,Dt=Wa(an(an(Object.prototype,{at:{value:le},shift:{value:le},push:{value:le},forEach:{value:le},join:{value:function(){return""}},every:{value:function(){return!0}},filter:{value:me},find:{value:le},findIndex:{value:function(){return-1}},flat:{value:me},flatMap:{value:me},includes:{value:function(){return!1}},indexOf:{value:function(){return-1}},map:{value:me},reduce:{value:tr(1)},sort:{value:me},each:{value:me},pipe:{value:ye},start:{value:me},stop:{value:me},done:{value:me},valueOf:{value:function(){return null}}}),{length:{value:0}}));function rr(e,t){return(t%e+e)%e}var sn=re(rr);var on=sn(12);var st={C:0,"C‚ôØ":1,"C#":1,"D‚ô≠":1,Db:1,D:2,"D‚ôØ":3,"D#":3,"E‚ô≠":3,Eb:3,E:4,F:5,"F‚ôØ":6,"F#":6,"G‚ô≠":6,Gb:6,G:7,"G‚ôØ":8,"G#":8,"A‚ô≠":8,Ab:8,A:9,"A‚ôØ":10,"A#":10,"B‚ô≠":10,Bb:10,B:11},Ka=/^([A-G][‚ô≠‚ôØ#b]?)(-?\d)$/,Qa=/^[A-G][‚ô≠‚ôØ#b]?/,Xa=/-?\d$/;function ae(e){if(typeof e=="number")return e;var t=Ka.exec(e);return(parseInt(t[2],10)+1)*12+st[t[1]]}function nr(e){return typeof e=="number"?on(e):st[Qa.exec(e)[0]]}var ar=["C","C‚ôØ","D","E‚ô≠","E","F","F‚ôØ","G","G‚ôØ","A","B‚ô≠","B"];function ir(e){return ot(e)+Pt(e)}function ot(e){return ar[on(e)]}function Pt(e){return typeof e=="number"?Math.floor(e/12)-1:Number(st[(Xa.exec(name)||Dt)[0]])}function Za(e,t,r){let u=e(t),c=e(r);return c===u?0:u>c?1:-1}var sr=re(Za,!0);function Ja(e,t){return t[e]}var we=re(Ja,!0);function or(e,t){return t+e}function Ee(e){return rr(12,e)}function Qe(e,t){return e>t?1:e<t?-1:0}var fr=[];function ft(e){fr.length=0;for(var t=e.length,r,u;t--;)r=e[t],u!==r[0]&&(u=r[0],fr.push(u));return fr.sort(Qe)}function Ya(e,t,r){return r.indexOf(e)===t}function cr(e,t){return e.map(r=>Ee(r+t)).filter(Ya).sort(Qe)}function fn(e,t){return cr(e,t*7)}var lr=[{name:"C",symbol:"C‚àÜ",spellings:[0,1,0,-1,0,0,1,0,-1,0,-1,0]},{name:"D‚ô≠",symbol:"D‚ô≠‚àÜ",spellings:[0,-1,0,-1,-1,0,-1,0,-1,0,-1,-1]},{name:"D",symbol:"D‚àÜ",spellings:[0,1,0,1,0,0,1,0,1,0,-1,0]},{name:"E‚ô≠",symbol:"E‚ô≠‚àÜ",spellings:[0,-1,0,-1,0,0,-1,0,-1,0,-1,-1]},{name:"E",symbol:"E‚àÜ",spellings:[0,1,0,1,0,1,1,0,1,0,1,0]},{name:"F",symbol:"F‚àÜ",spellings:[0,-1,0,-1,0,0,1,0,-1,0,-1,0]},{name:"G‚ô≠",symbol:"G‚ô≠‚àÜ",spellings:[0,-1,0,-1,-1,0,-1,0,-1,0,-1,-1]},{name:"G",symbol:"G‚àÜ",spellings:[0,1,0,-1,0,0,1,0,1,0,-1,0]},{name:"A‚ô≠",symbol:"A‚ô≠‚àÜ",spellings:[0,-1,0,-1,-1,0,-1,0,-1,0,-1,-1]},{name:"A",symbol:"A‚àÜ",spellings:[0,1,0,1,0,0,1,0,1,0,1,0]},{name:"B‚ô≠",symbol:"B‚ô≠‚àÜ",spellings:[0,-1,0,-1,0,0,-1,0,-1,0,-1,0]},{name:"B",symbol:"B‚àÜ",spellings:[1,1,0,1,0,1,1,0,1,0,1,0]}],cn=[0,2,4,5,7,9,11],ln={"F‚ô≠":-8,"C‚ô≠":-7,"G‚ô≠":-6,"D‚ô≠":-5,"A‚ô≠":-4,"E‚ô≠":-3,"B‚ô≠":-2,F:-1,C:0,G:1,D:2,A:3,E:4,B:5,"F‚ôØ":6,"C‚ôØ":7,"G‚ôØ":8,"D‚ôØ":9,"A‚ôØ":10,"E‚ôØ":11,"B‚ôØ":12};function un(e){return typeof e=="number"?e:ln[e]}function hn(e){return typeof e=="number"?cr(cn,e):fn(cn,ln[e])}var dn=/([ABCDEFG][b#‚ô≠‚ôØùÑ´ùÑ™]?)([^\/]*)(?:\/([ABCDEFG]))?/;var pn={"‚àÜ":[0,2,4,7,9,11],"‚àÜ7":[0,2,4,7,9,11],"-":[0,3,7],"-7":[0,2,3,5,7,9,10],"sus‚ô≠9":[0,1,5,7,10],"7sus‚ô≠9":[0,1,5,7,10],"‚àÜ‚ôØ11":[0,2,4,6,7,9,11],"‚àÜ(‚ôØ11)":[0,2,4,6,7,9,11],7:[0,4,7,10],13:[0,4,7,9,10],sus:[0,2,5,7,10],"7sus":[0,2,5,7,10],"-‚ô≠6":[0,2,3,5,7,8],√∏:[0,3,6,10],"-‚àÜ":[0,2,3,5,7,9,11],"13sus‚ô≠9":[0,1,5,7,9,10],"‚àÜ+":[0,2,4,6,8,9,11],"‚àÜ‚ôØ5":[0,2,4,6,8,9,11],"7‚ôØ11":[0,2,4,6,7,9,10],"7‚ô≠13":[0,2,4,7,8,10],"√∏(9)":[0,2,3,6,10],"7alt":[0,1,3,4,6,8,10],"‚àÜ‚ô≠6":[0,4,7,8,11]};function ja(e){return e.replace(/(maj)|(min)/,(t,r,u)=>r?"‚àÜ":u?"-":"")}function Va(e){var t=(dn.exec(e)||Dt)[1];return st[t]}function ei(e){let t=ja(e);return(dn.exec(t)||empty)[2]}function mn(e){let t=Va(e),r=ei(e);return pn[r]?pn[r].map(u=>Ee(u+t)).sort(Qe):[]}var ur=j(we(1),{chord:e=>mn(e[2]),note:e=>[ae(e[2])%12],default:e=>[]});var gn=j(we(1),{chord:e=>e[3],lyric:e=>e[3],note:e=>e[4],sequence:e=>e[4],default:e=>0});var hr=[];function ct(e,t){hr.length=0;let r,u=-1;for(;(r=e[++u])&&!(r[0]>t);)(r[0]===t||r[0]+gn(r)>t)&&hr.push(r);return hr}var ti=[1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12,1/12],bn=[10,5,8,10,6,10,8,10,7,10,8,4],ri=bn.reduce(or),ni=bn.map(e=>e/ri).map(xn),ai=[.1,.04,.1,.04,.1,.1,.04,.1,.04,.1,.04,.1].map(xn);function xn(e,t,r){return r.slice(12-t).concat(r.slice(0,12-t))}function vn(e,t){for(var r=0,u=0;u<e.length;++u)r+=Math.log(t[e[u]]);return r}function ii(e,t,r,u){var c=[],p=[],l=[],a=[],o=0,f=-1,d,n,i;for(p[o]=c;++f<12;)c[f]=Math.log(t[f])+vn(e[0],u[f]),l[f]=[f];for(;++o<e.length;){for(c=[],n=[],p[o]=c,d=-1;++d<12;){for(a.length=0,a[0]=-1/0,f=-1;++f<12;)i=p[o-1][f]+Math.log(r[f][d])+vn(e[o],u[d]),i>a[0]&&(a[0]=i,a[1]=f);c[d]=a[0],n[d]=l[a[1]].concat(d)}l=n}for(a.length=0,a[0]=-1/0,f=-1;++f<12;)i=p[e.length-1][f],i>a[0]&&(a[0]=i,a[1]=f);return l[a[1]]}function si(e,t){return e.push.apply(e,t),e}function pr(e){let t=ft(e),r=t.length,u=[],c=-1,p,l;for(;++c<r;){p=t[c],l=ct(e,p);var a=l.map(ur);if(a.find(o=>o.find(Number.isNaN)!==void 0)!==void 0)throw console.log(l),new Error("toNotes has returned NaN for beatEvents");u.push(l.map(ur).reduce(si,[]))}return r?ii(u,ti,ni,ai):[]}function yn(e){let t=e.filter(c=>/^note|chord$/.test(c[1])),r=ft(t),u=pr(t);return r.map((c,p)=>[c,u[p]])}function wn(e,t){let r=e.length;for(;r--;)if(e[r][0]<=t)return e[r][1];return e[0][1]}var lt={};Kr(lt,{bass:()=>li,chords:()=>ci,drum:()=>hi,percussion:()=>pi,piano:()=>ui,treble:()=>dr});var oi={"-2":"ùÑ´","-1":"‚ô≠",0:"",1:"‚ôØ",2:"ùÑ™"},fi=/^[A-G][b#‚ô≠‚ôØùÑ´ùÑ™]?(-?\d)?$/;function Pe(e,t,r=0){let u=lr[Ee(e+r)],c,p,l;if(typeof t[2]=="string"){let[f,d]=fi.exec(t[2])||[t[2]];d?(c=ae(t[2])+r,p=u.spellings[Ee(c)],l=Pt(c-p)):(c=nr(t[2])+r,p=u.spellings[Ee(c)],l="")}else c=t[2]+r,p=u.spellings[Ee(c)],l=Pt(c-p);let a=ar[Ee(c-p)],o=oi[p];return a+o+l}var En=Math.floor,ci={clef:"chords",getSpelling:Pe},dr={clef:"treble",topPitch:"G5",centerPitch:"B4",bottomPitch:"D4",getSpelling:Pe,pitches:["A6","G6","F6","E6","D6","C6","B5","A5","G5","F5","E5","D5","C5","B4","A4","G4","F4","E4","D4","C4","B3","A3","G3","F3","E3","D3","C3"],yRatioToPitch:function(e){let t=En(e*this.pitches.length);return t<0?this.pitches[0]:t>this.pitches.length-1?this.pitches[this.pitches.length-1]:this.pitches[t]},movePitch:function(e,t){let r=ae(this.minPitch),u=ae(this.maxPitch),c=ae(e)+t;return c>=r&&c<=u?c:void 0},get minPitch(){return this.pitches[this.pitches.length-1]},get maxPitch(){return this.pitches[0]}},li={clef:"bass",topPitch:"B3",centerPitch:"D3",bottomPitch:"F2",getSpelling:Pe},ui={clef:"piano",getSpelling:Pe,topPitch:"G5",centerPitch:"B4",bottomPitch:"D4",getPart:e=>/[012]$|[AC-G][b#‚ô≠‚ôØùÑ´ùÑ™]*3$/.test(e)?{part:"lower",centerPitch:"D3",centerRow:"stave-lower"}:{centerPitch:"B4",centerRow:"stave-upper"}},hi={clef:"drum",getSpelling:(e,t,r)=>t[1]==="note"?ir(ae(t[2])):Pe(e,t,r),slashedBlack:"ÓÉè",xBlack:"ÓÇ©",xOrnate:"ÓÇ™",triangleUpBlack:"ÓÇæ",diamondBlack:"ÓÉõ",circledBlack:"ÓÉ§",pitches:[null,null,null,null,55,57,49,42,51,50,48,38,45,43,41,36,35,44,null,null,null,null,null,null,null],yRatioToPitch:function(e){let t=En(e*this.pitches.length),r=t<4?4:t>17?17:t;return this.pitches[r]},pitches2:[44,35,36,41,43,45,47,48,56,38,37,50,54,51,53,42,46,49,57,55,52],movePitch:function(e,t){let r=ae(e),u=this.pitches2.indexOf(r);if(u<0)return;let c=u+t;if(!(c<0||c>=this.pitches2.length))return this.pitches2[c]},heads:{B1:1,D2:1,"E‚ô≠2":"head[x]","F‚ôØ2":"xBlack","G‚ôØ2":"xBlack","A‚ô≠2":"xBlack","B‚ô≠2":"xCircle","C‚ôØ3":"xCircle","E‚ô≠3":"xBlack",E3:"xCircle",F3:"head[x]","F‚ôØ3":"head[x]",G3:"xCircle","G‚ôØ3":"head[v]","A‚ô≠3":"triangleUpBlack",A3:"xCircle","B‚ô≠3":"head[v]",B3:"xBlack"},getHead:function(e,t,r){return t<.02?this.heads[e]+"Ghost":this.heads[e]},centerPitch:"B4",getPart:function(e){return"B1 C1 A‚ô≠2 G‚ôØ2".includes(e)?{part:"feet",stemDirection:"down",tieDirection:"down",centerRow:"stave-lower"}:{stemDirection:"up",tieDirection:"up",centerRow:"stave-upper"}},getRowDiff:function(e,t){return .1}},pi={clef:"percussion",topPitch:"C4",centerPitch:"B4",bottomPitch:"A4",getSpelling:(e,t,r)=>t[1]==="note"?ir(ae(t[2])):Pe(e,t,r)};var ut=/b|‚ô≠/,ht=/#|‚ôØ/;var ie=Object.assign,{abs:Cn,ceil:pl,floor:dl}=Math,Xe=[0,2,4,5,7,9,11],kn=["F‚ôØ","C‚ôØ","G‚ôØ","D‚ôØ","A‚ôØ","E‚ôØ","B‚ôØ","B‚ô≠","E‚ô≠","A‚ô≠","D‚ô≠","G‚ô≠","C‚ô≠","F‚ô≠"];function di(e,t){let r=kn.indexOf(e.pitch),u=kn.indexOf(t.pitch);return r>u?1:r<u?-1:0}function gr(e,t){return t&&t.stemDirection||(ae(e)<ae(t.pitch)?"down":"up")}function mi(e,t,r){let u=-1;for(;e[++u]&&e[u]<=t;);return r>=e[u]}function Nn(e){return e[1]==="lyric"?e[3]:e[4]}function gi(e,t,r){let u=e[r],c=gr(t.centerPitch,u);return e.splice(r,0,ie({},u,{type:"stem",stemDirection:c}),ie({},u,{type:"tail",stemDirection:c})),2}var _n=["C","D","E","F","G","A","B"];function Fe(e,t,r){if(e.getRowDiff)return e.getRowDiff(t,r);let u=t[0],c=parseInt(t[t.length-1],10),p=r[0],l=parseInt(r[r.length-1],10),a=_n.indexOf(u);return _n.indexOf(p)-a+(l-c)*7}function Tn(e,t,r,u){let c=e[0].part;if(r.length===1){if(r[0]>=u)throw new Error("Last beam index ("+r[0]+") cant be greater than n ("+u+")");return gi(e,t,r[0])}let p=e[r[0]]&&e[r[0]].stemDirection?e[r[0]].stemDirection:r.map(y=>Fe(t,t.centerPitch,e[y].pitch)).reduce((y,g)=>y+g,0)/r.length<0?"up":"down",l=[],a=[],o=-1,f=0,d=0,n,i,s,h;for(;r[++o]!==void 0;)n=r[o],i=e[n],s=Fe(t,t.centerPitch,i.pitch),i.stemDirection=p,i.tieDirection=p==="up"?"down":"up",o<(r.length-1)/2?f+=s/Math.floor(r.length/2):o>(r.length-1)/2&&(d+=s/Math.floor(r.length/2)),h&&h.beat===i.beat?(h.range=Fe(t,h.pitch,i.pitch),h.pitch=h.range<0?h.stemDirection==="up"?h.pitch:i.pitch:h.stemDirection==="up"?i.pitch:h.pitch):(h=ie({},i,{type:"stem"}),l.push(h)),i.tie==="begin"&&a.push(ie({},i,{type:"tie",beat:i.beat,updown:i.tieDirection,event:i.event}));let m=l[0],v=l[l.length-1],w=Fe(t,m.pitch,v.pitch),N=d-f,L=Cn(N)>Cn(.75*w)?.75*w:N;return l.forEach((y,g)=>{y.beamY=p==="down"?-L*g/(l.length-1)+Fe(t,m.pitch,y.pitch):L*g/(l.length-1)-Fe(t,m.pitch,y.pitch)}),e.splice(n,0,...l),e.splice(n,0,ie({},m,{type:"beam",beat:m.beat,duration:v.beat-m.beat,range:L,updown:p,stems:l})),e.splice(n,0,...a),l.length+a.length+1}function vi(e,t){let r=e[0]&&e[0].part,u=t.stave,c=t.key.reduce((d,n,i)=>{let s=n-Xe[i];if(s!==0){let h=ot(Xe[i]),m=10;for(;m--;)d[h+m]=s}return d},{}),p=0,l=-1,a,o,f;for(;a=e[++l];){if(f=a.beat+a.duration,a.type!=="head")continue;a.beat>p&&e.splice(l++,0,{beat:p,type:"rest",pitch:"",part:r,duration:a.beat-p}),f>p&&(p=f);let d=ht.test(a.pitch)?1:ut.test(a.pitch)?-1:void 0,n=a.pitch[0]+a.pitch.slice(-1);!(a.beat===0&&a.tie&&a.tie!=="begin")&&d!==c[n]&&(c[n]=d,e.splice(l++,0,ie({},a,{type:"acci",value:d||0})));let i=Fe(t.stave,t.stave.topPitch,a.pitch);if(i>0?e.splice(l++,0,ie({},a,{type:"upledger",rows:i})):(i=Fe(t.stave,a.pitch,t.stave.bottomPitch),i>0&&e.splice(l++,0,ie({},a,{type:"downledger",rows:i}))),o&&o.length&&(a.duration>=1||a.duration.toFixed(2)==="0.67"||mi(t.breaks,e[o[o.length-1]].beat,a.beat))&&(l+=Tn(e,t.stave,o,l),o=void 0),a.duration<4)if(a.duration<1&&a.duration.toFixed(2)!=="0.67")o?o.push(l):o=[l];else{let s=gr(u.centerPitch,a);e.splice(l++,0,ie({},a,{type:"stem",stemDirection:s})),a.tie==="begin"&&e.splice(l++,0,ie({},a,{type:"tie",beat:a.beat,updown:s==="up"?"down":"up",event:a.event}))}else if(a.tie==="begin"||a.tie==="middle"){let s=gr(u.centerPitch,a);e.splice(l++,0,ie({},a,{type:"tie",beat:a.beat,updown:s==="up"?"down":"up",event:a.event}))}}return o&&o.length&&(l+=Tn(e,t.stave,o,l),o=void 0),p<t.duration&&e.push({type:"rest",beat:p,duration:t.duration-p,pitch:"",part:r}),e}function bi(e){let t={clef:{name:"treble",stemDirectionNote:"B4"}},r=Object.values(e.symbols.reduce((u,c)=>(u[c.part]||(u[c.part]=[]),u[c.part].push(c),u),{}));return r.length===0&&(r[0]=[]),r.forEach(u=>vi(u,e,t.clef.stemDirectionNote)),e.symbols.length=0,r.reduce((u,c)=>(u.push.apply(u,c),u),e.symbols),e}function mr(e,t,r,u,c){let p={beat:e,duration:u[2],breaks:u[2]===4?[2]:u[2]===3?[1,2]:[2],symbols:[],stave:t,key:r,meter:u};u[0]===e&&p.symbols.push({type:"timesig",beat:0,numerator:u[2]/u[3],denominator:4/u[3],event:u});let l=-1,a,o;for(;(a=c[++l])&&(o=a.event)&&o[0]<p.beat+u[2];){let f=o[0]+o[4]-p.beat;f>p.duration?p.symbols.push(ie({},a,{beat:0,duration:p.duration,head:t.getHead&&t.getHead(a.pitch,o[3],p.duration),tie:"middle"},t.getPart&&t.getPart(a.pitch))):(p.symbols.push(ie({},a,{beat:0,duration:f,head:t.getHead&&t.getHead(a.pitch,o[3],f),tie:"end"},t.getPart&&t.getPart(a.pitch))),c.splice(l,1),--l)}return p}var xi={"-2":"ùÑ´","-1":"‚ô≠",0:"",1:"‚ôØ",2:"ùÑ™"};function yi(e,t,r,u,c,p){let l=[],a=[];c=ct(e,0).find(i=>i[1]==="meter")||c;let f=mr(0,r,u,c,l);a.push(f),f.symbols.unshift.apply(f.symbols,u.map((i,s)=>i-Xe[s]&&{type:"acci",pitch:ot(Xe[s])+xi[i-Xe[s]],value:i-Xe[s]}).filter(i=>!!i).sort(di)),f.symbols.unshift({type:"clef",beat:0,clef:r.clef});let d=-1,n;for(;n=e[++d];){if(n[1]==="meter"){n[0]!==f.beat&&new TypeError('Scribe: "meter" event must occur at bar start ‚Äì event ['+n.join(", ")+"] is on beat "+(n[0]-f.beat)+" of bar");continue}if(n[1]!=="note"&&n[1]!=="chord"&&n[1]!=="lyric")continue;for(;n[0]>=f.beat+f.duration;){if(n[0]===f.beat+f.duration){let m=d-1;for(;e[++m]&&e[m][0]===n[0];)e[m][1]==="meter"&&(c=e[m])}f=mr(f.beat+f.duration,r,u,c,l),a.push(f)}let i=n[0]-f.beat,s=t&&wn(t,n[0]),h=n[0]+Nn(n)>f.beat+f.duration?f.beat+f.duration-n[0]:Nn(n);if(n[1]==="note"){let m=r.getSpelling(s,n,p),v=ie({type:"head",beat:i,duration:h,pitch:m,transpose:p,head:r.getHead&&r.getHead(m,n[3],h),event:n},r.getPart&&r.getPart(m));f.symbols.push(v),n[4]>h&&(v.tie="begin",l.push(v))}else n[1]==="chord"?f.symbols.push({type:"chord",beat:i,duration:h,transpose:p,root:r.getSpelling(s,n,p),extension:n[3],event:n}):f.symbols.push({type:"lyric",beat:i,duration:h,value:n[2],event:n})}for(;l.length;)f=mr(f.beat+f.duration,r,u,c,l),a.push(f);return a}function vr(e,t,r,u,c){e.sort(sr(we(0)));let p=t?lt[t]:dr,l=t==="drum"?null:yn(e),a=un(r),o=hn(a*7+c);return yi(e,l,p,o,u,c).map(bi)}function br(e){var t={};return function(u){return u in t?t[u]:t[u]=e(u)}}function Ft(e){return function(r,...u){var c=e[r]||e.default;return c&&c.apply(this,u)}}var wi={xml:"application/xml",html:"text/html",svg:"image/svg+xml"};function Bn(e,t){if(t){var r=wi[e.toLowerCase()]||e,u;try{u=new window.DOMParser().parseFromString(t,r)}catch{return}if(!u||u.getElementsByTagName("parsererror").length)throw new Error("Invalid "+e.toUpperCase()+": "+t);return u}}function Ln(e){return Bn("html",e)}function An(e){return Bn("svg",e)}var _e=Object.assign,Ze={headers:function(e){return{}},body:ye},Ei=Ft({"application/x-www-form-urlencoded":function(e){return _e(e,{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"})},"application/json":function(e){return _e(e,{"Content-Type":"application/json; charset=utf-8","X-Requested-With":"XMLHttpRequest"})},"multipart/form-data":function(e){return _e(e,{"Content-Type":"multipart/form-data","X-Requested-With":"XMLHttpRequest"})},"audio/wav":function(e){return _e(e,{"Content-Type":"audio/wav","X-Requested-With":"XMLHttpRequest"})},"image/png":function(e){return _e(e,{"Content-Type":"image/png","X-Requested-With":"XMLHttpRequest"})},"image/jpg":function(e){return _e(e,{"Content-Type":"image/jpg","X-Requested-With":"XMLHttpRequest"})},"image/jpeg":function(e){return _e(e,{"Content-Type":"image/jpeg","X-Requested-With":"XMLHttpRequest"})},default:function(e){return _e(e,{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"})}}),Ci=Ft({"application/json":function(e){return e.get?ki(e):JSON.stringify(e)},"application/x-www-form-urlencoded":function(e){return e.get?Dn(e):Pn(e)},"multipart/form-data":function(e){return e.get?e:Ni(e)},default:ye});function ki(e){return JSON.stringify(Array.from(e.entries()).reduce(function(t,r){return t[r[0]]=r[1],t},{}))}function Dn(e){return new URLSearchParams(e).toString()}function Pn(e){return Object.keys(e).reduce((t,r)=>(t.append(r,e[r]),t),new URLSearchParams)}function Ni(e){throw new Error("TODO: dataToFormData(data)")}function _i(e,t){return t instanceof FormData?e+"?"+Dn(t):e+"?"+Pn(t)}function Ti(e,t,r,u){let c=typeof r=="string"?r:r&&r["Content-Type"]||"application/json",p=Ei(c,_e(Ze.headers&&t?Ze.headers(t):{},typeof r=="string"?{}:r)),l={method:e,mode:"cors",headers:p,credentials:"same-origin",signal:u&&u.signal};return e!=="GET"&&(l.body=Ci(c,Ze.body?Ze.body(t):t)),l}function St(e){return e.blob()}function Bi(e){return e.json().catch(t=>{throw new Error("Cannot parse JSON "+e.url+". "+t.message)})}function Mn(e){return e.formData()}function Li(e){return e.text()}function Ai(e){return e.text().then(t=>/^\s*<!DOCTYPE html>/.test(t)?Ln(t):z("fragment",t))}function Mi(e){return e.text().then(t=>/^\s*<\?xml/.test(t)?An(t):(console.warn("Untested SVG fragment parsing in request.js!"),z("fragment",t)))}var Di={"text/plain":Li,"text/html":Ai,"image/svg+xml":Mi,"application/json":Bi,"multipart/form-data":Mn,"application/x-www-form-urlencoded":Mn,audio:St,"audio/wav":St,"audio/m4a":St,"application/zip":St};function Pi(e){if(Ze.onresponse&&(e=Ze.onresponse(e)),!e.ok)throw new Error(e.statusText+"");let t=e.headers.get("Content-Type");if(!t)return;let r=t.replace(/\;.*$/,"");return Di[r](e)}function Fn(e="GET",t,r={},u="application/json"){e=e.toUpperCase(),e==="GET"&&r&&(t=_i(t,r));let c=Ti(e,r,u,arguments[4]);return fetch(t,c).then(Pi)}function Sn(e){return Fn("GET",e)}function Fi(e,t){let r;for(r in e)if(e[r]!==t[r])return!1;return!0}var In=re(Fi,!0);var ue={};ue.clone=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t};ue.cloneArray=function(e){for(var t=[],r=0;r<e.length;r++)t.push(ue.clone(e[r]));return t};ue.cloneHashOfHash=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=ue.clone(e[r]));return t};ue.cloneHashOfArrayOfHash=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=ue.cloneArray(e[r]));return t};ue.strip=function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")};ue.startsWith=function(e,t){return e.indexOf(t)===0};ue.endsWith=function(e,t){var r=e.length-t.length;return r>=0&&e.lastIndexOf(t)===r};ue.last=function(e){return e.length===0?null:e[e.length-1]};var G=ue;var qe={};(function(){"use strict";var e,t,r,u,c;qe.initialize=function(x,b,_,C,P){e=x,t=b,r=_,u=C,c=P,p()};function p(){r.annotationfont={face:"Helvetica",size:12,weight:"normal",style:"normal",decoration:"none"},r.gchordfont={face:"Helvetica",size:12,weight:"normal",style:"normal",decoration:"none"},r.historyfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},r.infofont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},r.measurefont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},r.partsfont={face:'"Times New Roman"',size:15,weight:"normal",style:"normal",decoration:"none"},r.repeatfont={face:'"Times New Roman"',size:13,weight:"normal",style:"normal",decoration:"none"},r.textfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},r.tripletfont={face:"Times",size:11,weight:"normal",style:"italic",decoration:"none"},r.vocalfont={face:'"Times New Roman"',size:13,weight:"bold",style:"normal",decoration:"none"},r.wordsfont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},u.formatting.composerfont={face:'"Times New Roman"',size:14,weight:"normal",style:"italic",decoration:"none"},u.formatting.subtitlefont={face:'"Times New Roman"',size:16,weight:"normal",style:"normal",decoration:"none"},u.formatting.tempofont={face:'"Times New Roman"',size:15,weight:"bold",style:"normal",decoration:"none"},u.formatting.titlefont={face:'"Times New Roman"',size:20,weight:"normal",style:"normal",decoration:"none"},u.formatting.footerfont={face:'"Times New Roman"',size:12,weight:"normal",style:"normal",decoration:"none"},u.formatting.headerfont={face:'"Times New Roman"',size:12,weight:"normal",style:"normal",decoration:"none"},u.formatting.voicefont={face:'"Times New Roman"',size:13,weight:"bold",style:"normal",decoration:"none"},u.formatting.tablabelfont={face:'"Trebuchet MS"',size:16,weight:"normal",style:"normal",decoration:"none"},u.formatting.tabnumberfont={face:'"Arial"',size:11,weight:"normal",style:"normal",decoration:"none"},u.formatting.tabgracefont={face:'"Arial"',size:8,weight:"normal",style:"normal",decoration:"none"},u.formatting.annotationfont=r.annotationfont,u.formatting.gchordfont=r.gchordfont,u.formatting.historyfont=r.historyfont,u.formatting.infofont=r.infofont,u.formatting.measurefont=r.measurefont,u.formatting.partsfont=r.partsfont,u.formatting.repeatfont=r.repeatfont,u.formatting.textfont=r.textfont,u.formatting.tripletfont=r.tripletfont,u.formatting.vocalfont=r.vocalfont,u.formatting.wordsfont=r.wordsfont}var l={gchordfont:!0,measurefont:!0,partsfont:!0,annotationfont:!0,composerfont:!0,historyfont:!0,infofont:!0,subtitlefont:!0,textfont:!0,titlefont:!0,voicefont:!0},a=function(x){switch(x){case"Arial-Italic":return{face:"Arial",weight:"normal",style:"italic",decoration:"none"};case"Arial-Bold":return{face:"Arial",weight:"bold",style:"normal",decoration:"none"};case"Bookman-Demi":return{face:"Bookman,serif",weight:"bold",style:"normal",decoration:"none"};case"Bookman-DemiItalic":return{face:"Bookman,serif",weight:"bold",style:"italic",decoration:"none"};case"Bookman-Light":return{face:"Bookman,serif",weight:"normal",style:"normal",decoration:"none"};case"Bookman-LightItalic":return{face:"Bookman,serif",weight:"normal",style:"italic",decoration:"none"};case"Courier":return{face:'"Courier New"',weight:"normal",style:"normal",decoration:"none"};case"Courier-Oblique":return{face:'"Courier New"',weight:"normal",style:"italic",decoration:"none"};case"Courier-Bold":return{face:'"Courier New"',weight:"bold",style:"normal",decoration:"none"};case"Courier-BoldOblique":return{face:'"Courier New"',weight:"bold",style:"italic",decoration:"none"};case"AvantGarde-Book":return{face:"AvantGarde,Arial",weight:"normal",style:"normal",decoration:"none"};case"AvantGarde-BookOblique":return{face:"AvantGarde,Arial",weight:"normal",style:"italic",decoration:"none"};case"AvantGarde-Demi":case"Avant-Garde-Demi":return{face:"AvantGarde,Arial",weight:"bold",style:"normal",decoration:"none"};case"AvantGarde-DemiOblique":return{face:"AvantGarde,Arial",weight:"bold",style:"italic",decoration:"none"};case"Helvetica-Oblique":return{face:"Helvetica",weight:"normal",style:"italic",decoration:"none"};case"Helvetica-Bold":return{face:"Helvetica",weight:"bold",style:"normal",decoration:"none"};case"Helvetica-BoldOblique":return{face:"Helvetica",weight:"bold",style:"italic",decoration:"none"};case"Helvetica-Narrow":return{face:'"Helvetica Narrow",Helvetica',weight:"normal",style:"normal",decoration:"none"};case"Helvetica-Narrow-Oblique":return{face:'"Helvetica Narrow",Helvetica',weight:"normal",style:"italic",decoration:"none"};case"Helvetica-Narrow-Bold":return{face:'"Helvetica Narrow",Helvetica',weight:"bold",style:"normal",decoration:"none"};case"Helvetica-Narrow-BoldOblique":return{face:'"Helvetica Narrow",Helvetica',weight:"bold",style:"italic",decoration:"none"};case"Palatino-Roman":return{face:"Palatino",weight:"normal",style:"normal",decoration:"none"};case"Palatino-Italic":return{face:"Palatino",weight:"normal",style:"italic",decoration:"none"};case"Palatino-Bold":return{face:"Palatino",weight:"bold",style:"normal",decoration:"none"};case"Palatino-BoldItalic":return{face:"Palatino",weight:"bold",style:"italic",decoration:"none"};case"NewCenturySchlbk-Roman":return{face:'"New Century",serif',weight:"normal",style:"normal",decoration:"none"};case"NewCenturySchlbk-Italic":return{face:'"New Century",serif',weight:"normal",style:"italic",decoration:"none"};case"NewCenturySchlbk-Bold":return{face:'"New Century",serif',weight:"bold",style:"normal",decoration:"none"};case"NewCenturySchlbk-BoldItalic":return{face:'"New Century",serif',weight:"bold",style:"italic",decoration:"none"};case"Times":case"Times-Roman":case"Times-Narrow":case"Times-Courier":case"Times-New-Roman":return{face:'"Times New Roman"',weight:"normal",style:"normal",decoration:"none"};case"Times-Italic":case"Times-Italics":return{face:'"Times New Roman"',weight:"normal",style:"italic",decoration:"none"};case"Times-Bold":return{face:'"Times New Roman"',weight:"bold",style:"normal",decoration:"none"};case"Times-BoldItalic":return{face:'"Times New Roman"',weight:"bold",style:"italic",decoration:"none"};case"ZapfChancery-MediumItalic":return{face:'"Zapf Chancery",cursive,serif',weight:"normal",style:"normal",decoration:"none"};default:return null}},o=function(x,b,_,C,P){function R(){var fe=parseInt(x[0].token);return x.shift(),b?x.length===0?{face:b.face,weight:b.weight,style:b.style,decoration:b.decoration,size:fe}:x.length===1&&x[0].token==="box"&&l[P]?{face:b.face,weight:b.weight,style:b.style,decoration:b.decoration,size:fe,box:!0}:(t("Extra parameters in font definition.",_,C),{face:b.face,weight:b.weight,style:b.style,decoration:b.decoration,size:fe}):(t("Can't set just the size of the font since there is no default value.",_,C),{face:'"Times New Roman"',weight:"normal",style:"normal",decoration:"none",size:fe})}if(x[0].token==="*"){if(x.shift(),x[0].type==="number")return R();t("Expected font size number after *.",_,C)}if(x[0].type==="number")return R();for(var H=[],$,te="normal",K="normal",oe="none",W=!1,Be="face",ze=!1;x.length;){var ee=x.shift(),X=ee.token.toLowerCase();switch(Be){case"face":ze||X!=="utf"&&ee.type!=="number"&&X!=="bold"&&X!=="italic"&&X!=="underline"&&X!=="box"?H.length>0&&ee.token==="-"?(ze=!0,H[H.length-1]=H[H.length-1]+ee.token):ze?(ze=!1,H[H.length-1]=H[H.length-1]+ee.token):H.push(ee.token):ee.type==="number"?($?t("Font size specified twice in font definition.",_,C):$=ee.token,Be="modifier"):X==="bold"?te="bold":X==="italic"?K="italic":X==="underline"?oe="underline":X==="box"?(l[P]?W=!0:t(`This font style doesn't support "box"`,_,C),Be="finished"):X==="utf"?(ee=x.shift(),Be="size"):t("Unknown parameter "+ee.token+" in font definition.",_,C);break;case"size":ee.type==="number"?$?t("Font size specified twice in font definition.",_,C):$=ee.token:t("Expected font size in font definition.",_,C),Be="modifier";break;case"modifier":X==="bold"?te="bold":X==="italic"?K="italic":X==="underline"?oe="underline":X==="box"?(l[P]?W=!0:t(`This font style doesn't support "box"`,_,C),Be="finished"):t("Unknown parameter "+ee.token+" in font definition.",_,C);break;case"finished":t('Extra characters found after "box" in font definition.',_,C);break}}$===void 0?b?$=b.size:(t("Must specify the size of the font since there is no default value.",_,C),$=12):$=parseFloat($),H=H.join(" "),H===""&&(b?H=b.face:(t("Must specify the name of the font since there is no default value.",_,C),H="sans-serif"));var Ge=a(H),Y={};return Ge?(Y.face=Ge.face,Y.weight=Ge.weight,Y.style=Ge.style,Y.decoration=Ge.decoration,Y.size=$,W&&(Y.box=!0),Y):(Y.face=H,Y.weight=te,Y.style=K,Y.decoration=oe,Y.size=$,W&&(Y.box=!0),Y)},f=function(x,b,_){return b.length===0?'Directive "'+x+'" requires a font as a parameter.':(r[x]=o(b,r[x],_,0,x),r.is_in_header&&(u.formatting[x]=r[x]),null)},d=function(x,b,_){return b.length===0?'Directive "'+x+'" requires a font as a parameter.':(u.formatting[x]=o(b,u.formatting[x],_,0,x),null)},n=function(x,b){var _="";b.forEach(function(P){_+=P.token});var C=parseFloat(_);if(isNaN(C)||C===0)return'Directive "'+x+'" requires a number as a parameter.';u.formatting.scale=C},i=["acoustic-bass-drum","bass-drum-1","side-stick","acoustic-snare","hand-clap","electric-snare","low-floor-tom","closed-hi-hat","high-floor-tom","pedal-hi-hat","low-tom","open-hi-hat","low-mid-tom","hi-mid-tom","crash-cymbal-1","high-tom","ride-cymbal-1","chinese-cymbal","ride-bell","tambourine","splash-cymbal","cowbell","crash-cymbal-2","vibraslap","ride-cymbal-2","hi-bongo","low-bongo","mute-hi-conga","open-hi-conga","low-conga","high-timbale","low-timbale","high-agogo","low-agogo","cabasa","maracas","short-whistle","long-whistle","short-guiro","long-guiro","claves","hi-wood-block","low-wood-block","mute-cuica","open-cuica","mute-triangle","open-triangle"],s=function(x){var b=x.split(/\s+/);if(b.length!==2&&b.length!==3)return{error:'Expected parameters "abc-note", "drum-sound", and optionally "note-head"'};var _=b[0],C=parseInt(b[1],10);if((isNaN(C)||C<35||C>81)&&b[1]&&(C=i.indexOf(b[1].toLowerCase())+35),isNaN(C)||C<35||C>81)return{error:'Expected drum name, received "'+b[1]+'"'};var P={sound:C};return b.length===3&&(P.noteHead=b[2]),{key:_,value:P}},h=function(x,b){var _=e.getMeasurement(b);return _.used===0||b.length!==0?{error:'Directive "'+x+'" requires a measurement as a parameter.'}:_.value},m=function(x,b){var _=e.getMeasurement(b);return _.used===0||b.length!==0?'Directive "'+x+'" requires a measurement as a parameter.':(u.formatting[x]=_.value,null)},v=function(x,b,_,C,P){if(_.length!==1||_[0].type!=="number")return'Directive "'+b+'" requires a number as a parameter.';var R=_[0].intt;return C!==void 0&&R<C?'Directive "'+b+'" requires a number greater than or equal to '+C+" as a parameter.":P!==void 0&&R>P?'Directive "'+b+'" requires a number less than or equal to '+P+" as a parameter.":(r[x]=R,null)},w=function(x,b,_){if(_.length===1&&(_[0].token==="true"||_[0].token==="false"))return r[x]=_[0].token==="true",null;var C=v(x,b,_,0,1);return C!==null?C:(r[x]=r[x]===1,null)},N=function(x,b,_,C){if(_.length!==1)return'Directive "'+b+'" requires one of [ '+C.join(", ")+" ] as a parameter.";for(var P=_[0].token,R=!1,H=0;!R&&H<C.length;H++)C[H]===P&&(R=!0);return R?(r[x]=P,null):'Directive "'+b+'" requires one of [ '+C.join(", ")+" ] as a parameter."},L=["nobarlines","barlines","beataccents","nobeataccents","droneon","droneoff","drumon","drumoff","fermatafixed","fermataproportional","gchordon","gchordoff","controlcombo","temperamentnormal","noportamento"],y=["gchord","ptstress","beatstring"],g=["bassvol","chordvol","bassprog","chordprog","c","channel","beatmod","deltaloudness","drumbars","gracedivider","makechordchannels","randomchordattack","chordattack","stressmodel","transpose","rtranspose","vol","volinc"],k=["program"],F=["ratio","snt","bendvelocity","pitchbend","control","temperamentlinear"],M=["beat"],D=["drone"],S=["portamento"],B=["expand","grace","trim"],A=["drum","chordname"],I=function(x,b,_){var C=x.shift().token,P=[];if(L.indexOf(C)>=0)x.length!==0&&t("Unexpected parameter in MIDI "+C,_,0);else if(y.indexOf(C)>=0)x.length!==1?t("Expected one parameter in MIDI "+C,_,0):P.push(x[0].token);else if(g.indexOf(C)>=0)x.length!==1?t("Expected one parameter in MIDI "+C,_,0):x[0].type!=="number"?t("Expected one integer parameter in MIDI "+C,_,0):P.push(x[0].intt);else if(k.indexOf(C)>=0)x.length!==1&&x.length!==2?t("Expected one or two parameters in MIDI "+C,_,0):x[0].type!=="number"||x.length===2&&x[1].type!=="number"?t("Expected integer parameter in MIDI "+C,_,0):(P.push(x[0].intt),x.length===2&&P.push(x[1].intt));else if(F.indexOf(C)>=0)x.length!==2?t("Expected two parameters in MIDI "+C,_,0):x[0].type!=="number"||x[1].type!=="number"?t("Expected two integer parameters in MIDI "+C,_,0):(P.push(x[0].intt),P.push(x[1].intt));else if(S.indexOf(C)>=0)x.length!==2?t("Expected two parameters in MIDI "+C,_,0):x[0].type!=="alpha"||x[1].type!=="number"?t("Expected one string and one integer parameters in MIDI "+C,_,0):(P.push(x[0].token),P.push(x[1].intt));else if(C==="drummap")x.length===2&&x[0].type==="alpha"&&x[1].type==="number"?(b.formatting||(b.formatting={}),b.formatting.midi||(b.formatting.midi={}),b.formatting.midi.drummap||(b.formatting.midi.drummap={}),b.formatting.midi.drummap[x[0].token]=x[1].intt,P=b.formatting.midi.drummap):x.length===3&&x[0].type==="punct"&&x[1].type==="alpha"&&x[2].type==="number"?(b.formatting||(b.formatting={}),b.formatting.midi||(b.formatting.midi={}),b.formatting.midi.drummap||(b.formatting.midi.drummap={}),b.formatting.midi.drummap[x[0].token+x[1].token]=x[2].intt,P=b.formatting.midi.drummap):t("Expected one note name and one integer parameter in MIDI "+C,_,0);else if(B.indexOf(C)>=0)x.length!==3||x[0].type!=="number"||x[1].token!=="/"||x[2].type!=="number"?t("Expected fraction parameter in MIDI "+C,_,0):(P.push(x[0].intt),P.push(x[2].intt));else if(M.indexOf(C)>=0)x.length!==4?t("Expected four parameters in MIDI "+C,_,0):x[0].type!=="number"||x[1].type!=="number"||x[2].type!=="number"||x[3].type!=="number"?t("Expected four integer parameters in MIDI "+C,_,0):(P.push(x[0].intt),P.push(x[1].intt),P.push(x[2].intt),P.push(x[3].intt));else if(D.indexOf(C)>=0)x.length!==5?t("Expected five parameters in MIDI "+C,_,0):x[0].type!=="number"||x[1].type!=="number"||x[2].type!=="number"||x[3].type!=="number"||x[4].type!=="number"?t("Expected five integer parameters in MIDI "+C,_,0):(P.push(x[0].intt),P.push(x[1].intt),P.push(x[2].intt),P.push(x[3].intt),P.push(x[4].intt));else if(k.indexOf(C)>=0)x.length!==1||x.length!==4?t("Expected one or two parameters in MIDI "+C,_,0):x[0].type!=="number"?t("Expected integer parameter in MIDI "+C,_,0):x.length===4?(x[1].token!=="octave"&&t("Expected octave parameter in MIDI "+C,_,0),x[2].token!=="="&&t("Expected octave parameter in MIDI "+C,_,0),x[3].type!=="number"&&t("Expected integer parameter for octave in MIDI "+C,_,0)):(P.push(x[0].intt),x.length===4&&P.push(x[3].intt));else if(A.indexOf(C)>=0)if(x.length<2)t("Expected string parameter and at least one integer parameter in MIDI "+C,_,0);else if(x[0].type!=="alpha")t("Expected string parameter and at least one integer parameter in MIDI "+C,_,0);else{var R=x.shift();for(P.push(R.token);x.length>0;)R=x.shift(),R.type!=="number"&&t("Expected integer parameter in MIDI "+C,_,0),P.push(R.intt)}c.hasBeginMusic()?c.appendElement("midi",-1,-1,{cmd:C,params:P}):(b.formatting.midi===void 0&&(b.formatting.midi={}),b.formatting.midi[C]=P)};qe.parseFontChangeLine=function(x){x=x.replace(/\$\$/g,"");var b=x.split("$");if(b.length>1&&r.setfont){var _=[];b[0]!==""&&_.push({text:b[0]});for(var C=1;C<b.length;C++)if(b[C][0]==="0")_.push({text:b[C].substring(1).replace(/\x03/g,"$$")});else{var P=parseInt(b[C][0],10);r.setfont[P]?_.push({font:r.setfont[P],text:b[C].substring(1).replace(/\x03/g,"$$")}):_[_.length-1].text+="$"+b[C].replace(/\x03/g,"$$")}return _}return x.replace(/\x03/g,"$$")};var q=["auto","above","below","hidden"];qe.addDirective=function(x){var b=e.tokenize(x,0,x.length);if(b.length===0||b[0].type!=="alpha")return null;var _=x.substring(x.indexOf(b[0].token)+b[0].token.length);_=e.stripComment(_);var C=b.shift().token.toLowerCase(),P="",R;switch(C){case"bagpipes":u.formatting.bagpipes=!0;break;case"flatbeams":u.formatting.flatbeams=!0;break;case"jazzchords":u.formatting.jazzchords=!0;break;case"accentAbove":u.formatting.accentAbove=!0;break;case"germanAlphabet":u.formatting.germanAlphabet=!0;break;case"landscape":r.landscape=!0;break;case"papersize":r.papersize=_;break;case"graceslurs":if(b.length!==1)return"Directive graceslurs requires one parameter: 0 or 1";if(b[0].token==="0"||b[0].token==="false")u.formatting.graceSlurs=!1;else if(b[0].token==="1"||b[0].token==="true")u.formatting.graceSlurs=!0;else return"Directive graceslurs requires one parameter: 0 or 1 (received "+b[0].token+")";break;case"lineThickness":var H=O(b);if(H.value!==void 0&&(u.formatting.lineThickness=H.value),H.error)return H.error;break;case"stretchlast":var $=O(b);if($.value!==void 0&&(u.formatting.stretchlast=$.value),$.error)return $.error;break;case"titlecaps":r.titlecaps=!0;break;case"titleleft":u.formatting.titleleft=!0;break;case"measurebox":u.formatting.measurebox=!0;break;case"vocal":return N("vocalPosition",C,b,q);case"dynamic":return N("dynamicPosition",C,b,q);case"gchord":return N("chordPosition",C,b,q);case"ornament":return N("ornamentPosition",C,b,q);case"volume":return N("volumePosition",C,b,q);case"botmargin":case"botspace":case"composerspace":case"indent":case"leftmargin":case"linesep":case"musicspace":case"partsspace":case"pageheight":case"pagewidth":case"rightmargin":case"staffsep":case"staffwidth":case"subtitlespace":case"sysstaffsep":case"systemsep":case"textspace":case"titlespace":case"topmargin":case"topspace":case"vocalspace":case"wordsspace":return m(C,b);case"voicescale":if(b.length!==1||b[0].type!=="number")return"voicescale requires one float as a parameter";var te=b.shift();return r.currentVoice&&(r.currentVoice.scale=te.floatt,c.changeVoiceScale(r.currentVoice.scale)),null;case"voicecolor":if(b.length!==1)return"voicecolor requires one string as a parameter";var K=b.shift();return r.currentVoice&&(r.currentVoice.color=K.token,c.changeVoiceColor(r.currentVoice.color)),null;case"vskip":var oe=Math.round(h(C,b));return oe.error?oe.error:(c.addSpacing(oe),null);case"scale":n(C,b);break;case"sep":if(b.length===0)c.addSeparator(14,14,85,{startChar:r.iChar,endChar:r.iChar+5});else{var W=e.getMeasurement(b);if(W.used===0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var Be=W.value;if(W=e.getMeasurement(b),W.used===0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var ze=W.value;if(W=e.getMeasurement(b),W.used===0||b.length!==0)return'Directive "'+C+'" requires 3 numbers: space above, space below, length of line';var ee=W.value;c.addSeparator(Be,ze,ee,{startChar:r.iChar,endChar:r.iChar+_.length})}break;case"barsperstaff":if(P=v("barsperstaff",C,b),P!==null)return P;break;case"staffnonote":if(b.length!==1)return"Directive staffnonote requires one parameter: 0 or 1";if(b[0].token==="0")r.staffnonote=!0;else if(b[0].token==="1")r.staffnonote=!1;else return"Directive staffnonote requires one parameter: 0 or 1 (received "+b[0].token+")";break;case"printtempo":if(P=w("printTempo",C,b),P!==null)return P;break;case"partsbox":if(P=w("partsBox",C,b),P!==null)return P;r.partsfont.box=r.partsBox;break;case"freegchord":if(P=w("freegchord",C,b),P!==null)return P;break;case"measurenb":case"barnumbers":if(P=v("barNumbers",C,b),P!==null)return P;break;case"setbarnb":if(b.length!==1||b[0].type!=="number")return"Directive setbarnb requires a number as a parameter.";r.currBarNumber=c.setBarNumberImmediate(b[0].intt);break;case"begintext":var X="";for(R=e.nextLine();R&&R.indexOf("%%endtext")!==0;)G.startsWith(R,"%%")?X+=R.substring(2)+`
`:X+=R+`
`,R=e.nextLine();c.addText(X,{startChar:r.iChar,endChar:r.iChar+X.length+7});break;case"continueall":r.continueall=!0;break;case"beginps":for(R=e.nextLine();R&&R.indexOf("%%endps")!==0;)e.nextLine();t("Postscript ignored",x,0);break;case"deco":_.length>0&&r.ignoredDecorations.push(_.substring(0,_.indexOf(" "))),t("Decoration redefinition ignored",x,0);break;case"text":var Ge=e.translateString(_);c.addText(qe.parseFontChangeLine(Ge),{startChar:r.iChar,endChar:r.iChar+_.length+7});break;case"center":var Y=e.translateString(_);c.addCentered(qe.parseFontChangeLine(Y));break;case"font":break;case"setfont":var fe=e.tokenize(_,0,_.length);if(fe.length>=4&&fe[0].token==="-"&&fe[1].type==="number"){var kt=parseInt(fe[1].token);kt>=1&&kt<=9&&(r.setfont||(r.setfont=[]),fe.shift(),fe.shift(),r.setfont[kt]=o(fe,r.setfont[kt],x,0,"setfont"))}break;case"gchordfont":case"partsfont":case"tripletfont":case"vocalfont":case"textfont":case"annotationfont":case"historyfont":case"infofont":case"measurefont":case"repeatfont":case"wordsfont":return f(C,b,x);case"composerfont":case"subtitlefont":case"tempofont":case"titlefont":case"voicefont":case"footerfont":case"headerfont":return d(C,b,x);case"barlabelfont":case"barnumberfont":case"barnumfont":return f("measurefont",b,x);case"staves":case"score":r.score_is_present=!0;for(var da=function(rt,xa,Ur,Wr,ya){(xa||r.staves.length===0)&&r.staves.push({index:r.staves.length,numVoices:0});var Ae=G.last(r.staves);Ur!==void 0&&Ae.bracket===void 0&&(Ae.bracket=Ur),Wr!==void 0&&Ae.brace===void 0&&(Ae.brace=Wr),ya&&(Ae.connectBarLines="end"),r.voices[rt]===void 0&&(r.voices[rt]={staffNum:Ae.index,index:Ae.numVoices},Ae.numVoices++)},je=!1,Ve=!1,et=!1,Nt=!1,_t=!1,Tt=!1,Xt=!1,Le,Hr=function(){if(Xt=!0,Le){var rt="start";Le.staffNum>0&&(r.staves[Le.staffNum-1].connectBarLines==="start"||r.staves[Le.staffNum-1].connectBarLines==="continue")&&(rt="continue"),r.staves[Le.staffNum].connectBarLines=rt}};b.length;){var ce=b.shift();switch(ce.token){case"(":je?t("Can't nest parenthesis in %%score",x,ce.start):(je=!0,Nt=!0);break;case")":!je||Nt?t("Unexpected close parenthesis in %%score",x,ce.start):je=!1;break;case"[":Ve?t("Can't nest brackets in %%score",x,ce.start):(Ve=!0,_t=!0);break;case"]":!Ve||_t?t("Unexpected close bracket in %%score",x,ce.start):(Ve=!1,r.staves[Le.staffNum].bracket="end");break;case"{":et?t("Can't nest braces in %%score",x,ce.start):(et=!0,Tt=!0);break;case"}":!et||Tt?t("Unexpected close brace in %%score",x,ce.start):(et=!1,r.staves[Le.staffNum].brace="end");break;case"|":Hr();break;default:for(var Zt="";(ce.type==="alpha"||ce.type==="number")&&(Zt+=ce.token,ce.continueId);)ce=b.shift();var ma=!je||Nt,ga=_t?"start":Ve?"continue":void 0,va=Tt?"start":et?"continue":void 0;da(Zt,ma,ga,va,Xt),Nt=!1,_t=!1,Tt=!1,Xt=!1,Le=r.voices[Zt],C==="staves"&&Hr();break}}break;case"newpage":var zr=e.getInt(_);c.addNewPage(zr.digits===0?-1:zr.value);break;case"abc":var Bt=_.split(" ");switch(Bt[0]){case"-copyright":case"-creator":case"-edited-by":case"-version":case"-charset":var ba=Bt.shift();c.addMetaText(C+ba,Bt.join(" "),{startChar:r.iChar,endChar:r.iChar+_.length+5});break;default:return"Unknown directive: "+C+Bt[0]}break;case"header":case"footer":var ve=e.getMeat(_,0,_.length);ve=_.substring(ve.start,ve.end),ve[0]==='"'&&ve[ve.length-1]==='"'&&(ve=ve.substring(1,ve.length-1));var be=ve.split("	"),Lt={};be.length===1?Lt={left:"",center:be[0],right:""}:be.length===2?Lt={left:be[0],center:be[1],right:""}:Lt={left:be[0],center:be[1],right:be[2]},be.length>3&&t("Too many tabs in "+C+": "+be.length+" found.",_,0),c.addMetaTextObj(C,Lt,{startChar:r.iChar,endChar:r.iChar+x.length});break;case"midi":var tt=e.tokenize(_,0,_.length,!0);tt.length>0&&tt[0].token==="="&&tt.shift(),tt.length===0?t("Expected midi command",_,0):I(tt,u,_);break;case"percmap":var At=s(_);At.error?t(At.error,x,8):(u.formatting.percmap||(u.formatting.percmap={}),u.formatting.percmap[At.key]=At.value);break;case"map":case"playtempo":case"auquality":case"continuous":case"nobarcheck":u.formatting[C]=_;break;default:return"Unknown directive: "+C}return null},qe.globalFormatting=function(x){for(var b in x)if(x.hasOwnProperty(b)){var _=""+x[b],C=e.tokenize(_,0,_.length),P;switch(b){case"titlefont":case"gchordfont":case"composerfont":case"footerfont":case"headerfont":case"historyfont":case"infofont":case"measurefont":case"partsfont":case"repeatfont":case"subtitlefont":case"tempofont":case"textfont":case"voicefont":case"tripletfont":case"vocalfont":case"wordsfont":case"annotationfont":case"tablabelfont":case"tabnumberfont":case"tabgracefont":f(b,C,_);break;case"scale":n(b,C);break;case"partsbox":P=w("partsBox",b,C),P!==null&&t(P),r.partsfont.box=r.partsBox;break;case"freegchord":P=w("freegchord",b,C),P!==null&&t(P);break;case"fontboxpadding":(C.length!==1||C[0].type!=="number")&&t('Directive "'+b+'" requires a number as a parameter.'),u.formatting.fontboxpadding=C[0].floatt;break;case"stretchlast":var R=O(C);if(R.value!==void 0&&(u.formatting.stretchlast=R.value),R.error)return R.error;break;default:t("Formatting directive unrecognized: ",b,0)}}};function O(x){if(x.length===0)return{value:1};if(x.length===1)if(x[0].type==="number"){if(x[0].floatt>=0||x[0].floatt<=1)return{value:x[0].floatt}}else{if(x[0].token==="false")return{value:0};if(x[0].token==="true")return{value:1}}return{error:"Directive stretchlast requires zero or one parameter: false, true, or number between 0 and 1 (received "+x[0].token+")"}}})();var J=qe;var xr={},On=["C,,,","D,,,","E,,,","F,,,","G,,,","A,,,","B,,,","C,,","D,,","E,,","F,,","G,,","A,,","B,,","C,","D,","E,","F,","G,","A,","B,","C","D","E","F","G","A","B","c","d","e","f","g","a","b","c'","d'","e'","f'","g'","a'","b'","c''","d''","e''","f''","g''","a''","b''","c'''","d'''","e'''","f'''","g'''","a'''","b'''"];xr.pitchIndex=function(e){return On.indexOf(e)};xr.noteName=function(e){return On[e]};var yr=xr;var It=["C","C‚ôØ","D","D‚ôØ","E","F","F‚ôØ","G","G‚ôØ","A","A‚ôØ","B"],Ot=["C","D‚ô≠","D","E‚ô≠","E","F","G‚ô≠","G","A‚ô≠","A","B‚ô≠","B"],Gt=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],qt=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];function wr(e,t,r,u){if(!t||t%12===0)return e;for(;t<0;)t+=12;t>11&&(t=t%12);var c=e.match(/^([A-G][b#‚ô≠‚ôØ]?)([^\/]+)?\/?([A-G][b#‚ô≠‚ôØ]?)?(.+)?/);if(!c)return e;var p=c[1],l=c[2],a=c[3],o=c[4],f=It.indexOf(p);if(f<0&&(f=Ot.indexOf(p)),f<0&&(f=Gt.indexOf(p)),f<0&&(f=qt.indexOf(p)),f<0)return e;if(f+=t,f=f%12,r?u?e=qt[f]:e=Ot[f]:u?e=Gt[f]:e=It[f],l&&(e+=l),a){var f=It.indexOf(a);f<0&&(f=Ot.indexOf(a)),f<0&&(f=Gt.indexOf(a)),f<0&&(f=qt.indexOf(a)),e+="/",f>=0?(f+=t,f=f%12,r?u?e+=qt[f]:e+=Ot[f]:u?e+=Gt[f]:e+=It[f]):e+=a}return o&&(e+=o),e}var Gn={C:{modes:["CMaj","Amin","Am","GMix","DDor","EPhr","FLyd","BLoc"],stepsFromC:0},Db:{modes:["DbMaj","Bbmin","Bbm","AbMix","EbDor","FPhr","GbLyd","CLoc"],stepsFromC:1},D:{modes:["DMaj","Bmin","Bm","AMix","EDor","F#Phr","GLyd","C#Loc"],stepsFromC:2},Eb:{modes:["EbMaj","Cmin","Cm","BbMix","FDor","GPhr","AbLyd","DLoc"],stepsFromC:3},E:{modes:["EMaj","C#min","C#m","BMix","F#Dor","G#Phr","ALyd","D#Loc"],stepsFromC:4},F:{modes:["FMaj","Dmin","Dm","CMix","GDor","APhr","BbLyd","ELoc"],stepsFromC:5},Gb:{modes:["GbMaj","Ebmin","Ebm","DbMix","AbDor","BbPhr","CbLyd","FLoc"],stepsFromC:6},G:{modes:["GMaj","Emin","Em","DMix","ADor","BPhr","CLyd","F#Loc"],stepsFromC:7},Ab:{modes:["AbMaj","Fmin","Fm","EbMix","BbDor","CPhr","DbLyd","GLoc"],stepsFromC:8},A:{modes:["AMaj","F#min","F#m","EMix","BDor","C#Phr","DLyd","G#Loc"],stepsFromC:9},Bb:{modes:["BbMaj","Gmin","Gm","FMix","CDor","DPhr","EbLyd","ALoc"],stepsFromC:10},B:{modes:["BMaj","G#min","G#m","F#Mix","C#Dor","D#Phr","ELyd","A#Loc"],stepsFromC:11},"C#":{modes:["C#Maj","A#min","A#m","G#Mix","D#Dor","E#Phr","F#Lyd","B#Loc"],stepsFromC:1},"F#":{modes:["F#Maj","D#min","D#m","C#Mix","G#Dor","A#Phr","BLyd","E#Loc"],stepsFromC:6},Cb:{modes:["CbMaj","Abmin","Abm","GbMix","DbDor","EbPhr","FbLyd","BbLoc"],stepsFromC:11}},pt=null;function Si(){pt={};for(var e=Object.keys(Gn),t=0;t<e.length;t++){var r=Gn[e[t]];pt[e[t].toLowerCase()]=e[t];for(var u=0;u<r.modes.length;u++){var c=r.modes[u].toLowerCase();pt[c]=e[t]}}}function qn(e){pt||Si();var t=e.toLowerCase().match(/([a-g][b#]?)(maj|min|mix|dor|phr|lyd|loc|m)?/);if(!t||!t[2])return e;t=t[1]+t[2];var r=pt[t];return r||e}var Re={acc:"sharp",note:"f"},Je={acc:"sharp",note:"c"},dt={acc:"sharp",note:"g"},Rt={acc:"sharp",note:"d"},Er={acc:"sharp",note:"A"},Rn={acc:"sharp",note:"e"},Ii={acc:"sharp",note:"B"},he={acc:"flat",note:"B"},Ce={acc:"flat",note:"e"},Se={acc:"flat",note:"A"},mt={acc:"flat",note:"d"},Cr={acc:"flat",note:"G"},$n={acc:"flat",note:"c"},Oi={acc:"flat",note:"F"},Gi={"C#":[Re,Je,dt,Rt,Er,Rn,Ii],"F#":[Re,Je,dt,Rt,Er,Rn],B:[Re,Je,dt,Rt,Er],E:[Re,Je,dt,Rt],A:[Re,Je,dt],D:[Re,Je],G:[Re],C:[],F:[he],Bb:[he,Ce],Eb:[he,Ce,Se],Cm:[he,Ce,Se],Ab:[he,Ce,Se,mt],Db:[he,Ce,Se,mt,Cr],Gb:[he,Ce,Se,mt,Cr,$n],Cb:[he,Ce,Se,mt,Cr,$n,Oi],"A#":[he,Ce],"B#":[],"D#":[he,Ce,Se],"E#":[he],"G#":[he,Ce,Se,mt],none:[]};function gt(e){var t=Gi[qn(e)];return t?JSON.parse(JSON.stringify(t)):null}var $t={},qi={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11},Ri=["C","Db","D","Eb","E","F","F#","G","Ab","A","Bb","B"],$i=["C","C#","D","D#","E","F","F#","G","G#","A","Bb","B"];$t.keySignature=function(e,t,r,u,c){if(e.clef.type==="perc"||e.clef.type==="none")return{accidentals:gt(t),root:r,acc:u};c||(c=0),e.localTransposeVerticalMovement=0,e.localTransposePreferFlats=!1;var p=gt(t);if(!p)return e.key;if(e.localTranspose=(e.globalTranspose?e.globalTranspose:0)+c,!e.localTranspose)return{accidentals:p,root:r,acc:u};if(e.globalTransposeOrigKeySig=p,e.localTranspose%12===0)return e.localTransposeVerticalMovement=e.localTranspose/12*7,{accidentals:p,root:r,acc:u};var l=t[0];t[1]==="b"||t[1]==="#"?(l+=t[1],t=t.substr(2)):t=t.substr(1);var a=qi[l],o=a!==void 0;o||(a=0,l="C",t="");for(var f=a+e.localTranspose;f<0;)f+=12;f>11&&(f=f%12);var d=t[0]==="m"?$i[f]:Ri[f],n=d+t,i=gt(n);i.length>0&&i[0].acc==="flat"&&(e.localTransposePreferFlats=!0);var s=n.charCodeAt(0)-l.charCodeAt(0);return e.localTranspose>0?(s<0||s===0&&(l[1]==="#"||n[1]==="b"))&&(s+=7):e.localTranspose<0&&(s>0||s===0&&(l[1]==="b"||n[1]==="#"))&&(s-=7),e.localTranspose>0?e.localTransposeVerticalMovement=s+Math.floor(e.localTranspose/12)*7:e.localTransposeVerticalMovement=s+Math.ceil(e.localTranspose/12)*7,o?{accidentals:i,root:d[0],acc:d.length>1?d[1]:""}:{accidentals:[],root:r,acc:u}};$t.chordName=function(e,t){return wr(t,e.localTranspose,e.localTransposePreferFlats,e.freegchord)};var Hn=["c","d","e","f","g","a","b"];function Hi(e,t,r,u,c){for(var p=Hn[(e+49)%7],l=0,a=0;a<u.length;a++)u[a].note.toLowerCase()===p&&(l=kr[u[a].acc]);for(var o=kr[r],f=o-l,d=Hn[(t+49)%7],n=0,i=0;i<c.accidentals.length;i++)c.accidentals[i].note.toLowerCase()===d&&(n=kr[c.accidentals[i].acc]);var s=f+n;return s<-2&&(t--,s+=d==="c"||d==="f"?1:2),s>2&&(t++,s-=d==="b"||d==="e"?1:2),[t,s]}var kr={dblflat:-2,flat:-1,natural:0,sharp:1,dblsharp:2},zi={"-2":"dblflat","-1":"flat",0:"natural",1:"sharp",2:"dblsharp"},Ui={"-2":"__","-1":"_",0:"=",1:"^",2:"^^"};$t.note=function(e,t){if(!(!e.localTranspose||e.clef.type==="perc")){var r=t.pitch;if(e.localTransposeVerticalMovement&&(t.pitch=t.pitch+e.localTransposeVerticalMovement,t.name)){var u=t.accidental?t.name.substring(1):t.name,c=t.accidental?t.name[0]:"",p=yr.pitchIndex(u);t.name=c+yr.noteName(p+e.localTransposeVerticalMovement)}if(t.accidental){var l=Hi(r,t.pitch,t.accidental,e.globalTransposeOrigKeySig,e.targetKey);t.pitch=l[0],t.accidental=zi[l[1]],t.name&&(t.name=Ui[l[1]]+t.name.replace(/[_^=]/g,""))}}};var vt=$t;var se={};(function(){var e,t,r,u,c;se.initialize=function(n,i,s,h,m){e=n,t=i,r=s,u=h,c=m},se.standardKey=function(n,i,s,h){return vt.keySignature(r,n,i,s,h)};var p={treble:{clef:"treble",pitch:4,mid:0},"treble+8":{clef:"treble+8",pitch:4,mid:0},"treble-8":{clef:"treble-8",pitch:4,mid:0},"treble^8":{clef:"treble+8",pitch:4,mid:0},treble_8:{clef:"treble-8",pitch:4,mid:0},treble1:{clef:"treble",pitch:2,mid:2},treble2:{clef:"treble",pitch:4,mid:0},treble3:{clef:"treble",pitch:6,mid:-2},treble4:{clef:"treble",pitch:8,mid:-4},treble5:{clef:"treble",pitch:10,mid:-6},perc:{clef:"perc",pitch:6,mid:0},none:{clef:"none",mid:0},bass:{clef:"bass",pitch:8,mid:-12},"bass+8":{clef:"bass+8",pitch:8,mid:-12},"bass-8":{clef:"bass-8",pitch:8,mid:-12},"bass^8":{clef:"bass+8",pitch:8,mid:-12},bass_8:{clef:"bass-8",pitch:8,mid:-12},"bass+16":{clef:"bass",pitch:8,mid:-12},"bass-16":{clef:"bass",pitch:8,mid:-12},"bass^16":{clef:"bass",pitch:8,mid:-12},bass_16:{clef:"bass",pitch:8,mid:-12},bass1:{clef:"bass",pitch:2,mid:-6},bass2:{clef:"bass",pitch:4,mid:-8},bass3:{clef:"bass",pitch:6,mid:-10},bass4:{clef:"bass",pitch:8,mid:-12},bass5:{clef:"bass",pitch:10,mid:-14},tenor:{clef:"alto",pitch:8,mid:-8},tenor1:{clef:"alto",pitch:2,mid:-2},tenor2:{clef:"alto",pitch:4,mid:-4},tenor3:{clef:"alto",pitch:6,mid:-6},tenor4:{clef:"alto",pitch:8,mid:-8},tenor5:{clef:"alto",pitch:10,mid:-10},alto:{clef:"alto",pitch:6,mid:-6},alto1:{clef:"alto",pitch:2,mid:-2},alto2:{clef:"alto",pitch:4,mid:-4},alto3:{clef:"alto",pitch:6,mid:-6},alto4:{clef:"alto",pitch:8,mid:-8},alto5:{clef:"alto",pitch:10,mid:-10},"alto+8":{clef:"alto+8",pitch:6,mid:-6},"alto-8":{clef:"alto-8",pitch:6,mid:-6},"alto^8":{clef:"alto+8",pitch:6,mid:-6},alto_8:{clef:"alto-8",pitch:6,mid:-6}},l=function(n,i){var s=p[n],h=s?s.mid:0;return h+i};se.fixClef=function(n){var i=p[n.type];i&&(n.clefPos=i.pitch,n.type=i.clef)},se.deepCopyKey=function(n){var i={accidentals:[],root:n.root,acc:n.acc,mode:n.mode};return n.accidentals.forEach(function(s){i.accidentals.push(G.clone(s))}),i};var a={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11};se.addPosToKey=function(n,i){var s=n.verticalPos;i.accidentals.forEach(function(h){var m=a[h.note];m=m-s,h.verticalPos=m}),i.impliedNaturals&&i.impliedNaturals.forEach(function(h){var m=a[h.note];m=m-s,h.verticalPos=m}),s<-10?(i.accidentals.forEach(function(h){h.verticalPos-=7,(h.verticalPos>=11||h.verticalPos===10&&h.acc==="flat")&&(h.verticalPos-=7),h.note==="A"&&h.acc==="sharp"&&(h.verticalPos-=7),(h.note==="G"||h.note==="F")&&h.acc==="flat"&&(h.verticalPos-=7)}),i.impliedNaturals&&i.impliedNaturals.forEach(function(h){h.verticalPos-=7,(h.verticalPos>=11||h.verticalPos===10&&h.acc==="flat")&&(h.verticalPos-=7),h.note==="A"&&h.acc==="sharp"&&(h.verticalPos-=7),(h.note==="G"||h.note==="F")&&h.acc==="flat"&&(h.verticalPos-=7)})):s<-4?(i.accidentals.forEach(function(h){h.verticalPos-=7,s===-8&&(h.note==="f"||h.note==="g")&&h.acc==="sharp"&&(h.verticalPos-=7)}),i.impliedNaturals&&i.impliedNaturals.forEach(function(h){h.verticalPos-=7,s===-8&&(h.note==="f"||h.note==="g")&&h.acc==="sharp"&&(h.verticalPos-=7)})):s>=7&&(i.accidentals.forEach(function(h){h.verticalPos+=7}),i.impliedNaturals&&i.impliedNaturals.forEach(function(h){h.verticalPos+=7}))},se.fixKey=function(n,i){var s=G.clone(i);return se.addPosToKey(n,s),s};var o=function(n){var i=0,s=n[i++];(s==="^"||s==="_")&&(s=n[i++]);var h=a[s];for(h===void 0&&(h=6);i<n.length;i++)if(n[i]===",")h-=7;else if(n[i]==="'")h+=7;else break;return{mid:h-6,str:n.substring(i)}},f=function(n){for(var i=0;i<n.length;i++)n[i].note==="b"?n[i].note="B":n[i].note==="a"?n[i].note="A":n[i].note==="F"?n[i].note="f":n[i].note==="E"?n[i].note="e":n[i].note==="D"?n[i].note="d":n[i].note==="C"?n[i].note="c":n[i].note==="G"&&n[i].acc==="sharp"?n[i].note="g":n[i].note==="g"&&n[i].acc==="flat"&&(n[i].note="G")};se.parseKey=function(n,i){n.length===0&&(n="none");var s=e.tokenize(n,0,n.length),h={};if(s.length===0)return t("Must pass in key signature.",n,0),h;switch(s[0].token){case"HP":J.addDirective("bagpipes"),r.key={root:"HP",accidentals:[],acc:"",mode:""},h.foundKey=!0,s.shift();break;case"Hp":J.addDirective("bagpipes"),r.key={root:"Hp",accidentals:[{acc:"natural",note:"g"},{acc:"sharp",note:"f"},{acc:"sharp",note:"c"}],acc:"",mode:""},h.foundKey=!0,s.shift();break;case"none":r.key={root:"none",accidentals:[],acc:"",mode:""},h.foundKey=!0,s.shift();break;default:var m=e.getKeyPitch(s[0].token);if(m.len>0){h.foundKey=!0;var v="",w="";s[0].token.length>1?s[0].token=s[0].token.substring(1):s.shift();var N=m.token;if(s.length>0){var L=e.getSharpFlat(s[0].token);if(L.len>0&&(s[0].token.length>1?s[0].token=s[0].token.substring(1):s.shift(),N+=L.token,v=L.token),s.length>0){var y=e.getMode(s[0].token);y.len>0&&(s.shift(),N+=y.token,w=y.token)}if(se.standardKey(N,m.token,v,0)===void 0)return t("Unsupported key signature: "+N,n,0),h}var g=se.deepCopyKey(r.key),k=!i&&r.globalTranspose?-r.globalTranspose:0,F;if(i&&(F=r.globalTransposeOrigKeySig),r.key=se.deepCopyKey(se.standardKey(N,m.token,v,k)),i&&(r.globalTransposeOrigKeySig=F),r.key.mode=w,g){for(var M,D=0;D<r.key.accidentals.length;D++)for(M=0;M<g.accidentals.length;M++)g.accidentals[M].note&&r.key.accidentals[D].note.toLowerCase()===g.accidentals[M].note.toLowerCase()&&(g.accidentals[M].note=null);for(M=0;M<g.accidentals.length;M++)g.accidentals[M].note&&(r.key.impliedNaturals||(r.key.impliedNaturals=[]),r.key.impliedNaturals.push({acc:"natural",note:g.accidentals[M].note}))}}break}if(s.length===0||(s[0].token==="exp"&&s.shift(),s.length===0)||(s[0].token==="oct"&&s.shift(),s.length===0))return h;var S=e.getKeyAccidentals2(s);if(S.warn&&t(S.warn,n,0),S.accs){h.foundKey||(h.foundKey=!0,r.key={root:"none",acc:"",mode:"",accidentals:[]}),f(S.accs);for(var B=0;B<S.accs.length;B++){for(var A=!1,I=0;I<r.key.accidentals.length&&!A;I++)r.key.accidentals[I].note===S.accs[B].note&&(A=!0,r.key.accidentals[I].acc!==S.accs[B].acc&&(r.key.accidentals[I].acc=S.accs[B].acc,r.key.explicitAccidentals||(r.key.explicitAccidentals=[]),r.key.explicitAccidentals.push(S.accs[B])));if(!A&&(r.key.explicitAccidentals||(r.key.explicitAccidentals=[]),r.key.explicitAccidentals.push(S.accs[B]),r.key.accidentals.push(S.accs[B]),r.key.impliedNaturals))for(var q=0;q<r.key.impliedNaturals.length;q++)r.key.impliedNaturals[q].note===S.accs[B].note&&r.key.impliedNaturals.splice(q,1)}}for(var O;s.length>0;)switch(s[0].token){case"m":case"middle":if(s.shift(),s.length===0)return t("Expected = after middle",n,0),h;if(O=s.shift(),O.token!=="="){t("Expected = after middle",n,O.start);break}if(s.length===0)return t("Expected parameter after middle=",n,0),h;var x=e.getPitchFromTokens(s);x.warn&&t(x.warn,n,0),x.position&&(r.clef.verticalPos=x.position-6);break;case"transpose":if(s.shift(),s.length===0)return t("Expected = after transpose",n,0),h;if(O=s.shift(),O.token!=="="){t("Expected = after transpose",n,O.start);break}if(s.length===0)return t("Expected parameter after transpose=",n,0),h;if(s[0].type!=="number"){t("Expected number after transpose",n,s[0].start);break}r.clef.transpose=s[0].intt,s.shift();break;case"stafflines":if(s.shift(),s.length===0)return t("Expected = after stafflines",n,0),h;if(O=s.shift(),O.token!=="="){t("Expected = after stafflines",n,O.start);break}if(s.length===0)return t("Expected parameter after stafflines=",n,0),h;if(s[0].type!=="number"){t("Expected number after stafflines",n,s[0].start);break}r.clef.stafflines=s[0].intt,s.shift();break;case"staffscale":if(s.shift(),s.length===0)return t("Expected = after staffscale",n,0),h;if(O=s.shift(),O.token!=="="){t("Expected = after staffscale",n,O.start);break}if(s.length===0)return t("Expected parameter after staffscale=",n,0),h;if(s[0].type!=="number"){t("Expected number after staffscale",n,s[0].start);break}r.clef.staffscale=s[0].floatt,s.shift();break;case"octave":if(s.shift(),s.length===0)return t("Expected = after octave",n,0),h;if(O=s.shift(),O.token!=="="){t("Expected = after octave",n,O.start);break}if(s.length===0)return t("Expected parameter after octave=",n,0),h;if(s[0].type!=="number"){t("Expected number after octave",n,s[0].start);break}r.octave=s[0].intt,s.shift();break;case"style":if(s.shift(),s.length===0)return t("Expected = after style",n,0),h;if(O=s.shift(),O.token!=="="){t("Expected = after style",n,O.start);break}if(s.length===0)return t("Expected parameter after style=",n,0),h;switch(s[0].token){case"normal":case"harmonic":case"rhythm":case"x":case"triangle":r.style=s[0].token,s.shift();break;default:t("error parsing style element: "+s[0].token,n,s[0].start);break}break;case"clef":if(s.shift(),s.length===0)return t("Expected = after clef",n,0),h;if(O=s.shift(),O.token!=="="){t("Expected = after clef",n,O.start);break}if(s.length===0)return t("Expected parameter after clef=",n,0),h;case"treble":case"bass":case"alto":case"tenor":case"perc":case"none":var b=s.shift();switch(b.token){case"treble":case"tenor":case"alto":case"bass":case"perc":case"none":break;case"C":b.token="alto";break;case"F":b.token="bass";break;case"G":b.token="treble";break;case"c":b.token="alto";break;case"f":b.token="bass";break;case"g":b.token="treble";break;default:t("Expected clef name. Found "+b.token,n,b.start);break}s.length>0&&s[0].type==="number"&&(b.token+=s[0].token,s.shift()),s.length>1&&(s[0].token==="-"||s[0].token==="+"||s[0].token==="^"||s[0].token==="_")&&s[1].token==="8"&&(b.token+=s[0].token+s[1].token,s.shift(),s.shift()),r.clef={type:b.token,verticalPos:l(b.token,0)},r.currentVoice&&r.currentVoice.transpose!==void 0&&(r.clef.transpose=r.currentVoice.transpose),h.foundClef=!0;break;default:t("Unknown parameter: "+s[0].token,n,s[0].start),s.shift()}return h};var d=function(n){r.currentVoice=r.voices[n],c.setCurrentVoice(r.currentVoice.staffNum,r.currentVoice.index)};se.parseVoice=function(n,i,s){var h=e.getMeat(n,i,s),m=h.start,v=h.end,w=e.getToken(n,m,v);if(w.length===0){t("Expected a voice id",n,m);return}var N=!1;r.voices[w]===void 0&&(r.voices[w]={},N=!0,r.score_is_present&&t("Can't have an unknown V: id when the %score directive is present",n,m)),m+=w.length,m+=e.eatWhiteSpace(n,m);for(var L={startStaff:N},y=function(x){var b=e.getVoiceToken(n,m,v);b.warn!==void 0?t("Expected value for "+x+" in voice: "+b.warn,n,m):b.err!==void 0?t("Expected value for "+x+" in voice: "+b.err,n,m):b.token.length===0&&n[m]!=='"'?t("Expected value for "+x+" in voice",n,m):L[x]=b.token,m+=b.len},g=function(x,b,_){var C=e.getVoiceToken(n,m,v);C.warn!==void 0?t("Expected value for "+b+" in voice: "+C.warn,n,m):C.err!==void 0?t("Expected value for "+b+" in voice: "+C.err,n,m):C.token.length===0&&n[m]!=='"'?t("Expected value for "+b+" in voice",n,m):(_==="number"&&(C.token=parseFloat(C.token)),r.voices[x][b]=C.token),m+=C.len},k=function(x,b){var _=e.getVoiceToken(n,m,v);if(_.warn!==void 0)t("Expected value for "+x+" in voice: "+_.warn,n,m);else if(_.err!==void 0)t("Expected value for "+x+" in voice: "+_.err,n,m);else if(_.token.length===0&&n[m]!=='"')t("Expected value for "+x+" in voice",n,m);else return b==="number"&&(_.token=parseFloat(_.token)),_.token;m+=_.len},F=function(x,b){var _={_B:2,_E:9,_b:-10,_e:-3},C=e.getVoiceToken(n,m,v);if(C.warn!==void 0)t("Expected one of (_B, _E, _b, _e) for "+b+" in voice: "+C.warn,n,m);else if(C.token.length===0&&n[m]!=='"')t("Expected one of (_B, _E, _b, _e) for "+b+" in voice",n,m);else{var P=_[C.token];P?r.voices[x][b]=P:t("Expected one of (_B, _E, _b, _e) for "+b+" in voice",n,m)}m+=C.len};m<v;){var M=e.getVoiceToken(n,m,v);if(m+=M.len,M.warn)t("Error parsing voice: "+M.warn,n,m);else{var D=null;switch(M.token){case"clef":case"cl":y("clef");var S=0;L.clef!==void 0&&(L.clef=L.clef.replace(/[',]/g,""),L.clef.indexOf("+16")!==-1&&(S+=14,L.clef=L.clef.replace("+16","")),L.verticalPos=l(L.clef,S));break;case"treble":case"bass":case"tenor":case"alto":case"perc":case"none":case"treble'":case"bass'":case"tenor'":case"alto'":case"none'":case"treble''":case"bass''":case"tenor''":case"alto''":case"none''":case"treble,":case"bass,":case"tenor,":case"alto,":case"none,":case"treble,,":case"bass,,":case"tenor,,":case"alto,,":case"none,,":var B=0;L.clef=M.token.replace(/[',]/g,""),L.verticalPos=l(L.clef,B),r.voices[w].clef=M.token;break;case"staves":case"stave":case"stv":y("staves");break;case"brace":case"brc":y("brace");break;case"bracket":case"brk":y("bracket");break;case"name":case"nm":y("name");break;case"subname":case"sname":case"snm":y("subname");break;case"merge":L.startStaff=!1;break;case"stem":case"stems":D=e.getVoiceToken(n,m,v),D.warn!==void 0?t("Expected value for stems in voice: "+D.warn,n,m):D.err!==void 0?t("Expected value for stems in voice: "+D.err,n,m):D.token==="up"||D.token==="down"?r.voices[w].stem=D.token:t("Expected up or down for voice stem",n,m),m+=D.len;break;case"up":case"down":r.voices[w].stem=M.token;break;case"middle":case"m":y("verticalPos"),L.verticalPos=o(L.verticalPos).mid;break;case"gchords":case"gch":r.voices[w].suppressChords=!0,D=e.getVoiceToken(n,m,v),D.token==="0"&&(m=m+D.len);break;case"space":case"spc":y("spacing");break;case"scale":g(w,"scale","number");break;case"score":F(w,"scoreTranspose");break;case"transpose":g(w,"transpose","number");break;case"stafflines":g(w,"stafflines","number");break;case"staffscale":g(w,"staffscale","number");break;case"octave":g(w,"octave","number");break;case"volume":g(w,"volume","number");break;case"cue":var A=k("cue","string");A==="on"?r.voices[w].scale=.6:r.voices[w].scale=1;break;case"style":D=e.getVoiceToken(n,m,v),D.warn!==void 0?t("Expected value for style in voice: "+D.warn,n,m):D.err!==void 0?t("Expected value for style in voice: "+D.err,n,m):D.token==="normal"||D.token==="harmonic"||D.token==="rhythm"||D.token==="x"||D.token==="triangle"?r.voices[w].style=D.token:t("Expected one of [normal, harmonic, rhythm, x, triangle] for voice style",n,m),m+=D.len;break}}m+=e.eatWhiteSpace(n,m)}if((L.startStaff||r.staves.length===0)&&(r.staves.push({index:r.staves.length,meter:r.origMeter}),r.score_is_present||(r.staves[r.staves.length-1].numVoices=0)),r.voices[w].staffNum===void 0){r.voices[w].staffNum=r.staves.length-1;var I=0;for(var q in r.voices)r.voices.hasOwnProperty(q)&&r.voices[q].staffNum===r.voices[w].staffNum&&I++;r.voices[w].index=I-1}var O=r.staves[r.voices[w].staffNum];r.score_is_present||O.numVoices++,L.clef&&(O.clef={type:L.clef,verticalPos:L.verticalPos}),L.spacing&&(O.spacing_below_offset=L.spacing),L.verticalPos&&(O.verticalPos=L.verticalPos),L.name&&(O.name?O.name.push(L.name):O.name=[L.name]),L.subname&&(O.subname?O.subname.push(L.subname):O.subname=[L.subname]),d(w)}})();var V=se;function zn(e,t,r,u,c){this.reset=function(a,o,f,d){V.initialize(a,o,f,d,c),J.initialize(a,o,f,d,c)},this.reset(e,t,r,u),this.setTitle=function(a,o){r.hasMainTitle?c.addSubtitle(a,{startChar:r.iChar,endChar:r.iChar+o+2}):(c.addMetaText("title",a,{startChar:r.iChar,endChar:r.iChar+o+2}),r.hasMainTitle=!0)},this.setMeter=function(a){if(a=e.stripComment(a),a==="C")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"common_time"};if(a==="C|")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"cut_time"};if(a==="o")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_perfectum"};if(a==="c")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_imperfectum"};if(a==="o.")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_perfectum_prolatio"};if(a==="c.")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),{type:"tempus_imperfectum_prolatio"};if(a.length===0||a.toLowerCase()==="none")return r.havent_set_length===!0&&(r.default_length=.125,r.havent_set_length=!1),null;var o=e.tokenize(a,0,a.length);try{var f=function(){var m={value:0,num:""},v=o.shift();for(v.token==="("&&(v=o.shift());;){if(v.type!=="number")throw"Expected top number of meter";if(m.value+=parseInt(v.token),m.num+=v.token,o.length===0||o[0].token==="/")return m;if(v=o.shift(),v.token===")"){if(o.length===0||o[0].token==="/")return m;throw"Unexpected paren in meter"}if(v.token!=="."&&v.token!=="+"||(m.num+=v.token,o.length===0))throw"Expected top number of meter";v=o.shift()}return m},d=function(){var m=f();if(o.length===0)return m;var v=o.shift();if(v.token!=="/")throw"Expected slash in meter";if(v=o.shift(),v.type!=="number")throw"Expected bottom number of meter";return m.den=v.token,m.value=m.value/parseInt(m.den),m};if(o.length===0)throw"Expected meter definition in M: line";for(var n={type:"specified",value:[]},i=0;;){var s=d();i+=s.value;var h={num:s.num};if(s.den!==void 0&&(h.den=s.den),n.value.push(h),o.length===0)break}return r.havent_set_length===!0&&(r.default_length=i<.75?.0625:.125,r.havent_set_length=!1),n}catch(m){t(m,a,0)}return null},this.calcTempo=function(a){var o=.25;r.meter&&r.meter.type==="specified"?o=1/parseInt(r.meter.value[0].den):r.origMeter&&r.origMeter.type==="specified"&&(o=1/parseInt(r.origMeter.value[0].den));for(var f=0;f<a.duration;f++)a.duration[f]=o*a.duration[f];return a},this.resolveTempo=function(){r.tempo&&(this.calcTempo(r.tempo),u.metaText.tempo=r.tempo,delete r.tempo)},this.addUserDefinition=function(a,o,f){var d=a.indexOf("=",o);if(d===-1){t("Need an = in a macro definition",a,o);return}var n=G.strip(a.substring(o,d)),i=G.strip(a.substring(d+1));if(n.length!==1){t("Macro definitions can only be one character",a,o);return}var s="HIJKLMNOPQRSTUVWXYhijklmnopqrstuvw~";if(s.indexOf(n)===-1){t("Macro definitions must be H-Y, h-w, or tilde",a,o);return}if(i.length===0){t("Missing macro definition",a,o);return}r.macros===void 0&&(r.macros={}),r.macros[n]=i},this.setDefaultLength=function(a,o,f){var d=a.substring(o,f).replace(/ /g,""),n=d.split("/");if(n.length===2){var i=parseInt(n[0]),s=parseInt(n[1]);s>0&&(r.default_length=i/s,r.havent_set_length=!1)}else n.length===1&&n[0]==="1"&&(r.default_length=1,r.havent_set_length=!1)};var p={larghissimo:20,adagissimo:24,sostenuto:28,grave:32,largo:40,lento:50,larghetto:60,adagio:68,adagietto:74,andante:80,andantino:88,"marcia moderato":84,"andante moderato":100,moderato:112,allegretto:116,"allegro moderato":120,allegro:126,animato:132,agitato:140,veloce:148,"mosso vivo":156,vivace:164,vivacissimo:172,allegrissimo:176,presto:184,prestissimo:210};this.setTempo=function(a,o,f,d){try{var n=e.tokenize(a,o,f);if(n.length===0)throw"Missing parameter in Q: field";var i={startChar:d+o-2,endChar:d+f},s=!0,h=n.shift();if(h.type==="quote"&&(i.preString=h.token,h=n.shift(),n.length===0))return p[i.preString.toLowerCase()]&&(i.bpm=p[i.preString.toLowerCase()],i.suppressBpm=!0),{type:"immediate",tempo:i};if(h.type==="alpha"&&h.token==="C"){if(n.length===0)throw"Missing tempo after C in Q: field";if(h=n.shift(),h.type==="punct"&&h.token==="="){if(n.length===0)throw"Missing tempo after = in Q: field";if(h=n.shift(),h.type!=="number")throw"Expected number after = in Q: field";i.duration=[1],i.bpm=parseInt(h.token)}else if(h.type==="number"){if(i.duration=[parseInt(h.token)],n.length===0)throw"Missing = after duration in Q: field";if(h=n.shift(),h.type!=="punct"||h.token!=="=")throw"Expected = after duration in Q: field";if(n.length===0)throw"Missing tempo after = in Q: field";if(h=n.shift(),h.type!=="number")throw"Expected number after = in Q: field";i.bpm=parseInt(h.token)}else throw"Expected number or equal after C in Q: field"}else if(h.type==="number"){var m=parseInt(h.token);if(n.length===0||n[0].type==="quote")i.duration=[1],i.bpm=m;else{if(s=!1,h=n.shift(),h.type!=="punct"&&h.token!=="/"||(h=n.shift(),h.type!=="number"))throw"Expected fraction in Q: field";var v=parseInt(h.token);for(i.duration=[m/v];n.length>0&&n[0].token!=="="&&n[0].type!=="quote";){if(h=n.shift(),h.type!=="number"||(m=parseInt(h.token),h=n.shift(),h.type!=="punct"&&h.token!=="/")||(h=n.shift(),h.type!=="number"))throw"Expected fraction in Q: field";v=parseInt(h.token),i.duration.push(m/v)}if(h=n.shift(),h.type!=="punct"&&h.token!=="=")throw"Expected = in Q: field";if(h=n.shift(),h.type!=="number")throw"Expected tempo in Q: field";i.bpm=parseInt(h.token)}}else throw"Unknown value in Q: field";if(n.length!==0&&(h=n.shift(),h.type==="quote"&&(i.postString=h.token,h=n.shift()),n.length!==0))throw"Unexpected string at end of Q: field";return r.printTempo===!1&&(i.suppress=!0),{type:s?"delaySet":"immediate",tempo:i}}catch(w){return t(w,a,o),{type:"none"}}},this.letter_to_inline_header=function(a,o,f){var d=e.eatWhiteSpace(a,o);if(o+=d,a.length>=o+5&&a[o]==="["&&a[o+2]===":"){var n=a.indexOf("]",o),i=r.iChar+o,s=r.iChar+n+1;switch(a.substring(o,o+3)){case"[I:":var h=J.addDirective(a.substring(o+3,n));return h&&t(h,a,o),[n-o+1+d];case"[M:":var m=this.setMeter(a.substring(o+3,n));return c.hasBeginMusic()&&m?c.appendStartingElement("meter",i,s,m):r.meter=m,[n-o+1+d];case"[K:":var v=V.parseKey(a.substring(o+3,n),!0);return v.foundClef&&c.hasBeginMusic()&&c.appendStartingElement("clef",i,s,r.clef),v.foundKey&&c.hasBeginMusic()&&c.appendStartingElement("key",i,s,V.fixKey(r.clef,r.key)),[n-o+1+d];case"[P:":var w=J.parseFontChangeLine(a.substring(o+3,n));return f||u.lines.length<=u.lineNum?r.partForNextLine={title:w,startChar:i,endChar:s}:c.appendElement("part",i,s,{title:w}),[n-o+1+d];case"[L:":return this.setDefaultLength(a,o+3,n),[n-o+1+d];case"[Q:":if(n>0){var N=this.setTempo(a,o+3,n,r.iChar);return N.type==="delaySet"?c.hasBeginMusic()?c.appendElement("tempo",i,s,this.calcTempo(N.tempo)):r.tempoForNextLine=["tempo",i,s,this.calcTempo(N.tempo)]:N.type==="immediate"&&(!f&&c.hasBeginMusic()?c.appendElement("tempo",i,s,N.tempo):r.tempoForNextLine=["tempo",i,s,N.tempo]),[n-o+1+d,a[o+1],a.substring(o+3,n)]}break;case"[V:":if(n>0)return V.parseVoice(a,o+3,n),[n-o+1+d,a[o+1],a.substring(o+3,n)];break;case"[r:":return[n-o+1+d];default:}}return[0]},this.letter_to_body_header=function(a,o){if(a.length>=o+3)switch(a.substring(o,o+2)){case"I:":var f=J.addDirective(a.substring(o+2));return f&&t(f,a,o),[a.length];case"M:":var d=this.setMeter(a.substring(o+2));return c.hasBeginMusic()&&d&&c.appendStartingElement("meter",r.iChar+o,r.iChar+a.length,d),[a.length];case"K:":var n=V.parseKey(a.substring(o+2),c.hasBeginMusic());return n.foundClef&&c.hasBeginMusic()&&c.appendStartingElement("clef",r.iChar+o,r.iChar+a.length,r.clef),n.foundKey&&c.hasBeginMusic()&&c.appendStartingElement("key",r.iChar+o,r.iChar+a.length,V.fixKey(r.clef,r.key)),[a.length];case"P:":return c.hasBeginMusic()&&c.appendElement("part",r.iChar+o,r.iChar+a.length,{title:a.substring(o+2)}),[a.length];case"L:":return this.setDefaultLength(a,o+2,a.length),[a.length];case"Q:":var i=a.indexOf("",o+2);i===-1&&(i=a.length);var s=this.setTempo(a,o+2,i,r.iChar);return s.type==="delaySet"?c.appendElement("tempo",r.iChar+o,r.iChar+a.length,this.calcTempo(s.tempo)):s.type==="immediate"&&c.appendElement("tempo",r.iChar+o,r.iChar+a.length,s.tempo),[i,a[o],G.strip(a.substring(o+2))];case"V:":return V.parseVoice(a,o+2,a.length),[a.length,a[o],G.strip(a.substring(o+2))];default:}return[0]};var l={A:"author",B:"book",C:"composer",D:"discography",F:"url",G:"group",I:"instruction",N:"notes",O:"origin",R:"rhythm",S:"source",W:"unalignedWords",Z:"transcription"};this.parseHeader=function(a){var o=l[a[0]],f=a.length-2,d=e.translateString(e.stripComment(a.substring(2)));if(o==="unalignedWords"||o==="notes")c.addMetaTextArray(o,J.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+a.length});else if(o!==void 0)c.addMetaText(o,J.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+a.length});else{var n=r.iChar,i=n+a.length;switch(a[0]){case"H":for(c.addMetaTextArray("history",J.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+a.length}),a=e.peekLine();a&&a[1]!==":";)e.nextLine(),c.addMetaTextArray("history",J.parseFontChangeLine(e.translateString(e.stripComment(a))),{startChar:r.iChar,endChar:r.iChar+a.length}),a=e.peekLine();break;case"K":this.resolveTempo();var s=V.parseKey(a.substring(2),!1);!r.is_in_header&&c.hasBeginMusic()&&(s.foundClef&&c.appendStartingElement("clef",n,i,r.clef),s.foundKey&&c.appendStartingElement("key",n,i,V.fixKey(r.clef,r.key))),r.is_in_header=!1;break;case"L":this.setDefaultLength(a,2,a.length);break;case"M":r.origMeter=r.meter=this.setMeter(a.substring(2));break;case"P":r.is_in_header?c.addMetaText("partOrder",J.parseFontChangeLine(d),{startChar:r.iChar,endChar:r.iChar+a.length}):r.partForNextLine={title:d,startChar:n,endChar:i};break;case"Q":var h=this.setTempo(a,2,a.length,r.iChar);h.type==="delaySet"?r.tempo=h.tempo:h.type==="immediate"&&(u.metaText.tempo?r.tempoForNextLine=["tempo",n,i,h.tempo]:u.metaText.tempo=h.tempo);break;case"T":r.titlecaps&&(d=d.toUpperCase()),this.setTitle(J.parseFontChangeLine(e.theReverser(d)),f);break;case"U":this.addUserDefinition(a,2,a.length);break;case"V":if(V.parseVoice(a,2,a.length),!r.is_in_header)return{newline:!0};break;case"s":return{symbols:!0};case"w":return{words:!0};case"X":break;case"E":case"m":t("Ignored header",a,0);break;default:return{regular:!0}}}return{}}}var Nr=["trill","lowermordent","uppermordent","mordent","pralltriller","accent","fermata","invertedfermata","tenuto","0","1","2","3","4","5","+","wedge","open","thumb","snap","turn","roll","breath","shortphrase","mediumphrase","longphrase","segno","coda","D.S.","D.C.","fine","beambr1","beambr2","slide","marcato","upbow","downbow","/","//","///","////","trem1","trem2","trem3","trem4","turnx","invertedturn","invertedturnx","trill(","trill)","arpeggio","xstem","mark","umarcato","style=normal","style=harmonic","style=rhythm","style=x","style=triangle","D.C.alcoda","D.C.alfine","D.S.alcoda","D.S.alfine","editorial","courtesy"],_r=["p","pp","f","ff","mf","mp","ppp","pppp","fff","ffff","sfz"],Tr=["crescendo(","crescendo)","diminuendo(","diminuendo)","glissando(","glissando)","~(","~)"],Br=[["<","accent"],[">","accent"],["tr","trill"],["plus","+"],["emphasis","accent"],["^","umarcato"],["marcato","umarcato"]],Lr=[["<(","crescendo("],["<)","crescendo)"],[">(","diminuendo("],[">)","diminuendo)"]],Un="ABCDEFGabcdefgxyzZ[]|^_{",Wn=[.5,.75,.875,.9375,.96875,.984375,.25,.375,.4375,.46875,.484375,.4921875,.125,.1875,.21875,.234375,.2421875,.24609375,.0625,.09375,.109375,.1171875,.12109375,.123046875,.03125,.046875,.0546875,.05859375,.060546875,.0615234375,.015625,.0234375,.02734375,.029296875,.0302734375,.03076171875],Kn={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11},Qn={x:"invisible",X:"invisible-multimeasure",y:"spacer",z:"rest",Z:"multimeasure"},Ar={dblflat:"__",flat:"_",natural:"=",sharp:"^",dblsharp:"^^",quarterflat:"_/",quartersharp:"^/"},Xn={2:3,3:2,4:3,5:2,6:2,7:2,8:3,9:2};var Q,Z,E,ge,ke,xt;function wt(e,t,r,u,c,p){Q=e,Z=t,E=r,ge=u,ke=c,xt=p,this.lineContinuation=!1}var Zn=function(e,t,r){if(e.inTie[t]===void 0)return!1;var u=e.currentVoice?e.currentVoice.staffNum*100+e.currentVoice.index:0;return!!(e.inTie[t][u]&&(r.pitches!==void 0||r.rest.type!=="spacer"))},T={};wt.prototype.parseMusic=function(e){xt.resolveTempo(),E.is_in_header=!1;for(var t=0,r=E.iChar;Q.isWhiteSpace(e[t])&&t<e.length;)t++;if(!(t===e.length||e[t]==="%")){var u=E.start_new_line;E.continueall===void 0?E.start_new_line=!0:E.start_new_line=!1;var c=0,p=xt.letter_to_body_header(e,t);p[0]>0&&(t+=p[0],p[1]==="V"&&this.startNewLine());for(var l=0;t<e.length;){var a=t;if(e[t]==="%")break;var o=xt.letter_to_inline_header(e,t,u);if(o[0]>0)t+=o[0],o[1]==="V"&&(u=!0);else{(!ke.hasBeginMusic()||u&&!this.lineContinuation)&&(this.startNewLine(),u=!1);for(var f;;)if(f=Q.eatWhiteSpace(e,t),f>0&&(t+=f),t>0&&e[t-1]===""&&(f=xt.letter_to_body_header(e,t),f[0]>0&&(f[1]==="V"&&this.startNewLine(),t=f[0],E.start_new_line=!1)),f=Xi(e,t),f[0]>0&&(t+=f[0]),f=Wi(e,t),f[0]>0){T.chord||(T.chord=[]);var d=Q.translateString(f[1]);d=d.replace(/;/g,`
`);for(var n=!1,i=0;i<T.chord.length;i++)T.chord[i].position===f[2]&&(n=!0,T.chord[i].name+=`
`+d);n===!1&&(f[2]===null&&f[3]?T.chord.push({name:d,rel_position:f[3]}):T.chord.push({name:d,position:f[2]})),t+=f[0];var s=Q.skipWhiteSpace(e.substring(t));s>0&&(T.force_end_beam_last=!0),t+=s}else if(Un.indexOf(e[t])===-1?f=Yn(e,t):f=[0],f[0]>0)f[1]===null?t+1<e.length&&this.startNewLine():f[1].length>0&&(f[1].indexOf("style=")===0?T.style=f[1].substr(6):(T.decoration===void 0&&(T.decoration=[]),f[1]==="beambr1"?T.beambr=1:f[1]==="beambr2"?T.beambr=2:T.decoration.push(f[1]))),t+=f[0];else if(f=Ki(e,t),f[0]>0)T.gracenotes=f[1],t+=f[0];else break;if(f=Zi(e,t),f[0]>0){l=0,T.gracenotes!==void 0&&(T.rest={type:"spacer"},T.duration=.125,E.addFormattingOptions(T,ge.formatting,"note"),ke.appendElement("note",r+t,r+t+f[0],T),E.measureNotEmpty=!0,T={});var h={type:f[1]};if(h.type.length===0)Z("Unknown bar type",e,t);else{if(E.inEnding&&h.type!=="bar_thin"&&(h.endEnding=!0,E.inEnding=!1),f[2]&&(h.startEnding=f[2],E.inEnding&&(h.endEnding=!0),E.inEnding=!0,f[1]==="bar_right_repeat"?E.restoreStartEndingHoldOvers():E.duplicateStartEndingHoldOvers()),T.decoration!==void 0&&(h.decoration=T.decoration),T.chord!==void 0&&(h.chord=T.chord),h.startEnding&&E.barFirstEndingNum===void 0?E.barFirstEndingNum=E.currBarNumber:h.startEnding&&h.endEnding&&E.barFirstEndingNum?E.currBarNumber=E.barFirstEndingNum:h.endEnding&&(E.barFirstEndingNum=void 0),h.type!=="bar_invisible"&&E.measureNotEmpty){var m=E.currentVoice===void 0||E.currentVoice.staffNum===0&&E.currentVoice.index===0;m&&(E.currBarNumber++,E.barNumbers&&E.currBarNumber%E.barNumbers===0&&(h.barNumber=E.currBarNumber))}E.addFormattingOptions(T,ge.formatting,"bar"),ke.appendElement("bar",r+a,r+t+f[0],h),E.measureNotEmpty=!1,T={}}t+=f[0]}else if(e[t]==="&")f=Qi(e,t),f[0]>0&&(ke.appendElement("overlay",r,r+1,{}),t+=1,l++);else{if(f=Ji(e,t),f.consumed>0&&(f.startSlur!==void 0&&(T.startSlur=f.startSlur),f.dottedSlur&&(T.dottedSlur=!0),f.triplet!==void 0&&(c>0?Z("Can't nest triplets",e,t):(T.startTriplet=f.triplet,T.tripletMultiplier=f.tripletQ/f.triplet,T.tripletR=f.num_notes,c=f.num_notes===void 0?f.triplet:f.num_notes)),t+=f.consumed),e[t]==="["){var v=t;t++;for(var w=null,N=!1,L=!1;!L;){var y=Yn(e,t);y[0]>0&&(t+=y[0]);var g=Mr(e,t,{},!1);if(g!==null&&g.pitch!==void 0)y[0]>0&&y[1].indexOf("style=")!==0&&(T.decoration===void 0&&(T.decoration=[]),T.decoration.push(y[1])),g.end_beam&&(T.end_beam=!0,delete g.end_beam),T.pitches===void 0?(T.duration=g.duration,T.pitches=[g]):T.pitches.push(g),delete g.duration,y[0]>0&&y[1].indexOf("style=")===0&&(T.pitches[T.pitches.length-1].style=y[1].substr(6)),E.inTieChord[T.pitches.length]&&(g.endTie=!0,E.inTieChord[T.pitches.length]=void 0),g.startTie&&(E.inTieChord[T.pitches.length]=!0),t=g.endChar,delete g.endChar;else if(e[t]===" ")Z("Spaces are not allowed in chords",e,t),t++;else{if(t<e.length&&e[t]==="]"){t++,E.next_note_duration!==0&&(T.duration=T.duration*E.next_note_duration,E.next_note_duration=0),Zn(E,l,T)&&(T.pitches.forEach(function(A){A.endTie=!0}),bt(E,l,!1)),c>0&&!(T.rest&&T.rest.type==="spacer")&&(c--,c===0&&(T.endTriplet=!0));for(var k=!1;t<e.length&&!k;){switch(e[t]){case" ":case"	":yt(T);break;case")":T.endSlur===void 0?T.endSlur=1:T.endSlur++;break;case"-":T.pitches.forEach(function(A){A.startTie={}}),bt(E,l,!0);break;case">":case"<":var F=jn(e,t);t+=F[0]-1,E.next_note_duration=F[2],w?w=w*F[1]:w=F[1];break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"/":var M=Q.getFraction(e,t);w=M.value,t=M.index;var D=e[t];D===" "&&(N=!0),D==="-"||D===")"||D===" "||D==="<"||D===">"?t--:k=!0;break;default:k=!0;break}k||t++}}else Z("Expected ']' to end the chords",e,t);T.pitches!==void 0&&(w!==null&&(T.duration=T.duration*w,N&&yt(T)),E.addFormattingOptions(T,ge.formatting,"note"),ke.appendElement("note",r+a,r+t,T),E.measureNotEmpty=!0,T={}),L=!0}}}else{var S={},B=Mr(e,t,S,!0);S.endTie!==void 0&&bt(E,l,!0),B!==null&&(B.pitch!==void 0?(T.pitches=[{}],B.accidental!==void 0&&(T.pitches[0].accidental=B.accidental),T.pitches[0].pitch=B.pitch,T.pitches[0].name=B.name,(B.midipitch||B.midipitch===0)&&(T.pitches[0].midipitch=B.midipitch),B.endSlur!==void 0&&(T.pitches[0].endSlur=B.endSlur),B.endTie!==void 0&&(T.pitches[0].endTie=B.endTie),B.startSlur!==void 0&&(T.pitches[0].startSlur=B.startSlur),T.startSlur!==void 0&&(T.pitches[0].startSlur=T.startSlur),T.dottedSlur!==void 0&&(T.pitches[0].dottedSlur=!0),B.startTie!==void 0&&(T.pitches[0].startTie=B.startTie),T.startTie!==void 0&&(T.pitches[0].startTie=T.startTie)):(T.rest=B.rest,B.endSlur!==void 0&&(T.endSlur=B.endSlur),B.endTie!==void 0&&(T.rest.endTie=B.endTie),B.startSlur!==void 0&&(T.startSlur=B.startSlur),B.startTie!==void 0&&(T.rest.startTie=B.startTie),T.startTie!==void 0&&(T.rest.startTie=T.startTie)),B.chord!==void 0&&(T.chord=B.chord),B.duration!==void 0&&(T.duration=B.duration),B.decoration!==void 0&&(T.decoration=B.decoration),B.graceNotes!==void 0&&(T.graceNotes=B.graceNotes),delete T.startSlur,delete T.dottedSlur,Zn(E,l,T)&&(T.pitches!==void 0?T.pitches[0].endTie=!0:T.rest.type!=="spacer"&&(T.rest.endTie=!0),bt(E,l,!1)),(B.startTie||T.startTie)&&bt(E,l,!0),t=B.endChar,c>0&&!(B.rest&&B.rest.type==="spacer")&&(c--,c===0&&(T.endTriplet=!0)),B.end_beam&&yt(T),T.rest&&T.rest.type==="rest"&&T.duration===1&&Jn(E)<=1&&(T.rest.type="whole",T.duration=Jn(E)),T.duration<1&&Wn.indexOf(T.duration)===-1&&T.duration!==0&&(!T.rest||T.rest.type!=="spacer")&&Z("Duration not representable: "+e.substring(a,t),e,t),E.addFormattingOptions(T,ge.formatting,"note"),ke.appendElement("note",r+a,r+t,T),E.measureNotEmpty=!0,T={})}t===a&&(e[t]!==" "&&e[t]!=="`"&&Z("Unknown character ignored",e,t),t++)}}}this.lineContinuation=e.indexOf("")>=0||p[0]>0,this.lineContinuation||(T={})}};var bt=function(e,t,r){var u=e.currentVoice?e.currentVoice.staffNum*100+e.currentVoice.index:0;e.inTie[t]===void 0&&(e.inTie[t]=[]),e.inTie[t][u]=r},Wi=function(e,t){if(e[t]==='"'){var r=Q.getBrackettedSubstring(e,t,5);if(r[2]||Z("Missing the closing quote while parsing the chord symbol",e,t),r[0]>0&&r[1].length>0&&r[1][0]==="^")r[1]=r[1].substring(1),r[2]="above";else if(r[0]>0&&r[1].length>0&&r[1][0]==="_")r[1]=r[1].substring(1),r[2]="below";else if(r[0]>0&&r[1].length>0&&r[1][0]==="<")r[1]=r[1].substring(1),r[2]="left";else if(r[0]>0&&r[1].length>0&&r[1][0]===">")r[1]=r[1].substring(1),r[2]="right";else if(r[0]>0&&r[1].length>0&&r[1][0]==="@"){r[1]=r[1].substring(1);var u=Q.getFloat(r[1]);u.digits===0&&Z("Missing first position in absolutely positioned annotation.",e,t),r[1]=r[1].substring(u.digits),r[1][0]!==","&&Z("Missing comma absolutely positioned annotation.",e,t),r[1]=r[1].substring(1);var c=Q.getFloat(r[1]);c.digits===0&&Z("Missing second position in absolutely positioned annotation.",e,t),r[1]=r[1].substring(c.digits);var p=Q.skipWhiteSpace(r[1]);r[1]=r[1].substring(p),r[2]=null,r[3]={x:u.value,y:c.value}}else E.freegchord!==!0&&(r[1]=r[1].replace(/([ABCDEFG0-9])b/g,"$1‚ô≠"),r[1]=r[1].replace(/([ABCDEFG0-9])#/g,"$1‚ôØ"),r[1]=r[1].replace(/^([ABCDEFG])([‚ôØ‚ô≠]?)o([^A-Za-z])/g,"$1$2¬∞$3"),r[1]=r[1].replace(/^([ABCDEFG])([‚ôØ‚ô≠]?)o$/g,"$1$2¬∞"),r[1]=r[1].replace(/^([ABCDEFG])([‚ôØ‚ô≠]?)0([^A-Za-z])/g,"$1$2√∏$3"),r[1]=r[1].replace(/^([ABCDEFG])([‚ôØ‚ô≠]?)\^([^A-Za-z])/g,"$1$2‚àÜ$3")),r[2]="default",r[1]=vt.chordName(E,r[1]);return r}return[0,""]},Ki=function(e,t){if(e[t]==="{"){var r=Q.getBrackettedSubstring(e,t,1,"}");r[2]||Z("Missing the closing '}' while parsing grace note",e,t),e[t+r[0]]===")"&&(r[0]++,r[1]+=")");for(var u=[],c=0,p=!1;c<r[1].length;){var l=!1;r[1][c]==="/"&&(l=!0,c++);var a=Mr(r[1],c,{},!1);a!==null?(a.duration=a.duration/(E.default_length*8),l&&(a.acciaccatura=!0),u.push(a),p&&(a.endTie=!0,p=!1),a.startTie&&(p=!0),c=a.endChar,delete a.endChar,a.end_beam&&(a.endBeam=!0,delete a.end_beam)):(r[1][c]===" "?u.length>0&&(u[u.length-1].endBeam=!0):Z("Unknown character '"+r[1][c]+"' while parsing grace note",e,t),c++)}if(u.length)return[r[0],u]}return[0]};function Qi(e,t){if(e[t]==="&"){for(var r=t;e[t]&&e[t]!==":"&&e[t]!=="|";)t++;return[t-r,e.substring(r+1,t)]}return[0]}function Jn(e){var t=e.origMeter;return!t||t.type!=="specified"||!t.value||t.value.length===0?1:parseInt(t.value[0].num,10)/parseInt(t.value[0].den,10)}var Yn=function(e,t){var r=E.macros[e[t]];if(r!==void 0)return(r[0]==="!"||r[0]==="+")&&(r=r.substring(1)),(r[r.length-1]==="!"||r[r.length-1]==="+")&&(r=r.substring(0,r.length-1)),Nr.includes(r)?[1,r]:_r.includes(r)?(E.volumePosition==="hidden"&&(r=""),[1,r]):Tr.includes(r)?(E.dynamicPosition==="hidden"&&(r=""),[1,r]):(E.ignoredDecorations.includes(r)||Z("Unknown macro: "+r,e,t),[1,""]);switch(e[t]){case".":if(e[t+1]==="("||e[t+1]==="-")break;return[1,"staccato"];case"u":return[1,"upbow"];case"v":return[1,"downbow"];case"~":return[1,"irishroll"];case"!":case"+":var u=Q.getBrackettedSubstring(e,t,5);if(u[1].length>1&&(u[1][0]==="^"||u[1][0]==="_")&&(u[1]=u[1].substring(1)),Nr.includes(u[1]))return u;if(_r.includes(u[1]))return E.volumePosition==="hidden"&&(u[1]=""),u;if(Tr.includes(u[1]))return E.dynamicPosition==="hidden"&&(u[1]=""),u;var c=Br.findIndex(function(p){return u[1]===p[0]});return c>=0?(u[1]=Br[c][1],u):(c=Lr.findIndex(function(p){return u[1]===p[0]}),c>=0?(u[1]=Lr[c][1],E.dynamicPosition==="hidden"&&(u[1]=""),u):e[t]==="!"&&(u[0]===1||e[t+u[0]-1]!=="!")?[1,null]:(Z("Unknown decoration: "+u[1],e,t),u[1]="",u));case"H":return[1,"fermata"];case"J":return[1,"slide"];case"L":return[1,"accent"];case"M":return[1,"mordent"];case"O":return[1,"coda"];case"P":return[1,"pralltriller"];case"R":return[1,"roll"];case"S":return[1,"segno"];case"T":return[1,"trill"]}return[0,0]},Xi=function(e,t){for(var r=t;Q.isWhiteSpace(e[t]);)t++;return[t-r]},Zi=function(e,t){var r=Q.getBarLine(e,t);if(r.len===0)return[0,""];if(r.warn)return Z(r.warn,e,t),[r.len,""];for(var u=0;u<e.length&&e[t+r.len+u]===" ";u++);var c=r.len;if(e[t+r.len+u]==="["&&(r.len+=u+1),e[t+r.len]==='"'&&e[t+r.len-1]==="["){var p=Q.getBrackettedSubstring(e,t+r.len,5);return[r.len+p[0],r.token,p[1]]}var l=Q.getTokenOf(e.substring(t+r.len),"1234567890-,");return l.len===0||l.token[0]==="-"?[c,r.token]:[r.len+l.len,r.token,l.token]},Ji=function(e,t){var r={},u=t;for(e[t]==="."&&e[t+1]==="("&&(r.dottedSlur=!0,t++);e[t]==="("||Q.isWhiteSpace(e[t]);)e[t]==="("&&(t+1<e.length&&e[t+1]>="2"&&e[t+1]<="9"?(r.triplet!==void 0?Z("Can't nest triplets",e,t):(r.triplet=e[t+1]-"0",r.tripletQ=Xn[r.triplet],r.num_notes=r.triplet,t+2<e.length&&e[t+2]===":"&&(t+3<e.length&&e[t+3]===":"?t+4<e.length&&e[t+4]>="1"&&e[t+4]<="9"?(r.num_notes=e[t+4]-"0",t+=3):Z("expected number after the two colons after the triplet to mark the duration",e,t):t+3<e.length&&e[t+3]>="1"&&e[t+3]<="9"?(r.tripletQ=e[t+3]-"0",t+4<e.length&&e[t+4]===":"?t+5<e.length&&e[t+5]>="1"&&e[t+5]<="9"&&(r.num_notes=e[t+5]-"0",t+=4):t+=2):Z("expected number after the triplet to mark the duration",e,t))),t++):r.startSlur===void 0?r.startSlur=1:r.startSlur++),t++;return r.consumed=t-u,r};wt.prototype.startNewLine=function(){var e={startChar:-1,endChar:-1};E.partForNextLine.title&&(e.part=E.partForNextLine),e.clef=E.currentVoice&&E.staves[E.currentVoice.staffNum].clef!==void 0?G.clone(E.staves[E.currentVoice.staffNum].clef):G.clone(E.clef);var t=E.currentVoice?E.currentVoice.scoreTranspose:0;if(e.key=V.standardKey(E.key.root+E.key.acc+E.key.mode,E.key.root,E.key.acc,t),e.key.mode=E.key.mode,E.key.impliedNaturals&&(e.key.impliedNaturals=E.key.impliedNaturals),E.key.explicitAccidentals)for(var r=0;r<E.key.explicitAccidentals.length;r++){for(var u=!1,c=0;c<e.key.accidentals.length;c++)e.key.accidentals[c].note===E.key.explicitAccidentals[r].note&&(e.key.accidentals[c].acc=E.key.explicitAccidentals[r].acc,u=!0);u||e.key.accidentals.push(E.key.explicitAccidentals[r])}if(E.targetKey=e.key,e.key.explicitAccidentals&&delete e.key.explicitAccidentals,V.addPosToKey(e.clef,e.key),E.meter!==null?(E.currentVoice?(E.staves.forEach(function(a){a.meter=E.meter}),e.meter=E.staves[E.currentVoice.staffNum].meter,E.staves[E.currentVoice.staffNum].meter=null):e.meter=E.meter,E.meter=null):E.currentVoice&&E.staves[E.currentVoice.staffNum].meter&&(e.meter=E.staves[E.currentVoice.staffNum].meter,E.staves[E.currentVoice.staffNum].meter=null),E.currentVoice&&E.currentVoice.name&&(e.name=E.currentVoice.name),E.vocalfont&&(e.vocalfont=E.vocalfont),E.tripletfont&&(e.tripletfont=E.tripletfont),E.gchordfont&&(e.gchordfont=E.gchordfont),E.style&&(e.style=E.style),E.currentVoice){var p=E.staves[E.currentVoice.staffNum];p.brace&&(e.brace=p.brace),p.bracket&&(e.bracket=p.bracket),p.connectBarLines&&(e.connectBarLines=p.connectBarLines),p.name&&(e.name=p.name[E.currentVoice.index]),p.subname&&(e.subname=p.subname[E.currentVoice.index]),E.currentVoice.stem&&(e.stem=E.currentVoice.stem),E.currentVoice.stafflines&&(e.stafflines=E.currentVoice.stafflines),E.currentVoice.staffscale&&(e.staffscale=E.currentVoice.staffscale),E.currentVoice.scale&&(e.scale=E.currentVoice.scale),E.currentVoice.color&&(e.color=E.currentVoice.color),E.currentVoice.style&&(e.style=E.currentVoice.style),E.currentVoice.transpose&&(e.clef.transpose=E.currentVoice.transpose)}var l=E.currentVoice===void 0||E.currentVoice.staffNum===0&&E.currentVoice.index===0;E.barNumbers===0&&l&&E.currBarNumber!==1&&(e.barNumber=E.currBarNumber),ke.startNewLine(e),E.key.impliedNaturals&&delete E.key.impliedNaturals,E.partForNextLine={},E.tempoForNextLine.length===4&&ke.appendElement(E.tempoForNextLine[0],E.tempoForNextLine[1],E.tempoForNextLine[2],E.tempoForNextLine[3]),E.tempoForNextLine=[]};var yt=function(e){return e.duration!==void 0&&e.duration<.25&&(e.end_beam=!0),e},Mr=function(e,t,r,u){var c=function(i){return i==="octave"||i==="duration"||i==="Zduration"||i==="broken_rhythm"||i==="end_slur"},p;e[t]==="."&&e[t+1]==="-"&&(p=!0,t++);for(var l="startSlur",a=!1;;){switch(e[t]){case"(":if(l==="startSlur")r.startSlur===void 0?r.startSlur=1:r.startSlur++;else return c(l)?(r.endChar=t,r):null;break;case")":if(c(l))r.endSlur===void 0?r.endSlur=1:r.endSlur++;else return null;break;case"^":if(l==="startSlur")r.accidental="sharp",l="sharp2";else if(l==="sharp2")r.accidental="dblsharp",l="pitch";else return c(l)?(r.endChar=t,r):null;break;case"_":if(l==="startSlur")r.accidental="flat",l="flat2";else if(l==="flat2")r.accidental="dblflat",l="pitch";else return c(l)?(r.endChar=t,r):null;break;case"=":if(l==="startSlur")r.accidental="natural",l="pitch";else return c(l)?(r.endChar=t,r):null;break;case"A":case"B":case"C":case"D":case"E":case"F":case"G":case"a":case"b":case"c":case"d":case"e":case"f":case"g":if(l==="startSlur"||l==="sharp2"||l==="flat2"||l==="pitch"){if(r.pitch=Kn[e[t]],r.pitch+=7*(E.currentVoice&&E.currentVoice.octave!==void 0?E.currentVoice.octave:E.octave),r.name=e[t],r.accidental&&(r.name=Ar[r.accidental]+r.name),vt.note(E,r),l="octave",u&&E.next_note_duration!==0?(r.duration=E.default_length*E.next_note_duration,E.next_note_duration=0,a=!0):r.duration=E.default_length,E.clef&&E.clef.type==="perc"||E.currentVoice&&E.currentVoice.clef==="perc"){var o=e[t];r.accidental&&(o=Ar[r.accidental]+o),ge.formatting&&ge.formatting.midi&&ge.formatting.midi.drummap&&(r.midipitch=ge.formatting.midi.drummap[o])}}else return c(l)?(r.endChar=t,r):null;break;case",":if(l==="octave")r.pitch-=7,r.name+=",";else return c(l)?(r.endChar=t,r):null;break;case"'":if(l==="octave")r.pitch+=7,r.name+="'";else return c(l)?(r.endChar=t,r):null;break;case"x":case"X":case"y":case"z":case"Z":if(l==="startSlur")r.rest={type:Qn[e[t]]},delete r.accidental,delete r.startSlur,delete r.startTie,delete r.endSlur,delete r.endTie,delete r.end_beam,delete r.grace_notes,r.rest.type.indexOf("multimeasure")>=0?(r.duration=ge.getBarLength(),r.rest.text=1,l="Zduration"):(u&&E.next_note_duration!==0?(r.duration=E.default_length*E.next_note_duration,E.next_note_duration=0,a=!0):r.duration=E.default_length,l="duration");else return c(l)?(r.endChar=t,r):null;break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":case"/":if(l==="octave"||l==="duration"){var f=Q.getFraction(e,t);for(r.duration=r.duration*f.value,r.endChar=f.index;f.index<e.length&&(Q.isWhiteSpace(e[f.index])||e[f.index]==="-");)e[f.index]==="-"?r.startTie={}:r=yt(r),f.index++;t=f.index-1,l="broken_rhythm"}else if(l==="sharp2")r.accidental="quartersharp",l="pitch";else if(l==="flat2")r.accidental="quarterflat",l="pitch";else if(l==="Zduration"){var d=Q.getNumber(e,t);return r.duration=d.num*ge.getBarLength(),r.rest.text=d.num,r.endChar=d.index,r}else return null;break;case"-":if(l==="startSlur")ke.addTieToLastNote(p),r.endTie=!0;else if(l==="octave"||l==="duration"||l==="end_slur")if(r.startTie={},!a&&u)l="broken_rhythm";else return Q.isWhiteSpace(e[t+1])&&yt(r),r.endChar=t+1,r;else return l==="broken_rhythm"?(r.endChar=t,r):null;break;case" ":case"	":if(c(l)){r.end_beam=!0,p=!1;do e[t]==="."&&e[t+1]==="-"&&(p=!0,t++),e[t]==="-"&&(r.startTie={},p&&(r.startTie.style="dotted")),t++;while(t<e.length&&(Q.isWhiteSpace(e[t])||e[t]==="-")||e[t]==="."&&e[t+1]==="-");if(r.endChar=t,!a&&u&&(e[t]==="<"||e[t]===">"))t--,l="broken_rhythm";else return r}else return null;break;case">":case"<":if(c(l))if(u){var n=jn(e,t);t+=n[0]-1,E.next_note_duration=n[2],r.duration=n[1]*r.duration,l="end_slur"}else return r.endChar=t,r;else return null;break;default:return c(l)?(r.endChar=t,r):null}if(t++,t===e.length)return c(l)?(r.endChar=t,r):null}return null},jn=function(e,t){switch(e[t]){case">":return t<e.length-2&&e[t+1]===">"&&e[t+2]===">"?[3,1.875,.125]:t<e.length-1&&e[t+1]===">"?[2,1.75,.25]:[1,1.5,.5];case"<":return t<e.length-2&&e[t+1]==="<"&&e[t+2]==="<"?[3,.125,1.875]:t<e.length-1&&e[t+1]==="<"?[2,.25,1.75]:[1,.5,1.5]}return null};var Dr=function(e,t){this.lineIndex=0,this.lines=e,this.multilineVars=t,this.skipWhiteSpace=function(n){for(var i=0;i<n.length;i++)if(!this.isWhiteSpace(n[i]))return i;return n.length};var r=function(n,i){return i>=n.length};this.eatWhiteSpace=function(n,i){for(var s=i;s<n.length;s++)if(!this.isWhiteSpace(n[s]))return s-i;return s-i},this.getKeyPitch=function(n){var i=this.skipWhiteSpace(n);if(r(n,i))return{len:0};switch(n[i]){case"A":return{len:i+1,token:"A"};case"B":return{len:i+1,token:"B"};case"C":return{len:i+1,token:"C"};case"D":return{len:i+1,token:"D"};case"E":return{len:i+1,token:"E"};case"F":return{len:i+1,token:"F"};case"G":return{len:i+1,token:"G"}}return{len:0}},this.getSharpFlat=function(n){if(n==="bass")return{len:0};switch(n[0]){case"#":return{len:1,token:"#"};case"b":return{len:1,token:"b"}}return{len:0}},this.getMode=function(n){var i=function(m,v){for(;v<m.length&&(m[v]>="a"&&m[v]<="z"||m[v]>="A"&&m[v]<="Z");)v++;return v},s=this.skipWhiteSpace(n);if(r(n,s))return{len:0};var h=n.substring(s,s+3).toLowerCase();switch((h.length>1&&h[1]===" "||h[1]==="^"||h[1]==="_"||h[1]==="=")&&(h=h[0]),h){case"mix":return{len:i(n,s),token:"Mix"};case"dor":return{len:i(n,s),token:"Dor"};case"phr":return{len:i(n,s),token:"Phr"};case"lyd":return{len:i(n,s),token:"Lyd"};case"loc":return{len:i(n,s),token:"Loc"};case"aeo":return{len:i(n,s),token:"m"};case"maj":return{len:i(n,s),token:""};case"ion":return{len:i(n,s),token:""};case"min":return{len:i(n,s),token:"m"};case"m":return{len:i(n,s),token:"m"}}return{len:0}},this.getClef=function(n,i){var s=n,h=this.skipWhiteSpace(n);if(r(n,h))return{len:0};var m=!1,v=n.substring(h);if(G.startsWith(v,"clef=")&&(m=!0,v=v.substring(5),h+=5),v.length===0&&m)return{len:h+5,warn:"No clef specified: "+s};var w=this.skipWhiteSpace(v);if(r(v,w))return{len:0};w>0&&(h+=w,v=v.substring(w));var N=null;if(G.startsWith(v,"treble"))N="treble";else if(G.startsWith(v,"bass3"))N="bass3";else if(G.startsWith(v,"bass"))N="bass";else if(G.startsWith(v,"tenor"))N="tenor";else if(G.startsWith(v,"alto2"))N="alto2";else if(G.startsWith(v,"alto1"))N="alto1";else if(G.startsWith(v,"alto"))N="alto";else if(!i&&m&&G.startsWith(v,"none"))N="none";else if(G.startsWith(v,"perc"))N="perc";else if(!i&&m&&G.startsWith(v,"C"))N="tenor";else if(!i&&m&&G.startsWith(v,"F"))N="bass";else if(!i&&m&&G.startsWith(v,"G"))N="treble";else return{len:h+5,warn:"Unknown clef specified: "+s};return v=v.substring(N.length),w=this.isMatch(v,"+8"),w>0?N+="+8":(w=this.isMatch(v,"-8"),w>0&&(N+="-8")),{len:h+N.length,token:N,explicit:m}},this.getBarLine=function(n,i){switch(n[i]){case"]":switch(++i,n[i]){case"|":return{len:2,token:"bar_thick_thin"};case"[":return++i,n[i]>="1"&&n[i]<="9"||n[i]==='"'?{len:2,token:"bar_invisible"}:{len:1,warn:"Unknown bar symbol"};default:return{len:1,token:"bar_invisible"}}break;case":":switch(++i,n[i]){case":":return{len:2,token:"bar_dbl_repeat"};case"|":switch(++i,n[i]){case"]":switch(++i,n[i]){case"|":return++i,n[i]===":"?{len:5,token:"bar_dbl_repeat"}:{len:3,token:"bar_right_repeat"};default:return{len:3,token:"bar_right_repeat"}}break;case"|":return++i,n[i]===":"?{len:4,token:"bar_dbl_repeat"}:{len:3,token:"bar_right_repeat"};default:return{len:2,token:"bar_right_repeat"}}break;default:return{len:1,warn:"Unknown bar symbol"}}break;case"[":if(++i,n[i]==="|")switch(++i,n[i]){case":":return{len:3,token:"bar_left_repeat"};case"]":return{len:3,token:"bar_invisible"};default:return{len:2,token:"bar_thick_thin"}}else return n[i]>="1"&&n[i]<="9"||n[i]==='"'?{len:1,token:"bar_invisible"}:{len:0};break;case"|":switch(++i,n[i]){case"]":return{len:2,token:"bar_thin_thick"};case"|":return++i,n[i]===":"?{len:3,token:"bar_left_repeat"}:{len:2,token:"bar_thin_thin"};case":":for(var s=0;n[i+s]===":";)s++;return{len:1+s,token:"bar_left_repeat"};default:return{len:1,token:"bar_thin"}}break}return{len:0}},this.getTokenOf=function(n,i){for(var s=0;s<n.length;s++)if(i.indexOf(n[s])<0)return{len:s,token:n.substring(0,s)};return{len:s,token:n}},this.getToken=function(n,i,s){for(var h=i;h<s&&!this.isWhiteSpace(n[h]);)h++;return n.substring(i,h)},this.isMatch=function(n,i){var s=this.skipWhiteSpace(n);return r(n,s)?0:G.startsWith(n.substring(s),i)?s+i.length:0},this.getPitchFromTokens=function(n){var i={},s={A:5,B:6,C:0,D:1,E:2,F:3,G:4,a:12,b:13,c:7,d:8,e:9,f:10,g:11};if(i.position=s[n[0].token],i.position===void 0)return{warn:"Pitch expected. Found: "+n[0].token};for(n.shift();n.length;)switch(n[0].token){case",":i.position-=7,n.shift();break;case"'":i.position+=7,n.shift();break;default:return i}return i},this.getKeyAccidentals2=function(n){for(var i;n.length>0;){var s;if(n[0].token==="^"){if(s="sharp",n.shift(),n.length===0)return{accs:i,warn:"Expected note name after "+s};switch(n[0].token){case"^":s="dblsharp",n.shift();break;case"/":s="quartersharp",n.shift();break}}else if(n[0].token==="=")s="natural",n.shift();else if(n[0].token==="_"){if(s="flat",n.shift(),n.length===0)return{accs:i,warn:"Expected note name after "+s};switch(n[0].token){case"_":s="dblflat",n.shift();break;case"/":s="quarterflat",n.shift();break}}else return{accs:i};if(n.length===0)return{accs:i,warn:"Expected note name after "+s};switch(n[0].token[0]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":i===void 0&&(i=[]),i.push({acc:s,note:n[0].token[0]}),n[0].token.length===1?n.shift():n[0].token=n[0].token.substring(1);break;default:return{accs:i,warn:"Expected note name after "+s+" Found: "+n[0].token}}}return{accs:i}},this.getKeyAccidental=function(n){var i={"^":"sharp","^^":"dblsharp","=":"natural",_:"flat",__:"dblflat","_/":"quarterflat","^/":"quartersharp"},s=this.skipWhiteSpace(n);if(r(n,s))return{len:0};var h=null;switch(n[s]){case"^":case"_":case"=":h=n[s];break;default:return{len:0}}if(s++,r(n,s))return{len:1,warn:"Expected note name after accidental"};switch(n[s]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":return{len:s+1,token:{acc:i[h],note:n[s]}};case"^":case"_":case"/":if(h+=n[s],s++,r(n,s))return{len:2,warn:"Expected note name after accidental"};switch(n[s]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":case"A":case"B":case"C":case"D":case"E":case"F":case"G":return{len:s+1,token:{acc:i[h],note:n[s]}};default:return{len:2,warn:"Expected note name after accidental"}}break;default:return{len:1,warn:"Expected note name after accidental"}}},this.isWhiteSpace=function(n){return n===" "||n==="	"||n===""},this.getMeat=function(n,i,s){var h=n.indexOf("%",i);for(h>=0&&h<s&&(s=h);i<s&&(n[i]===" "||n[i]==="	"||n[i]==="");)i++;for(;i<s&&(n[s-1]===" "||n[s-1]==="	"||n[s-1]==="");)s--;return{start:i,end:s}};var u=function(n){return n>="A"&&n<="Z"||n>="a"&&n<="z"},c=function(n){return n>="0"&&n<="9"};this.tokenize=function(n,i,s,h){var m=this.getMeat(n,i,s);i=m.start,s=m.end;for(var v=[],w;i<s;){if(n[i]==='"'){for(w=i+1;w<s&&n[w]!=='"';)w++;v.push({type:"quote",token:n.substring(i+1,w),start:i+1,end:w}),w++}else if(u(n[i])){if(w=i+1,h)for(;w<s&&!this.isWhiteSpace(n[w]);)w++;else for(;w<s&&u(n[w]);)w++;v.push({type:"alpha",token:n.substring(i,w),continueId:c(n[w]),start:i,end:w}),i=w+1}else if(n[i]==="."&&c(n[w+1])){w=i+1;for(var N=null,L=null;w<s&&c(n[w]);)w++;L=parseFloat(n.substring(i,w)),v.push({type:"number",token:n.substring(i,w),intt:N,floatt:L,continueId:u(n[w]),start:i,end:w}),i=w+1}else if(c(n[i])||n[i]==="-"&&c(n[w+1])){w=i+1;for(var y=null,g=null;w<s&&c(n[w]);)w++;if(n[w]==="."&&c(n[w+1]))for(w++;w<s&&c(n[w]);)w++;else y=parseInt(n.substring(i,w));g=parseFloat(n.substring(i,w)),v.push({type:"number",token:n.substring(i,w),intt:y,floatt:g,continueId:u(n[w]),start:i,end:w}),i=w+1}else n[i]===" "||n[i]==="	"||v.push({type:"punct",token:n[i],start:i,end:i+1}),w=i+1;i=w}return v},this.getVoiceToken=function(n,i,s){for(var h=i;h<s&&this.isWhiteSpace(n[h])||n[h]==="=";)h++;if(n[h]==='"'){var m=n.indexOf('"',h+1);return m===-1||m>=s?{len:1,err:"Missing close quote"}:{len:m-i+1,token:this.translateString(n.substring(h+1,m))}}else{for(var v=h;v<s&&!this.isWhiteSpace(n[v])&&n[v]!=="=";)v++;return{len:v-i+1,token:n.substring(h,v)}}};var p={"`a":"√†","'a":"√°","^a":"√¢","~a":"√£",'"a':"√§",oa:"√•",aa:"√•","=a":"ƒÅ",ua:"ƒÉ",";a":"ƒÖ","`e":"√®","'e":"√©","^e":"√™",'"e':"√´","=e":"ƒì",ue:"ƒï",";e":"ƒô",".e":"ƒó","`i":"√¨","'i":"√≠","^i":"√Æ",'"i':"√Ø","=i":"ƒ´",ui:"ƒ≠",";i":"ƒØ","`o":"√≤","'o":"√≥","^o":"√¥","~o":"√µ",'"o':"√∂","=o":"≈ç",uo:"≈è","/o":"√∏","`u":"√π","'u":"√∫","^u":"√ª","~u":"≈©",'"u':"√º",ou:"≈Ø","=u":"≈´",uu:"≈≠",";u":"≈≥","`A":"√Ä","'A":"√Å","^A":"√Ç","~A":"√É",'"A':"√Ñ",oA:"√Ö",AA:"√Ö","=A":"ƒÄ",uA:"ƒÇ",";A":"ƒÑ","`E":"√à","'E":"√â","^E":"√ä",'"E':"√ã","=E":"ƒí",uE:"ƒî",";E":"ƒò",".E":"ƒñ","`I":"√å","'I":"√ç","^I":"√é","~I":"ƒ®",'"I':"√è","=I":"ƒ™",uI:"ƒ¨",";I":"ƒÆ",".I":"ƒ∞","`O":"√í","'O":"√ì","^O":"√î","~O":"√ï",'"O':"√ñ","=O":"≈å",uO:"≈é","/O":"√ò","`U":"√ô","'U":"√ö","^U":"√õ","~U":"≈®",'"U':"√ú",oU:"≈Æ","=U":"≈™",uU:"≈¨",";U":"≈≤",ae:"√¶",AE:"√Ü",oe:"≈ì",OE:"≈í",ss:"√ü","'c":"ƒá","^c":"ƒâ",uc:"ƒç",cc:"√ß",".c":"ƒã",cC:"√á","'C":"ƒÜ","^C":"ƒà",uC:"ƒå",".C":"ƒä","~N":"√ë","~n":"√±","=s":"≈°",vs:"≈°",DH:"√ê",dh:"√∞",HO:"≈ê",Ho:"≈ë",HU:"≈∞",Hu:"≈±","'Y":"√ù","'y":"√Ω","^Y":"≈∂","^y":"≈∑",'"Y':"≈∏",'"y':"√ø",vS:"≈†",vZ:"≈Ω",vz:"≈æ"},l={"#":"‚ôØ",b:"‚ô≠","=":"‚ôÆ"},a={201:"‚ôØ",202:"‚ô≠",203:"‚ôÆ",241:"¬°",242:"¬¢",252:"a",262:"2",272:"o",302:"√Ç",312:"√ä",322:"√í",332:"√ö",342:"√¢",352:"√™",362:"√≤",372:"√∫",243:"¬£",253:"¬´",263:"3",273:"¬ª",303:"√É",313:"√ã",323:"√ì",333:"√õ",343:"√£",353:"√´",363:"√≥",373:"√ª",244:"¬§",254:"¬¨",264:"  ÃÅ",274:"1‚ÅÑ4",304:"√Ñ",314:"√å",324:"√î",334:"√ú",344:"√§",354:"√¨",364:"√¥",374:"√º",245:"¬•",255:"-",265:"Œº",275:"1‚ÅÑ2",305:"√Ö",315:"√ç",325:"√ï",335:"√ù",345:"√•",355:"√≠",365:"√µ",375:"√Ω",246:"¬¶",256:"¬Æ",266:"¬∂",276:"3‚ÅÑ4",306:"√Ü",316:"√é",326:"√ñ",336:"√û",346:"√¶",356:"√Æ",366:"√∂",376:"√æ",247:"¬ß",257:" ÃÑ",267:"¬∑",277:"¬ø",307:"√á",317:"√è",327:"√ó",337:"√ü",347:"√ß",357:"√Ø",367:"√∑",377:"√ø",250:" Ãà",260:"¬∞",270:" Ãß",300:"√Ä",310:"√à",320:"√ê",330:"√ò",340:"√†",350:"√®",360:"√∞",370:"√∏",251:"¬©",261:"¬±",271:"1",301:"√Å",311:"√â",321:"√ë",331:"√ô",341:"√°",351:"√©",361:"√±",371:"√π"};this.translateString=function(n){var i=n.split("\\");if(i.length===1)return n;var s=null;return i.forEach(function(h){if(s===null)s=h;else{var m=p[h.substring(0,2)];m!==void 0?s+=m+h.substring(2):(m=a[h.substring(0,3)],m!==void 0?s+=m+h.substring(3):(m=l[h.substring(0,1)],m!==void 0?s+=m+h.substring(1):s+="\\"+h))}}),s},this.getNumber=function(n,i){for(var s=0;i<n.length;)switch(n[i]){case"0":s=s*10,i++;break;case"1":s=s*10+1,i++;break;case"2":s=s*10+2,i++;break;case"3":s=s*10+3,i++;break;case"4":s=s*10+4,i++;break;case"5":s=s*10+5,i++;break;case"6":s=s*10+6,i++;break;case"7":s=s*10+7,i++;break;case"8":s=s*10+8,i++;break;case"9":s=s*10+9,i++;break;default:return{num:s,index:i}}return{num:s,index:i}},this.getFraction=function(n,i){var s=1,h=1;if(n[i]!=="/"){var m=this.getNumber(n,i);s=m.num,i=m.index}if(n[i]==="/")if(i++,n[i]==="/"){for(var v=.5;n[i++]==="/";)v=v/2;return{value:s*v,index:i-1}}else{var w=i,N=this.getNumber(n,i);N.num===0&&w===i&&(N.num=2),N.num!==0&&(h=N.num),i=N.index}return{value:s/h,index:i}};function o(n){let s=/^(\d+)\./.exec(n);return s?s[1]:null}var f=[{match:/,\s*[Tt]he$/,replace:"The "},{match:/,\s*[Aa]$/,replace:"A "},{match:/,\s*[Aa]n$/,replace:"An "}];this.theReverser=function(n){for(var i=0;i<f.length;i++){var s=f[i],h=n.match(s.match);if(h){var m=o(n);m&&(n=n.replace(m+".",""),n=n.trim());var v=h[0].length,w=s.replace+n.substring(0,n.length-v);return m&&(w=m+". "+w),w}}return n},this.stripComment=function(n){var i=n.indexOf("%");return i>=0?G.strip(n.substring(0,i)):G.strip(n)},this.getInt=function(n){var i=parseInt(n);if(isNaN(i))return{digits:0};var s=""+i,h=n.indexOf(s);return{value:i,digits:h+s.length}},this.getFloat=function(n){var i=parseFloat(n);if(isNaN(i))return{digits:0};var s=""+i,h=n.indexOf(s);return{value:i,digits:h+s.length}},this.getMeasurement=function(n){if(n.length===0)return{used:0};var i=1,s="";if(n[0].token==="-")n.shift(),s="-",i++;else if(n[0].type!=="number")return{used:0};if(s+=n.shift().token,n.length===0)return{used:1,value:parseInt(s)};var h=n.shift();if(h.token==="."){if(i++,n.length===0)return{used:i,value:parseInt(s)};if(n[0].type==="number"&&(h=n.shift(),s=s+"."+h.token,i++,n.length===0))return{used:i,value:parseFloat(s)};h=n.shift()}switch(h.token){case"pt":return{used:i+1,value:parseFloat(s)};case"px":return{used:i+1,value:parseFloat(s)};case"cm":return{used:i+1,value:parseFloat(s)/2.54*72};case"in":return{used:i+1,value:parseFloat(s)*72};default:return n.unshift(h),{used:i,value:parseFloat(s)}}};var d=function(n){return n=n.replace(/\\n/g,`
`),n=n.replace(/\\"/g,'"'),n};this.getBrackettedSubstring=function(n,i,s,h){for(var m=h||n[i],v=i+1,w=!1;v<n.length&&(w||n[v]!==m);)w=n[v]==="\\",++v;return n[v]===m?[v-i+1,d(n.substring(i+1,v)),!0]:(v=i+s,v>n.length-1&&(v=n.length-1),[v-i+1,d(n.substring(i+1,v)),!1])}};Dr.prototype.peekLine=function(){return this.lines[this.lineIndex]};Dr.prototype.nextLine=function(){if(this.lineIndex>0&&(this.multilineVars.iChar+=this.lines[this.lineIndex-1].length+1),this.lineIndex<this.lines.length){var e=this.lines[this.lineIndex];return this.lineIndex++,e}return null};var Vn=Dr;function Yi(e,t,r){if(!(!t||e.lines.length===0)){var u=e.deline({lineBreaks:!1}),c=Vi(u,t);e.lines=ji(u,c,r),e.lineBreaks=c}}function ji(e,t,r){for(var u=[],c=[],p=[],l=1,a=0;a<t.length;a++){var o=t[a];if(e[o.ogLine].staff){var f=e[o.ogLine].staff[o.staff];if(u[o.line]||(u[o.line]={staff:[]}),!u[o.line].staff[o.staff]){u[o.line].staff[o.staff]={voices:[]},r!==void 0&&o.staff===0&&o.line>0&&(u[o.line].staff[o.staff].barNumber=l);for(var d=Object.keys(f),n=0;n<d.length;n++){var i=d[n]==="voices";d[n]==="meter"&&o.line!==0&&(i=!0),i||(u[o.line].staff[o.staff][d[n]]=f[d[n]])}c[o.staff]&&(u[o.line].staff[o.staff].key=c[o.staff])}u[o.line].staff[o.staff].voices[o.voice]||(u[o.line].staff[o.staff].voices[o.voice]=[]),u[o.line].staff[o.staff].voices[o.voice]=e[o.ogLine].staff[o.staff].voices[o.voice].slice(o.start,o.end+1),p[o.staff*10+o.voice]&&u[o.line].staff[o.staff].voices[o.voice].unshift({el_type:"stem",direction:p[o.staff*10+o.voice].direction});for(var s=u[o.line].staff[o.staff].voices[o.voice],h=s.length-1;h>=0;h--)if(s[h].el_type==="key"){c[o.staff]={root:s[h].root,acc:s[h].acc,mode:s[h].mode,accidentals:s[h].accidentals.filter(function(v){return v.acc!=="natural"})};break}for(h=s.length-1;h>=0;h--)if(s[h].el_type==="stem"){p[o.staff*10+o.voice]={direction:s[h].direction};break}if(r!==void 0&&o.staff===0&&o.voice===0)for(h=0;h<s.length;h++)s[h].el_type==="bar"&&(l++,h===s.length-1?delete s[h].barNumber:s[h].barNumber=l)}else u[o.line]=e[o.ogLine]}for(var m=0;m<u.length;m++)u[m].staff&&(u[m].staff=u[m].staff.filter(function(v){return v!=null}));return u}function Vi(e,t){for(var r=[],u=0,c=0,p=0,l=0;l<e.length;l++){var a=e[l];if(a.staff){var o=c,f=t[u];u++;for(var d=0;d<a.staff.length;d++)for(var n=a.staff[d],i=0;i<n.voices.length;i++){p=o;for(var s=0,h=0,m=n.voices[i],v=0,w=0;w<m.length;w++){var N=m[w];N.el_type==="bar"&&(f[h]===s&&(r.push({ogLine:l,line:p,staff:d,voice:i,start:v,end:w}),v=w+1,p++,c=Math.max(c,p),h++),s++)}r.push({ogLine:l,line:p,staff:d,voice:i,start:v,end:m.length}),p++,c=Math.max(c,p)}}else r.push({ogLine:l,line:p}),p++,c=Math.max(c,p)}return r}function es(e,t){for(var r=[],u=[],c=0,p=0;p<e.length;p++){var l=e[p],a=c+l;if(a<t)c=a;else{var o=t-c,f=a-t;o<f&&c>0?(r.push(p-1),u.push(Math.round(c-l)),c=l):p<e.length-1&&(r.push(p),u.push(Math.round(c)),c=0)}}return u.push(Math.round(c)),{lineBreaks:r,totals:u}}function Ht(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return t}function ts(e,t,r,u,c,p,l,a,o,f,d){for(var n=f;n<e.length;n++){var i=e[n];r+=i,u+=i;var s=Math.abs(r-t[a]),h=Math.abs(s-p)<t[0]/10;if(h)if(s<p){var m=Ht(c),v=Ht(o);v.push(n-1),m.push(u-i),d.push({accumulator:r,lineAccumulator:i,lineWidths:m,lastVariance:Math.abs(r-t[a+1]),highestVariance:Math.max(l,p),currLine:a+1,lineBreaks:v,startIndex:n+1})}else s>p&&n<e.length-1&&(m=Ht(c),v=Ht(o),d.push({accumulator:r,lineAccumulator:u,lineWidths:m,lastVariance:s,highestVariance:Math.max(l,s),currLine:a,lineBreaks:v,startIndex:n+1}));s>p?(o.push(n-1),a++,l=Math.max(l,p),p=Math.abs(r-t[a]),c.push(u-i),u=i):p=s}c.push(u)}function rs(e,t,r,u){for(var c=Math.ceil(e.total/t),p=Math.floor(e.total/c),l=[],a=0;a<c;a++)l.push(p*(a+1));var o=[];o.push({accumulator:0,lineAccumulator:0,lineWidths:[],lastVariance:999999,highestVariance:0,currLine:0,lineBreaks:[],startIndex:0});for(var f=0;f<o.length;)ts(e.measureWidths,l,o[f].accumulator,o[f].lineAccumulator,o[f].lineWidths,o[f].lastVariance,o[f].highestVariance,o[f].currLine,o[f].lineBreaks,o[f].startIndex,o),f++;for(a=0;a<o.length;a++){var d=o[a];d.variances=[],d.aveVariance=0;for(var n=0;n<d.lineWidths.length;n++){var i=d.lineWidths[n];d.variances.push(i-l[0]),d.aveVariance+=Math.abs(i-l[0])}d.aveVariance=d.aveVariance/d.lineWidths.length,u.attempts.push({type:"optimizeLineWidths",lineBreaks:d.lineBreaks,variances:d.variances,aveVariance:d.aveVariance,widths:e.measureWidths})}var s=9999999,h=-1;for(a=0;a<o.length;a++)d=o[a],d.aveVariance<s&&(s=d.aveVariance,h=a);return{failed:!1,lineBreaks:o[h].lineBreaks,variance:o[h].highestVariance}}function ns(e,t,r){for(var u=[],c=[],p=0,l=!1,a=0;a<e.length;a++)p+=e[a],p>t&&(l=!0),a%r===r-1&&(a!==e.length-1&&u.push(a),c.push(Math.round(p)),p=0);return{failed:l,totals:c,lineBreaks:u}}function as(e,t,r){var u={lineBreaks:e,staffwidth:t};for(var c in r)r.hasOwnProperty(c)&&c!=="wrap"&&c!=="staffwidth"&&(u[c]=r[c]);return{revisedParams:u}}function is(e,t,r){if(t.length===0||r.staffwidth<t[0].left)return{reParse:!1,explanation:"Staff width is narrower than the margin",revisedParams:r};var u=r.scale?Math.max(r.scale,.1):1,c=r.wrap.minSpacing?Math.max(parseFloat(r.wrap.minSpacing),1):1,p=r.wrap.minSpacingLimit?Math.max(parseFloat(r.wrap.minSpacingLimit),1):c-.1,l=r.wrap.maxSpacing?Math.max(parseFloat(r.wrap.maxSpacing),1):void 0;r.wrap.lastLineLimit&&!l&&(l=Math.max(parseFloat(r.wrap.lastLineLimit),1));for(var a=r.wrap.preferredMeasuresPerLine?Math.max(parseInt(r.wrap.preferredMeasuresPerLine,10),0):void 0,o=[],f=[],d=0;d<t.length;d++){var n=t[d],i=r.staffwidth-n.left,s=i/c/u,h=i/l/u,m=i/p/u,v={widths:n,lineBreakPoint:s,minLineSize:h,attempts:[],staffWidth:r.staffwidth,minWidth:Math.round(m)},w=null;if(a){var N=ns(n.measureWidths,s,a);v.attempts.push({type:"Fixed Measures Per Line",preferredMeasuresPerLine:a,lineBreaks:N.lineBreaks,failed:N.failed,totals:N.totals}),N.failed||(w=N.lineBreaks)}if(!w){var L=es(n.measureWidths,s);v.attempts.push({type:"Free Form",lineBreaks:L.lineBreaks,totals:L.totals}),w=L.lineBreaks,w.length>0&&n.measureWidths.length<25&&(L=rs(n,s,w,v),v.attempts.push({type:"Optimize",failed:L.failed,reason:L.reason,lineBreaks:L.lineBreaks,totals:L.totals}),L.failed||(w=L.lineBreaks))}o.push(w),f.push(v)}var y=r.staffwidth,g=as(o,y,r);return g.explanation=f,g.reParse=!0,g}var ea={wrapLines:Yi,calcLineWraps:is};var Te={};Te.FONTEM=360;Te.FONTSIZE=30;Te.STEP=Te.FONTSIZE*93/720;Te.SPACE=10;Te.TOPNOTE=15;Te.STAVEHEIGHT=100;Te.INDENT=50;var Pr=Te;function Fr(e,t){t||(t={});for(var r=!!t.lineBreaks,u=[],c=!1,p=[],l=[],a=[],o=[],f=[],d=[],n=[],i=0;i<e.length;i++){var s=e[i];if(s.staff){if(c&&!s.vskip)for(var h=u[u.length-1],m=0;m<h.staff.length;m++){var v=s.staff[m],w=h.staff[m];if(v&&($e(v.meter,p[m])||(ss(v.meter,v.voices),p[m]=v.meter,delete v.meter),$e(v.key,l[m])||(os(v.key,v.voices),l[m]=v.key,delete v.key),v.title&&(w.abbrevTitle=v.title),$e(v.clef,a[m])||(fs(v.clef,v.voices),a[m]=v.clef,delete v.clef),$e(v.vocalfont,o[m])||(zt(v.vocalfont,v.voices,"vocalfont"),o[m]=v.vocalfont,delete v.vocalfont),$e(v.gchordfont,f[m])||(zt(v.gchordfont,v.voices,"gchordfont"),f[m]=v.gchordfont,delete v.gchordfont),$e(v.tripletfont,d[m])||(zt(v.tripletfont,v.voices,"tripletfont"),d[m]=v.tripletfont,delete v.tripletfont),$e(v.annotationfont,n[m])||(zt(v.annotationfont,v.voices,"annotationfont"),n[m]=v.annotationfont,delete v.annotationfont)),v)for(var N=0;N<w.voices.length;N++){var L=w.voices[N],y=v.voices[N];r&&L.push({el_type:"break"}),y&&(w.voices[N]=L.concat(y))}}else{for(var g=0;g<s.staff.length;g++)l[g]=s.staff[g].key,p[g]=s.staff[g].meter,a[g]=s.staff[g].clef;u.push(cs(s))}c=!0}else c=!1,u.push(s)}return u}function ta(e,t){return e==="abselem"?"abselem":t}function ss(e,t){e.el_type="meter",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function os(e,t){e.el_type="key",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function fs(e,t){e.el_type="clef",e.startChar=-1,e.endChar=-1;for(var r=0;r<t.length;r++)t[r].unshift(e)}function zt(e,t,r){e.el_type="font",e.type=r,e.startChar=-1,e.endChar=-1;for(var u=0;u<t.length;u++)t[u].unshift(e)}function $e(e,t){if(!e)return!0;var r=JSON.stringify(e,ta),u=JSON.stringify(t,ta);return r===u}function cs(e){for(var t={},r=Object.keys(e),u=0;u<r.length;u++)if(r[u]!=="staff")t[r[u]]=e[r[u]];else{t.staff=[];for(var c=0;c<e.staff.length;c++){for(var p={},l=Object.keys(e.staff[c]),a=0;a<l.length;a++)if(l[a]!=="voices")p[l[a]]=e.staff[c][l[a]];else{p.voices=[];for(var o=0;o<e.staff[c].voices.length;o++)p.voices.push([].concat(e.staff[c].voices[o]))}t.staff.push(p)}}return t}function Sr(){this.reset=function(){this.version="1.1.0",this.media="screen",this.metaText={},this.metaTextInfo={},this.formatting={},this.lines=[],this.staffNum=0,this.voiceNum=0,this.lineNum=0,this.runningFonts={},delete this.visualTranspose},this.reset();function e(l,a,o,f){for(var d=0;d<f.length;d++)l[o][f[d]]=a[o][f[d]]}this.copyTopInfo=function(l){var a=["tempo","title","header","rhythm","origin","composer","author","partOrder"];e(this,l,"metaText",a),e(this,l,"metaTextInfo",a)},this.copyBottomInfo=function(l){var a=["unalignedWords","book","source","discography","notes","transcription","history","abc-copyright","abc-creator","abc-edited-by","footer"];e(this,l,"metaText",a),e(this,l,"metaTextInfo",a)},this.getBeatLength=function(){var l=this.getMeterFraction(),a=1;return(l.num===6||l.num===9||l.num===12||l.num===3&&l.den===8)&&(a=3),a/l.den};function t(l,a){for(var o=0,f=0;f<l.length;f++)if(l[f].staff)for(var d=0;d<l[f].staff.length;d++)for(var n=0;n<l[f].staff[d].voices.length;n++)for(var i=l[f].staff[d].voices[n],s=1,h=0;h<i.length;h++){var m=i[h].rest&&i[h].rest.type==="spacer";if(i[h].startTriplet&&(s=i[h].tripletMultiplier),i[h].duration&&!m&&i[h].el_type!=="tempo"&&(o+=i[h].duration*s),i[h].endTriplet&&(s=1),o>=a&&(o-=a),i[h].el_type==="bar")return o}return o}this.getPickupLength=function(){var l=this.getBarLength(),a=t(this.lines,l);return a<1e-8||l-a<1e-8?0:a},this.getBarLength=function(){var l=this.getMeterFraction();return l.num/l.den},this.getTotalTime=function(){return this.totalTime},this.getTotalBeats=function(){return this.totalBeats},this.millisecondsPerMeasure=function(l){var a;if(l)a=l;else{var o=this.metaText?this.metaText.tempo:null;a=this.getBpm(o)}a<=0&&(a=1);var f=this.getBeatsPerMeasure(),d=f/a;return d*6e4},this.getBeatsPerMeasure=function(){var l=this.getBeatLength(),a=this.getBarLength();return a/l},this.getMeter=function(){for(var l=0;l<this.lines.length;l++){var a=this.lines[l];if(a.staff)for(var o=0;o<a.staff.length;o++){var f=a.staff[o].meter;if(f)return f}}return{type:"common_time"}},this.getMeterFraction=function(){var l=this.getMeter(),a=4,o=4;return l&&(l.type==="specified"?(a=parseInt(l.value[0].num,10),o=parseInt(l.value[0].den,10)):l.type==="cut_time"?(a=2,o=2):l.type==="common_time"&&(a=4,o=4)),this.meter={num:a,den:o},this.meter},this.getKeySignature=function(){for(var l=0;l<this.lines.length;l++){var a=this.lines[l];if(a.staff){for(var o=0;o<a.staff.length;o++)if(a.staff[o].key)return a.staff[o].key}}return{}},this.getElementFromChar=function(l){for(var a=0;a<this.lines.length;a++){var o=this.lines[a];if(o.staff)for(var f=0;f<o.staff.length;f++)for(var d=o.staff[f],n=0;n<d.voices.length;n++)for(var i=d.voices[n],s=0;s<i.length;s++){var h=i[s];if(h.startChar&&h.endChar&&h.startChar<=l&&h.endChar>l)return h}}return null};function r(l){for(var a,o,f,d,n=l.length-1;n>=0;n--){var i=l[n];i.type==="bar"?(i.top=f,i.nextTop=a,a=f,i.bottom=d,i.nextBottom=o,o=d):i.type==="event"&&(f=i.top,d=i.top+i.height)}}function u(l){var a=[];for(var o in l)l.hasOwnProperty(o)&&a.push(l[o]);return a=a.sort(function(f,d){var n=f.milliseconds-d.milliseconds;return n!==0?n:f.type==="bar"?-1:1}),a}this.addElementToEvents=function(l,a,o,f,d,n,i,s,h,m){if(a.hint)return{isTiedState:void 0,duration:0};var v=a.durationClass?a.durationClass:a.duration;if(a.abcelem.rest&&a.abcelem.rest.type==="spacer"&&(v=0),v>0){for(var w=[],N=0;N<a.elemset.length;N++)a.elemset[N]!==null&&w.push(a.elemset[N]);var L=a.startTie;if(h!==void 0)l["event"+h].elements.push(w),m&&(l["event"+o]||(l["event"+o]={type:"event",milliseconds:o,line:n,measureNumber:i,top:f,height:d,left:null,width:0,elements:[],startChar:null,endChar:null,startCharArray:[],endCharArray:[]}),l["event"+o].measureStart=!0,m=!1),L||(h=void 0);else{if(!l["event"+o])l["event"+o]={type:"event",milliseconds:o,line:n,measureNumber:i,top:f,height:d,left:a.x,width:a.w,elements:[w],startChar:a.abcelem.startChar,endChar:a.abcelem.endChar,startCharArray:[a.abcelem.startChar],endCharArray:[a.abcelem.endChar],midiPitches:a.abcelem.midiPitches?G.cloneArray(a.abcelem.midiPitches):[]},a.abcelem.midiGraceNotePitches&&(l["event"+o].midiGraceNotePitches=G.cloneArray(a.abcelem.midiGraceNotePitches));else{if(l["event"+o].left?l["event"+o].left=Math.min(l["event"+o].left,a.x):l["event"+o].left=a.x,l["event"+o].elements.push(w),l["event"+o].startCharArray.push(a.abcelem.startChar),l["event"+o].endCharArray.push(a.abcelem.endChar),l["event"+o].startChar===null&&(l["event"+o].startChar=a.abcelem.startChar),l["event"+o].endChar===null&&(l["event"+o].endChar=a.abcelem.endChar),a.abcelem.midiPitches&&a.abcelem.midiPitches.length){l["event"+o].midiPitches||(l["event"+o].midiPitches=[]);for(var N=0;N<a.abcelem.midiPitches.length;N++)l["event"+o].midiPitches.push(a.abcelem.midiPitches[N])}if(a.abcelem.midiGraceNotePitches&&a.abcelem.midiGraceNotePitches.length){l["event"+o].midiGraceNotePitches||(l["event"+o].midiGraceNotePitches=[]);for(var y=0;y<a.abcelem.midiGraceNotePitches.length;y++)l["event"+o].midiGraceNotePitches.push(a.abcelem.midiGraceNotePitches[y])}}m&&(l["event"+o].measureStart=!0,m=!1),L&&(h=o)}}return{isTiedState:h,duration:v/s,nextIsBar:m||a.type==="bar"}},this.makeVoicesArray=function(){for(var l=[],a=[],o={},f=0;f<this.engraver.staffgroups.length;f++){var d=this.engraver.staffgroups[f];if(d&&d.staffs&&d.staffs.length>0){var n=d.staffs[0],i=n.absoluteY,s=i-n.top*Pr.STEP,h=d.staffs[d.staffs.length-1];i=h.absoluteY;for(var m=i-h.bottom*Pr.STEP,v=m-s,w=d.voices,N=0;N<w.length;N++)if(!(w[N].staff&&w[N].staff.isTabStaff)){var L=!1;l[N]||(l[N]=[]),a[N]===void 0&&(a[N]=0);for(var y=w[N].children,g=0;g<y.length;g++)y[g].type==="tempo"&&(o[a[N]]=this.getBpm(y[g].abcelem)),l[N].push({top:s,height:v,line:d.line,measureNumber:a[N],elem:y[g]}),y[g].type==="bar"&&L&&a[N]++,(y[g].type==="note"||y[g].type==="rest")&&(L=!0)}}}return this.tempoLocations=o,l},this.setupEvents=function(l,a,o,f){f||(f=1);for(var d=[],n={},i=l,s,h=!0,m=this.makeVoicesArray(),v=0,w=0;w<m.length;w++){var N=i,L=Math.round(N*1e3),y=0,g=-1,k=m[w],F=o;a=this.getBeatLength()*F/60;for(var M=-1,D=0;D<k.length;D++){var S=k[D].measureNumber;M!==S&&this.tempoLocations[S]&&(F=this.tempoLocations[S],a=f*this.getBeatLength()*F/60,M=S);var B=k[D].elem,A=this.addElementToEvents(n,B,L,k[D].top,k[D].height,k[D].line,k[D].measureNumber,a,s,h);s=A.isTiedState,h=A.nextIsBar,N+=A.duration;var I;if(B.duration>0&&n["event"+L]&&(I="event"+L),L=Math.round(N*1e3),B.type==="bar"){var q=B.abcelem.type,O=q==="bar_right_repeat"||q==="bar_dbl_repeat",x=B.abcelem.startEnding==="1",b=q==="bar_left_repeat"||q==="bar_dbl_repeat"||q==="bar_right_repeat";if(O){D>0&&(n[I].endX=B.x),g===-1&&(g=D);var _=0;M=-1;for(var C=y;C<g;C++){S=k[C].measureNumber,M!==S&&this.tempoLocations[S]&&(F=this.tempoLocations[S],a=f*this.getBeatLength()*F/60,M=S);var P=k[C].elem;A=this.addElementToEvents(n,P,L,k[C].top,k[C].height,k[C].line,k[C].measureNumber,a,s,h),s=A.isTiedState,h=A.nextIsBar,N+=A.duration,_=L,L=Math.round(N*1e3)}n["event"+_]&&(n["event"+_].endX=k[g].elem.x),h=!0,g=-1}x&&(g=D),b&&(y=D)}}v=Math.max(v,L)}return d=u(n),r(d),p(this.lines,d),d.push({type:"end",milliseconds:v}),this.addUsefulCallbackInfo(d,F*f),d},this.addUsefulCallbackInfo=function(l,a){for(var o=this.millisecondsPerMeasure(a),f=0;f<l.length;f++){var d=l[f];d.millisecondsPerMeasure=o}};function c(l,a){for(;a<l.length&&l[a].left===null;)a++;return l[a]}function p(l,a){if(!(a.length<1)){for(var o=0;o<a.length-1;o++){var f=a[o],d=c(a,o+1);if(f.left!==null){var n=d&&f.top===d.top?d.left:l[f.line].staffGroup.w;f.endX!==void 0?n>f.left&&(f.endX=Math.min(f.endX,n)):f.endX=n}}var i=a[a.length-1];i.endX=l[i.line].staffGroup.w}}this.getBpm=function(l){var a;if(l){a=l.bpm;var o=this.getBeatLength(),f=l.duration&&l.duration.length>0?l.duration[0]:o;a=a*f/o}if(!a){a=180;var d=this.getMeterFraction();d&&d.num!==3&&d.num%3===0&&(a=120)}return a},this.setTiming=function(l,a){if(a=a||0,!this.engraver||!this.engraver.staffgroups)return console.log("setTiming cannot be called before the tune is drawn."),this.noteTimings=[],this.noteTimings;var o=this.metaText?this.metaText.tempo:null,f=this.getBpm(o),d=1;l?o&&(d=l/f):l=f;var n=this.getBeatLength(),i=l/60,s=this.getBarLength(),h=s/n*a/i;h&&(h-=this.getPickupLength()/n/i);var m=n*i;return this.noteTimings=this.setupEvents(h,m,l,d),this.noteTimings.length>0?(this.totalTime=this.noteTimings[this.noteTimings.length-1].milliseconds/1e3,this.totalBeats=this.totalTime*i):(this.totalTime=void 0,this.totalBeats=void 0),this.noteTimings},this.setUpAudio=function(l){console.log("NEUTERED")},this.deline=function(l){return Fr(this.lines,l)}}var ls=function(e){var t=this;this.setVisualTranspose=function(c){c&&(e.visualTranspose=c)},this.resolveOverlays=function(){for(var c=!1,p=[],l=0;l<e.lines.length;l++){var a=e.lines[l];if(a.staff)for(var o=0;o<a.staff.length;o++){for(var f=a.staff[o],d=[],n=0;n<f.voices.length;n++){var i=f.voices[n];d.push({hasOverlay:!1,voice:[],snip:[]}),p[l]=0;for(var s=0,h=!1,m=0,v=-1,w=0;w<i.length;w++){var N=i[w];if(N.el_type==="overlay"&&!h){c=!0,h=!0,v=w,d[n].hasOverlay=!0,m===0&&(m=p[l]);for(var L=0;L<l;L++)p[L]&&e.lines[L].staff&&f.voices.length>=e.lines[L].staff[0].voices.length&&e.lines[L].staff[0].voices.push([{el_type:"note",duration:p[L],rest:{type:"invisible"},startChar:N.startChar,endChar:N.endChar}])}else N.el_type==="bar"?(h?(h=!1,d[n].snip.push({start:v,len:w-v}),d[n].voice.push(N)):(s>0&&d[n].voice.push({el_type:"note",duration:s,rest:{type:"invisible"},startChar:N.startChar,endChar:N.endChar}),d[n].voice.push(N)),s=0):N.el_type==="note"?h?d[n].voice.push(N):(s+=N.duration,p[l]+=N.duration):(N.el_type==="scale"||N.el_type==="stem"||N.el_type==="overlay"||N.el_type==="style"||N.el_type==="transpose"||N.el_type==="color")&&d[n].voice.push(N)}d[n].hasOverlay&&d[n].snip.length===0&&d[n].snip.push({start:v,len:i.length-v})}for(n=0;n<d.length;n++){var y=d[n];if(y.hasOverlay){y.voice.splice(0,0,{el_type:"stem",direction:"down"}),f.voices.push(y.voice);for(var g=y.snip.length-1;g>=0;g--){var k=y.snip[g];f.voices[n].splice(k.start,k.len),f.voices[n].splice(k.start+1,0,{el_type:"stem",direction:"auto"});var F=r(f.voices[n],k.start);f.voices[n].splice(F,0,{el_type:"stem",direction:"up"})}for(g=0;g<f.voices[f.voices.length-1].length;g++){f.voices[f.voices.length-1][g]=G.clone(f.voices[f.voices.length-1][g]);var M=f.voices[f.voices.length-1][g];M.el_type==="bar"&&M.startEnding&&delete M.startEnding,M.el_type==="bar"&&M.endEnding&&delete M.endEnding}}}}}return c};function r(c,p){for(var l=p-1;l>0&&c[l].el_type!=="bar";l--);return l}function u(c){for(var p=!0,l=0;l<c.length;l++){var a=c[l];if(a.staff){for(var o=0;o<a.staff.length;o++){var f=a.staff[o];if(f.title){for(var d=!1,n=0;n<f.title.length;n++)f.title[n]?(f.title[n]=p?f.title[n].name:f.title[n].subname,f.title[n]?d=!0:f.title[n]=""):f.title[n]="";d||delete f.title}}p=!1}}}this.cleanUp=function(c,p,l){this.closeLine(),delete e.runningFonts,us(e),e.metaText.tempo&&e.metaText.tempo.bpm&&!e.metaText.tempo.duration&&(e.metaText.tempo.duration=[e.getBeatLength()]);var a=!1,o,f,d;for(o=0;o<e.lines.length;o++)if(e.lines[o].staff!==void 0){var n=!1;for(f=0;f<e.lines[o].staff.length;f++)if(e.lines[o].staff[f]===void 0)a=!0,e.lines[o].staff[f]=null;else for(d=0;d<e.lines[o].staff[f].voices.length;d++)e.lines[o].staff[f].voices[d]===void 0?e.lines[o].staff[f].voices[d]=[]:this.containsNotes(e.lines[o].staff[f].voices[d])&&(n=!0);n||(e.lines[o]=null,a=!0)}if(a&&(e.lines=e.lines.filter(function(g){return!!g}),e.lines.forEach(function(g){g.staff&&(g.staff=g.staff.filter(function(k){return!!k}))})),c)for(;m(e.lines,c););if(p){for(a=!1,o=0;o<e.lines.length;o++)if(e.lines[o].staff!==void 0)for(f=0;f<e.lines[o].staff.length;f++){var i=!1;for(d=0;d<e.lines[o].staff[f].voices.length;d++)this.containsNotesStrict(e.lines[o].staff[f].voices[d])&&(i=!0);i||(a=!0,e.lines[o].staff[f]=null)}a&&e.lines.forEach(function(g){g.staff&&(g.staff=g.staff.filter(function(k){return!!k}))})}for(u(e.lines),o=0;o<e.lines.length;o++)if(e.lines[o].staff)for(f=0;f<e.lines[o].staff.length;f++)delete e.lines[o].staff[f].workingClef;for(;this.resolveOverlays(););function s(g,k,F){l[k]||(l[k]=[]),l[k][F]||(l[k][F]=[]);for(var M,D=function(R,H,$){if(l[k][F][$]===void 0){for(M=0;M<l[k][F].length;M++)if(l[k][F][M]!==void 0){$=M;break}if(l[k][F][$]===void 0){var te=$*100+1;R.endSlur.forEach(function(W){te===W&&--te}),l[k][F][$]=[te]}}for(var K,oe=0;oe<H;oe++)K=l[k][F][$].pop(),R.endSlur.push(K);return l[k][F][$].length===0&&delete l[k][F][$],K},S=function(R,H,$,te){R.startSlur=[],l[k][F][$]===void 0&&(l[k][F][$]=[]);for(var K=$*100+1,oe=0;oe<H;oe++)te&&(te.forEach(function(W){K===W&&++K}),te.forEach(function(W){K===W&&++K}),te.forEach(function(W){K===W&&++K})),l[k][F][$].forEach(function(W){K===W&&++K}),l[k][F][$].forEach(function(W){K===W&&++K}),l[k][F][$].push(K),R.startSlur.push({label:K}),R.dottedSlur&&(R.startSlur[R.startSlur.length-1].style="dotted",delete R.dottedSlur),K++},B=0;B<g.length;B++){var A=g[B];if(A.el_type==="note"){if(A.gracenotes)for(var I=0;I<A.gracenotes.length;I++){if(A.gracenotes[I].endSlur){var q=A.gracenotes[I].endSlur;A.gracenotes[I].endSlur=[];for(var O=0;O<q;O++)D(A.gracenotes[I],1,20)}A.gracenotes[I].startSlur&&(M=A.gracenotes[I].startSlur,S(A.gracenotes[I],M,20))}if(A.endSlur&&(M=A.endSlur,A.endSlur=[],D(A,M,0)),A.startSlur&&(M=A.startSlur,S(A,M,0)),A.pitches){for(var x=[],b=0;b<A.pitches.length;b++)if(A.pitches[b].endSlur){var _=A.pitches[b].endSlur;A.pitches[b].endSlur=[];for(var C=0;C<_;C++){var P=D(A.pitches[b],1,b+1);x.push(P)}}for(b=0;b<A.pitches.length;b++)A.pitches[b].startSlur&&(M=A.pitches[b].startSlur,S(A.pitches[b],M,b+1,x));A.gracenotes&&A.pitches[0].endSlur&&A.pitches[0].endSlur[0]===100&&A.pitches[0].startSlur&&(A.gracenotes[0].endSlur?A.gracenotes[0].endSlur.push(A.pitches[0].startSlur[0].label):A.gracenotes[0].endSlur=[A.pitches[0].startSlur[0].label],A.pitches[0].endSlur.length===1?delete A.pitches[0].endSlur:A.pitches[0].endSlur[0]===100?A.pitches[0].endSlur.shift():A.pitches[0].endSlur[A.pitches[0].endSlur.length-1]===100&&A.pitches[0].endSlur.pop(),l[k][F][1].length===1?delete l[k][F][1]:l[k][F][1].pop())}}}}function h(g){V.fixClef(g)}function m(g,k){for(o=0;o<g.length;o++)if(g[o].staff!==void 0)for(f=0;f<g[o].staff.length;f++){var F=[];for(d=0;d<g[o].staff[f].voices.length;d++)for(var M=g[o].staff[f].voices[d],D=0,S=0;S<M.length;S++)if(M[S].el_type==="bar"){if(D++,D>=k&&S<M.length-1){var B=v(g,o);if(!B){var A=JSON.parse(JSON.stringify(g[o]));g.push(G.clone(A)),B=g[g.length-1];for(var I=0;I<B.staff.length;I++)for(var q=0;q<B.staff[I].voices.length;q++)B.staff[I].voices[q]=[]}var O=S+1,x=g[o].staff[f].voices[d].slice(O);return g[o].staff[f].voices[d]=g[o].staff[f].voices[d].slice(0,O),B.staff[f].voices[d]=F.concat(x.concat(B.staff[f].voices[d])),!0}}else M[S].duration||F.push(M[S])}return!1}function v(g,k){for(k++;g.length>k;){if(g[k].staff)return g[k];k++}return null}for(e.lineNum=0;e.lineNum<e.lines.length;e.lineNum++){var w=e.lines[e.lineNum].staff;if(w)for(e.staffNum=0;e.staffNum<w.length;e.staffNum++)for(w[e.staffNum].clef&&h(w[e.staffNum].clef),e.voiceNum=0;e.voiceNum<w[e.staffNum].voices.length;e.voiceNum++){var N=w[e.staffNum].voices[e.voiceNum];s(N,e.staffNum,e.voiceNum);for(var L=0;L<N.length;L++)N[L].el_type==="clef"&&h(N[L]);if(N.length>0&&N[N.length-1].barNumber){var y=v(e.lines,e.lineNum);y&&(y.staff[0].barNumber=N[N.length-1].barNumber),delete N[N.length-1].barNumber}}}return delete e.staffNum,delete e.voiceNum,delete e.lineNum,delete e.potentialStartBeam,delete e.potentialEndBeam,delete e.vskipPending,l},e.reset(),this.getLastNote=function(){if(e.lines[e.lineNum]&&e.lines[e.lineNum].staff&&e.lines[e.lineNum].staff[e.staffNum]&&e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum])for(var c=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum].length-1;c>=0;c--){var p=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum][c];if(p.el_type==="note")return p}return null},this.addTieToLastNote=function(c){var p=this.getLastNote();return p&&p.pitches&&p.pitches.length>0?(p.pitches[0].startTie={},c&&(p.pitches[0].startTie.style="dotted"),!0):!1},this.getDuration=function(c){return c.duration?c.duration:0},this.closeLine=function(){e.potentialStartBeam&&e.potentialEndBeam&&(e.potentialStartBeam.startBeam=!0,e.potentialEndBeam.endBeam=!0),delete e.potentialStartBeam,delete e.potentialEndBeam},this.appendElement=function(c,p,l,a){var o=e,f=function(s){var h=o.lines[o.lineNum].staff[o.staffNum];if(h){if(s.pitches!==void 0){var m=h.workingClef.verticalPos;s.pitches.forEach(function(w){w.verticalPos=w.pitch-m})}if(s.gracenotes!==void 0){var v=h.workingClef.verticalPos;s.gracenotes.forEach(function(w){w.verticalPos=w.pitch-v})}h.voices[o.voiceNum].push(s)}};a.el_type=c,p!==null&&(a.startChar=p),l!==null&&(a.endChar=l);var d=function(){o.potentialStartBeam.startBeam=!0,a.endBeam=!0,delete o.potentialStartBeam,delete o.potentialEndBeam},n=function(){o.potentialStartBeam!==void 0&&o.potentialEndBeam!==void 0&&(o.potentialStartBeam.startBeam=!0,o.potentialEndBeam.endBeam=!0),delete o.potentialStartBeam,delete o.potentialEndBeam};if(c==="note"){var i=t.getDuration(a);i>=.25||a.force_end_beam_last&&o.potentialStartBeam!==void 0?n():a.end_beam&&o.potentialStartBeam!==void 0?a.rest===void 0?d():n():a.rest===void 0&&(o.potentialStartBeam===void 0?a.end_beam||(o.potentialStartBeam=a,delete o.potentialEndBeam):o.potentialEndBeam=a)}else n();delete a.end_beam,delete a.force_end_beam_last,f(a)},this.appendStartingElement=function(c,p,l,a){this.closeLine();var o;c==="key"&&(o=a.impliedNaturals,delete a.impliedNaturals,delete a.explicitAccidentals);var f=G.clone(a);if(e.lines[e.lineNum]&&e.lines[e.lineNum].staff){e.lines[e.lineNum].staff.length<=e.staffNum&&(e.lines[e.lineNum].staff[e.staffNum]={},e.lines[e.lineNum].staff[e.staffNum].clef=G.clone(e.lines[e.lineNum].staff[0].clef),e.lines[e.lineNum].staff[e.staffNum].key=G.clone(e.lines[e.lineNum].staff[0].key),e.lines[e.lineNum].staff[0].meter&&(e.lines[e.lineNum].staff[e.staffNum].meter=G.clone(e.lines[e.lineNum].staff[0].meter)),e.lines[e.lineNum].staff[e.staffNum].workingClef=G.clone(e.lines[e.lineNum].staff[0].workingClef),e.lines[e.lineNum].staff[e.staffNum].voices=[[]]),c==="clef"&&(e.lines[e.lineNum].staff[e.staffNum].workingClef=f);for(var d=e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum],n=0;n<d.length;n++){if(d[n].el_type==="note"||d[n].el_type==="bar"){f.el_type=c,f.startChar=p,f.endChar=l,o&&(f.accidentals=o.concat(f.accidentals)),d.push(f);return}if(d[n].el_type===c){f.el_type=c,f.startChar=p,f.endChar=l,o&&(f.accidentals=o.concat(f.accidentals)),d[n]=f;return}}e.lines[e.lineNum].staff[e.staffNum][c]=a}},this.pushLine=function(c){e.vskipPending&&(c.vskip=e.vskipPending,delete e.vskipPending),e.lines.push(c)},this.addSubtitle=function(c,p){this.pushLine({subtitle:{text:c,startChar:p.startChar,endChar:p.endChar}})},this.addSpacing=function(c){e.vskipPending=c},this.addNewPage=function(c){this.pushLine({newpage:c})},this.addSeparator=function(c,p,l,a){this.pushLine({separator:{spaceAbove:Math.round(c),spaceBelow:Math.round(p),lineLength:Math.round(l),startChar:a.startChar,endChar:a.endChar}})},this.addText=function(c,p){this.pushLine({text:{text:c,startChar:p.startChar,endChar:p.endChar}})},this.addCentered=function(c){this.pushLine({text:[{text:c,center:!0}]})},this.containsNotes=function(c){for(var p=0;p<c.length;p++)if(c[p].el_type==="note"||c[p].el_type==="bar")return!0;return!1},this.containsNotesStrict=function(c){for(var p=0;p<c.length;p++)if(c[p].el_type==="note"&&(c[p].rest===void 0||c[p].chord!==void 0))return!0;return!1},this.changeVoiceScale=function(c){t.appendElement("scale",null,null,{size:c})},this.changeVoiceColor=function(c){t.appendElement("color",null,null,{color:c})},this.startNewLine=function(c){var p=e;this.closeLine();var l=function(f){var d=p.lines[p.lineNum].staff[p.staffNum];if(d.voices[p.voiceNum]=[],d.title||(d.title=[]),d.title[p.voiceNum]={name:f.name,subname:f.subname},f.style&&t.appendElement("style",null,null,{head:f.style}),f.stem)t.appendElement("stem",null,null,{direction:f.stem});else if(p.voiceNum>0){if(d.voices[0]!==void 0){for(var n=!1,i=0;i<d.voices[0].length;i++)d.voices[0].el_type==="stem"&&(n=!0);if(!n){var s={el_type:"stem",direction:"up"};d.voices[0].splice(0,0,s)}}t.appendElement("stem",null,null,{direction:"down"})}f.scale&&t.appendElement("scale",null,null,{size:f.scale}),f.color&&t.appendElement("color",null,null,{color:f.color})},a=function(f){f.key&&f.key.impliedNaturals&&(f.key.accidentals=f.key.accidentals.concat(f.key.impliedNaturals),delete f.key.impliedNaturals),p.lines[p.lineNum].staff[p.staffNum]={voices:[],clef:f.clef,key:f.key,workingClef:f.clef},f.stafflines!==void 0&&(p.lines[p.lineNum].staff[p.staffNum].clef.stafflines=f.stafflines,p.lines[p.lineNum].staff[p.staffNum].workingClef.stafflines=f.stafflines),f.staffscale&&(p.lines[p.lineNum].staff[p.staffNum].staffscale=f.staffscale),f.annotationfont&&t.setLineFont("annotationfont",f.annotationfont),f.gchordfont&&t.setLineFont("gchordfont",f.gchordfont),f.tripletfont&&t.setLineFont("tripletfont",f.tripletfont),f.vocalfont&&t.setLineFont("vocalfont",f.vocalfont),f.bracket&&(p.lines[p.lineNum].staff[p.staffNum].bracket=f.bracket),f.brace&&(p.lines[p.lineNum].staff[p.staffNum].brace=f.brace),f.connectBarLines&&(p.lines[p.lineNum].staff[p.staffNum].connectBarLines=f.connectBarLines),f.barNumber&&(p.lines[p.lineNum].staff[p.staffNum].barNumber=f.barNumber),l(f),f.part&&t.appendElement("part",f.part.startChar,f.part.endChar,{title:f.part.title}),f.meter!==void 0&&(p.lines[p.lineNum].staff[p.staffNum].meter=f.meter),p.vskipPending&&(p.lines[p.lineNum].vskip=p.vskipPending,delete p.vskipPending)},o=function(f){p.lines[p.lineNum]={staff:[]},a(f)};e.lines[e.lineNum]===void 0?o(c):e.lines[e.lineNum].staff===void 0?(e.lineNum++,this.startNewLine(c)):e.lines[e.lineNum].staff[e.staffNum]===void 0?a(c):e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum]===void 0?l(c):this.containsNotes(e.lines[e.lineNum].staff[e.staffNum].voices[e.voiceNum])?(e.lineNum++,this.startNewLine(c)):c.part&&t.appendElement("part",c.part.startChar,c.part.endChar,{title:c.part.title})},this.setRunningFont=function(c,p){e.runningFonts[c]=p},this.setLineFont=function(c,p){if(e.runningFonts[c]){for(var l=!1,a=Object.keys(p),o=0;o<a.length;o++)e.runningFonts[c][a[o]]!==p[a[o]]&&(l=!0);l&&(e.lines[e.lineNum].staff[e.staffNum][c]=p)}e.runningFonts[c]=p},this.setBarNumberImmediate=function(c){var p=this.getCurrentVoice();if(p&&p.length>0){var l=p[p.length-1];if(l.el_type==="bar")l.barNumber!==void 0&&(l.barNumber=c);else return c-1}return c},this.hasBeginMusic=function(){for(var c=0;c<e.lines.length;c++)if(e.lines[c].staff)return!0;return!1},this.isFirstLine=function(c){for(var p=c-1;p>=0;p--)if(e.lines[p].staff!==void 0)return!1;return!0},this.getCurrentVoice=function(){var c=e.lines[e.lineNum];if(!c)return null;var p=c.staff[e.staffNum];return p&&p.voices[e.voiceNum]!==void 0?p.voices[e.voiceNum]:null},this.setCurrentVoice=function(c,p){e.staffNum=c,e.voiceNum=p;for(var l=0;l<e.lines.length;l++)if(e.lines[l].staff&&(e.lines[l].staff[c]===void 0||e.lines[l].staff[c].voices[p]===void 0||!this.containsNotes(e.lines[l].staff[c].voices[p]))){e.lineNum=l;return}e.lineNum=l},this.addMetaText=function(c,p,l){e.metaText[c]===void 0?(e.metaText[c]=p,e.metaTextInfo[c]=l):(typeof e.metaText[c]=="string"&&typeof p=="string"?e.metaText[c]+=`
`+p:(e.metaText[c]==="string"&&(e.metaText[c]=[{text:e.metaText[c]}]),typeof p=="string"&&(p=[{text:p}]),e.metaText[c]=e.metaText[c].concat(p)),e.metaTextInfo[c].endChar=l.endChar)},this.addMetaTextArray=function(c,p,l){e.metaText[c]===void 0?(e.metaText[c]=[p],e.metaTextInfo[c]=l):(e.metaText[c].push(p),e.metaTextInfo[c].endChar=l.endChar)},this.addMetaTextObj=function(c,p,l){e.metaText[c]=p,e.metaTextInfo[c]=l}};function ra(e){if(!e||typeof e=="string")return!1;for(var t="",r=0;r<e.length;r++)if(typeof e[r]!="string")return!1;return!0}function us(e){ra(e.metaText.notes)&&(e.metaText.notes=e.metaText.notes.join(`
`)),ra(e.metaText.history)&&(e.metaText.history=e.metaText.history.join(`
`))}var na=ls;function aa(){"use strict";var e=new Sr,t=new na(e),r,u="",c="";this.getTune=function(){var y={formatting:e.formatting,lines:e.lines,media:e.media,metaText:e.metaText,metaTextInfo:e.metaTextInfo,version:e.version,addElementToEvents:e.addElementToEvents,addUsefulCallbackInfo:e.addUsefulCallbackInfo,getTotalTime:e.getTotalTime,getTotalBeats:e.getTotalBeats,getBarLength:e.getBarLength,getBeatLength:e.getBeatLength,getBeatsPerMeasure:e.getBeatsPerMeasure,getBpm:e.getBpm,getMeter:e.getMeter,getMeterFraction:e.getMeterFraction,getPickupLength:e.getPickupLength,getKeySignature:e.getKeySignature,getElementFromChar:e.getElementFromChar,makeVoicesArray:e.makeVoicesArray,millisecondsPerMeasure:e.millisecondsPerMeasure,setupEvents:e.setupEvents,setTiming:e.setTiming,setUpAudio:e.setUpAudio,deline:e.deline};return e.lineBreaks&&(y.lineBreaks=e.lineBreaks),e.visualTranspose&&(y.visualTranspose=e.visualTranspose),y};function p(y,g,k){y.positioning||(y.positioning={}),y.positioning[g]=k}function l(y,g,k){y.fonts||(y.fonts={}),y.fonts[g]=k}var a={reset:function(){for(var y in this)this.hasOwnProperty(y)&&typeof this[y]!="function"&&delete this[y];this.iChar=0,this.key={accidentals:[],root:"none",acc:"",mode:""},this.meter=null,this.origMeter=null,this.hasMainTitle=!1,this.default_length=.125,this.clef={type:"treble",verticalPos:0},this.octave=0,this.next_note_duration=0,this.start_new_line=!0,this.is_in_header=!0,this.partForNextLine={},this.tempoForNextLine=[],this.havent_set_length=!0,this.voices={},this.staves=[],this.macros={},this.currBarNumber=1,this.barCounter={},this.ignoredDecorations=[],this.score_is_present=!1,this.inEnding=!1,this.inTie=[],this.inTieChord={},this.vocalPosition="auto",this.dynamicPosition="auto",this.chordPosition="auto",this.ornamentPosition="auto",this.volumePosition="auto",this.openSlurs=[],this.freegchord=!1,this.endingHoldOver={}},differentFont:function(y,g){return this[y].decoration!==g[y].decoration||this[y].face!==g[y].face||this[y].size!==g[y].size||this[y].style!==g[y].style||this[y].weight!==g[y].weight},addFormattingOptions:function(y,g,k){k==="note"?(this.vocalPosition!=="auto"&&p(y,"vocalPosition",this.vocalPosition),this.dynamicPosition!=="auto"&&p(y,"dynamicPosition",this.dynamicPosition),this.chordPosition!=="auto"&&p(y,"chordPosition",this.chordPosition),this.ornamentPosition!=="auto"&&p(y,"ornamentPosition",this.ornamentPosition),this.volumePosition!=="auto"&&p(y,"volumePosition",this.volumePosition),this.differentFont("annotationfont",g)&&l(y,"annotationfont",this.annotationfont),this.differentFont("gchordfont",g)&&l(y,"gchordfont",this.gchordfont),this.differentFont("vocalfont",g)&&l(y,"vocalfont",this.vocalfont),this.differentFont("tripletfont",g)&&l(y,"tripletfont",this.tripletfont)):k==="bar"&&(this.dynamicPosition!=="auto"&&p(y,"dynamicPosition",this.dynamicPosition),this.chordPosition!=="auto"&&p(y,"chordPosition",this.chordPosition),this.ornamentPosition!=="auto"&&p(y,"ornamentPosition",this.ornamentPosition),this.volumePosition!=="auto"&&p(y,"volumePosition",this.volumePosition),this.differentFont("measurefont",g)&&l(y,"measurefont",this.measurefont),this.differentFont("repeatfont",g)&&l(y,"repeatfont",this.repeatfont))},duplicateStartEndingHoldOvers:function(){this.endingHoldOver={inTie:[],inTieChord:{}};for(var y=0;y<this.inTie.length;y++)if(this.endingHoldOver.inTie.push([]),this.inTie[y])for(var g=0;g<this.inTie[y].length;g++)this.endingHoldOver.inTie[y].push(this.inTie[y][g]);for(var k in this.inTieChord)this.inTieChord.hasOwnProperty(k)&&(this.endingHoldOver.inTieChord[k]=this.inTieChord[k])},restoreStartEndingHoldOvers:function(){if(this.endingHoldOver.inTie){this.inTie=[],this.inTieChord={};for(var y=0;y<this.endingHoldOver.inTie.length;y++){this.inTie.push([]);for(var g=0;g<this.endingHoldOver.inTie[y].length;g++)this.inTie[y].push(this.endingHoldOver.inTie[y][g])}for(var k in this.endingHoldOver.inTieChord)this.endingHoldOver.inTieChord.hasOwnProperty(k)&&(this.inTieChord[k]=this.endingHoldOver.inTieChord[k])}}},o=function(y){a.warnings||(a.warnings=[]),a.warnings.push(y)},f=function(y){a.warningObjects||(a.warningObjects=[]),a.warningObjects.push(y)},d=function(y){var g=y.replace(/\x12/g," ");return g=g.replace(/&/g,"&amp;"),g=g.replace(/</g,"&lt;"),g.replace(/>/g,"&gt;")},n=function(y,g,k){g||(g=" ");var F=g[k];(F===" "||!F)&&(F="SPACE");var M=d(g.substring(k-64,k))+'<span style="text-decoration:underline;font-size:1.3em;font-weight:bold;">'+F+"</span>"+d(g.substring(k+1).substring(0,64));o("Music Line:"+r.lineIndex+":"+(k+1)+": "+y+":  "+M),f({message:y,line:g,startChar:a.iChar+k,column:k})},i,s;this.getWarnings=function(){return a.warnings},this.getWarningObjects=function(){return a.warningObjects};var h=function(y,g){if(g.indexOf("")>=0){u+=g;return}if(g=u+g,u="",!y){n("Can't add words before the first line of music",y,0);return}g=G.strip(g),g[g.length-1]!=="-"&&(g=g+" ");for(var k=[],F=0,M=!1,D=function(I){var q=G.strip(g.substring(F,I));if(q=q.replace(/\\([-_*|~])/g,"$1"),F=I+1,q.length>0){M&&(q=q.replace(/~/g," "));var O=g[I];return O!=="_"&&O!=="-"&&(O=" "),k.push({syllable:r.translateString(q),divider:O}),M=!1,!0}return!1},S=!1,B=0;B<g.length;B++){switch(g[B]){case" ":case"":D(B);break;case"-":!S&&!D(B)&&k.length>0&&(G.last(k).divider="-",k.push({skip:!0,to:"next"}));break;case"_":S||(D(B),k.push({skip:!0,to:"slur"}));break;case"*":S||(D(B),k.push({skip:!0,to:"next"}));break;case"|":S||(D(B),k.push({skip:!0,to:"bar"}));break;case"~":S||(M=!0);break}S=g[B]==="\\"}var A=!1;y.forEach(function(I){if(k.length!==0){if(k[0].skip){switch(k[0].to){case"next":I.el_type==="note"&&I.pitches!==null&&!A&&k.shift();break;case"slur":I.el_type==="note"&&I.pitches!==null&&k.shift();break;case"bar":I.el_type==="bar"&&k.shift();break}I.el_type!=="bar"&&(I.lyric===void 0?I.lyric=[{syllable:"",divider:" "}]:I.lyric.push({syllable:"",divider:" "}))}else if(I.el_type==="note"&&I.rest===void 0&&!A){var q=k.shift();q.syllable&&(q.syllable=q.syllable.replace(/ +/g,"¬†")),I.lyric===void 0?I.lyric=[q]:I.lyric.push(q)}}})},m=function(y,g){if(g.indexOf("")>=0){c+=g;return}if(g=c+g,c="",!y){n("Can't add symbols before the first line of music",y,0);return}g=G.strip(g),g[g.length-1]!=="-"&&(g=g+" ");for(var k=[],F=0,M=!1,D=function(A){var I=G.strip(g.substring(F,A));if(F=A+1,I.length>0){M&&(I=I.replace(/~/g," "));var q=g[A];return q!=="_"&&q!=="-"&&(q=" "),k.push({syllable:r.translateString(I),divider:q}),M=!1,!0}return!1},S=0;S<g.length;S++)switch(g[S]){case" ":case"":D(S);break;case"-":!D(S)&&k.length>0&&(G.last(k).divider="-",k.push({skip:!0,to:"next"}));break;case"_":D(S),k.push({skip:!0,to:"slur"});break;case"*":D(S),k.push({skip:!0,to:"next"});break;case"|":D(S),k.push({skip:!0,to:"bar"});break;case"~":M=!0;break}var B=!1;y.forEach(function(A){if(k.length!==0){if(k[0].skip)switch(k[0].to){case"next":A.el_type==="note"&&A.pitches!==null&&!B&&k.shift();break;case"slur":A.el_type==="note"&&A.pitches!==null&&k.shift();break;case"bar":A.el_type==="bar"&&k.shift();break}else if(A.el_type==="note"&&A.rest===void 0&&!B){var I=k.shift();A.lyric===void 0?A.lyric=[I]:A.lyric.push(I)}}})},v=function(y){if(G.startsWith(y,"%%")){var g=J.addDirective(y.substring(2));g&&n(g,y,2);return}var k=y.indexOf("%");if(k>=0&&(y=y.substring(0,k)),y=y.replace(/\s+$/,""),y.length!==0){if(u){h(t.getCurrentVoice(),y.substring(2));return}if(c){m(t.getCurrentVoice(),y.substring(2));return}if(y.length<2||y[1]!==":"||s.lineContinuation){s.parseMusic(y);return}var F=i.parseHeader(y);F.regular&&s.parseMusic(y),F.newline&&s.startNewLine(),F.words&&h(t.getCurrentVoice(),y.substring(2)),F.symbols&&m(t.getCurrentVoice(),y.substring(2))}};function w(y,g){y.push({el_type:"hint"});for(var k=0;k<g.length;k++){var F=g[k],M=G.clone(F);if(y.push(M),F.el_type==="bar")return}}function N(y,g){for(var k=0;k<y.length;k++){var F=y[k],M=g[k];if(M)for(var D=0;D<M.voices.length;D++){var S=M.voices[D],B=F.voices[D];B&&w(B,S)}}}function L(){for(var y=0;y<e.lines.length;y++){var g=e.lines[y].staff;if(g){for(var k=y+1;k<e.lines.length&&e.lines[k].staff===void 0;)k++;if(k<e.lines.length){var F=e.lines[k].staff;N(g,F)}}}}this.parse=function(y,g,k){g||(g={}),k||(k=0),e.reset(),y=y.replace(/\r\n?/g,`
`)+`
`;var F=y.split(`
\\`);if(F.length>1){for(var M=1;M<F.length;M++)for(;F[M].length>0&&F[M][0]!==`
`;)F[M]=F[M].substr(1),F[M-1]+=" ";y=F.join("  ")}y=y.replace(/\\([ \t]*)(%.*)*\n/g,function(O,x,b){var _=b?Array(b.length+1).join(" "):"";return x+""+_+`
`});var D=y.split(`
`);G.last(D).length===0&&D.pop(),r=new Vn(D,a),i=new zn(r,n,a,e,t),s=new wt(r,n,a,e,t,i),g.print&&(e.media="print"),a.reset(),a.iChar=k,g.visualTranspose?(a.globalTranspose=parseInt(g.visualTranspose),a.globalTranspose===0?a.globalTranspose=void 0:t.setVisualTranspose(g.visualTranspose)):a.globalTranspose=void 0,g.lineBreaks&&(a.lineBreaks=g.lineBreaks),i.reset(r,n,a,e);try{g.format&&J.globalFormatting(g.format);for(var S=r.nextLine();S;){if(g.header_only&&a.is_in_header===!1||g.stop_on_warning&&a.warnings)throw"normal_abort";var B=a.is_in_header;v(S),B&&!a.is_in_header&&(t.setRunningFont("annotationfont",a.annotationfont),t.setRunningFont("gchordfont",a.gchordfont),t.setRunningFont("tripletfont",a.tripletfont),t.setRunningFont("vocalfont",a.vocalfont)),S=r.nextLine()}u&&h(t.getCurrentVoice(),""),c&&m(t.getCurrentVoice(),""),a.openSlurs=t.cleanUp(a.barsperstaff,a.staffnonote,a.openSlurs)}catch(O){if(O!=="normal_abort")throw O}var A=11*72,I=8.5*72;switch(a.papersize){case"legal":A=14*72,I=8.5*72;break;case"A4":A=11.7*72,I=8.3*72;break}if(a.landscape){var q=A;A=I,I=q}e.formatting.pagewidth||(e.formatting.pagewidth=I),e.formatting.pageheight||(e.formatting.pageheight=A),g.hint_measures&&L(),ea.wrapLines(e,a.lineBreaks,a.barNumbers)}}var ia=new aa;function Ir(e){throw new Error("Todo: "+e)}function hs(e,t){let r=t.sequences.find(In({id:e}));return r||(r={id:e,events:[],cursor:0},t.sequences.push(r),t.events.push([0,"sequence",e]),r)}function Et(e,t){let r=t.length;for(;r--;)if(t[r][1]===e)return t[r]}function ps(e,t){return[0,0,2,4,5,7,9,11,12,14,16,17,19,21,23,24,26,28,29,31,33,35,36,38,40,41,43,45,47,48][t]+e+60}function Or(e){ia.parse(e);let t=ia.getTune(),r=t.lines.reduce((u,c)=>(c.staff.reduce((p,l,a)=>{let o=hs(a,u),f=o.events;if(l.clef){let n=l.clef.type,i=Et("clef",f);(!i||i[2]!==n)&&f.push([0,"clef",n])}let d=Et("key",f);if(l.key){let n=l.key.mode===""?l.key.root:Ir("What happens when ABC decides key.mode is not an empty string?"),i={C:0,D:2,E:4,F:5,G:7,A:9,B:11};i[n]||Ir('ABC says root is "'+n+'", we have not implemented support for that');let s=i[n];(!d||d[2]!==n)&&(d=[o.cursor,"key",s],f.push(d))}if(l.meter){let n=1/(+l.meter.value[0].den/4),i=+l.meter.value[0].num*n,s=Et("meter",f);(!s||s[2]!==i||s[3]!==n)&&f.push([0,"meter",i,n])}if(l.voices){let n=Et("note",f);l.voices[0].reduce((i,s)=>{if(s.el_type==="note")s.pitches.reduce((h,m)=>(h.push([o.cursor,"note",ps(d[2],m.pitch),.25,s.duration*4]),h),i),o.cursor+=s.duration*4;else if(s.el_type==="bar"){let h=Et("meter",i);if((o.cursor-h[0])%h[2]!==0){let v=(Math.floor((o.cursor-h[0])/h[2])+1)*h[2];o.cursor=v}}else console.log("ABC voice ignored:",s);return i},f),l.voices[1]&&Ir("What do we do with a second array of voices?")}return p},u.sequences),u),{name:t.metaText.title,events:[],sequences:[],meta:t.metaText});return r.sequences.forEach(u=>delete u.cursor),r}var ds={chord:3,note:3,key:1,meter:2,rate:1,lyric:2},ms=/^[ABCDEFG][b‚ô≠#‚ôØ]{0,1}-?\d$/,sa=/^[ABCDEFG][b‚ô≠#‚ôØ]{0,1}/;function Gr(e){let t=e.trim().split(/\s+/),r=[],u=-1;for(;t[++u]!==void 0;){let c=Number(t[u]),p=t[++u];ms.test(p)?(p="note",--u):sa.test(p)&&(p="chord",--u);let l=[c,p],a=ds[p];if(a===void 0)throw new TypeError('Unrecognised type "'+p+'" in sequence data');if(p==="chord"){let o=sa.exec(t[++u])[0],f=t[u].slice(o.length)||t[++u],d=Number(t[++u]);l.push(o,f,d)}else for(;a--;){let o=Number(t[++u]);l.push(Number.isNaN(o)?t[u]:o)}r.push(l)}return r}function gs(e){let t=e.files[Object.keys(e.files)[0]];return He(t.type,t.content)}function vs(e){let t=e.settings.find(matches({id:13324}))||e.settings[0];return He("abc",t.abc)}function He(e,t){if(typeof t=="object")return t.files?gs(t):t.settings?vs():Array.isArray(t)?{id:0,events:t}:t;if(e==="abc"||e==="text/x-abc")return Or(t.replace(/\n\s+/g,`
`)).sequences[0];if(e==="sequence"||e==="text/plain")return{events:Gr(t)};{let r=JSON.parse(t);return Array.isArray(r)?{id:0,events:r}:r}}var bs=br(Sn);var oa=j((e,t)=>typeof t,{string:function(e,t){return bs(t).then(r=>He(e,r)).catch(r=>console.error(r))},default:function(e,t,r,u){t[e]=u}});var xs=/^(\d+)\/(\d+)$/;function fa(e){let t=xs.exec(e),r=parseInt(t[1],10),u=4/parseInt(t[2],10);return{1:"meter",2:r*u,3:u}}function ca(e){let t=e[2],r=e[3],u=t/r,c=4/r;return u+"/"+c}var Ie={};Kr(Ie,{acciDoubleFlat:()=>qs,acciDoubleSharp:()=>Rs,acciFlat:()=>Ut,acciNatural:()=>qr,acciParensLeft:()=>$s,acciParensRight:()=>Hs,acciSharp:()=>Wt,altoClef:()=>Cs,bassClef:()=>ks,chordAugmented:()=>So,chordBassSlash:()=>Rr,chordBracketLeft:()=>Ro,chordBracketRight:()=>$o,chordDiminished:()=>Po,chordGlyphs:()=>Ho,chordHalfDiminished:()=>Fo,chordMajorSeventh:()=>Io,chordMinor:()=>Oo,chordParensLeftTall:()=>Go,chordParensRightTall:()=>qo,drumClef:()=>Ns,graceNoteStemDown:()=>po,graceNoteStemUp:()=>ho,head0125:()=>zs,head01875:()=>Us,head025:()=>Ws,head0375:()=>Ks,head05:()=>Qs,head075:()=>Xs,head1:()=>Zs,head15:()=>Js,head2:()=>Ys,head3:()=>js,head4:()=>Vs,head6:()=>eo,headBracketLeft:()=>to,headBracketRight:()=>ro,headCircleX:()=>fo,headDiamondBlack:()=>ao,headDiamondBlackWide:()=>io,headPlusBlack:()=>oo,headSlashHorizontalEnds:()=>uo,headSlashVerticalEnds:()=>lo,headSlashedBlack2:()=>no,headTriangleUpBlack:()=>co,headXBlack:()=>so,percussionClef:()=>_s,rest0125:()=>wo,rest01875:()=>Eo,rest025:()=>Co,rest0375:()=>ko,rest05:()=>No,rest075:()=>_o,rest1:()=>To,rest15:()=>Bo,rest2:()=>Lo,rest3:()=>Ao,rest4:()=>Mo,rest6:()=>Do,tailDown0125:()=>yo,tailDown025:()=>bo,tailDown05:()=>go,tailUp0125:()=>xo,tailUp025:()=>vo,tailUp05:()=>mo,timeSig0:()=>Ts,timeSig1:()=>Bs,timeSig2:()=>Ls,timeSig3:()=>As,timeSig4:()=>Ms,timeSig5:()=>Ds,timeSig6:()=>Ps,timeSig7:()=>Fs,timeSig8:()=>Ss,timeSig9:()=>Is,timeSigCommon:()=>Os,timeSigCutCommon:()=>Gs,treble8downClef:()=>ws,treble8upClef:()=>Es,trebleClef:()=>ys});var ys="&#xE050;",ws="&#xE052;",Es="&#xE053;",Cs="&#xE05C;",ks="&#xE062;",Ns="&#xE069;",_s="&#xE069;",Ts="&#xE080;",Bs="&#xE081;",Ls="&#xE082;",As="&#xE083;",Ms="&#xE084;",Ds="&#xE085;",Ps="&#xE086;",Fs="&#xE087;",Ss="&#xE088;",Is="&#xE089;",Os="&#xE08A;",Gs="&#xE08B;",qs="&#xE264;",Ut="&#xE260;",qr="&#xE261;",Wt="&#xE262;",Rs="&#xE263;",$s="&#xE26A;",Hs="&#xE26B;",zs="&#xE0A4;",Us="&#xE0A4;&#xE1E7;",Ws="&#xE0A4;",Ks="&#xE0A4;&#xE1E7;",Qs="&#xE0A4;",Xs="&#xE0A4;&#xE1E7;",Zs="&#xE0A4;",Js="&#xE0A4;&#xE1E7;",Ys="&#xE0A3;",js="&#xE0A3;&#xE1E7;",Vs="&#xE0A2;",eo="&#xE0A2;&#xE1E7;",to="&#xE0F5;",ro="&#xE0F6;",no="&#xE0D0;",ao="&#xE0DB;",io="&#xE0DC;",so="&#xE0A9;",oo="&#xE0AF;",fo="&#xE0B3;",co="&#xE0BE;",lo="&#xE100;",uo="&#xE101;",ho="&#xE560;",po="&#xE561;",mo="&#xE240;",go="&#xE241;",vo="&#xE242;",bo="&#xE243;",xo="&#xE244;",yo="&#xE245;",wo="&#xE4E8;",Eo="&#xE4E8;&#xE1E7;",Co="&#xE4E7;",ko="&#xE4E7;&#xE1E7;",No="&#xE4E6;",_o="&#xE4E6;&#xE1E7;",To="&#xE4E5;",Bo="&#xE4E5;&#xE1E7;",Lo="&#xE4E4;",Ao="&#xE4E4;&#xE1E7;",Mo="&#xE4E3;",Do="&#xE4E3;&#xE1E7;",Po="&#xE870;",Fo="&#xE871;",So="&#xE872;",Io="&#xE873;",Oo="&#xE874;",Go="&#xE875;",qo="&#xE876;",Ro="(",$o=")",Rr="&#xE87B;",Ho={"‚àÜ‚ôØ11":"Ó°≥Óµ¢11","‚àÜ":"Ó°≥",7:"7","-7":"Ó°¥7","-‚ô≠6":"Ó°¥Óµ†6","7sus‚ô≠9":"7susÓµ¢",√∏:"Ó°±","7‚ôØ11":"7Óµ¢11","-‚àÜ":"Ó°¥Ó°≥","‚àÜ‚ô≠6":"Ó°≥Óµ†6","-‚ô≠9":"Ó°¥Óµ†9",√∏7:"Ó°±7","‚àÜ‚ôØ5":"Ó°≥Óµ¢5","7alt":"7alt","¬∞":"Ó°∞","7‚ô≠9":"7Óµ†","+7":"Ó°≤7"};var la=Math.abs,Kt=Symbol("scribe-id"),zo=0;function Ye(e){return e[Kt]||(e[Kt]=++zo+""),e[Kt]}var Oe=1.1;function ua(e,t,r){return`<path class="beam-path-16th beam-path" d="
        M${r[0]},              ${-e*r[0]/(t.length-1)-.5*Oe}
        L${r[r.length-1]},${-e*r[r.length-1]/(t.length-1)-.5*Oe}
        L${r[r.length-1]},${-e*r[r.length-1]/(t.length-1)+.5*Oe}
        L${r[0]},              ${-e*r[0]/(t.length-1)+.5*Oe}
    Z"></path>`}function Uo(e,t){let r=e.map(we("duration")),u="",c=-1,p;for(;r[++c];)r[c]<.5&&r[c].toFixed(2)!=="0.33"?p?p.push(c):p=[c]:p&&(u+=ua(t,e,p),p=void 0);return p&&(u+=ua(t,e,p)),u}var Qt={flat:`<span class="chord-flat">${Ut}</span>`,sharp:`<span class="chord-sharp">${Wt}</span>`},ha=j(we("type"),{clef:e=>z("span",{class:`${e.clef}-clef clef`,data:{eventId:null},html:Ie[e.clef+"Clef"]||""}),chord:e=>z("abbr",{class:"chord-abbr",title:"TODO - name of chord",data:{beat:e.beat+1,duration:e.duration,eventId:Ye(e.event)},html:'<span class="chord-root">'+e.root.replace(ht,Qt.sharp).replace(ut,Qt.flat)+"</span><sup>"+e.extension.replace(ht,Qt.sharp).replace(ut,Qt.flat)+"</sup>"+(e.bass?Rr+'<span class="chord-bass">'+e.bass+"</span>":"")}),timesig:e=>z("span",{class:"timesig",data:{eventId:Ye(e.event)},html:`<sup>${Ie["timeSig"+e.numerator]}</sup>
            <sub>${Ie["timeSig"+e.denominator]}</sub>`}),lyric:e=>z("span",{class:"lyric",part:"lyric",data:{beat:e.beat+1,duration:e.duration,eventId:Ye(e.event)},html:e.value}),acci:e=>z("span",{class:"acci",data:e.beat===void 0?{pitch:e.pitch}:{beat:e.beat+1,pitch:e.pitch,part:e.part,eventId:Ye(e.event)},html:e.value===1?Wt:e.value===-1?Ut:qr}),upledger:e=>z("svg",{class:"up-ledge ledge",viewBox:`0 ${.5-e.rows} 4.4 ${e.rows}`,preserveAspectRatio:"xMidYMax",data:{beat:e.beat+1,pitch:e.pitch,part:e.part},style:`height: ${e.rows*.125}em;`,html:`<g transform="translate(0 -8)">
            <line x1="0" x2="4.4" y1="8" y2="8"></line>
            <line x1="0" x2="4.4" y1="6" y2="6"></line>
            <line x1="0" x2="4.4" y1="4" y2="4"></line>
            <line x1="0" x2="4.4" y1="2" y2="2"></line>
            <line x1="0" x2="4.4" y1="0" y2="0"></line>
            <line x1="0" x2="4.4" y1="2" y2="2"></line>
            <line x1="0" x2="4.4" y1="4" y2="4"></line>
            <line x1="0" x2="4.4" y1="6" y2="6"></line>
            <line x1="0" x2="4.4" y1="8" y2="8"></line>
        </g>`}),downledger:e=>z("svg",{class:"down-ledge ledge",viewBox:`0 -0.5 4.4 ${e.rows}`,preserveAspectRatio:"xMidYMin",data:{beat:e.beat+1,pitch:e.pitch,part:e.part},style:`height: ${e.rows*.125}em;`,html:`<g transform="translate(0 -8)">
            <line x1="0" x2="4.4" y1="8" y2="8"></line>
            <line x1="0" x2="4.4" y1="6" y2="6"></line>
            <line x1="0" x2="4.4" y1="4" y2="4"></line>
            <line x1="0" x2="4.4" y1="2" y2="2"></line>
            <line x1="0" x2="4.4" y1="0" y2="0"></line>
            <line x1="0" x2="4.4" y1="2" y2="2"></line>
            <line x1="0" x2="4.4" y1="4" y2="4"></line>
            <line x1="0" x2="4.4" y1="6" y2="6"></line>
            <line x1="0" x2="4.4" y1="8" y2="8"></line>
        </g>`}),head:e=>z("span",{class:"head",data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part,eventId:Ye(e.event)},html:`${Ie["head"+(e.duration+"").replace(".","")]||""}`}),stem:e=>z("svg",{class:`${e.stemDirection}-stem stem`,viewBox:"0 0 2.7 7",preserveAspectRatio:"none",data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part},style:`--beam-y: ${e.beamY===void 0?0:e.beamY};`,html:e.stemDirection==="up"?'<line class="stem-path" x1="2.6" y1="0" x2="2.6" y2="6.6"></line>':'<line class="stem-path" x1="0.1" y1="0.4" x2="0.1" y2="7"></line>'}),beam:e=>z("svg",{class:`${e.updown}-beam beam`,viewBox:`0 ${(e.range>0?-e.range:0)-.5} ${e.stems.length-1} ${la(e.range)+1}`,preserveAspectRatio:"none",data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part},style:`height: ${(la(e.range)+1)*.125}em; align-self: ${e.range>0?"end":"start"};`,html:`
            <path class="beam-path" d="M0,${-.5*Oe} L${e.stems.length-1},${-e.range-.5*Oe} L${e.stems.length-1},${-e.range+.5*Oe} L0,${.5*Oe} Z"></path>
            ${Uo(e.stems,e.range)}
        `}),tie:e=>z("svg",{class:`${e.updown}-tie tie`,viewBox:"0 0 1 1",preserveAspectRatio:"none",data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part},style:`height: 0.75em; align-self: ${e.updown==="up"?"start":"end"};`,html:'<path class="tie-path" transform="translate(0, 0.14) scale(1 0.6)" d="M0.979174733,0.0124875307 C0.650597814,1.1195554 0.135029714,1.00095361 0.0165376402,0.026468657 C0.0113570514,0.0135475362 0.00253387291,0.00218807553 0,0 C0.0977526897,1.29523004 0.656681642,1.37089992 1,2.43111793e-08 C0.991901367,2.43111797e-08 0.987703936,0.01248753 0.979174733,0.0124875307 Z M0.979174733,0.0124875307"></path>'}),tail:e=>z("span",{class:`${e.stemDirection}-tail tail`,data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part,eventId:Ye(e.event)},html:Ie["tail"+(e.stemDirection==="up"?"Up":"Down")+(e.duration+"").replace(".","")]}),rest:e=>z("span",{class:"rest",data:{beat:e.beat+1,pitch:e.pitch,duration:e.duration,part:e.part},html:`${Ie["rest"+(e.duration+"").replace(".","")]||""}`}),default:function(e){return function(t){e[t.type]||(e[t.type]=!0,console.log(t),console.error('Scribe: symbol type "'+t.type+'" not rendered'))}}({})});function Wo(e,t){let r=ha(t);return r&&e.push(r),e}function Ko(e,t){return e.push(z("div",{class:`${t.stave.clef}-stave stave bar`,data:{beat:t.beat,duration:t.duration},children:t.symbols.reduce(Wo,[])})),e}function $r(e){return e.reduce(Ko,[])}var Qo=Object.assign,Xo=Object.defineProperties,Zo=import.meta.url.replace(/\/[^\/]*\.js/,"/shadow.css"),Ct=pe.of(),pa=[];Ct.each(e=>pa.forEach(t=>t(e)));var th=Xo(er("scribe-music",{shadow:`<link rel="stylesheet" href="${Zo}" />`,construct:function(e,t){let r=e.querySelector("link");pa.push(u=>r.href=u),Ct.value&&(r.href=Ct.value),t.data=pe.of(),t.clef=pe.of("treble"),t.key=pe.of("C"),t.meter=pe.of([-4,"meter",4,1]),t.transpose=pe.of(0),t.isSafari=navigator.userAgent.includes("AppleWebKit/")&&!navigator.userAgent.includes("Chrome/")&&!navigator.userAgent.includes("Edge/")&&!navigator.userAgent.includes("Gecko/")},connect:function(e,t){if(t.isSafari&&this.classList.add("safari"),pe.from(()=>t.data.value&&$r(vr(t.data.value.events,t.clef.value,t.key.value,t.meter.value,t.transpose.value))).each(r=>{e.querySelectorAll(".bar").forEach(u=>u.remove()),e.append.apply(e,r)}),!this.src){let r=this.textContent.trim();t.data.value=He(this.type,r)}}},{clef:{attribute:function(e){this.clef=e},get:function(){return U(this).clef.value},set:function(e){if(!lt[e]){console.warn('<scribe-music> Attempt to set invalid clef="'+e+'" ignored');return}U(this).clef.value=e}},key:{attribute:function(e){this.key=e===""?"C":""},get:function(){return U(this).key.value},set:function(e){let t=U(this);if(typeof e!="string"||!/^[A-G][#b‚ôØ‚ô≠]?$/.test(e)){console.warn('<scribe-music> Attempt to set invalid key="'+e+'" ignored');return}t.key.value=e.replace(/[#b]$/,r=>r==="#"?"‚ôØ":"‚ô≠")}},meter:{attribute:function(e){this.meter=e===""?"4/4":e},get:function(){return ca(U(this).meter.value)},set:function(e){U(this).meter.value=Qo([0],fa(e))}},transpose:{attribute:function(e){this.transpose=e},get:function(){return U(this).transpose.value},set:function(e){U(this).transpose.value=typeof e=="number"?Math.round(e):parseInt(e,10)}},type:{attribute:function(e){this.type=e},writable:!0},src:{attribute:function(e){this.src=e},get:function(){return U(this).src},set:function(e){let t=U(this);t.src=e,oa(this.type,e).then(r=>this.data=r)},default:null},data:{get:function(){return U(this).data.value},set:function(e){U(this).data.value=e},default:null}},null,"github.com/stephband/scribe/"),{stylesheet:{set:e=>Ct.value=e,get:()=>Ct.value}});export{th as default};
